'use strict';const a133_0x51c455=a133_0x11df;function a133_0x49ea(){const _0x1078a2=['findByIds','Playing\x20voice\x20recorded:\x20','push','uuid','Play\x20sound:\x20','mongoose','AudioPlayer','../text-to-audio/text-to-audio.service','AgendaService','design:paramtypes','findOne','length','275537xriXzj','39FuepNJ','findById','OnEvent','assets','stop','exec','TextToAudioService','495395dUhLDX','../common/path','findByIdAndUpdate','broadcastPlaying','killAll','log','28rTkmqC','isFileExist','forEach','join','findByType','Sound','filePath','SoundGateway','findByIdAndDelete','fileName','585224NcGGJa','4fxueqB','delete','__metadata','SoundType','../common/events/sound','__decorate','find','TextToAudio','cancelJob','255897GoBTTu','validateAndMoveFileAsync','__esModule','AUDIO_DIR','Model','design:type','path','../common/job','playSoundOnEvent','function','playTextToAudioRecorded','UploadService','scheduleJob','getOwnPropertyDescriptor','error','copyFiles','80cComTt','../common/audio/audio-player','Tune','save','soundModel','playAsync','processRootPath','metadata','audio','moveFile','decorate','update','deleteFile','@nestjs/event-emitter','Sound\x20not\x20found!','./constants','PROCESS_CACHE','executeJob','assign','InjectModel','split','uploadService','../common/constants','775086gmVraG','File\x20not\x20found!','play','streamingService','SoundService','\x20-\x20','object','logger','./data/default-sounds','playVoiceRecorded','now','soundGateway','defineProperty','all','__param','playStreamAudioAsync','PlaySound','prototype','textToAudioService','SoundEvent','Logger','TMP_UPLOAD_DIR','_id','textToAudio','DEFAULT_TUNES_DIR','pop','getNewFileName','4978094YvlbSn','56798NdFARd','name','design:returntype','StreamingService','updateVolume','../upload/upload.service','volume','JobType','@nestjs/common'];a133_0x49ea=function(){return _0x1078a2;};return a133_0x49ea();}(function(_0x4aa099,_0x4130bd){const _0x42e8e6=a133_0x11df,_0x51037f=_0x4aa099();while(!![]){try{const _0x2fd814=parseInt(_0x42e8e6(0xa3))/0x1+parseInt(_0x42e8e6(0x108))/0x2*(-parseInt(_0x42e8e6(0xa4))/0x3)+-parseInt(_0x42e8e6(0xbc))/0x4*(parseInt(_0x42e8e6(0xab))/0x5)+-parseInt(_0x42e8e6(0xec))/0x6+parseInt(_0x42e8e6(0xb1))/0x7*(parseInt(_0x42e8e6(0xbb))/0x8)+-parseInt(_0x42e8e6(0xc5))/0x9*(parseInt(_0x42e8e6(0xd5))/0xa)+parseInt(_0x42e8e6(0x107))/0xb;if(_0x2fd814===_0x4130bd)break;else _0x51037f['push'](_0x51037f['shift']());}catch(_0xca8a22){_0x51037f['push'](_0x51037f['shift']());}}}(a133_0x49ea,0x2fcd0));function a133_0x11df(_0x5c44d2,_0x1080bd){const _0x49ea7e=a133_0x49ea();return a133_0x11df=function(_0x11df09,_0x131696){_0x11df09=_0x11df09-0x9d;let _0x408db3=_0x49ea7e[_0x11df09];return _0x408db3;},a133_0x11df(_0x5c44d2,_0x1080bd);}var __decorate=this&&this[a133_0x51c455(0xc1)]||function(_0x4174eb,_0x5a8795,_0x2d7355,_0x55cdc8){const _0x8192e1=a133_0x51c455;var _0x21281e=arguments[_0x8192e1(0xa2)],_0x18da50=_0x21281e<0x3?_0x5a8795:_0x55cdc8===null?_0x55cdc8=Object[_0x8192e1(0xd2)](_0x5a8795,_0x2d7355):_0x55cdc8,_0x3a2b2b;if(typeof Reflect==='object'&&typeof Reflect[_0x8192e1(0xdf)]===_0x8192e1(0xce))_0x18da50=Reflect['decorate'](_0x4174eb,_0x5a8795,_0x2d7355,_0x55cdc8);else{for(var _0x1f9f8c=_0x4174eb['length']-0x1;_0x1f9f8c>=0x0;_0x1f9f8c--)if(_0x3a2b2b=_0x4174eb[_0x1f9f8c])_0x18da50=(_0x21281e<0x3?_0x3a2b2b(_0x18da50):_0x21281e>0x3?_0x3a2b2b(_0x5a8795,_0x2d7355,_0x18da50):_0x3a2b2b(_0x5a8795,_0x2d7355))||_0x18da50;}return _0x21281e>0x3&&_0x18da50&&Object[_0x8192e1(0xf8)](_0x5a8795,_0x2d7355,_0x18da50),_0x18da50;},__metadata=this&&this[a133_0x51c455(0xbe)]||function(_0x81bdf5,_0x147da2){const _0x900bcc=a133_0x51c455;if(typeof Reflect===_0x900bcc(0xf2)&&typeof Reflect[_0x900bcc(0xdc)]==='function')return Reflect['metadata'](_0x81bdf5,_0x147da2);},__param=this&&this[a133_0x51c455(0xfa)]||function(_0x1d1908,_0x1af2c7){return function(_0x20a4f7,_0x499e5e){_0x1af2c7(_0x20a4f7,_0x499e5e,_0x1d1908);};},SoundService_1;Object[a133_0x51c455(0xf8)](exports,a133_0x51c455(0xc7),{'value':!![]}),exports[a133_0x51c455(0xf0)]=void 0x0;const common_1=require(a133_0x51c455(0x110)),mongoose_1=require('@nestjs/mongoose'),mongoose_2=require(a133_0x51c455(0x116)),path=require(a133_0x51c455(0xcb)),event_emitter_1=require(a133_0x51c455(0xe2)),file_1=require('../common/file'),agenda_service_1=require('../agenda/agenda.service'),enums_1=require('../common/enums'),constants_1=require(a133_0x51c455(0xeb)),utils_1=require('../common/utils'),path_1=require(a133_0x51c455(0xac)),audio_player_1=require(a133_0x51c455(0xd6)),sound_1=require(a133_0x51c455(0xc0)),job_1=require(a133_0x51c455(0xcc)),constants_2=require(a133_0x51c455(0xe4)),default_sounds_1=require(a133_0x51c455(0xf4)),sound_gateway_1=require('./sound.gateway'),path_2=require(a133_0x51c455(0xcb)),upload_service_1=require(a133_0x51c455(0x10d)),text_to_audio_service_1=require(a133_0x51c455(0x9e)),streaming_service_1=require('../streaming/streaming.service');let SoundService=SoundService_1=class SoundService{constructor(_0x3700a2,_0x429254,_0x86d7b0,_0x4be186,_0x5544f6,_0x1d41b3){const _0x44b00d=a133_0x51c455;this[_0x44b00d(0xd9)]=_0x3700a2,this['agendaService']=_0x429254,this[_0x44b00d(0xea)]=_0x86d7b0,this[_0x44b00d(0xfe)]=_0x4be186,this['streamingService']=_0x5544f6,this['soundGateway']=_0x1d41b3,this[_0x44b00d(0xf3)]=new common_1[(_0x44b00d(0x100))](SoundService_1[_0x44b00d(0x109)]);}async['create'](_0x4e3e84){const _0x51471e=a133_0x51c455;await this[_0x51471e(0xc6)](_0x4e3e84,null);const _0x1439e8=new this[(_0x51471e(0xd9))](_0x4e3e84);return _0x1439e8[_0x51471e(0xd8)]();}async[a133_0x51c455(0xb5)](_0x15ad44){const _0x220abc=a133_0x51c455,_0x4336e8=await this['soundModel'][_0x220abc(0xc2)]({'type':_0x15ad44})[_0x220abc(0xa9)]();return _0x4336e8;}async['findOne'](_0x1fac4b){const _0x3fd6be=a133_0x51c455,_0x1f2411=await this[_0x3fd6be(0xd9)][_0x3fd6be(0xa5)](_0x1fac4b);return _0x1f2411;}async[a133_0x51c455(0x111)](_0x275485){const _0x48196c=a133_0x51c455,_0x5ec3cd=await this[_0x48196c(0xd9)][_0x48196c(0xc2)]({'_id':{'$in':_0x275485}});return _0x5ec3cd;}async[a133_0x51c455(0xe0)](_0x135d9e,_0x14d502){const _0x943dbc=a133_0x51c455,_0x249427=await this['soundModel']['findById'](_0x135d9e)['exec']();if(!_0x249427)throw new Error(_0x943dbc(0xe3));await this['validateAndMoveFileAsync'](_0x14d502,_0x249427===null||_0x249427===void 0x0?void 0x0:_0x249427[_0x943dbc(0xba)]);const _0x14b858=await this[_0x943dbc(0xd9)][_0x943dbc(0xad)](_0x135d9e,Object[_0x943dbc(0xe7)](Object['assign']({},_0x14d502),{'updatedAtUtc':new Date()}),{'new':!![]});return _0x14b858;}async[a133_0x51c455(0x10c)](_0x2497f4,_0x2bfb98){const _0x388e44=a133_0x51c455,_0x2bfdab=await this[_0x388e44(0xd9)][_0x388e44(0xa5)](_0x2497f4)[_0x388e44(0xa9)]();if(!_0x2bfdab)throw new Error('Sound\x20not\x20found!');const _0x3c16c4=await this['soundModel'][_0x388e44(0xad)](_0x2497f4,Object[_0x388e44(0xe7)](Object[_0x388e44(0xe7)]({},_0x2bfb98),{'updatedAtUtc':new Date()}),{'new':!![]});return _0x3c16c4;}async[a133_0x51c455(0xbd)](_0x1626cf){const _0x1c7a7f=a133_0x51c455,_0x2b115f=await this[_0x1c7a7f(0xd9)][_0x1c7a7f(0xb9)](_0x1626cf);if(_0x2b115f[_0x1c7a7f(0xba)]){const _0x517ca0=constants_1[_0x1c7a7f(0xc8)]+'/'+_0x2b115f[_0x1c7a7f(0xba)];try{(0x0,file_1[_0x1c7a7f(0xe1)])(_0x517ca0);}catch(_0xad3b18){this[_0x1c7a7f(0xf3)][_0x1c7a7f(0xd3)](_0xad3b18);}}return _0x2b115f;}async['upload'](_0x2fc602,_0x510660){const _0x139618=a133_0x51c455,_0x23cade=await this[_0x139618(0xd9)][_0x139618(0xa5)](_0x2fc602)[_0x139618(0xa9)](),_0x281a54=_0x23cade===null||_0x23cade===void 0x0?void 0x0:_0x23cade[_0x139618(0xba)],_0x1ab721=this[_0x139618(0x106)](_0x510660['originalname']),_0x1206f7=constants_1['AUDIO_DIR']+'/'+_0x1ab721;await(0x0,file_1[_0x139618(0xde)])(_0x510660[_0x139618(0xcb)],_0x1206f7);const _0x50157a={'fileName':_0x1ab721},_0x5f4c32=await this[_0x139618(0xd9)][_0x139618(0xad)](_0x2fc602,Object[_0x139618(0xe7)](Object['assign']({},_0x50157a),{'updatedAtUtc':new Date()}),{'new':!![]});if(_0x281a54){const _0x35e883=constants_1[_0x139618(0xc8)]+'/'+_0x281a54;(0x0,file_1[_0x139618(0xe1)])(_0x35e883);}return _0x5f4c32;}async[a133_0x51c455(0xcd)](_0xb8d0d6){const _0x9f4a6c=a133_0x51c455,{soundId:_0x2b51e1,jobId:_0x583fb3,durationInSecond:_0x4335ae}=_0xb8d0d6,_0x34d1ff=await this[_0x9f4a6c(0xa1)](_0x2b51e1),_0x2217f3=path['join'](path_1[_0x9f4a6c(0xdb)],_0x9f4a6c(0xa7),_0x9f4a6c(0xdd),_0x34d1ff['fileName']);job_1['PROCESS_CACHE'][_0x9f4a6c(0xaf)](),this[_0x9f4a6c(0xf3)][_0x9f4a6c(0xb0)]('Playing\x20sound:\x20'+_0x2b51e1+_0x9f4a6c(0xf1)+_0x34d1ff[_0x9f4a6c(0x109)]),(0x0,job_1[_0x9f4a6c(0xe6)])({'jobId':_0x583fb3,'run':()=>audio_player_1['AudioPlayer'][_0x9f4a6c(0xda)](_0x2217f3,_0x34d1ff[_0x9f4a6c(0x10e)]),'next':()=>this[_0x9f4a6c(0xa8)](_0x2b51e1),'durationInSecond':_0x4335ae}),this[_0x9f4a6c(0xf7)][_0x9f4a6c(0xae)]({'id':_0x2b51e1,'isPlaying':!![]});}async[a133_0x51c455(0xf5)](_0x5db80c){const _0x2bebdb=a133_0x51c455,{voiceId:_0x18d401,jobId:_0x5570f4,durationInSecond:_0xdeae3b}=_0x5db80c,_0x4e7167=await this[_0x2bebdb(0xea)]['findVoiceRecoredById'](_0x18d401),_0x4825af=_0x4e7167[_0x2bebdb(0xb7)],_0x37ab22=(0x0,path_2[_0x2bebdb(0xb4)])(process['cwd'](),_0x4825af);job_1[_0x2bebdb(0xe5)][_0x2bebdb(0xaf)](),this[_0x2bebdb(0xf3)]['log'](_0x2bebdb(0x112)+_0x18d401),(0x0,job_1['executeJob'])({'jobId':_0x5570f4,'run':()=>audio_player_1[_0x2bebdb(0x9d)]['playAsync'](_0x37ab22),'durationInSecond':_0xdeae3b,'next':()=>null});}async[a133_0x51c455(0xcf)](_0x38e09c){const _0x575d69=a133_0x51c455,{textToAudioId:_0x2dbaba,jobId:_0x1ebb26,durationInSecond:_0x5340f0}=_0x38e09c,{message:_0x5ede56}=await this[_0x575d69(0xfe)]['getMessageById'](_0x2dbaba);job_1[_0x575d69(0xe5)][_0x575d69(0xaf)](),(0x0,job_1[_0x575d69(0xe6)])({'jobId':_0x1ebb26,'run':()=>{const _0xf22309=_0x575d69;let _0x3605e8=null;return this[_0xf22309(0xfe)][_0xf22309(0x103)](_0x5ede56,_0x22a934=>{const _0x41cabc=_0xf22309;_0x3605e8=this[_0x41cabc(0xef)][_0x41cabc(0xfb)](_0x22a934);}),_0x3605e8;},'durationInSecond':_0x5340f0,'next':()=>null});}async[a133_0x51c455(0xee)](_0x4c99ee,_0x2b94d0,_0x5df848=![]){const _0x2e1a1f=a133_0x51c455,_0x33ca7f={'when':_0x2e1a1f(0xf6),'jobType':enums_1[_0x2e1a1f(0x10f)][_0x2e1a1f(0xfc)],'attributes':{'soundId':_0x2b94d0,'durationInSecond':_0x5df848?0x15180:undefined},'audit':{'actor':_0x4c99ee,'name':enums_1[_0x2e1a1f(0x10f)][_0x2e1a1f(0xfc)],'message':_0x2e1a1f(0x115)+_0x2b94d0}},_0xef550d=await this[_0x2e1a1f(0xd9)]['findOne']({'jobId':{'$ne':null}});_0xef550d&&await this[_0x2e1a1f(0xa8)](_0xef550d['id']);const {jobId:_0x1d32f8}=await this['agendaService'][_0x2e1a1f(0xd1)](_0x33ca7f);return this[_0x2e1a1f(0xe0)](_0x2b94d0,{'jobId':_0x1d32f8});}async[a133_0x51c455(0xa8)](_0x4c6a0d){const _0x188db7=a133_0x51c455;let _0xe11761=await this['findOne'](_0x4c6a0d);const {jobId:_0x2623b2}=_0xe11761||{};if(_0x2623b2){const {success:_0x55263d}=await this['agendaService'][_0x188db7(0xc4)](_0x2623b2);_0x55263d&&(_0xe11761=await this[_0x188db7(0xe0)](_0x4c6a0d,{'jobId':null}));}return this[_0x188db7(0xf7)][_0x188db7(0xae)]({'id':_0xe11761['id'],'isPlaying':![]}),_0xe11761;}async['resetTunes'](){const _0x1a372c=a133_0x51c455,_0x1038bf=await this[_0x1a372c(0xb5)](constants_2[_0x1a372c(0xbf)][_0x1a372c(0xd7)]);if(_0x1038bf[_0x1a372c(0xa2)]>0x0){const _0x3b6d69=[];_0x1038bf[_0x1a372c(0xb3)](_0x1c5557=>{const _0x3608d9=_0x1a372c;_0x3b6d69[_0x3608d9(0x113)](this['delete'](_0x1c5557[_0x3608d9(0x102)]));}),await Promise[_0x1a372c(0xf9)](_0x3b6d69);}await(0x0,file_1[_0x1a372c(0xd4)])(constants_1[_0x1a372c(0x104)],constants_1[_0x1a372c(0x101)]);const _0x295eb3=[];return default_sounds_1['DEFAULT_TUNES'][_0x1a372c(0xb3)](_0xb142f6=>{const _0xa67e75=_0x1a372c;_0x295eb3[_0xa67e75(0x113)](this['create'](Object[_0xa67e75(0xe7)]({},_0xb142f6)));}),await Promise[_0x1a372c(0xf9)](_0x295eb3),!![];}[a133_0x51c455(0x106)](_0x77aed0){const _0x286447=a133_0x51c455,_0x383d59=_0x77aed0[_0x286447(0xe9)]('.')[_0x286447(0x105)]();return(0x0,utils_1[_0x286447(0x114)])()+'.'+_0x383d59;}async['validateAndMoveFileAsync'](_0x514525,_0x315913){const _0x4f00f5=a133_0x51c455;if(!_0x514525[_0x4f00f5(0xba)])return;const _0x46b9f0=constants_1[_0x4f00f5(0x101)]+'/'+_0x514525[_0x4f00f5(0xba)],_0x2e0bf5=_0x315913||this[_0x4f00f5(0x106)](_0x514525[_0x4f00f5(0xba)]),_0x241160=constants_1[_0x4f00f5(0xc8)]+'/'+_0x2e0bf5;if(!(0x0,file_1[_0x4f00f5(0xb2)])(_0x46b9f0))throw new Error(_0x4f00f5(0xed));!(0x0,file_1[_0x4f00f5(0xb2)])(constants_1[_0x4f00f5(0xc8)])&&(0x0,file_1['createFolder'])(constants_1[_0x4f00f5(0xc8)]),await(0x0,file_1[_0x4f00f5(0xde)])(_0x46b9f0,_0x241160),_0x514525[_0x4f00f5(0xba)]=_0x2e0bf5;}};__decorate([(0x0,event_emitter_1['OnEvent'])(sound_1[a133_0x51c455(0xff)]['Play']),__metadata('design:type',Function),__metadata(a133_0x51c455(0xa0),[Object]),__metadata(a133_0x51c455(0x10a),Promise)],SoundService[a133_0x51c455(0xfd)],a133_0x51c455(0xcd),null),__decorate([(0x0,event_emitter_1[a133_0x51c455(0xa6)])(sound_1[a133_0x51c455(0xff)]['VoiceRecorded']),__metadata(a133_0x51c455(0xca),Function),__metadata(a133_0x51c455(0xa0),[Object]),__metadata(a133_0x51c455(0x10a),Promise)],SoundService[a133_0x51c455(0xfd)],a133_0x51c455(0xf5),null),__decorate([(0x0,event_emitter_1['OnEvent'])(sound_1[a133_0x51c455(0xff)][a133_0x51c455(0xc3)]),__metadata(a133_0x51c455(0xca),Function),__metadata(a133_0x51c455(0xa0),[Object]),__metadata(a133_0x51c455(0x10a),Promise)],SoundService[a133_0x51c455(0xfd)],a133_0x51c455(0xcf),null),SoundService=SoundService_1=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,mongoose_1[a133_0x51c455(0xe8)])(a133_0x51c455(0xb6))),__param(0x5,(0x0,common_1['Inject'])(sound_gateway_1[a133_0x51c455(0xb8)])),__metadata('design:paramtypes',[mongoose_2[a133_0x51c455(0xc9)],agenda_service_1[a133_0x51c455(0x9f)],upload_service_1[a133_0x51c455(0xd0)],text_to_audio_service_1[a133_0x51c455(0xaa)],streaming_service_1[a133_0x51c455(0x10b)],sound_gateway_1[a133_0x51c455(0xb8)]])],SoundService),exports[a133_0x51c455(0xf0)]=SoundService;