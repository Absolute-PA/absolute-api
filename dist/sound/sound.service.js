'use strict';function a136_0x4fdd(){const _0x2e6e53=['OnEvent','playTextToAudioRecorded','VoiceRecorded','forEach','mongoose','PlaySound','Playing\x20voice\x20recorded:\x20','_id','findByIdAndUpdate','defineProperty','originalname','textToAudioService','../common/utils','__esModule','function','delete','PROCESS_CACHE','AudioPlayer','TextToAudioService','../common/audio/audio-player','playAsync','updateVolume','filePath','./sound.gateway','Sound','soundModel','findByType','SoundGateway','Playing\x20sound:\x20','update','4604964clRESF','agendaService','killAll','error','playSoundOnEvent','name','streamingService','5XVjkgl','design:returntype','all','cwd','findOne','__param','moveFile','upload','now','AUDIO_DIR','Injectable','log','TextToAudio','stop','@nestjs/mongoose','DEFAULT_TUNES','scheduleJob','metadata','SoundEvent','findVoiceRecoredById','File\x20not\x20found!','processRootPath','design:paramtypes','Logger','split','getNewFileName','save','validateAndMoveFileAsync','create','5579390GiZAHB','find','6730tuRsEg','cancelJob','createFolder','UploadService','Model','../agenda/agenda.service','Play','object','__decorate','broadcastPlaying','length','../common/constants','303212xwLkrM','2592848xpmuHn','decorate','36bMtfZU','prototype','49544XbgCxh','resetTunes','JobType','DEFAULT_TUNES_DIR','fileName','exec','Sound\x20not\x20found!','play','pop','1589xjVBAA','./data/default-sounds','soundGateway','getOwnPropertyDescriptor','textToAudio','assign','uploadService','./constants','executeJob','3510024JzenAX','audio','design:type','path','findById','push','../streaming/streaming.service','Sound\x20file\x20not\x20found:\x20','Inject','playStreamAudioAsync','deleteFile','isFileExist','TMP_UPLOAD_DIR','logger','playVoiceRecorded','findByIdAndDelete','findByIds','uuid','assets','join','Voice\x20file\x20not\x20found:\x20','../common/path','__metadata'];a136_0x4fdd=function(){return _0x2e6e53;};return a136_0x4fdd();}const a136_0x5d6432=a136_0x5ebf;(function(_0x41e432,_0x46187e){const _0x1e03a9=a136_0x5ebf,_0x26c2f7=_0x41e432();while(!![]){try{const _0x343afa=-parseInt(_0x1e03a9(0x1e3))/0x1+parseInt(_0x1e03a9(0x1f0))/0x2+parseInt(_0x1e03a9(0x188))/0x3+parseInt(_0x1e03a9(0x1ef))/0x4*(parseInt(_0x1e03a9(0x1c4))/0x5)+-parseInt(_0x1e03a9(0x1bd))/0x6+parseInt(_0x1e03a9(0x1fd))/0x7*(parseInt(_0x1e03a9(0x1f4))/0x8)+-parseInt(_0x1e03a9(0x1f2))/0x9*(parseInt(_0x1e03a9(0x1e1))/0xa);if(_0x343afa===_0x46187e)break;else _0x26c2f7['push'](_0x26c2f7['shift']());}catch(_0x5bb394){_0x26c2f7['push'](_0x26c2f7['shift']());}}}(a136_0x4fdd,0xe5ff2));var __decorate=this&&this[a136_0x5d6432(0x1eb)]||function(_0x149533,_0x52b1ce,_0xc27f54,_0x160f63){const _0x2042b3=a136_0x5d6432;var _0x40a1bb=arguments[_0x2042b3(0x1ed)],_0x44027b=_0x40a1bb<0x3?_0x52b1ce:_0x160f63===null?_0x160f63=Object[_0x2042b3(0x182)](_0x52b1ce,_0xc27f54):_0x160f63,_0xf84050;if(typeof Reflect===_0x2042b3(0x1ea)&&typeof Reflect[_0x2042b3(0x1f1)]===_0x2042b3(0x1ad))_0x44027b=Reflect[_0x2042b3(0x1f1)](_0x149533,_0x52b1ce,_0xc27f54,_0x160f63);else{for(var _0x1f9460=_0x149533['length']-0x1;_0x1f9460>=0x0;_0x1f9460--)if(_0xf84050=_0x149533[_0x1f9460])_0x44027b=(_0x40a1bb<0x3?_0xf84050(_0x44027b):_0x40a1bb>0x3?_0xf84050(_0x52b1ce,_0xc27f54,_0x44027b):_0xf84050(_0x52b1ce,_0xc27f54))||_0x44027b;}return _0x40a1bb>0x3&&_0x44027b&&Object[_0x2042b3(0x1a8)](_0x52b1ce,_0xc27f54,_0x44027b),_0x44027b;},__metadata=this&&this[a136_0x5d6432(0x19e)]||function(_0x34469f,_0x298635){const _0x1d951b=a136_0x5d6432;if(typeof Reflect===_0x1d951b(0x1ea)&&typeof Reflect[_0x1d951b(0x1d5)]==='function')return Reflect[_0x1d951b(0x1d5)](_0x34469f,_0x298635);},__param=this&&this[a136_0x5d6432(0x1c9)]||function(_0x5bebe8,_0x2cd6b4){return function(_0xda909c,_0x173ee7){_0x2cd6b4(_0xda909c,_0x173ee7,_0x5bebe8);};},SoundService_1;Object[a136_0x5d6432(0x1a8)](exports,a136_0x5d6432(0x1ac),{'value':!![]}),exports['SoundService']=void 0x0;function a136_0x5ebf(_0x267a29,_0x4916bc){const _0x4fdde5=a136_0x4fdd();return a136_0x5ebf=function(_0x5ebfce,_0x1921fa){_0x5ebfce=_0x5ebfce-0x182;let _0x1fb5d1=_0x4fdde5[_0x5ebfce];return _0x1fb5d1;},a136_0x5ebf(_0x267a29,_0x4916bc);}const common_1=require('@nestjs/common'),mongoose_1=require(a136_0x5d6432(0x1d2)),mongoose_2=require(a136_0x5d6432(0x1a3)),path=require(a136_0x5d6432(0x18b)),event_emitter_1=require('@nestjs/event-emitter'),file_1=require('../common/file'),agenda_service_1=require(a136_0x5d6432(0x1e8)),enums_1=require('../common/enums'),constants_1=require(a136_0x5d6432(0x1ee)),utils_1=require(a136_0x5d6432(0x1ab)),path_1=require(a136_0x5d6432(0x19d)),audio_player_1=require(a136_0x5d6432(0x1b2)),sound_1=require('../common/events/sound'),job_1=require('../common/job'),constants_2=require(a136_0x5d6432(0x186)),default_sounds_1=require(a136_0x5d6432(0x1fe)),sound_gateway_1=require(a136_0x5d6432(0x1b6)),path_2=require('path'),upload_service_1=require('../upload/upload.service'),text_to_audio_service_1=require('../text-to-audio/text-to-audio.service'),streaming_service_1=require(a136_0x5d6432(0x18e));let SoundService=SoundService_1=class SoundService{constructor(_0x57f6e,_0x2c9168,_0xa0acd1,_0x6ad019,_0x2adcae,_0xe631e8){const _0x934223=a136_0x5d6432;this[_0x934223(0x1b8)]=_0x57f6e,this[_0x934223(0x1be)]=_0x2c9168,this[_0x934223(0x185)]=_0xa0acd1,this[_0x934223(0x1aa)]=_0x6ad019,this['streamingService']=_0x2adcae,this[_0x934223(0x1ff)]=_0xe631e8,this[_0x934223(0x195)]=new common_1[(_0x934223(0x1db))](SoundService_1[_0x934223(0x1c2)]);}async['create'](_0x508665){const _0x1a8d26=a136_0x5d6432;await this[_0x1a8d26(0x1df)](_0x508665,null);const _0x5df8d3=new this['soundModel'](_0x508665);return _0x5df8d3[_0x1a8d26(0x1de)]();}async[a136_0x5d6432(0x1b9)](_0x3f5eff){const _0x17f851=a136_0x5d6432,_0x5a2c0d=await this[_0x17f851(0x1b8)]['find']({'type':_0x3f5eff})[_0x17f851(0x1f9)]();return _0x5a2c0d;}async[a136_0x5d6432(0x1c8)](_0x5c8a34){const _0xb9932e=a136_0x5d6432,_0x3edd7d=await this['soundModel'][_0xb9932e(0x18c)](_0x5c8a34);return _0x3edd7d;}async[a136_0x5d6432(0x198)](_0xfb3e38){const _0x534a01=a136_0x5d6432,_0x29bf1a=await this['soundModel'][_0x534a01(0x1e2)]({'_id':{'$in':_0xfb3e38}});return _0x29bf1a;}async[a136_0x5d6432(0x1bc)](_0x367405,_0x2a4768){const _0x3b36fd=a136_0x5d6432,_0x1a3f55=await this[_0x3b36fd(0x1b8)][_0x3b36fd(0x18c)](_0x367405)[_0x3b36fd(0x1f9)]();if(!_0x1a3f55)throw new Error(_0x3b36fd(0x1fa));await this['validateAndMoveFileAsync'](_0x2a4768,_0x1a3f55===null||_0x1a3f55===void 0x0?void 0x0:_0x1a3f55[_0x3b36fd(0x1f8)]);const _0x35f5f0=await this[_0x3b36fd(0x1b8)][_0x3b36fd(0x1a7)](_0x367405,Object[_0x3b36fd(0x184)](Object[_0x3b36fd(0x184)]({},_0x2a4768),{'updatedAtUtc':new Date()}),{'new':!![]});return _0x35f5f0;}async[a136_0x5d6432(0x1b4)](_0x1f67f6,_0x473211){const _0x3f879b=a136_0x5d6432,_0x4e7976=await this['soundModel']['findById'](_0x1f67f6)['exec']();if(!_0x4e7976)throw new Error(_0x3f879b(0x1fa));const _0x27e7ab=await this[_0x3f879b(0x1b8)]['findByIdAndUpdate'](_0x1f67f6,Object[_0x3f879b(0x184)](Object[_0x3f879b(0x184)]({},_0x473211),{'updatedAtUtc':new Date()}),{'new':!![]});return _0x27e7ab;}async[a136_0x5d6432(0x1ae)](_0x567972){const _0x2ec0aa=a136_0x5d6432,_0x275d28=await this['soundModel'][_0x2ec0aa(0x197)](_0x567972);if(_0x275d28[_0x2ec0aa(0x1f8)]){const _0x48688f=constants_1[_0x2ec0aa(0x1cd)]+'/'+_0x275d28[_0x2ec0aa(0x1f8)];try{(0x0,file_1['deleteFile'])(_0x48688f);}catch(_0x1a4091){this['logger'][_0x2ec0aa(0x1c0)](_0x1a4091);}}return _0x275d28;}async[a136_0x5d6432(0x1cb)](_0x170a07,_0x2af11d){const _0x577188=a136_0x5d6432,_0x1b9d08=await this[_0x577188(0x1b8)][_0x577188(0x18c)](_0x170a07)['exec'](),_0x398711=_0x1b9d08===null||_0x1b9d08===void 0x0?void 0x0:_0x1b9d08[_0x577188(0x1f8)],_0x1557be=this[_0x577188(0x1dd)](_0x2af11d[_0x577188(0x1a9)]),_0x503e4b=constants_1['AUDIO_DIR']+'/'+_0x1557be;await(0x0,file_1[_0x577188(0x1ca)])(_0x2af11d[_0x577188(0x18b)],_0x503e4b);const _0x1859db={'fileName':_0x1557be},_0x305a8c=await this[_0x577188(0x1b8)]['findByIdAndUpdate'](_0x170a07,Object['assign'](Object[_0x577188(0x184)]({},_0x1859db),{'updatedAtUtc':new Date()}),{'new':!![]});if(_0x398711){const _0x358d8d=constants_1[_0x577188(0x1cd)]+'/'+_0x398711;(0x0,file_1[_0x577188(0x192)])(_0x358d8d);}return _0x305a8c;}async[a136_0x5d6432(0x1c1)](_0x31af99){const _0x42fa0e=a136_0x5d6432,{soundId:_0x2f1ff1,jobId:_0x17e2ae,durationInSecond:_0x562d2a}=_0x31af99,_0x1d2518=await this[_0x42fa0e(0x1c8)](_0x2f1ff1),_0x254c26=path[_0x42fa0e(0x19b)](path_1[_0x42fa0e(0x1d9)],_0x42fa0e(0x19a),_0x42fa0e(0x189),_0x1d2518[_0x42fa0e(0x1f8)]);if(!(0x0,file_1['isFileExist'])(_0x254c26)){this[_0x42fa0e(0x195)][_0x42fa0e(0x1c0)](_0x42fa0e(0x18f)+_0x254c26);return;}job_1['PROCESS_CACHE'][_0x42fa0e(0x1bf)](),this[_0x42fa0e(0x195)][_0x42fa0e(0x1cf)](_0x42fa0e(0x1bb)+_0x2f1ff1+'\x20-\x20'+_0x1d2518[_0x42fa0e(0x1c2)]),(0x0,job_1[_0x42fa0e(0x187)])({'jobId':_0x17e2ae,'run':()=>audio_player_1[_0x42fa0e(0x1b0)][_0x42fa0e(0x1b3)](_0x254c26,_0x1d2518['volume']),'next':()=>this[_0x42fa0e(0x1d1)](_0x2f1ff1),'durationInSecond':_0x562d2a}),this[_0x42fa0e(0x1ff)][_0x42fa0e(0x1ec)]({'id':_0x2f1ff1,'isPlaying':!![]});}async[a136_0x5d6432(0x196)](_0x4d909d){const _0x5a18be=a136_0x5d6432,{voiceId:_0x36b168,jobId:_0x409b97,durationInSecond:_0x347103}=_0x4d909d,_0x1aacaa=await this[_0x5a18be(0x185)][_0x5a18be(0x1d7)](_0x36b168),_0x2011e4=_0x1aacaa[_0x5a18be(0x1b5)],_0x448cb5=(0x0,path_2['join'])(process[_0x5a18be(0x1c7)](),_0x2011e4);if(!(0x0,file_1[_0x5a18be(0x193)])(_0x448cb5)){this[_0x5a18be(0x195)][_0x5a18be(0x1c0)](_0x5a18be(0x19c)+_0x448cb5);return;}job_1[_0x5a18be(0x1af)][_0x5a18be(0x1bf)](),this[_0x5a18be(0x195)]['log'](_0x5a18be(0x1a5)+_0x36b168),(0x0,job_1['executeJob'])({'jobId':_0x409b97,'run':()=>audio_player_1[_0x5a18be(0x1b0)][_0x5a18be(0x1b3)](_0x448cb5),'durationInSecond':_0x347103,'next':()=>null});}async['playTextToAudioRecorded'](_0x25ed56){const _0x14e100=a136_0x5d6432,{textToAudioId:_0x3eb66d,jobId:_0xc55d6a,durationInSecond:_0x23a5b6}=_0x25ed56,{message:_0x495b16}=await this[_0x14e100(0x1aa)]['getMessageById'](_0x3eb66d);job_1[_0x14e100(0x1af)][_0x14e100(0x1bf)](),(0x0,job_1['executeJob'])({'jobId':_0xc55d6a,'run':()=>{const _0x46874a=_0x14e100;let _0x1641e1=null;return this[_0x46874a(0x1aa)][_0x46874a(0x183)](_0x495b16,_0x5e016=>{const _0x46c962=_0x46874a;_0x1641e1=this[_0x46c962(0x1c3)][_0x46c962(0x191)](_0x5e016);}),_0x1641e1;},'durationInSecond':_0x23a5b6,'next':()=>null});}async[a136_0x5d6432(0x1fb)](_0x205a14,_0x5ec934,_0x286d5a=![]){const _0x5e7564=a136_0x5d6432,_0x217d67={'when':_0x5e7564(0x1cc),'jobType':enums_1['JobType'][_0x5e7564(0x1a4)],'attributes':{'soundId':_0x5ec934,'durationInSecond':_0x286d5a?0x15180:undefined},'audit':{'actor':_0x205a14,'name':enums_1[_0x5e7564(0x1f6)][_0x5e7564(0x1a4)],'message':'Play\x20sound:\x20'+_0x5ec934}},_0x20e423=await this[_0x5e7564(0x1b8)][_0x5e7564(0x1c8)]({'jobId':{'$ne':null}});_0x20e423&&await this[_0x5e7564(0x1d1)](_0x20e423['id']);const {jobId:_0x189b27}=await this[_0x5e7564(0x1be)][_0x5e7564(0x1d4)](_0x217d67);return this[_0x5e7564(0x1bc)](_0x5ec934,{'jobId':_0x189b27});}async[a136_0x5d6432(0x1d1)](_0x57f0df){const _0x4ca3e6=a136_0x5d6432;let _0x40ac8e=await this[_0x4ca3e6(0x1c8)](_0x57f0df);const {jobId:_0x3c5970}=_0x40ac8e||{};if(_0x3c5970){const {success:_0x25db14}=await this[_0x4ca3e6(0x1be)][_0x4ca3e6(0x1e4)](_0x3c5970);_0x25db14&&(_0x40ac8e=await this['update'](_0x57f0df,{'jobId':null}));}return this[_0x4ca3e6(0x1ff)][_0x4ca3e6(0x1ec)]({'id':_0x40ac8e['id'],'isPlaying':![]}),_0x40ac8e;}async[a136_0x5d6432(0x1f5)](){const _0x95a32b=a136_0x5d6432,_0x117a9e=await this[_0x95a32b(0x1b9)](constants_2['SoundType']['Tune']);if(_0x117a9e['length']>0x0){const _0x1dcee9=[];_0x117a9e[_0x95a32b(0x1a2)](_0x44113e=>{const _0x237e35=_0x95a32b;_0x1dcee9[_0x237e35(0x18d)](this[_0x237e35(0x1ae)](_0x44113e[_0x237e35(0x1a6)]));}),await Promise['all'](_0x1dcee9);}await(0x0,file_1['copyFiles'])(constants_1[_0x95a32b(0x1f7)],constants_1[_0x95a32b(0x194)]);const _0x1b71d2=[];return default_sounds_1[_0x95a32b(0x1d3)]['forEach'](_0x418091=>{const _0x2a9d84=_0x95a32b;_0x1b71d2[_0x2a9d84(0x18d)](this[_0x2a9d84(0x1e0)](Object[_0x2a9d84(0x184)]({},_0x418091)));}),await Promise[_0x95a32b(0x1c6)](_0x1b71d2),!![];}[a136_0x5d6432(0x1dd)](_0x5ccd6b){const _0x16cda2=a136_0x5d6432,_0x3bd96b=_0x5ccd6b[_0x16cda2(0x1dc)]('.')[_0x16cda2(0x1fc)]();return(0x0,utils_1[_0x16cda2(0x199)])()+'.'+_0x3bd96b;}async['validateAndMoveFileAsync'](_0x2cbaf7,_0xcc066c){const _0x40c79a=a136_0x5d6432;if(!_0x2cbaf7[_0x40c79a(0x1f8)])return;const _0x37d00f=constants_1['TMP_UPLOAD_DIR']+'/'+_0x2cbaf7[_0x40c79a(0x1f8)],_0x1504d7=_0xcc066c||this[_0x40c79a(0x1dd)](_0x2cbaf7[_0x40c79a(0x1f8)]),_0x415ac9=constants_1[_0x40c79a(0x1cd)]+'/'+_0x1504d7;if(!(0x0,file_1['isFileExist'])(_0x37d00f))throw new Error(_0x40c79a(0x1d8));!(0x0,file_1[_0x40c79a(0x193)])(constants_1[_0x40c79a(0x1cd)])&&(0x0,file_1[_0x40c79a(0x1e5)])(constants_1['AUDIO_DIR']),await(0x0,file_1[_0x40c79a(0x1ca)])(_0x37d00f,_0x415ac9),_0x2cbaf7[_0x40c79a(0x1f8)]=_0x1504d7;}};__decorate([(0x0,event_emitter_1[a136_0x5d6432(0x19f)])(sound_1[a136_0x5d6432(0x1d6)][a136_0x5d6432(0x1e9)]),__metadata(a136_0x5d6432(0x18a),Function),__metadata(a136_0x5d6432(0x1da),[Object]),__metadata('design:returntype',Promise)],SoundService['prototype'],'playSoundOnEvent',null),__decorate([(0x0,event_emitter_1[a136_0x5d6432(0x19f)])(sound_1[a136_0x5d6432(0x1d6)][a136_0x5d6432(0x1a1)]),__metadata('design:type',Function),__metadata(a136_0x5d6432(0x1da),[Object]),__metadata(a136_0x5d6432(0x1c5),Promise)],SoundService[a136_0x5d6432(0x1f3)],'playVoiceRecorded',null),__decorate([(0x0,event_emitter_1[a136_0x5d6432(0x19f)])(sound_1[a136_0x5d6432(0x1d6)][a136_0x5d6432(0x1d0)]),__metadata(a136_0x5d6432(0x18a),Function),__metadata('design:paramtypes',[Object]),__metadata(a136_0x5d6432(0x1c5),Promise)],SoundService[a136_0x5d6432(0x1f3)],a136_0x5d6432(0x1a0),null),SoundService=SoundService_1=__decorate([(0x0,common_1[a136_0x5d6432(0x1ce)])(),__param(0x0,(0x0,mongoose_1['InjectModel'])(a136_0x5d6432(0x1b7))),__param(0x5,(0x0,common_1[a136_0x5d6432(0x190)])(sound_gateway_1[a136_0x5d6432(0x1ba)])),__metadata('design:paramtypes',[mongoose_2[a136_0x5d6432(0x1e7)],agenda_service_1['AgendaService'],upload_service_1[a136_0x5d6432(0x1e6)],text_to_audio_service_1[a136_0x5d6432(0x1b1)],streaming_service_1['StreamingService'],sound_gateway_1['SoundGateway']])],SoundService),exports['SoundService']=SoundService;