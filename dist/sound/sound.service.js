'use strict';const a133_0x3da51f=a133_0x193f;function a133_0x20ad(){const _0x21e152=['TMP_UPLOAD_DIR','findByIdAndUpdate','playStreamAudioAsync','../common/path','metadata','@nestjs/common','design:type','9YimXSC','Sound\x20not\x20found!','delete','processRootPath','TextToAudioService','JobType','filePath','streamingService','AUDIO_DIR','Injectable','../common/constants','PROCESS_CACHE','design:paramtypes','getOwnPropertyDescriptor','793583EKYFvH','assign','function','save','Play\x20sound:\x20','executeJob','join','broadcastPlaying','UploadService','AgendaService','20scEiOn','exec','killAll','object','now','StreamingService','692180AWblIh','__esModule','3QtKJxi','DEFAULT_TUNES_DIR','create','AudioPlayer','PlaySound','volume','uploadService','cancelJob','design:returntype','1xipYJw','upload','8245292LcraKI','decorate','SoundService','uuid','push','playVoiceRecorded','deleteFile','582786yVukUP','Play','@nestjs/mongoose','validateAndMoveFileAsync','playSoundOnEvent','../common/audio/audio-player','__metadata','findByIds','SoundEvent','2216336RQCVlu','cwd','../text-to-audio/text-to-audio.service','all','findOne','208414YStNYF','prototype','SoundGateway','isFileExist','../upload/upload.service','name','\x20-\x20','getNewFileName','findVoiceRecoredById','Playing\x20sound:\x20','../common/file','agendaService','Tune','DEFAULT_TUNES','../common/utils','textToAudio','findById','copyFiles','path','originalname','TextToAudio','fileName','play','length','update','audio','getMessageById','resetTunes','textToAudioService','split','mongoose','playTextToAudioRecorded','Sound','File\x20not\x20found!','OnEvent','soundModel','scheduleJob','soundGateway','../common/events/sound','@nestjs/event-emitter','logger','playAsync','stop','defineProperty','find','moveFile','Playing\x20voice\x20recorded:\x20','2131910emoSCC','Logger','forEach','__decorate'];a133_0x20ad=function(){return _0x21e152;};return a133_0x20ad();}(function(_0x3698ac,_0x4d8950){const _0x5eaf76=a133_0x193f,_0x5ddd05=_0x3698ac();while(!![]){try{const _0x4576b1=-parseInt(_0x5eaf76(0x19b))/0x1*(parseInt(_0x5eaf76(0x1b2))/0x2)+parseInt(_0x5eaf76(0x192))/0x3*(-parseInt(_0x5eaf76(0x190))/0x4)+parseInt(_0x5eaf76(0x204))/0x5*(parseInt(_0x5eaf76(0x1a4))/0x6)+-parseInt(_0x5eaf76(0x1fa))/0x7+-parseInt(_0x5eaf76(0x1ad))/0x8+-parseInt(_0x5eaf76(0x1ec))/0x9*(parseInt(_0x5eaf76(0x1e1))/0xa)+parseInt(_0x5eaf76(0x19d))/0xb;if(_0x4576b1===_0x4d8950)break;else _0x5ddd05['push'](_0x5ddd05['shift']());}catch(_0x3d3614){_0x5ddd05['push'](_0x5ddd05['shift']());}}}(a133_0x20ad,0x3ecda));var __decorate=this&&this[a133_0x3da51f(0x1e4)]||function(_0x45e6de,_0x19e1fa,_0x366c3e,_0x277d09){const _0x33f0e0=a133_0x3da51f;var _0x1f352a=arguments[_0x33f0e0(0x1c9)],_0x2518a2=_0x1f352a<0x3?_0x19e1fa:_0x277d09===null?_0x277d09=Object[_0x33f0e0(0x1f9)](_0x19e1fa,_0x366c3e):_0x277d09,_0x55a897;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x33f0e0(0x1fc))_0x2518a2=Reflect[_0x33f0e0(0x19e)](_0x45e6de,_0x19e1fa,_0x366c3e,_0x277d09);else{for(var _0x4a4541=_0x45e6de['length']-0x1;_0x4a4541>=0x0;_0x4a4541--)if(_0x55a897=_0x45e6de[_0x4a4541])_0x2518a2=(_0x1f352a<0x3?_0x55a897(_0x2518a2):_0x1f352a>0x3?_0x55a897(_0x19e1fa,_0x366c3e,_0x2518a2):_0x55a897(_0x19e1fa,_0x366c3e))||_0x2518a2;}return _0x1f352a>0x3&&_0x2518a2&&Object[_0x33f0e0(0x1dd)](_0x19e1fa,_0x366c3e,_0x2518a2),_0x2518a2;},__metadata=this&&this[a133_0x3da51f(0x1aa)]||function(_0x3cf211,_0x4f99e7){const _0x208312=a133_0x3da51f;if(typeof Reflect===_0x208312(0x18d)&&typeof Reflect[_0x208312(0x1e9)]===_0x208312(0x1fc))return Reflect[_0x208312(0x1e9)](_0x3cf211,_0x4f99e7);},__param=this&&this['__param']||function(_0xe5685a,_0x5948b6){return function(_0x136462,_0x159e6d){_0x5948b6(_0x136462,_0x159e6d,_0xe5685a);};},SoundService_1;Object[a133_0x3da51f(0x1dd)](exports,a133_0x3da51f(0x191),{'value':!![]}),exports[a133_0x3da51f(0x19f)]=void 0x0;const common_1=require(a133_0x3da51f(0x1ea)),mongoose_1=require(a133_0x3da51f(0x1a6)),mongoose_2=require(a133_0x3da51f(0x1d0)),path=require(a133_0x3da51f(0x1c4)),event_emitter_1=require(a133_0x3da51f(0x1d9)),file_1=require(a133_0x3da51f(0x1bc)),agenda_service_1=require('../agenda/agenda.service'),enums_1=require('../common/enums'),constants_1=require(a133_0x3da51f(0x1f6)),utils_1=require(a133_0x3da51f(0x1c0)),path_1=require(a133_0x3da51f(0x1e8)),audio_player_1=require(a133_0x3da51f(0x1a9)),sound_1=require(a133_0x3da51f(0x1d8)),job_1=require('../common/job'),constants_2=require('./constants'),default_sounds_1=require('./data/default-sounds'),sound_gateway_1=require('./sound.gateway'),path_2=require('path'),upload_service_1=require(a133_0x3da51f(0x1b6)),text_to_audio_service_1=require(a133_0x3da51f(0x1af)),streaming_service_1=require('../streaming/streaming.service');function a133_0x193f(_0xc216fc,_0x42c973){const _0x20ad19=a133_0x20ad();return a133_0x193f=function(_0x193f94,_0x2a31e2){_0x193f94=_0x193f94-0x18d;let _0x3fe525=_0x20ad19[_0x193f94];return _0x3fe525;},a133_0x193f(_0xc216fc,_0x42c973);}let SoundService=SoundService_1=class SoundService{constructor(_0x101397,_0x4c19a5,_0xd39082,_0x26ef70,_0x1b1336,_0x41a65b){const _0x448eca=a133_0x3da51f;this[_0x448eca(0x1d5)]=_0x101397,this['agendaService']=_0x4c19a5,this[_0x448eca(0x198)]=_0xd39082,this[_0x448eca(0x1ce)]=_0x26ef70,this[_0x448eca(0x1f3)]=_0x1b1336,this['soundGateway']=_0x41a65b,this[_0x448eca(0x1da)]=new common_1[(_0x448eca(0x1e2))](SoundService_1[_0x448eca(0x1b7)]);}async['create'](_0x326c8f){const _0x486b8b=a133_0x3da51f;await this['validateAndMoveFileAsync'](_0x326c8f,null);const _0x14108d=new this[(_0x486b8b(0x1d5))](_0x326c8f);return _0x14108d[_0x486b8b(0x1fd)]();}async['findByType'](_0x40cf0c){const _0x16e716=a133_0x3da51f,_0x13adb8=await this[_0x16e716(0x1d5)][_0x16e716(0x1de)]({'type':_0x40cf0c})[_0x16e716(0x205)]();return _0x13adb8;}async[a133_0x3da51f(0x1b1)](_0x6ff1c7){const _0x1271ad=a133_0x3da51f,_0x282f13=await this[_0x1271ad(0x1d5)]['findById'](_0x6ff1c7);return _0x282f13;}async[a133_0x3da51f(0x1ab)](_0xaddacc){const _0x4c2659=a133_0x3da51f,_0x1ce72b=await this[_0x4c2659(0x1d5)][_0x4c2659(0x1de)]({'_id':{'$in':_0xaddacc}});return _0x1ce72b;}async['update'](_0x214d5a,_0x1260b6){const _0x330ee8=a133_0x3da51f,_0x225d7e=await this[_0x330ee8(0x1d5)][_0x330ee8(0x1c2)](_0x214d5a)['exec']();if(!_0x225d7e)throw new Error('Sound\x20not\x20found!');await this[_0x330ee8(0x1a7)](_0x1260b6,_0x225d7e===null||_0x225d7e===void 0x0?void 0x0:_0x225d7e[_0x330ee8(0x1c7)]);const _0x151e9d=await this['soundModel'][_0x330ee8(0x1e6)](_0x214d5a,Object[_0x330ee8(0x1fb)](Object[_0x330ee8(0x1fb)]({},_0x1260b6),{'updatedAtUtc':new Date()}),{'new':!![]});return _0x151e9d;}async['updateVolume'](_0x3c4bea,_0x56c911){const _0xa5f0c3=a133_0x3da51f,_0xddd25=await this[_0xa5f0c3(0x1d5)]['findById'](_0x3c4bea)[_0xa5f0c3(0x205)]();if(!_0xddd25)throw new Error(_0xa5f0c3(0x1ed));const _0x1c386d=await this[_0xa5f0c3(0x1d5)][_0xa5f0c3(0x1e6)](_0x3c4bea,Object['assign'](Object[_0xa5f0c3(0x1fb)]({},_0x56c911),{'updatedAtUtc':new Date()}),{'new':!![]});return _0x1c386d;}async[a133_0x3da51f(0x1ee)](_0x2272ef){const _0x59e554=a133_0x3da51f,_0x852c1c=await this[_0x59e554(0x1d5)]['findByIdAndDelete'](_0x2272ef);if(_0x852c1c['fileName']){const _0x350880=constants_1[_0x59e554(0x1f4)]+'/'+_0x852c1c['fileName'];try{(0x0,file_1['deleteFile'])(_0x350880);}catch(_0x3f9a36){this[_0x59e554(0x1da)]['error'](_0x3f9a36);}}return _0x852c1c;}async[a133_0x3da51f(0x19c)](_0x7ffea1,_0x12e2b2){const _0xfdc4f8=a133_0x3da51f,_0x1b3031=await this[_0xfdc4f8(0x1d5)][_0xfdc4f8(0x1c2)](_0x7ffea1)['exec'](),_0x383a40=_0x1b3031===null||_0x1b3031===void 0x0?void 0x0:_0x1b3031[_0xfdc4f8(0x1c7)],_0x285c16=this['getNewFileName'](_0x12e2b2[_0xfdc4f8(0x1c5)]),_0xb3833f=constants_1[_0xfdc4f8(0x1f4)]+'/'+_0x285c16;await(0x0,file_1[_0xfdc4f8(0x1df)])(_0x12e2b2['path'],_0xb3833f);const _0xc4f311={'fileName':_0x285c16},_0x1c55c7=await this[_0xfdc4f8(0x1d5)][_0xfdc4f8(0x1e6)](_0x7ffea1,Object['assign'](Object[_0xfdc4f8(0x1fb)]({},_0xc4f311),{'updatedAtUtc':new Date()}),{'new':!![]});if(_0x383a40){const _0x26155b=constants_1[_0xfdc4f8(0x1f4)]+'/'+_0x383a40;(0x0,file_1[_0xfdc4f8(0x1a3)])(_0x26155b);}return _0x1c55c7;}async[a133_0x3da51f(0x1a8)](_0x6f62f4){const _0x5b3015=a133_0x3da51f,{soundId:_0x4c9814,jobId:_0x432ac1,durationInSecond:_0xf337c6}=_0x6f62f4,_0x40948f=await this[_0x5b3015(0x1b1)](_0x4c9814),_0x11b137=path[_0x5b3015(0x200)](path_1[_0x5b3015(0x1ef)],'assets',_0x5b3015(0x1cb),_0x40948f[_0x5b3015(0x1c7)]);job_1[_0x5b3015(0x1f7)]['killAll'](),this['logger']['log'](_0x5b3015(0x1bb)+_0x4c9814+_0x5b3015(0x1b8)+_0x40948f[_0x5b3015(0x1b7)]),(0x0,job_1[_0x5b3015(0x1ff)])({'jobId':_0x432ac1,'run':()=>audio_player_1[_0x5b3015(0x195)][_0x5b3015(0x1db)](_0x11b137,_0x40948f[_0x5b3015(0x197)]),'next':()=>this[_0x5b3015(0x1dc)](_0x4c9814),'durationInSecond':_0xf337c6}),this[_0x5b3015(0x1d7)][_0x5b3015(0x201)]({'id':_0x4c9814,'isPlaying':!![]});}async['playVoiceRecorded'](_0x1b17d0){const _0x4d69ab=a133_0x3da51f,{voiceId:_0x2ee732,jobId:_0x1d3b29,durationInSecond:_0x4c42fa}=_0x1b17d0,_0x10b8e9=await this['uploadService'][_0x4d69ab(0x1ba)](_0x2ee732),_0x498d49=_0x10b8e9[_0x4d69ab(0x1f2)],_0x613ab0=(0x0,path_2[_0x4d69ab(0x200)])(process[_0x4d69ab(0x1ae)](),_0x498d49);job_1[_0x4d69ab(0x1f7)][_0x4d69ab(0x206)](),this[_0x4d69ab(0x1da)]['log'](_0x4d69ab(0x1e0)+_0x2ee732),(0x0,job_1[_0x4d69ab(0x1ff)])({'jobId':_0x1d3b29,'run':()=>audio_player_1['AudioPlayer'][_0x4d69ab(0x1db)](_0x613ab0),'durationInSecond':_0x4c42fa,'next':()=>null});}async[a133_0x3da51f(0x1d1)](_0xaa34bb){const _0x5af868=a133_0x3da51f,{textToAudioId:_0x1b0bb5,jobId:_0x301ae4,durationInSecond:_0x1db43e}=_0xaa34bb,{message:_0x355ec9}=await this[_0x5af868(0x1ce)][_0x5af868(0x1cc)](_0x1b0bb5);job_1[_0x5af868(0x1f7)][_0x5af868(0x206)](),(0x0,job_1[_0x5af868(0x1ff)])({'jobId':_0x301ae4,'run':()=>{const _0x32b1ee=_0x5af868;let _0x332d51=null;return this['textToAudioService'][_0x32b1ee(0x1c1)](_0x355ec9,_0x127c84=>{const _0x4adba7=_0x32b1ee;_0x332d51=this['streamingService'][_0x4adba7(0x1e7)](_0x127c84);}),_0x332d51;},'durationInSecond':_0x1db43e,'next':()=>null});}async[a133_0x3da51f(0x1c8)](_0x5ef21d,_0x4638e6,_0x420ceb=![]){const _0xb4b0e4=a133_0x3da51f,_0x5e1a3f={'when':_0xb4b0e4(0x18e),'jobType':enums_1[_0xb4b0e4(0x1f1)][_0xb4b0e4(0x196)],'attributes':{'soundId':_0x4638e6,'durationInSecond':_0x420ceb?0x15180:undefined},'audit':{'actor':_0x5ef21d,'name':enums_1[_0xb4b0e4(0x1f1)][_0xb4b0e4(0x196)],'message':_0xb4b0e4(0x1fe)+_0x4638e6}},_0x1bad7f=await this[_0xb4b0e4(0x1d5)]['findOne']({'jobId':{'$ne':null}});_0x1bad7f&&await this[_0xb4b0e4(0x1dc)](_0x1bad7f['id']);const {jobId:_0x2a89a2}=await this[_0xb4b0e4(0x1bd)][_0xb4b0e4(0x1d6)](_0x5e1a3f);return this[_0xb4b0e4(0x1ca)](_0x4638e6,{'jobId':_0x2a89a2});}async[a133_0x3da51f(0x1dc)](_0xf5317c){const _0xd2bcaf=a133_0x3da51f;let _0x40eb19=await this[_0xd2bcaf(0x1b1)](_0xf5317c);const {jobId:_0x3948dd}=_0x40eb19||{};if(_0x3948dd){const {success:_0x152681}=await this['agendaService'][_0xd2bcaf(0x199)](_0x3948dd);_0x152681&&(_0x40eb19=await this['update'](_0xf5317c,{'jobId':null}));}return this[_0xd2bcaf(0x1d7)][_0xd2bcaf(0x201)]({'id':_0x40eb19['id'],'isPlaying':![]}),_0x40eb19;}async[a133_0x3da51f(0x1cd)](){const _0xcfddf7=a133_0x3da51f,_0x23cbfe=await this['findByType'](constants_2['SoundType'][_0xcfddf7(0x1be)]);if(_0x23cbfe['length']>0x0){const _0x3c5702=[];_0x23cbfe['forEach'](_0x57fbd1=>{const _0x556820=_0xcfddf7;_0x3c5702[_0x556820(0x1a1)](this[_0x556820(0x1ee)](_0x57fbd1['_id']));}),await Promise['all'](_0x3c5702);}await(0x0,file_1[_0xcfddf7(0x1c3)])(constants_1[_0xcfddf7(0x193)],constants_1[_0xcfddf7(0x1e5)]);const _0x1a08b8=[];return default_sounds_1[_0xcfddf7(0x1bf)][_0xcfddf7(0x1e3)](_0x87fb59=>{const _0x2d114b=_0xcfddf7;_0x1a08b8['push'](this[_0x2d114b(0x194)](Object['assign']({},_0x87fb59)));}),await Promise[_0xcfddf7(0x1b0)](_0x1a08b8),!![];}['getNewFileName'](_0x11afa5){const _0x3cf604=a133_0x3da51f,_0x48f34e=_0x11afa5[_0x3cf604(0x1cf)]('.')['pop']();return(0x0,utils_1[_0x3cf604(0x1a0)])()+'.'+_0x48f34e;}async[a133_0x3da51f(0x1a7)](_0x3e698b,_0x52f414){const _0x330784=a133_0x3da51f;if(!_0x3e698b[_0x330784(0x1c7)])return;const _0x255183=constants_1['TMP_UPLOAD_DIR']+'/'+_0x3e698b[_0x330784(0x1c7)],_0x253319=_0x52f414||this[_0x330784(0x1b9)](_0x3e698b['fileName']),_0x2117bb=constants_1[_0x330784(0x1f4)]+'/'+_0x253319;if(!(0x0,file_1[_0x330784(0x1b5)])(_0x255183))throw new Error(_0x330784(0x1d3));!(0x0,file_1[_0x330784(0x1b5)])(constants_1[_0x330784(0x1f4)])&&(0x0,file_1['createFolder'])(constants_1[_0x330784(0x1f4)]),await(0x0,file_1[_0x330784(0x1df)])(_0x255183,_0x2117bb),_0x3e698b[_0x330784(0x1c7)]=_0x253319;}};__decorate([(0x0,event_emitter_1['OnEvent'])(sound_1[a133_0x3da51f(0x1ac)][a133_0x3da51f(0x1a5)]),__metadata(a133_0x3da51f(0x1eb),Function),__metadata(a133_0x3da51f(0x1f8),[Object]),__metadata(a133_0x3da51f(0x19a),Promise)],SoundService[a133_0x3da51f(0x1b3)],a133_0x3da51f(0x1a8),null),__decorate([(0x0,event_emitter_1[a133_0x3da51f(0x1d4)])(sound_1[a133_0x3da51f(0x1ac)]['VoiceRecorded']),__metadata(a133_0x3da51f(0x1eb),Function),__metadata(a133_0x3da51f(0x1f8),[Object]),__metadata(a133_0x3da51f(0x19a),Promise)],SoundService[a133_0x3da51f(0x1b3)],a133_0x3da51f(0x1a2),null),__decorate([(0x0,event_emitter_1['OnEvent'])(sound_1[a133_0x3da51f(0x1ac)][a133_0x3da51f(0x1c6)]),__metadata(a133_0x3da51f(0x1eb),Function),__metadata(a133_0x3da51f(0x1f8),[Object]),__metadata('design:returntype',Promise)],SoundService['prototype'],a133_0x3da51f(0x1d1),null),SoundService=SoundService_1=__decorate([(0x0,common_1[a133_0x3da51f(0x1f5)])(),__param(0x0,(0x0,mongoose_1['InjectModel'])(a133_0x3da51f(0x1d2))),__param(0x5,(0x0,common_1['Inject'])(sound_gateway_1[a133_0x3da51f(0x1b4)])),__metadata(a133_0x3da51f(0x1f8),[mongoose_2['Model'],agenda_service_1[a133_0x3da51f(0x203)],upload_service_1[a133_0x3da51f(0x202)],text_to_audio_service_1[a133_0x3da51f(0x1f0)],streaming_service_1[a133_0x3da51f(0x18f)],sound_gateway_1[a133_0x3da51f(0x1b4)]])],SoundService),exports['SoundService']=SoundService;