'use strict';function a136_0x4121(){const _0x252f71=['2302895ijpCkr','updateVolume','processRootPath','originalname','design:paramtypes','Model','../common/utils','audio','2745505JtQGYt','defineProperty','streamingService','error','create','all','481046BnSmyQ','../common/audio/audio-player','SoundGateway','6743384SkNSSW','1096053qhDZHa','save','logger','TMP_UPLOAD_DIR','executeJob','deleteFile','prototype','broadcastPlaying','findVoiceRecoredById','@nestjs/mongoose','AudioPlayer','Sound','find','textToAudioService','Tune','fileName','validateAndMoveFileAsync','upload','length','design:type','killAll','moveFile','AgendaService','Play','TextToAudioService','__param','object','../upload/upload.service','PROCESS_CACHE','uploadService','decorate','_id','./sound.gateway','playTextToAudioRecorded','forEach','VoiceRecorded','volume','path','StreamingService','getMessageById','@nestjs/event-emitter','playSoundOnEvent','name','playStreamAudioAsync','assign','SoundService','DEFAULT_TUNES','push','log','cancelJob','metadata','delete','4WtrXvc','uuid','function','Logger','9iWLOmv','3159276RFAzgm','Play\x20sound:\x20','soundGateway','DEFAULT_TUNES_DIR','getNewFileName','playAsync','findById','update','../streaming/streaming.service','stop','@nestjs/common','findOne','copyFiles','assets','pop','findByIdAndDelete','findByType','339406SfukfM','JobType','soundModel','findByIdAndUpdate','UploadService','../common/job','__esModule','resetTunes','agendaService','../common/events/sound','File\x20not\x20found!','playVoiceRecorded','mongoose','Playing\x20sound:\x20','findByIds','Sound\x20not\x20found!','design:returntype','SoundEvent','join','AUDIO_DIR','../agenda/agenda.service','./data/default-sounds','createFolder','isFileExist','textToAudio','getOwnPropertyDescriptor','PlaySound','exec'];a136_0x4121=function(){return _0x252f71;};return a136_0x4121();}const a136_0x3c3ae7=a136_0x39dc;(function(_0x30e257,_0x4bbbc5){const _0x4d2aed=a136_0x39dc,_0x2eaaf6=_0x30e257();while(!![]){try{const _0x15b451=-parseInt(_0x4d2aed(0x250))/0x1+-parseInt(_0x4d2aed(0x202))/0x2+-parseInt(_0x4d2aed(0x206))/0x3*(-parseInt(_0x4d2aed(0x23a))/0x4)+-parseInt(_0x4d2aed(0x1f4))/0x5+parseInt(_0x4d2aed(0x23f))/0x6+-parseInt(_0x4d2aed(0x1fc))/0x7+parseInt(_0x4d2aed(0x205))/0x8*(parseInt(_0x4d2aed(0x23e))/0x9);if(_0x15b451===_0x4bbbc5)break;else _0x2eaaf6['push'](_0x2eaaf6['shift']());}catch(_0x276e61){_0x2eaaf6['push'](_0x2eaaf6['shift']());}}}(a136_0x4121,0x49c11));function a136_0x39dc(_0x2c2df9,_0x22c009){const _0x412151=a136_0x4121();return a136_0x39dc=function(_0x39dc24,_0x3a0284){_0x39dc24=_0x39dc24-0x1ed;let _0x51d2cc=_0x412151[_0x39dc24];return _0x51d2cc;},a136_0x39dc(_0x2c2df9,_0x22c009);}var __decorate=this&&this['__decorate']||function(_0x139b37,_0x1baefd,_0x240b8,_0x591fb9){const _0x50d43d=a136_0x39dc;var _0x71c8b6=arguments[_0x50d43d(0x218)],_0xd2340a=_0x71c8b6<0x3?_0x1baefd:_0x591fb9===null?_0x591fb9=Object[_0x50d43d(0x1f1)](_0x1baefd,_0x240b8):_0x591fb9,_0x318cbd;if(typeof Reflect===_0x50d43d(0x220)&&typeof Reflect['decorate']==='function')_0xd2340a=Reflect[_0x50d43d(0x224)](_0x139b37,_0x1baefd,_0x240b8,_0x591fb9);else{for(var _0x1ba122=_0x139b37['length']-0x1;_0x1ba122>=0x0;_0x1ba122--)if(_0x318cbd=_0x139b37[_0x1ba122])_0xd2340a=(_0x71c8b6<0x3?_0x318cbd(_0xd2340a):_0x71c8b6>0x3?_0x318cbd(_0x1baefd,_0x240b8,_0xd2340a):_0x318cbd(_0x1baefd,_0x240b8))||_0xd2340a;}return _0x71c8b6>0x3&&_0xd2340a&&Object[_0x50d43d(0x1fd)](_0x1baefd,_0x240b8,_0xd2340a),_0xd2340a;},__metadata=this&&this['__metadata']||function(_0x32286c,_0x2659cf){const _0x1e6e13=a136_0x39dc;if(typeof Reflect===_0x1e6e13(0x220)&&typeof Reflect[_0x1e6e13(0x238)]===_0x1e6e13(0x23c))return Reflect['metadata'](_0x32286c,_0x2659cf);},__param=this&&this[a136_0x3c3ae7(0x21f)]||function(_0x2dc2f2,_0x313c76){return function(_0xb8e261,_0x6212d){_0x313c76(_0xb8e261,_0x6212d,_0x2dc2f2);};},SoundService_1;Object[a136_0x3c3ae7(0x1fd)](exports,a136_0x3c3ae7(0x256),{'value':!![]}),exports['SoundService']=void 0x0;const common_1=require(a136_0x3c3ae7(0x249)),mongoose_1=require(a136_0x3c3ae7(0x20f)),mongoose_2=require(a136_0x3c3ae7(0x25c)),path=require(a136_0x3c3ae7(0x22b)),event_emitter_1=require(a136_0x3c3ae7(0x22e)),file_1=require('../common/file'),agenda_service_1=require(a136_0x3c3ae7(0x264)),enums_1=require('../common/enums'),constants_1=require('../common/constants'),utils_1=require(a136_0x3c3ae7(0x1fa)),path_1=require('../common/path'),audio_player_1=require(a136_0x3c3ae7(0x203)),sound_1=require(a136_0x3c3ae7(0x259)),job_1=require(a136_0x3c3ae7(0x255)),constants_2=require('./constants'),default_sounds_1=require(a136_0x3c3ae7(0x1ed)),sound_gateway_1=require(a136_0x3c3ae7(0x226)),path_2=require(a136_0x3c3ae7(0x22b)),upload_service_1=require(a136_0x3c3ae7(0x221)),text_to_audio_service_1=require('../text-to-audio/text-to-audio.service'),streaming_service_1=require(a136_0x3c3ae7(0x247));let SoundService=SoundService_1=class SoundService{constructor(_0x1c6fe3,_0x5911c4,_0x5a56d8,_0x584fc6,_0x4a6f45,_0x2c11c9){const _0x148e33=a136_0x3c3ae7;this[_0x148e33(0x252)]=_0x1c6fe3,this[_0x148e33(0x258)]=_0x5911c4,this['uploadService']=_0x5a56d8,this['textToAudioService']=_0x584fc6,this['streamingService']=_0x4a6f45,this['soundGateway']=_0x2c11c9,this[_0x148e33(0x208)]=new common_1[(_0x148e33(0x23d))](SoundService_1[_0x148e33(0x230)]);}async[a136_0x3c3ae7(0x200)](_0x56f3d0){const _0x1aed2c=a136_0x3c3ae7;await this[_0x1aed2c(0x216)](_0x56f3d0,null);const _0x48abe8=new this[(_0x1aed2c(0x252))](_0x56f3d0);return _0x48abe8[_0x1aed2c(0x207)]();}async[a136_0x3c3ae7(0x24f)](_0x79fb7e){const _0x2e39ef=a136_0x3c3ae7,_0x5eaaa2=await this['soundModel'][_0x2e39ef(0x212)]({'type':_0x79fb7e})[_0x2e39ef(0x1f3)]();return _0x5eaaa2;}async[a136_0x3c3ae7(0x24a)](_0x11078e){const _0x178dc8=a136_0x3c3ae7,_0x2d26e5=await this[_0x178dc8(0x252)][_0x178dc8(0x245)](_0x11078e);return _0x2d26e5;}async[a136_0x3c3ae7(0x25e)](_0x2dd3d1){const _0x526bde=a136_0x3c3ae7,_0x1869da=await this['soundModel'][_0x526bde(0x212)]({'_id':{'$in':_0x2dd3d1}});return _0x1869da;}async[a136_0x3c3ae7(0x246)](_0x1cc0ad,_0x2c23af){const _0xf6a495=a136_0x3c3ae7,_0x4d67e1=await this['soundModel']['findById'](_0x1cc0ad)['exec']();if(!_0x4d67e1)throw new Error('Sound\x20not\x20found!');await this[_0xf6a495(0x216)](_0x2c23af,_0x4d67e1===null||_0x4d67e1===void 0x0?void 0x0:_0x4d67e1[_0xf6a495(0x215)]);const _0x1be82f=await this[_0xf6a495(0x252)]['findByIdAndUpdate'](_0x1cc0ad,Object[_0xf6a495(0x232)](Object[_0xf6a495(0x232)]({},_0x2c23af),{'updatedAtUtc':new Date()}),{'new':!![]});return _0x1be82f;}async[a136_0x3c3ae7(0x1f5)](_0x21c275,_0x367c68){const _0x5cad5b=a136_0x3c3ae7,_0x47a188=await this[_0x5cad5b(0x252)][_0x5cad5b(0x245)](_0x21c275)['exec']();if(!_0x47a188)throw new Error(_0x5cad5b(0x25f));const _0x53fa4c=await this['soundModel'][_0x5cad5b(0x253)](_0x21c275,Object[_0x5cad5b(0x232)](Object[_0x5cad5b(0x232)]({},_0x367c68),{'updatedAtUtc':new Date()}),{'new':!![]});return _0x53fa4c;}async[a136_0x3c3ae7(0x239)](_0x4c64e1){const _0x2a2d1b=a136_0x3c3ae7,_0x17743a=await this[_0x2a2d1b(0x252)][_0x2a2d1b(0x24e)](_0x4c64e1);if(_0x17743a[_0x2a2d1b(0x215)]){const _0x48b52d=constants_1[_0x2a2d1b(0x263)]+'/'+_0x17743a['fileName'];try{(0x0,file_1['deleteFile'])(_0x48b52d);}catch(_0x212c11){this['logger'][_0x2a2d1b(0x1ff)](_0x212c11);}}return _0x17743a;}async[a136_0x3c3ae7(0x217)](_0x1f9159,_0x3558d2){const _0x50d3c6=a136_0x3c3ae7,_0x2b9391=await this[_0x50d3c6(0x252)][_0x50d3c6(0x245)](_0x1f9159)[_0x50d3c6(0x1f3)](),_0x33d288=_0x2b9391===null||_0x2b9391===void 0x0?void 0x0:_0x2b9391[_0x50d3c6(0x215)],_0x3f6497=this[_0x50d3c6(0x243)](_0x3558d2[_0x50d3c6(0x1f7)]),_0x1cb6af=constants_1[_0x50d3c6(0x263)]+'/'+_0x3f6497;await(0x0,file_1['moveFile'])(_0x3558d2[_0x50d3c6(0x22b)],_0x1cb6af);const _0x3295a6={'fileName':_0x3f6497},_0x5cb8dd=await this[_0x50d3c6(0x252)][_0x50d3c6(0x253)](_0x1f9159,Object[_0x50d3c6(0x232)](Object[_0x50d3c6(0x232)]({},_0x3295a6),{'updatedAtUtc':new Date()}),{'new':!![]});if(_0x33d288){const _0x4dc7f4=constants_1[_0x50d3c6(0x263)]+'/'+_0x33d288;(0x0,file_1[_0x50d3c6(0x20b)])(_0x4dc7f4);}return _0x5cb8dd;}async['playSoundOnEvent'](_0x5480d0){const _0x303d8a=a136_0x3c3ae7,{soundId:_0x5b03a0,jobId:_0x1f8083,durationInSecond:_0x31759c}=_0x5480d0,_0x348c3b=await this[_0x303d8a(0x24a)](_0x5b03a0),_0x42444a=path[_0x303d8a(0x262)](path_1[_0x303d8a(0x1f6)],_0x303d8a(0x24c),_0x303d8a(0x1fb),_0x348c3b['fileName']);if(!(0x0,file_1[_0x303d8a(0x1ef)])(_0x42444a)){this[_0x303d8a(0x208)][_0x303d8a(0x1ff)]('Sound\x20file\x20not\x20found:\x20'+_0x42444a);return;}job_1[_0x303d8a(0x222)][_0x303d8a(0x21a)](),this[_0x303d8a(0x208)]['log'](_0x303d8a(0x25d)+_0x5b03a0+'\x20-\x20'+_0x348c3b[_0x303d8a(0x230)]),(0x0,job_1[_0x303d8a(0x20a)])({'jobId':_0x1f8083,'run':()=>audio_player_1[_0x303d8a(0x210)]['playAsync'](_0x42444a,_0x348c3b[_0x303d8a(0x22a)]),'next':()=>this[_0x303d8a(0x248)](_0x5b03a0),'durationInSecond':_0x31759c}),this['soundGateway'][_0x303d8a(0x20d)]({'id':_0x5b03a0,'isPlaying':!![]});}async[a136_0x3c3ae7(0x25b)](_0x461347){const _0x4b020d=a136_0x3c3ae7,{voiceId:_0x56a48d,jobId:_0x18301c,durationInSecond:_0x1470e4}=_0x461347,_0x515f1e=await this[_0x4b020d(0x223)][_0x4b020d(0x20e)](_0x56a48d),_0x3e4422=_0x515f1e['filePath'],_0x2541f9=(0x0,path_2[_0x4b020d(0x262)])(process['cwd'](),_0x3e4422);if(!(0x0,file_1[_0x4b020d(0x1ef)])(_0x2541f9)){this[_0x4b020d(0x208)][_0x4b020d(0x1ff)]('Voice\x20file\x20not\x20found:\x20'+_0x2541f9);return;}job_1[_0x4b020d(0x222)][_0x4b020d(0x21a)](),this[_0x4b020d(0x208)][_0x4b020d(0x236)]('Playing\x20voice\x20recorded:\x20'+_0x56a48d),(0x0,job_1[_0x4b020d(0x20a)])({'jobId':_0x18301c,'run':()=>audio_player_1[_0x4b020d(0x210)][_0x4b020d(0x244)](_0x2541f9),'durationInSecond':_0x1470e4,'next':()=>null});}async[a136_0x3c3ae7(0x227)](_0x392ad2){const _0x4d95ec=a136_0x3c3ae7,{textToAudioId:_0x54dc6a,jobId:_0x4edf80,durationInSecond:_0x4c9f81}=_0x392ad2,{message:_0x166a23}=await this['textToAudioService'][_0x4d95ec(0x22d)](_0x54dc6a);job_1[_0x4d95ec(0x222)][_0x4d95ec(0x21a)](),(0x0,job_1[_0x4d95ec(0x20a)])({'jobId':_0x4edf80,'run':()=>{const _0x3086a2=_0x4d95ec;let _0x5611d6=null;return this[_0x3086a2(0x213)][_0x3086a2(0x1f0)](_0x166a23,_0x17e613=>{const _0x4e1f25=_0x3086a2;_0x5611d6=this[_0x4e1f25(0x1fe)][_0x4e1f25(0x231)](_0x17e613);}),_0x5611d6;},'durationInSecond':_0x4c9f81,'next':()=>null});}async['play'](_0x5e021f,_0x5b0914,_0x1cbcc0=![]){const _0x2ce291=a136_0x3c3ae7,_0x5af2f9={'when':'now','jobType':enums_1['JobType'][_0x2ce291(0x1f2)],'attributes':{'soundId':_0x5b0914,'durationInSecond':_0x1cbcc0?0x15180:undefined},'audit':{'actor':_0x5e021f,'name':enums_1[_0x2ce291(0x251)][_0x2ce291(0x1f2)],'message':_0x2ce291(0x240)+_0x5b0914}},_0x58379=await this[_0x2ce291(0x252)][_0x2ce291(0x24a)]({'jobId':{'$ne':null}});_0x58379&&await this[_0x2ce291(0x248)](_0x58379['id']);const {jobId:_0xab04e7}=await this[_0x2ce291(0x258)]['scheduleJob'](_0x5af2f9);return this[_0x2ce291(0x246)](_0x5b0914,{'jobId':_0xab04e7});}async[a136_0x3c3ae7(0x248)](_0x21711d){const _0x539453=a136_0x3c3ae7;let _0x111e28=await this[_0x539453(0x24a)](_0x21711d);const {jobId:_0x4e59d1}=_0x111e28||{};if(_0x4e59d1){const {success:_0x3072b1}=await this[_0x539453(0x258)][_0x539453(0x237)](_0x4e59d1);_0x3072b1&&(_0x111e28=await this['update'](_0x21711d,{'jobId':null}));}return this[_0x539453(0x241)]['broadcastPlaying']({'id':_0x111e28['id'],'isPlaying':![]}),_0x111e28;}async[a136_0x3c3ae7(0x257)](){const _0x5befa0=a136_0x3c3ae7,_0x4f34d3=await this['findByType'](constants_2['SoundType'][_0x5befa0(0x214)]);if(_0x4f34d3['length']>0x0){const _0x24f574=[];_0x4f34d3[_0x5befa0(0x228)](_0x3c7530=>{const _0x1627e6=_0x5befa0;_0x24f574[_0x1627e6(0x235)](this['delete'](_0x3c7530[_0x1627e6(0x225)]));}),await Promise[_0x5befa0(0x201)](_0x24f574);}await(0x0,file_1[_0x5befa0(0x24b)])(constants_1[_0x5befa0(0x242)],constants_1[_0x5befa0(0x209)]);const _0x5bd3ce=[];return default_sounds_1[_0x5befa0(0x234)][_0x5befa0(0x228)](_0x1a1fc6=>{const _0x411570=_0x5befa0;_0x5bd3ce['push'](this[_0x411570(0x200)](Object['assign']({},_0x1a1fc6)));}),await Promise[_0x5befa0(0x201)](_0x5bd3ce),!![];}[a136_0x3c3ae7(0x243)](_0x3e4cd1){const _0x2c0771=a136_0x3c3ae7,_0x145c8a=_0x3e4cd1['split']('.')[_0x2c0771(0x24d)]();return(0x0,utils_1[_0x2c0771(0x23b)])()+'.'+_0x145c8a;}async['validateAndMoveFileAsync'](_0x41668f,_0x13e711){const _0x21ba92=a136_0x3c3ae7;if(!_0x41668f[_0x21ba92(0x215)])return;const _0x5a0725=constants_1[_0x21ba92(0x209)]+'/'+_0x41668f['fileName'],_0x13b632=_0x13e711||this[_0x21ba92(0x243)](_0x41668f['fileName']),_0xf2005a=constants_1[_0x21ba92(0x263)]+'/'+_0x13b632;if(!(0x0,file_1[_0x21ba92(0x1ef)])(_0x5a0725))throw new Error(_0x21ba92(0x25a));!(0x0,file_1[_0x21ba92(0x1ef)])(constants_1[_0x21ba92(0x263)])&&(0x0,file_1[_0x21ba92(0x1ee)])(constants_1[_0x21ba92(0x263)]),await(0x0,file_1[_0x21ba92(0x21b)])(_0x5a0725,_0xf2005a),_0x41668f[_0x21ba92(0x215)]=_0x13b632;}};__decorate([(0x0,event_emitter_1['OnEvent'])(sound_1['SoundEvent'][a136_0x3c3ae7(0x21d)]),__metadata('design:type',Function),__metadata(a136_0x3c3ae7(0x1f8),[Object]),__metadata('design:returntype',Promise)],SoundService[a136_0x3c3ae7(0x20c)],a136_0x3c3ae7(0x22f),null),__decorate([(0x0,event_emitter_1['OnEvent'])(sound_1[a136_0x3c3ae7(0x261)][a136_0x3c3ae7(0x229)]),__metadata('design:type',Function),__metadata(a136_0x3c3ae7(0x1f8),[Object]),__metadata(a136_0x3c3ae7(0x260),Promise)],SoundService[a136_0x3c3ae7(0x20c)],a136_0x3c3ae7(0x25b),null),__decorate([(0x0,event_emitter_1['OnEvent'])(sound_1[a136_0x3c3ae7(0x261)]['TextToAudio']),__metadata(a136_0x3c3ae7(0x219),Function),__metadata(a136_0x3c3ae7(0x1f8),[Object]),__metadata(a136_0x3c3ae7(0x260),Promise)],SoundService[a136_0x3c3ae7(0x20c)],a136_0x3c3ae7(0x227),null),SoundService=SoundService_1=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,mongoose_1['InjectModel'])(a136_0x3c3ae7(0x211))),__param(0x5,(0x0,common_1['Inject'])(sound_gateway_1[a136_0x3c3ae7(0x204)])),__metadata(a136_0x3c3ae7(0x1f8),[mongoose_2[a136_0x3c3ae7(0x1f9)],agenda_service_1[a136_0x3c3ae7(0x21c)],upload_service_1[a136_0x3c3ae7(0x254)],text_to_audio_service_1[a136_0x3c3ae7(0x21e)],streaming_service_1[a136_0x3c3ae7(0x22c)],sound_gateway_1[a136_0x3c3ae7(0x204)]])],SoundService),exports[a136_0x3c3ae7(0x233)]=SoundService;