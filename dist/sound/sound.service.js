'use strict';const a133_0xd3902a=a133_0x4fb8;function a133_0xe596(){const _0x5f3991=['AUDIO_DIR','cwd','prototype','exec','push','stop','log','findByIdAndDelete','TextToAudio','findByType','InjectModel','find','6Aolcoz','DEFAULT_TUNES','__esModule','DEFAULT_TUNES_DIR','resetTunes','delete','Play','all','playAsync','33315sZWKXA','assets','fileName','findByIds','upload','SoundGateway','../streaming/streaming.service','3bPaggT','File\x20not\x20found!','AgendaService','3128380oaYjMH','processRootPath','path','VoiceRecorded','moveFile','3088ohxmvz','@nestjs/mongoose','Sound\x20file\x20not\x20found:\x20','Play\x20sound:\x20','../agenda/agenda.service','Sound','./sound.gateway','Tune','soundModel','10001937BWrebN','update','2669443eCoAub','createFolder','design:paramtypes','../common/audio/audio-player','StreamingService','uuid','isFileExist','Inject','textToAudio','findByIdAndUpdate','playTextToAudioRecorded','length','../common/file','OnEvent','playVoiceRecorded','mongoose','SoundService','killAll','2528xLZGcB','Sound\x20not\x20found!','188hDZdSL','getNewFileName','JobType','design:returntype','Injectable','play','findOne','SoundType','1305OIlvAa','../common/events/sound','split','PROCESS_CACHE','TextToAudioService','SoundEvent','save','logger','textToAudioService','object','now','scheduleJob','join','streamingService','AudioPlayer','findById','assign','executeJob','445557fwxTfK','create','TMP_UPLOAD_DIR','error','../common/path','agendaService','__metadata','../common/constants','broadcastPlaying','../common/utils','deleteFile','__param','audio','decorate','design:type','metadata','../text-to-audio/text-to-audio.service','playStreamAudioAsync','__decorate','pop','updateVolume','volume','forEach','defineProperty','\x20-\x20','validateAndMoveFileAsync','name','playSoundOnEvent','PlaySound','uploadService','../common/job','@nestjs/common','soundGateway'];a133_0xe596=function(){return _0x5f3991;};return a133_0xe596();}(function(_0x17e6dc,_0x5393db){const _0x58fea2=a133_0x4fb8,_0x42e2dc=_0x17e6dc();while(!![]){try{const _0x1739d2=-parseInt(_0x58fea2(0x8e))/0x1*(-parseInt(_0x58fea2(0xb3))/0x2)+parseInt(_0x58fea2(0xcf))/0x3+parseInt(_0x58fea2(0xb5))/0x4*(parseInt(_0x58fea2(0x87))/0x5)+parseInt(_0x58fea2(0x7e))/0x6*(parseInt(_0x58fea2(0xa1))/0x7)+-parseInt(_0x58fea2(0x96))/0x8*(parseInt(_0x58fea2(0xbd))/0x9)+parseInt(_0x58fea2(0x91))/0xa+-parseInt(_0x58fea2(0x9f))/0xb;if(_0x1739d2===_0x5393db)break;else _0x42e2dc['push'](_0x42e2dc['shift']());}catch(_0xe3b9a1){_0x42e2dc['push'](_0x42e2dc['shift']());}}}(a133_0xe596,0x2f776));var __decorate=this&&this[a133_0xd3902a(0xe1)]||function(_0x1cf7df,_0x59740e,_0x3ab01a,_0x273196){const _0x114cf5=a133_0xd3902a;var _0x22de7c=arguments[_0x114cf5(0xac)],_0x24a154=_0x22de7c<0x3?_0x59740e:_0x273196===null?_0x273196=Object['getOwnPropertyDescriptor'](_0x59740e,_0x3ab01a):_0x273196,_0x2c8ec0;if(typeof Reflect===_0x114cf5(0xc6)&&typeof Reflect[_0x114cf5(0xdc)]==='function')_0x24a154=Reflect['decorate'](_0x1cf7df,_0x59740e,_0x3ab01a,_0x273196);else{for(var _0x1cd46b=_0x1cf7df['length']-0x1;_0x1cd46b>=0x0;_0x1cd46b--)if(_0x2c8ec0=_0x1cf7df[_0x1cd46b])_0x24a154=(_0x22de7c<0x3?_0x2c8ec0(_0x24a154):_0x22de7c>0x3?_0x2c8ec0(_0x59740e,_0x3ab01a,_0x24a154):_0x2c8ec0(_0x59740e,_0x3ab01a))||_0x24a154;}return _0x22de7c>0x3&&_0x24a154&&Object[_0x114cf5(0x68)](_0x59740e,_0x3ab01a,_0x24a154),_0x24a154;},__metadata=this&&this[a133_0xd3902a(0xd5)]||function(_0x188c87,_0x1b6a20){const _0x3b4245=a133_0xd3902a;if(typeof Reflect==='object'&&typeof Reflect[_0x3b4245(0xde)]==='function')return Reflect[_0x3b4245(0xde)](_0x188c87,_0x1b6a20);},__param=this&&this[a133_0xd3902a(0xda)]||function(_0x1869a8,_0x12f38e){return function(_0x4720ca,_0x24c092){_0x12f38e(_0x4720ca,_0x24c092,_0x1869a8);};},SoundService_1;Object[a133_0xd3902a(0x68)](exports,a133_0xd3902a(0x80),{'value':!![]}),exports['SoundService']=void 0x0;function a133_0x4fb8(_0xda348a,_0x38c9ea){const _0xe59689=a133_0xe596();return a133_0x4fb8=function(_0x4fb8d,_0x4fea39){_0x4fb8d=_0x4fb8d-0x66;let _0x4cb5ec=_0xe59689[_0x4fb8d];return _0x4cb5ec;},a133_0x4fb8(_0xda348a,_0x38c9ea);}const common_1=require(a133_0xd3902a(0x70)),mongoose_1=require(a133_0xd3902a(0x97)),mongoose_2=require(a133_0xd3902a(0xb0)),path=require(a133_0xd3902a(0x93)),event_emitter_1=require('@nestjs/event-emitter'),file_1=require(a133_0xd3902a(0xad)),agenda_service_1=require(a133_0xd3902a(0x9a)),enums_1=require('../common/enums'),constants_1=require(a133_0xd3902a(0xd6)),utils_1=require(a133_0xd3902a(0xd8)),path_1=require(a133_0xd3902a(0xd3)),audio_player_1=require(a133_0xd3902a(0xa4)),sound_1=require(a133_0xd3902a(0xbe)),job_1=require(a133_0xd3902a(0x6f)),constants_2=require('./constants'),default_sounds_1=require('./data/default-sounds'),sound_gateway_1=require(a133_0xd3902a(0x9c)),path_2=require('path'),upload_service_1=require('../upload/upload.service'),text_to_audio_service_1=require(a133_0xd3902a(0xdf)),streaming_service_1=require(a133_0xd3902a(0x8d));let SoundService=SoundService_1=class SoundService{constructor(_0x40fae1,_0x455782,_0xda024c,_0x5aa6e8,_0x32f991,_0x162a7f){const _0x224751=a133_0xd3902a;this[_0x224751(0x9e)]=_0x40fae1,this[_0x224751(0xd4)]=_0x455782,this[_0x224751(0x6e)]=_0xda024c,this[_0x224751(0xc5)]=_0x5aa6e8,this[_0x224751(0xca)]=_0x32f991,this['soundGateway']=_0x162a7f,this[_0x224751(0xc4)]=new common_1['Logger'](SoundService_1['name']);}async['create'](_0x7c7d1a){const _0x429ae5=a133_0xd3902a;await this['validateAndMoveFileAsync'](_0x7c7d1a,null);const _0xd21e71=new this[(_0x429ae5(0x9e))](_0x7c7d1a);return _0xd21e71[_0x429ae5(0xc3)]();}async[a133_0xd3902a(0x7b)](_0x4f089e){const _0x5ac3f1=a133_0xd3902a,_0x4a04eb=await this[_0x5ac3f1(0x9e)][_0x5ac3f1(0x7d)]({'type':_0x4f089e})[_0x5ac3f1(0x75)]();return _0x4a04eb;}async[a133_0xd3902a(0xbb)](_0x338b8a){const _0x2e23b3=a133_0xd3902a,_0x750c78=await this[_0x2e23b3(0x9e)][_0x2e23b3(0xcc)](_0x338b8a);return _0x750c78;}async[a133_0xd3902a(0x8a)](_0x158fe7){const _0xc4fcb0=a133_0xd3902a,_0xb4366=await this[_0xc4fcb0(0x9e)][_0xc4fcb0(0x7d)]({'_id':{'$in':_0x158fe7}});return _0xb4366;}async[a133_0xd3902a(0xa0)](_0x3ebcff,_0x21b7b0){const _0x120c42=a133_0xd3902a,_0x5482bd=await this['soundModel']['findById'](_0x3ebcff)['exec']();if(!_0x5482bd)throw new Error(_0x120c42(0xb4));await this[_0x120c42(0x6a)](_0x21b7b0,_0x5482bd===null||_0x5482bd===void 0x0?void 0x0:_0x5482bd[_0x120c42(0x89)]);const _0x87d1f2=await this[_0x120c42(0x9e)][_0x120c42(0xaa)](_0x3ebcff,Object[_0x120c42(0xcd)](Object[_0x120c42(0xcd)]({},_0x21b7b0),{'updatedAtUtc':new Date()}),{'new':!![]});return _0x87d1f2;}async[a133_0xd3902a(0xe3)](_0x2dfcbc,_0x3a9218){const _0x3b136a=a133_0xd3902a,_0x1dd3fa=await this[_0x3b136a(0x9e)]['findById'](_0x2dfcbc)[_0x3b136a(0x75)]();if(!_0x1dd3fa)throw new Error(_0x3b136a(0xb4));const _0x4ec964=await this[_0x3b136a(0x9e)][_0x3b136a(0xaa)](_0x2dfcbc,Object[_0x3b136a(0xcd)](Object[_0x3b136a(0xcd)]({},_0x3a9218),{'updatedAtUtc':new Date()}),{'new':!![]});return _0x4ec964;}async[a133_0xd3902a(0x83)](_0x298db6){const _0x525cb7=a133_0xd3902a,_0x1a4b4b=await this[_0x525cb7(0x9e)][_0x525cb7(0x79)](_0x298db6);if(_0x1a4b4b[_0x525cb7(0x89)]){const _0x5d4b43=constants_1[_0x525cb7(0x72)]+'/'+_0x1a4b4b[_0x525cb7(0x89)];try{(0x0,file_1['deleteFile'])(_0x5d4b43);}catch(_0x399143){this[_0x525cb7(0xc4)][_0x525cb7(0xd2)](_0x399143);}}return _0x1a4b4b;}async[a133_0xd3902a(0x8b)](_0x15fb44,_0xb1b8e){const _0x42d300=a133_0xd3902a,_0x48d223=await this['soundModel'][_0x42d300(0xcc)](_0x15fb44)[_0x42d300(0x75)](),_0x384bdd=_0x48d223===null||_0x48d223===void 0x0?void 0x0:_0x48d223[_0x42d300(0x89)],_0x503196=this[_0x42d300(0xb6)](_0xb1b8e['originalname']),_0x50b5a6=constants_1['AUDIO_DIR']+'/'+_0x503196;await(0x0,file_1[_0x42d300(0x95)])(_0xb1b8e[_0x42d300(0x93)],_0x50b5a6);const _0x39a910={'fileName':_0x503196},_0x116042=await this[_0x42d300(0x9e)][_0x42d300(0xaa)](_0x15fb44,Object[_0x42d300(0xcd)](Object[_0x42d300(0xcd)]({},_0x39a910),{'updatedAtUtc':new Date()}),{'new':!![]});if(_0x384bdd){const _0x4b4be7=constants_1[_0x42d300(0x72)]+'/'+_0x384bdd;(0x0,file_1[_0x42d300(0xd9)])(_0x4b4be7);}return _0x116042;}async[a133_0xd3902a(0x6c)](_0x5b757c){const _0x473ac1=a133_0xd3902a,{soundId:_0x3dc200,jobId:_0x3ae2a6,durationInSecond:_0x1b07ce}=_0x5b757c,_0x25f35e=await this[_0x473ac1(0xbb)](_0x3dc200),_0x294e88=path[_0x473ac1(0xc9)](path_1[_0x473ac1(0x92)],_0x473ac1(0x88),_0x473ac1(0xdb),_0x25f35e['fileName']);if(!(0x0,file_1[_0x473ac1(0xa7)])(_0x294e88)){this[_0x473ac1(0xc4)][_0x473ac1(0xd2)](_0x473ac1(0x98)+_0x294e88);return;}job_1[_0x473ac1(0xc0)]['killAll'](),this['logger'][_0x473ac1(0x78)]('Playing\x20sound:\x20'+_0x3dc200+_0x473ac1(0x69)+_0x25f35e[_0x473ac1(0x6b)]),(0x0,job_1[_0x473ac1(0xce)])({'jobId':_0x3ae2a6,'run':()=>audio_player_1[_0x473ac1(0xcb)][_0x473ac1(0x86)](_0x294e88,_0x25f35e[_0x473ac1(0x66)]),'next':()=>this['stop'](_0x3dc200),'durationInSecond':_0x1b07ce}),this[_0x473ac1(0x71)][_0x473ac1(0xd7)]({'id':_0x3dc200,'isPlaying':!![]});}async[a133_0xd3902a(0xaf)](_0x8e4685){const _0x4b5d50=a133_0xd3902a,{voiceId:_0x803fff,jobId:_0x50f912,durationInSecond:_0x23f902}=_0x8e4685,_0x10afd2=await this[_0x4b5d50(0x6e)]['findVoiceRecoredById'](_0x803fff),_0x9c5dc2=_0x10afd2['filePath'],_0x179193=(0x0,path_2[_0x4b5d50(0xc9)])(process[_0x4b5d50(0x73)](),_0x9c5dc2);if(!(0x0,file_1['isFileExist'])(_0x179193)){this['logger'][_0x4b5d50(0xd2)]('Voice\x20file\x20not\x20found:\x20'+_0x179193);return;}job_1[_0x4b5d50(0xc0)][_0x4b5d50(0xb2)](),this[_0x4b5d50(0xc4)][_0x4b5d50(0x78)]('Playing\x20voice\x20recorded:\x20'+_0x803fff),(0x0,job_1[_0x4b5d50(0xce)])({'jobId':_0x50f912,'run':()=>audio_player_1['AudioPlayer'][_0x4b5d50(0x86)](_0x179193),'durationInSecond':_0x23f902,'next':()=>null});}async[a133_0xd3902a(0xab)](_0x21d994){const _0x14ac90=a133_0xd3902a,{textToAudioId:_0x5e5c3d,jobId:_0x145429,durationInSecond:_0x41b101}=_0x21d994,{message:_0x5c8272}=await this[_0x14ac90(0xc5)]['getMessageById'](_0x5e5c3d);job_1['PROCESS_CACHE'][_0x14ac90(0xb2)](),(0x0,job_1['executeJob'])({'jobId':_0x145429,'run':()=>{const _0x1f0e98=_0x14ac90;let _0x59bb6c=null;return this[_0x1f0e98(0xc5)][_0x1f0e98(0xa9)](_0x5c8272,_0x2a9e59=>{const _0x4662cd=_0x1f0e98;_0x59bb6c=this[_0x4662cd(0xca)][_0x4662cd(0xe0)](_0x2a9e59);}),_0x59bb6c;},'durationInSecond':_0x41b101,'next':()=>null});}async[a133_0xd3902a(0xba)](_0x22f6ed,_0x56fafc,_0x585f97=![]){const _0x63830c=a133_0xd3902a,_0x1ebca3={'when':_0x63830c(0xc7),'jobType':enums_1[_0x63830c(0xb7)][_0x63830c(0x6d)],'attributes':{'soundId':_0x56fafc,'durationInSecond':_0x585f97?0x15180:undefined},'audit':{'actor':_0x22f6ed,'name':enums_1[_0x63830c(0xb7)][_0x63830c(0x6d)],'message':_0x63830c(0x99)+_0x56fafc}},_0xa8071=await this[_0x63830c(0x9e)][_0x63830c(0xbb)]({'jobId':{'$ne':null}});_0xa8071&&await this[_0x63830c(0x77)](_0xa8071['id']);const {jobId:_0x4a34db}=await this[_0x63830c(0xd4)][_0x63830c(0xc8)](_0x1ebca3);return this['update'](_0x56fafc,{'jobId':_0x4a34db});}async[a133_0xd3902a(0x77)](_0x4d420b){const _0x29ae9d=a133_0xd3902a;let _0x2bd9a0=await this[_0x29ae9d(0xbb)](_0x4d420b);const {jobId:_0x2e14ea}=_0x2bd9a0||{};if(_0x2e14ea){const {success:_0x5b44aa}=await this['agendaService']['cancelJob'](_0x2e14ea);_0x5b44aa&&(_0x2bd9a0=await this['update'](_0x4d420b,{'jobId':null}));}return this[_0x29ae9d(0x71)][_0x29ae9d(0xd7)]({'id':_0x2bd9a0['id'],'isPlaying':![]}),_0x2bd9a0;}async[a133_0xd3902a(0x82)](){const _0x24ac6b=a133_0xd3902a,_0x10d2c3=await this[_0x24ac6b(0x7b)](constants_2[_0x24ac6b(0xbc)][_0x24ac6b(0x9d)]);if(_0x10d2c3[_0x24ac6b(0xac)]>0x0){const _0x5bc17c=[];_0x10d2c3[_0x24ac6b(0x67)](_0x38168a=>{const _0x3ff88f=_0x24ac6b;_0x5bc17c[_0x3ff88f(0x76)](this[_0x3ff88f(0x83)](_0x38168a['_id']));}),await Promise['all'](_0x5bc17c);}await(0x0,file_1['copyFiles'])(constants_1[_0x24ac6b(0x81)],constants_1[_0x24ac6b(0xd1)]);const _0x1ab315=[];return default_sounds_1[_0x24ac6b(0x7f)][_0x24ac6b(0x67)](_0x3b7a97=>{const _0x529d84=_0x24ac6b;_0x1ab315['push'](this[_0x529d84(0xd0)](Object[_0x529d84(0xcd)]({},_0x3b7a97)));}),await Promise[_0x24ac6b(0x85)](_0x1ab315),!![];}['getNewFileName'](_0x3846d5){const _0x2c4bef=a133_0xd3902a,_0x42459c=_0x3846d5[_0x2c4bef(0xbf)]('.')[_0x2c4bef(0xe2)]();return(0x0,utils_1[_0x2c4bef(0xa6)])()+'.'+_0x42459c;}async[a133_0xd3902a(0x6a)](_0x5bd485,_0x84b38){const _0x574356=a133_0xd3902a;if(!_0x5bd485[_0x574356(0x89)])return;const _0x3b6b4f=constants_1[_0x574356(0xd1)]+'/'+_0x5bd485[_0x574356(0x89)],_0x2018f3=_0x84b38||this[_0x574356(0xb6)](_0x5bd485[_0x574356(0x89)]),_0xacf44a=constants_1[_0x574356(0x72)]+'/'+_0x2018f3;if(!(0x0,file_1[_0x574356(0xa7)])(_0x3b6b4f))throw new Error(_0x574356(0x8f));!(0x0,file_1[_0x574356(0xa7)])(constants_1['AUDIO_DIR'])&&(0x0,file_1[_0x574356(0xa2)])(constants_1[_0x574356(0x72)]),await(0x0,file_1[_0x574356(0x95)])(_0x3b6b4f,_0xacf44a),_0x5bd485[_0x574356(0x89)]=_0x2018f3;}};__decorate([(0x0,event_emitter_1[a133_0xd3902a(0xae)])(sound_1['SoundEvent'][a133_0xd3902a(0x84)]),__metadata(a133_0xd3902a(0xdd),Function),__metadata('design:paramtypes',[Object]),__metadata(a133_0xd3902a(0xb8),Promise)],SoundService[a133_0xd3902a(0x74)],a133_0xd3902a(0x6c),null),__decorate([(0x0,event_emitter_1['OnEvent'])(sound_1[a133_0xd3902a(0xc2)][a133_0xd3902a(0x94)]),__metadata(a133_0xd3902a(0xdd),Function),__metadata(a133_0xd3902a(0xa3),[Object]),__metadata('design:returntype',Promise)],SoundService['prototype'],a133_0xd3902a(0xaf),null),__decorate([(0x0,event_emitter_1[a133_0xd3902a(0xae)])(sound_1['SoundEvent'][a133_0xd3902a(0x7a)]),__metadata(a133_0xd3902a(0xdd),Function),__metadata(a133_0xd3902a(0xa3),[Object]),__metadata(a133_0xd3902a(0xb8),Promise)],SoundService[a133_0xd3902a(0x74)],'playTextToAudioRecorded',null),SoundService=SoundService_1=__decorate([(0x0,common_1[a133_0xd3902a(0xb9)])(),__param(0x0,(0x0,mongoose_1[a133_0xd3902a(0x7c)])(a133_0xd3902a(0x9b))),__param(0x5,(0x0,common_1[a133_0xd3902a(0xa8)])(sound_gateway_1[a133_0xd3902a(0x8c)])),__metadata('design:paramtypes',[mongoose_2['Model'],agenda_service_1[a133_0xd3902a(0x90)],upload_service_1['UploadService'],text_to_audio_service_1[a133_0xd3902a(0xc1)],streaming_service_1[a133_0xd3902a(0xa5)],sound_gateway_1['SoundGateway']])],SoundService),exports[a133_0xd3902a(0xb1)]=SoundService;