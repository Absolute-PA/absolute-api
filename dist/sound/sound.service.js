'use strict';const a133_0x3a9a45=a133_0x4610;function a133_0x4610(_0x1eb891,_0x470515){const _0x1b58cb=a133_0x1b58();return a133_0x4610=function(_0x4610d6,_0x3a97d2){_0x4610d6=_0x4610d6-0xa6;let _0x1761fc=_0x1b58cb[_0x4610d6];return _0x1761fc;},a133_0x4610(_0x1eb891,_0x470515);}function a133_0x1b58(){const _0x3206e8=['findByIdAndDelete','../common/path','object','function','../common/job','../common/enums','OnEvent','VoiceRecorded','delete','error','design:returntype','findByIdAndUpdate','AgendaService','find','PROCESS_CACHE','Sound\x20file\x20not\x20found:\x20','path','name','5086305fViqZO','PlaySound','design:paramtypes','../text-to-audio/text-to-audio.service','../agenda/agenda.service','defineProperty','findByType','processRootPath','resetTunes','design:type','pop','132mqJttV','File\x20not\x20found!','SoundEvent','@nestjs/mongoose','579344OGziEs','all','join','assets','67115TjmMpZ','textToAudioService','../upload/upload.service','./sound.gateway','UploadService','getNewFileName','Voice\x20file\x20not\x20found:\x20','save','update','cwd','deleteFile','AUDIO_DIR','log','_id','__param','Sound\x20not\x20found!','filePath','../common/constants','decorate','uploadService','findOne','broadcastPlaying','agendaService','6456250jGIoad','soundGateway','5392170xNslAV','\x20-\x20','moveFile','forEach','@nestjs/common','__metadata','scheduleJob','Model','../common/file','play','stop','playSoundOnEvent','TextToAudio','audio','72hAxqvP','exec','playTextToAudioRecorded','30074AZRGkg','textToAudio','findVoiceRecoredById','getOwnPropertyDescriptor','fileName','Sound','soundModel','StreamingService','__esModule','validateAndMoveFileAsync','SoundGateway','DEFAULT_TUNES_DIR','getMessageById','assign','playAsync','upload','InjectModel','createFolder','split','metadata','112PDznNn','Play','length','playVoiceRecorded','executeJob','Injectable','logger','killAll','prototype','mongoose','copyFiles','JobType','SoundType','findByIds','streamingService','cancelJob','Logger','TMP_UPLOAD_DIR','../common/audio/audio-player','findById','Inject','AudioPlayer','./data/default-sounds','now','isFileExist','create','push','Playing\x20voice\x20recorded:\x20','originalname','31419cafGZZ','SoundService','../common/utils'];a133_0x1b58=function(){return _0x3206e8;};return a133_0x1b58();}(function(_0x5b1789,_0x491dd5){const _0x2f4476=a133_0x4610,_0x3dcc52=_0x5b1789();while(!![]){try{const _0x2a1a30=parseInt(_0x2f4476(0xcf))/0x1+-parseInt(_0x2f4476(0x121))/0x2*(-parseInt(_0x2f4476(0xef))/0x3)+parseInt(_0x2f4476(0x11e))/0x4*(parseInt(_0x2f4476(0xf7))/0x5)+parseInt(_0x2f4476(0x110))/0x6+parseInt(_0x2f4476(0xb2))/0x7*(-parseInt(_0x2f4476(0xf3))/0x8)+parseInt(_0x2f4476(0xe4))/0x9+-parseInt(_0x2f4476(0x10e))/0xa;if(_0x2a1a30===_0x491dd5)break;else _0x3dcc52['push'](_0x3dcc52['shift']());}catch(_0x42d74c){_0x3dcc52['push'](_0x3dcc52['shift']());}}}(a133_0x1b58,0x9110c));var __decorate=this&&this['__decorate']||function(_0x4575f1,_0x1af804,_0x228ca6,_0xcb35e3){const _0x33e654=a133_0x4610;var _0x23c620=arguments[_0x33e654(0xb4)],_0x310149=_0x23c620<0x3?_0x1af804:_0xcb35e3===null?_0xcb35e3=Object[_0x33e654(0x124)](_0x1af804,_0x228ca6):_0xcb35e3,_0x1d4f8c;if(typeof Reflect===_0x33e654(0xd4)&&typeof Reflect[_0x33e654(0x109)]===_0x33e654(0xd5))_0x310149=Reflect['decorate'](_0x4575f1,_0x1af804,_0x228ca6,_0xcb35e3);else{for(var _0x10ebfa=_0x4575f1['length']-0x1;_0x10ebfa>=0x0;_0x10ebfa--)if(_0x1d4f8c=_0x4575f1[_0x10ebfa])_0x310149=(_0x23c620<0x3?_0x1d4f8c(_0x310149):_0x23c620>0x3?_0x1d4f8c(_0x1af804,_0x228ca6,_0x310149):_0x1d4f8c(_0x1af804,_0x228ca6))||_0x310149;}return _0x23c620>0x3&&_0x310149&&Object[_0x33e654(0xe9)](_0x1af804,_0x228ca6,_0x310149),_0x310149;},__metadata=this&&this[a133_0x3a9a45(0x115)]||function(_0x20bca1,_0x1b967d){const _0x262590=a133_0x3a9a45;if(typeof Reflect===_0x262590(0xd4)&&typeof Reflect[_0x262590(0xb1)]===_0x262590(0xd5))return Reflect[_0x262590(0xb1)](_0x20bca1,_0x1b967d);},__param=this&&this[a133_0x3a9a45(0x105)]||function(_0x47cfce,_0x57cc47){return function(_0x597626,_0x32fde9){_0x57cc47(_0x597626,_0x32fde9,_0x47cfce);};},SoundService_1;Object[a133_0x3a9a45(0xe9)](exports,a133_0x3a9a45(0xa6),{'value':!![]}),exports['SoundService']=void 0x0;const common_1=require(a133_0x3a9a45(0x114)),mongoose_1=require(a133_0x3a9a45(0xf2)),mongoose_2=require(a133_0x3a9a45(0xbb)),path=require(a133_0x3a9a45(0xe2)),event_emitter_1=require('@nestjs/event-emitter'),file_1=require(a133_0x3a9a45(0x118)),agenda_service_1=require(a133_0x3a9a45(0xe8)),enums_1=require(a133_0x3a9a45(0xd7)),constants_1=require(a133_0x3a9a45(0x108)),utils_1=require(a133_0x3a9a45(0xd1)),path_1=require(a133_0x3a9a45(0xd3)),audio_player_1=require(a133_0x3a9a45(0xc4)),sound_1=require('../common/events/sound'),job_1=require(a133_0x3a9a45(0xd6)),constants_2=require('./constants'),default_sounds_1=require(a133_0x3a9a45(0xc8)),sound_gateway_1=require(a133_0x3a9a45(0xfa)),path_2=require(a133_0x3a9a45(0xe2)),upload_service_1=require(a133_0x3a9a45(0xf9)),text_to_audio_service_1=require(a133_0x3a9a45(0xe7)),streaming_service_1=require('../streaming/streaming.service');let SoundService=SoundService_1=class SoundService{constructor(_0x8289f2,_0x3c168e,_0x48a177,_0x35f225,_0x4c7a2f,_0x1010ff){const _0x22e480=a133_0x3a9a45;this[_0x22e480(0x127)]=_0x8289f2,this[_0x22e480(0x10d)]=_0x3c168e,this[_0x22e480(0x10a)]=_0x48a177,this['textToAudioService']=_0x35f225,this[_0x22e480(0xc0)]=_0x4c7a2f,this[_0x22e480(0x10f)]=_0x1010ff,this[_0x22e480(0xb8)]=new common_1[(_0x22e480(0xc2))](SoundService_1[_0x22e480(0xe3)]);}async[a133_0x3a9a45(0xcb)](_0x2e8c81){const _0x49aee3=a133_0x3a9a45;await this['validateAndMoveFileAsync'](_0x2e8c81,null);const _0x337eab=new this['soundModel'](_0x2e8c81);return _0x337eab[_0x49aee3(0xfe)]();}async['findByType'](_0x2253e3){const _0x657c4a=a133_0x3a9a45,_0x4c690b=await this['soundModel']['find']({'type':_0x2253e3})[_0x657c4a(0x11f)]();return _0x4c690b;}async['findOne'](_0x8de46){const _0x2c8f79=await this['soundModel']['findById'](_0x8de46);return _0x2c8f79;}async[a133_0x3a9a45(0xbf)](_0x58d0f6){const _0x355908=a133_0x3a9a45,_0x54b2c9=await this[_0x355908(0x127)][_0x355908(0xdf)]({'_id':{'$in':_0x58d0f6}});return _0x54b2c9;}async[a133_0x3a9a45(0xff)](_0x49315d,_0x5c15e5){const _0x515bbd=a133_0x3a9a45,_0x24b581=await this[_0x515bbd(0x127)]['findById'](_0x49315d)[_0x515bbd(0x11f)]();if(!_0x24b581)throw new Error(_0x515bbd(0x106));await this[_0x515bbd(0xa7)](_0x5c15e5,_0x24b581===null||_0x24b581===void 0x0?void 0x0:_0x24b581[_0x515bbd(0x125)]);const _0x48d31e=await this[_0x515bbd(0x127)][_0x515bbd(0xdd)](_0x49315d,Object['assign'](Object[_0x515bbd(0xab)]({},_0x5c15e5),{'updatedAtUtc':new Date()}),{'new':!![]});return _0x48d31e;}async['updateVolume'](_0x5b76d6,_0x9f4987){const _0x52b541=a133_0x3a9a45,_0x160c05=await this['soundModel'][_0x52b541(0xc5)](_0x5b76d6)[_0x52b541(0x11f)]();if(!_0x160c05)throw new Error(_0x52b541(0x106));const _0x3fda69=await this['soundModel']['findByIdAndUpdate'](_0x5b76d6,Object[_0x52b541(0xab)](Object['assign']({},_0x9f4987),{'updatedAtUtc':new Date()}),{'new':!![]});return _0x3fda69;}async[a133_0x3a9a45(0xda)](_0x267e12){const _0x5f0d46=a133_0x3a9a45,_0x2595b2=await this[_0x5f0d46(0x127)][_0x5f0d46(0xd2)](_0x267e12);if(_0x2595b2[_0x5f0d46(0x125)]){const _0x2cf441=constants_1[_0x5f0d46(0x102)]+'/'+_0x2595b2[_0x5f0d46(0x125)];try{(0x0,file_1[_0x5f0d46(0x101)])(_0x2cf441);}catch(_0x22c886){this[_0x5f0d46(0xb8)]['error'](_0x22c886);}}return _0x2595b2;}async[a133_0x3a9a45(0xad)](_0x37a477,_0x4cdd27){const _0x1b9214=a133_0x3a9a45,_0x3ea57f=await this['soundModel']['findById'](_0x37a477)[_0x1b9214(0x11f)](),_0x2d0090=_0x3ea57f===null||_0x3ea57f===void 0x0?void 0x0:_0x3ea57f[_0x1b9214(0x125)],_0x14a702=this['getNewFileName'](_0x4cdd27[_0x1b9214(0xce)]),_0xebe20c=constants_1[_0x1b9214(0x102)]+'/'+_0x14a702;await(0x0,file_1[_0x1b9214(0x112)])(_0x4cdd27[_0x1b9214(0xe2)],_0xebe20c);const _0xb74334={'fileName':_0x14a702},_0x1ee53d=await this['soundModel'][_0x1b9214(0xdd)](_0x37a477,Object[_0x1b9214(0xab)](Object[_0x1b9214(0xab)]({},_0xb74334),{'updatedAtUtc':new Date()}),{'new':!![]});if(_0x2d0090){const _0x2ae6d2=constants_1[_0x1b9214(0x102)]+'/'+_0x2d0090;(0x0,file_1[_0x1b9214(0x101)])(_0x2ae6d2);}return _0x1ee53d;}async['playSoundOnEvent'](_0x174121){const _0x55075f=a133_0x3a9a45,{soundId:_0x29fadd,jobId:_0x58c821,durationInSecond:_0x14c173}=_0x174121,_0x3739bb=await this[_0x55075f(0x10b)](_0x29fadd),_0x18cc1e=path[_0x55075f(0xf5)](path_1[_0x55075f(0xeb)],_0x55075f(0xf6),_0x55075f(0x11d),_0x3739bb[_0x55075f(0x125)]);if(!(0x0,file_1['isFileExist'])(_0x18cc1e)){this[_0x55075f(0xb8)][_0x55075f(0xdb)](_0x55075f(0xe1)+_0x18cc1e);return;}job_1['PROCESS_CACHE']['killAll'](),this[_0x55075f(0xb8)][_0x55075f(0x103)]('Playing\x20sound:\x20'+_0x29fadd+_0x55075f(0x111)+_0x3739bb[_0x55075f(0xe3)]),(0x0,job_1['executeJob'])({'jobId':_0x58c821,'run':()=>audio_player_1[_0x55075f(0xc7)]['playAsync'](_0x18cc1e,_0x3739bb['volume']),'next':()=>this[_0x55075f(0x11a)](_0x29fadd),'durationInSecond':_0x14c173}),this[_0x55075f(0x10f)]['broadcastPlaying']({'id':_0x29fadd,'isPlaying':!![]});}async[a133_0x3a9a45(0xb5)](_0x5491ac){const _0x216f9b=a133_0x3a9a45,{voiceId:_0x4e88e2,jobId:_0x51db94,durationInSecond:_0x39f2e9}=_0x5491ac,_0x5deefb=await this[_0x216f9b(0x10a)][_0x216f9b(0x123)](_0x4e88e2),_0x129ce8=_0x5deefb[_0x216f9b(0x107)],_0x4228b1=(0x0,path_2['join'])(process[_0x216f9b(0x100)](),_0x129ce8);if(!(0x0,file_1['isFileExist'])(_0x4228b1)){this[_0x216f9b(0xb8)][_0x216f9b(0xdb)](_0x216f9b(0xfd)+_0x4228b1);return;}job_1[_0x216f9b(0xe0)][_0x216f9b(0xb9)](),this[_0x216f9b(0xb8)]['log'](_0x216f9b(0xcd)+_0x4e88e2),(0x0,job_1[_0x216f9b(0xb6)])({'jobId':_0x51db94,'run':()=>audio_player_1[_0x216f9b(0xc7)][_0x216f9b(0xac)](_0x4228b1),'durationInSecond':_0x39f2e9,'next':()=>null});}async[a133_0x3a9a45(0x120)](_0x12408e){const _0x47d442=a133_0x3a9a45,{textToAudioId:_0x9ac9a5,jobId:_0x4a2063,durationInSecond:_0x2c6e6b}=_0x12408e,{message:_0x1a6ab0}=await this[_0x47d442(0xf8)][_0x47d442(0xaa)](_0x9ac9a5);job_1[_0x47d442(0xe0)][_0x47d442(0xb9)](),(0x0,job_1[_0x47d442(0xb6)])({'jobId':_0x4a2063,'run':()=>{const _0x1b7092=_0x47d442;let _0xcbeca4=null;return this[_0x1b7092(0xf8)][_0x1b7092(0x122)](_0x1a6ab0,_0x28961d=>{const _0x234a53=_0x1b7092;_0xcbeca4=this[_0x234a53(0xc0)]['playStreamAudioAsync'](_0x28961d);}),_0xcbeca4;},'durationInSecond':_0x2c6e6b,'next':()=>null});}async[a133_0x3a9a45(0x119)](_0x21becf,_0x4a8b49,_0x3d78fa=![]){const _0x26b77d=a133_0x3a9a45,_0x36ef88={'when':_0x26b77d(0xc9),'jobType':enums_1[_0x26b77d(0xbd)][_0x26b77d(0xe5)],'attributes':{'soundId':_0x4a8b49,'durationInSecond':_0x3d78fa?0x15180:undefined},'audit':{'actor':_0x21becf,'name':enums_1['JobType'][_0x26b77d(0xe5)],'message':'Play\x20sound:\x20'+_0x4a8b49}},_0x1ead6c=await this[_0x26b77d(0x127)][_0x26b77d(0x10b)]({'jobId':{'$ne':null}});_0x1ead6c&&await this['stop'](_0x1ead6c['id']);const {jobId:_0x48b3ce}=await this[_0x26b77d(0x10d)][_0x26b77d(0x116)](_0x36ef88);return this['update'](_0x4a8b49,{'jobId':_0x48b3ce});}async[a133_0x3a9a45(0x11a)](_0x2567bf){const _0x57c536=a133_0x3a9a45;let _0x1cf18e=await this[_0x57c536(0x10b)](_0x2567bf);const {jobId:_0x3ff91f}=_0x1cf18e||{};if(_0x3ff91f){const {success:_0x13e643}=await this[_0x57c536(0x10d)][_0x57c536(0xc1)](_0x3ff91f);_0x13e643&&(_0x1cf18e=await this[_0x57c536(0xff)](_0x2567bf,{'jobId':null}));}return this['soundGateway'][_0x57c536(0x10c)]({'id':_0x1cf18e['id'],'isPlaying':![]}),_0x1cf18e;}async[a133_0x3a9a45(0xec)](){const _0x448b46=a133_0x3a9a45,_0x225727=await this[_0x448b46(0xea)](constants_2[_0x448b46(0xbe)]['Tune']);if(_0x225727[_0x448b46(0xb4)]>0x0){const _0x3991c0=[];_0x225727[_0x448b46(0x113)](_0x2f2fc6=>{const _0x290b97=_0x448b46;_0x3991c0[_0x290b97(0xcc)](this[_0x290b97(0xda)](_0x2f2fc6[_0x290b97(0x104)]));}),await Promise[_0x448b46(0xf4)](_0x3991c0);}await(0x0,file_1[_0x448b46(0xbc)])(constants_1[_0x448b46(0xa9)],constants_1[_0x448b46(0xc3)]);const _0x1aecc7=[];return default_sounds_1['DEFAULT_TUNES'][_0x448b46(0x113)](_0x5e37bd=>{const _0x1ae387=_0x448b46;_0x1aecc7[_0x1ae387(0xcc)](this[_0x1ae387(0xcb)](Object[_0x1ae387(0xab)]({},_0x5e37bd)));}),await Promise[_0x448b46(0xf4)](_0x1aecc7),!![];}[a133_0x3a9a45(0xfc)](_0x5e0d31){const _0x193400=a133_0x3a9a45,_0x58567d=_0x5e0d31[_0x193400(0xb0)]('.')[_0x193400(0xee)]();return(0x0,utils_1['uuid'])()+'.'+_0x58567d;}async[a133_0x3a9a45(0xa7)](_0x57055c,_0x882308){const _0x57eab1=a133_0x3a9a45;if(!_0x57055c[_0x57eab1(0x125)])return;const _0x3c731c=constants_1['TMP_UPLOAD_DIR']+'/'+_0x57055c['fileName'],_0x272aef=_0x882308||this[_0x57eab1(0xfc)](_0x57055c[_0x57eab1(0x125)]),_0x4ef84b=constants_1[_0x57eab1(0x102)]+'/'+_0x272aef;if(!(0x0,file_1[_0x57eab1(0xca)])(_0x3c731c))throw new Error(_0x57eab1(0xf0));!(0x0,file_1[_0x57eab1(0xca)])(constants_1['AUDIO_DIR'])&&(0x0,file_1[_0x57eab1(0xaf)])(constants_1[_0x57eab1(0x102)]),await(0x0,file_1[_0x57eab1(0x112)])(_0x3c731c,_0x4ef84b),_0x57055c['fileName']=_0x272aef;}};__decorate([(0x0,event_emitter_1[a133_0x3a9a45(0xd8)])(sound_1[a133_0x3a9a45(0xf1)][a133_0x3a9a45(0xb3)]),__metadata(a133_0x3a9a45(0xed),Function),__metadata(a133_0x3a9a45(0xe6),[Object]),__metadata(a133_0x3a9a45(0xdc),Promise)],SoundService['prototype'],a133_0x3a9a45(0x11b),null),__decorate([(0x0,event_emitter_1[a133_0x3a9a45(0xd8)])(sound_1[a133_0x3a9a45(0xf1)][a133_0x3a9a45(0xd9)]),__metadata(a133_0x3a9a45(0xed),Function),__metadata(a133_0x3a9a45(0xe6),[Object]),__metadata(a133_0x3a9a45(0xdc),Promise)],SoundService[a133_0x3a9a45(0xba)],a133_0x3a9a45(0xb5),null),__decorate([(0x0,event_emitter_1[a133_0x3a9a45(0xd8)])(sound_1['SoundEvent'][a133_0x3a9a45(0x11c)]),__metadata('design:type',Function),__metadata(a133_0x3a9a45(0xe6),[Object]),__metadata(a133_0x3a9a45(0xdc),Promise)],SoundService[a133_0x3a9a45(0xba)],'playTextToAudioRecorded',null),SoundService=SoundService_1=__decorate([(0x0,common_1[a133_0x3a9a45(0xb7)])(),__param(0x0,(0x0,mongoose_1[a133_0x3a9a45(0xae)])(a133_0x3a9a45(0x126))),__param(0x5,(0x0,common_1[a133_0x3a9a45(0xc6)])(sound_gateway_1['SoundGateway'])),__metadata('design:paramtypes',[mongoose_2[a133_0x3a9a45(0x117)],agenda_service_1[a133_0x3a9a45(0xde)],upload_service_1[a133_0x3a9a45(0xfb)],text_to_audio_service_1['TextToAudioService'],streaming_service_1[a133_0x3a9a45(0x128)],sound_gateway_1[a133_0x3a9a45(0xa8)]])],SoundService),exports[a133_0x3a9a45(0xd0)]=SoundService;