'use strict';function a136_0xd041(_0x4eb82d,_0x3eb6dd){const _0x12c3e=a136_0x12c3();return a136_0xd041=function(_0xd04178,_0x49c061){_0xd04178=_0xd04178-0x107;let _0xc1dd96=_0x12c3e[_0xd04178];return _0xc1dd96;},a136_0xd041(_0x4eb82d,_0x3eb6dd);}const a136_0x3d8510=a136_0xd041;(function(_0x382c00,_0x54a932){const _0x1cc7f7=a136_0xd041,_0x3f84a2=_0x382c00();while(!![]){try{const _0x249013=-parseInt(_0x1cc7f7(0x108))/0x1*(-parseInt(_0x1cc7f7(0x111))/0x2)+parseInt(_0x1cc7f7(0x150))/0x3*(-parseInt(_0x1cc7f7(0x121))/0x4)+-parseInt(_0x1cc7f7(0x10e))/0x5+-parseInt(_0x1cc7f7(0x110))/0x6+parseInt(_0x1cc7f7(0x178))/0x7+parseInt(_0x1cc7f7(0x115))/0x8+parseInt(_0x1cc7f7(0x165))/0x9;if(_0x249013===_0x54a932)break;else _0x3f84a2['push'](_0x3f84a2['shift']());}catch(_0x455ebf){_0x3f84a2['push'](_0x3f84a2['shift']());}}}(a136_0x12c3,0xc31f1));var __decorate=this&&this[a136_0x3d8510(0x16f)]||function(_0x48598f,_0x1834e6,_0x47d0b5,_0x1d4b4d){const _0x376100=a136_0x3d8510;var _0x26b0f4=arguments[_0x376100(0x148)],_0x299de5=_0x26b0f4<0x3?_0x1834e6:_0x1d4b4d===null?_0x1d4b4d=Object[_0x376100(0x127)](_0x1834e6,_0x47d0b5):_0x1d4b4d,_0x4aafb3;if(typeof Reflect==='object'&&typeof Reflect[_0x376100(0x149)]===_0x376100(0x16d))_0x299de5=Reflect[_0x376100(0x149)](_0x48598f,_0x1834e6,_0x47d0b5,_0x1d4b4d);else{for(var _0x2fb16f=_0x48598f[_0x376100(0x148)]-0x1;_0x2fb16f>=0x0;_0x2fb16f--)if(_0x4aafb3=_0x48598f[_0x2fb16f])_0x299de5=(_0x26b0f4<0x3?_0x4aafb3(_0x299de5):_0x26b0f4>0x3?_0x4aafb3(_0x1834e6,_0x47d0b5,_0x299de5):_0x4aafb3(_0x1834e6,_0x47d0b5))||_0x299de5;}return _0x26b0f4>0x3&&_0x299de5&&Object[_0x376100(0x168)](_0x1834e6,_0x47d0b5,_0x299de5),_0x299de5;},__metadata=this&&this[a136_0x3d8510(0x13e)]||function(_0x219cb5,_0x1ced87){const _0x5e9cc0=a136_0x3d8510;if(typeof Reflect===_0x5e9cc0(0x15f)&&typeof Reflect['metadata']===_0x5e9cc0(0x16d))return Reflect['metadata'](_0x219cb5,_0x1ced87);},__param=this&&this[a136_0x3d8510(0x138)]||function(_0xd6b4d3,_0x4d43c2){return function(_0x4f57d8,_0x28c9c0){_0x4d43c2(_0x4f57d8,_0x28c9c0,_0xd6b4d3);};},SoundService_1;Object[a136_0x3d8510(0x168)](exports,a136_0x3d8510(0x124),{'value':!![]}),exports[a136_0x3d8510(0x11f)]=void 0x0;function a136_0x12c3(){const _0x590501=['updateVolume','../common/constants','__esModule','playSoundOnEvent','findById','getOwnPropertyDescriptor','../text-to-audio/text-to-audio.service','findByType','killAll','File\x20not\x20found!','OnEvent','design:paramtypes','soundModel','TMP_UPLOAD_DIR','all','streamingService','name','uuid','executeJob','find','log','./sound.gateway','__param','stop','originalname','soundGateway','push','findByIdAndDelete','__metadata','UploadService','JobType','TextToAudioService','PROCESS_CACHE','fileName','uploadService','isFileExist','design:returntype','Playing\x20voice\x20recorded:\x20','length','decorate','@nestjs/common','SoundGateway','create','split','../common/utils','update','108726ZXSClJ','design:type','delete','Logger','AUDIO_DIR','audio','Sound\x20file\x20not\x20found:\x20','prototype','findByIdAndUpdate','getNewFileName','PlaySound','SoundType','scheduleJob','./constants','_id','object','findOne','path','error','forEach','../common/file','8394768mNRQDM','DEFAULT_TUNES','agendaService','defineProperty','AudioPlayer','findVoiceRecoredById','playVoiceRecorded','@nestjs/event-emitter','function','pop','__decorate','playAsync','../common/job','textToAudioService','assign','Voice\x20file\x20not\x20found:\x20','broadcastPlaying','\x20-\x20','Playing\x20sound:\x20','4328121iVGIba','join','7AYvLLN','TextToAudio','resetTunes','upload','cwd','Model','3257465alXmld','playTextToAudioRecorded','6849006VKYDFJ','347902lWVGvp','../common/events/sound','../streaming/streaming.service','VoiceRecorded','10765304JEHHKY','processRootPath','SoundEvent','now','validateAndMoveFileAsync','deleteFile','logger','AgendaService','exec','textToAudio','SoundService','volume','168tpDutf'];a136_0x12c3=function(){return _0x590501;};return a136_0x12c3();}const common_1=require(a136_0x3d8510(0x14a)),mongoose_1=require('@nestjs/mongoose'),mongoose_2=require('mongoose'),path=require(a136_0x3d8510(0x161)),event_emitter_1=require(a136_0x3d8510(0x16c)),file_1=require(a136_0x3d8510(0x164)),agenda_service_1=require('../agenda/agenda.service'),enums_1=require('../common/enums'),constants_1=require(a136_0x3d8510(0x123)),utils_1=require(a136_0x3d8510(0x14e)),path_1=require('../common/path'),audio_player_1=require('../common/audio/audio-player'),sound_1=require(a136_0x3d8510(0x112)),job_1=require(a136_0x3d8510(0x171)),constants_2=require(a136_0x3d8510(0x15d)),default_sounds_1=require('./data/default-sounds'),sound_gateway_1=require(a136_0x3d8510(0x137)),path_2=require('path'),upload_service_1=require('../upload/upload.service'),text_to_audio_service_1=require(a136_0x3d8510(0x128)),streaming_service_1=require(a136_0x3d8510(0x113));let SoundService=SoundService_1=class SoundService{constructor(_0x32ffe5,_0x36a6bb,_0x4ea67a,_0x2fae3d,_0x153102,_0xf0b934){const _0x590b43=a136_0x3d8510;this[_0x590b43(0x12e)]=_0x32ffe5,this[_0x590b43(0x167)]=_0x36a6bb,this['uploadService']=_0x4ea67a,this[_0x590b43(0x172)]=_0x2fae3d,this[_0x590b43(0x131)]=_0x153102,this[_0x590b43(0x13b)]=_0xf0b934,this['logger']=new common_1[(_0x590b43(0x153))](SoundService_1[_0x590b43(0x132)]);}async[a136_0x3d8510(0x14c)](_0x262116){const _0x1b0e25=a136_0x3d8510;await this[_0x1b0e25(0x119)](_0x262116,null);const _0x296150=new this['soundModel'](_0x262116);return _0x296150['save']();}async['findByType'](_0x451d71){const _0x46e9e9=a136_0x3d8510,_0x4118b3=await this[_0x46e9e9(0x12e)][_0x46e9e9(0x135)]({'type':_0x451d71})['exec']();return _0x4118b3;}async[a136_0x3d8510(0x160)](_0x411df7){const _0x1610ad=a136_0x3d8510,_0x253bd4=await this[_0x1610ad(0x12e)][_0x1610ad(0x126)](_0x411df7);return _0x253bd4;}async['findByIds'](_0x595612){const _0x161b61=a136_0x3d8510,_0x3aa5a4=await this['soundModel'][_0x161b61(0x135)]({'_id':{'$in':_0x595612}});return _0x3aa5a4;}async[a136_0x3d8510(0x14f)](_0x1114ee,_0x2d2f45){const _0x143b72=a136_0x3d8510,_0x47c7dd=await this[_0x143b72(0x12e)]['findById'](_0x1114ee)[_0x143b72(0x11d)]();if(!_0x47c7dd)throw new Error('Sound\x20not\x20found!');await this['validateAndMoveFileAsync'](_0x2d2f45,_0x47c7dd===null||_0x47c7dd===void 0x0?void 0x0:_0x47c7dd[_0x143b72(0x143)]);const _0x3e2e01=await this['soundModel'][_0x143b72(0x158)](_0x1114ee,Object['assign'](Object['assign']({},_0x2d2f45),{'updatedAtUtc':new Date()}),{'new':!![]});return _0x3e2e01;}async[a136_0x3d8510(0x122)](_0x3b461b,_0x37fdbe){const _0x58ec12=a136_0x3d8510,_0x1b645e=await this[_0x58ec12(0x12e)][_0x58ec12(0x126)](_0x3b461b)[_0x58ec12(0x11d)]();if(!_0x1b645e)throw new Error('Sound\x20not\x20found!');const _0x369beb=await this[_0x58ec12(0x12e)]['findByIdAndUpdate'](_0x3b461b,Object[_0x58ec12(0x173)](Object[_0x58ec12(0x173)]({},_0x37fdbe),{'updatedAtUtc':new Date()}),{'new':!![]});return _0x369beb;}async[a136_0x3d8510(0x152)](_0x21ecb5){const _0x226aca=a136_0x3d8510,_0x40be3e=await this[_0x226aca(0x12e)][_0x226aca(0x13d)](_0x21ecb5);if(_0x40be3e[_0x226aca(0x143)]){const _0x319f18=constants_1['AUDIO_DIR']+'/'+_0x40be3e['fileName'];try{(0x0,file_1[_0x226aca(0x11a)])(_0x319f18);}catch(_0x422ce2){this[_0x226aca(0x11b)]['error'](_0x422ce2);}}return _0x40be3e;}async[a136_0x3d8510(0x10b)](_0x468637,_0x120b2d){const _0x3ba53c=a136_0x3d8510,_0x41e987=await this[_0x3ba53c(0x12e)][_0x3ba53c(0x126)](_0x468637)[_0x3ba53c(0x11d)](),_0x3b0926=_0x41e987===null||_0x41e987===void 0x0?void 0x0:_0x41e987[_0x3ba53c(0x143)],_0x6b7c19=this[_0x3ba53c(0x159)](_0x120b2d[_0x3ba53c(0x13a)]),_0x4b31c1=constants_1['AUDIO_DIR']+'/'+_0x6b7c19;await(0x0,file_1['moveFile'])(_0x120b2d[_0x3ba53c(0x161)],_0x4b31c1);const _0x3fba68={'fileName':_0x6b7c19},_0x4ccce0=await this[_0x3ba53c(0x12e)][_0x3ba53c(0x158)](_0x468637,Object['assign'](Object[_0x3ba53c(0x173)]({},_0x3fba68),{'updatedAtUtc':new Date()}),{'new':!![]});if(_0x3b0926){const _0x56111d=constants_1['AUDIO_DIR']+'/'+_0x3b0926;(0x0,file_1[_0x3ba53c(0x11a)])(_0x56111d);}return _0x4ccce0;}async[a136_0x3d8510(0x125)](_0x46139c){const _0x33143c=a136_0x3d8510,{soundId:_0x2c480a,jobId:_0x15eb66,durationInSecond:_0x3edd3e}=_0x46139c,_0xb62c34=await this[_0x33143c(0x160)](_0x2c480a),_0x32fa0b=path[_0x33143c(0x107)](path_1[_0x33143c(0x116)],'assets',_0x33143c(0x155),_0xb62c34[_0x33143c(0x143)]);if(!(0x0,file_1[_0x33143c(0x145)])(_0x32fa0b)){this['logger'][_0x33143c(0x162)](_0x33143c(0x156)+_0x32fa0b);return;}job_1[_0x33143c(0x142)]['killAll'](),this[_0x33143c(0x11b)][_0x33143c(0x136)](_0x33143c(0x177)+_0x2c480a+_0x33143c(0x176)+_0xb62c34['name']),(0x0,job_1[_0x33143c(0x134)])({'jobId':_0x15eb66,'run':()=>audio_player_1[_0x33143c(0x169)]['playAsync'](_0x32fa0b,_0xb62c34[_0x33143c(0x120)]),'next':()=>this['stop'](_0x2c480a),'durationInSecond':_0x3edd3e}),this[_0x33143c(0x13b)][_0x33143c(0x175)]({'id':_0x2c480a,'isPlaying':!![]});}async[a136_0x3d8510(0x16b)](_0x196825){const _0x11f7ea=a136_0x3d8510,{voiceId:_0x39b3fd,jobId:_0x3d7b1b,durationInSecond:_0x548984}=_0x196825,_0x167402=await this[_0x11f7ea(0x144)][_0x11f7ea(0x16a)](_0x39b3fd),_0x27f239=_0x167402['filePath'],_0x1e7fb8=(0x0,path_2[_0x11f7ea(0x107)])(process[_0x11f7ea(0x10c)](),_0x27f239);if(!(0x0,file_1[_0x11f7ea(0x145)])(_0x1e7fb8)){this[_0x11f7ea(0x11b)]['error'](_0x11f7ea(0x174)+_0x1e7fb8);return;}job_1[_0x11f7ea(0x142)][_0x11f7ea(0x12a)](),this[_0x11f7ea(0x11b)]['log'](_0x11f7ea(0x147)+_0x39b3fd),(0x0,job_1[_0x11f7ea(0x134)])({'jobId':_0x3d7b1b,'run':()=>audio_player_1['AudioPlayer'][_0x11f7ea(0x170)](_0x1e7fb8),'durationInSecond':_0x548984,'next':()=>null});}async[a136_0x3d8510(0x10f)](_0x49a34f){const _0x5ccbd7=a136_0x3d8510,{textToAudioId:_0x125db3,jobId:_0x25bcbf,durationInSecond:_0x1cf91c}=_0x49a34f,{message:_0x3ceae4}=await this[_0x5ccbd7(0x172)]['getMessageById'](_0x125db3);job_1['PROCESS_CACHE']['killAll'](),(0x0,job_1[_0x5ccbd7(0x134)])({'jobId':_0x25bcbf,'run':()=>{const _0x26d491=_0x5ccbd7;let _0x20b9f1=null;return this[_0x26d491(0x172)][_0x26d491(0x11e)](_0x3ceae4,_0x5f0ca1=>{const _0x780a3d=_0x26d491;_0x20b9f1=this[_0x780a3d(0x131)]['playStreamAudioAsync'](_0x5f0ca1);}),_0x20b9f1;},'durationInSecond':_0x1cf91c,'next':()=>null});}async['play'](_0x427fd8,_0x5bc356,_0x765ab0=![]){const _0x4780f1=a136_0x3d8510,_0x27dd2e={'when':_0x4780f1(0x118),'jobType':enums_1['JobType'][_0x4780f1(0x15a)],'attributes':{'soundId':_0x5bc356,'durationInSecond':_0x765ab0?0x15180:undefined},'audit':{'actor':_0x427fd8,'name':enums_1[_0x4780f1(0x140)]['PlaySound'],'message':'Play\x20sound:\x20'+_0x5bc356}},_0xb925ed=await this[_0x4780f1(0x12e)][_0x4780f1(0x160)]({'jobId':{'$ne':null}});_0xb925ed&&await this[_0x4780f1(0x139)](_0xb925ed['id']);const {jobId:_0x380213}=await this[_0x4780f1(0x167)][_0x4780f1(0x15c)](_0x27dd2e);return this[_0x4780f1(0x14f)](_0x5bc356,{'jobId':_0x380213});}async[a136_0x3d8510(0x139)](_0x3d4d77){const _0x589698=a136_0x3d8510;let _0x4ce71c=await this['findOne'](_0x3d4d77);const {jobId:_0x345c27}=_0x4ce71c||{};if(_0x345c27){const {success:_0xde6ce6}=await this[_0x589698(0x167)]['cancelJob'](_0x345c27);_0xde6ce6&&(_0x4ce71c=await this['update'](_0x3d4d77,{'jobId':null}));}return this[_0x589698(0x13b)]['broadcastPlaying']({'id':_0x4ce71c['id'],'isPlaying':![]}),_0x4ce71c;}async[a136_0x3d8510(0x10a)](){const _0x10b767=a136_0x3d8510,_0xe78677=await this[_0x10b767(0x129)](constants_2[_0x10b767(0x15b)]['Tune']);if(_0xe78677[_0x10b767(0x148)]>0x0){const _0x587e81=[];_0xe78677[_0x10b767(0x163)](_0x1f94a1=>{const _0x31cea4=_0x10b767;_0x587e81[_0x31cea4(0x13c)](this[_0x31cea4(0x152)](_0x1f94a1[_0x31cea4(0x15e)]));}),await Promise[_0x10b767(0x130)](_0x587e81);}await(0x0,file_1['copyFiles'])(constants_1['DEFAULT_TUNES_DIR'],constants_1[_0x10b767(0x12f)]);const _0x3d0bee=[];return default_sounds_1[_0x10b767(0x166)]['forEach'](_0x3276f2=>{const _0x3fbb49=_0x10b767;_0x3d0bee[_0x3fbb49(0x13c)](this[_0x3fbb49(0x14c)](Object['assign']({},_0x3276f2)));}),await Promise[_0x10b767(0x130)](_0x3d0bee),!![];}[a136_0x3d8510(0x159)](_0x50de2a){const _0x38ba21=a136_0x3d8510,_0x1fb700=_0x50de2a[_0x38ba21(0x14d)]('.')[_0x38ba21(0x16e)]();return(0x0,utils_1[_0x38ba21(0x133)])()+'.'+_0x1fb700;}async['validateAndMoveFileAsync'](_0x53317b,_0x4087ee){const _0x6acd18=a136_0x3d8510;if(!_0x53317b[_0x6acd18(0x143)])return;const _0x512853=constants_1[_0x6acd18(0x12f)]+'/'+_0x53317b[_0x6acd18(0x143)],_0x407fa8=_0x4087ee||this[_0x6acd18(0x159)](_0x53317b[_0x6acd18(0x143)]),_0x452ff2=constants_1[_0x6acd18(0x154)]+'/'+_0x407fa8;if(!(0x0,file_1[_0x6acd18(0x145)])(_0x512853))throw new Error(_0x6acd18(0x12b));!(0x0,file_1[_0x6acd18(0x145)])(constants_1[_0x6acd18(0x154)])&&(0x0,file_1['createFolder'])(constants_1[_0x6acd18(0x154)]),await(0x0,file_1['moveFile'])(_0x512853,_0x452ff2),_0x53317b[_0x6acd18(0x143)]=_0x407fa8;}};__decorate([(0x0,event_emitter_1['OnEvent'])(sound_1[a136_0x3d8510(0x117)]['Play']),__metadata(a136_0x3d8510(0x151),Function),__metadata(a136_0x3d8510(0x12d),[Object]),__metadata(a136_0x3d8510(0x146),Promise)],SoundService[a136_0x3d8510(0x157)],a136_0x3d8510(0x125),null),__decorate([(0x0,event_emitter_1[a136_0x3d8510(0x12c)])(sound_1[a136_0x3d8510(0x117)][a136_0x3d8510(0x114)]),__metadata(a136_0x3d8510(0x151),Function),__metadata(a136_0x3d8510(0x12d),[Object]),__metadata(a136_0x3d8510(0x146),Promise)],SoundService[a136_0x3d8510(0x157)],'playVoiceRecorded',null),__decorate([(0x0,event_emitter_1[a136_0x3d8510(0x12c)])(sound_1[a136_0x3d8510(0x117)][a136_0x3d8510(0x109)]),__metadata(a136_0x3d8510(0x151),Function),__metadata(a136_0x3d8510(0x12d),[Object]),__metadata('design:returntype',Promise)],SoundService[a136_0x3d8510(0x157)],a136_0x3d8510(0x10f),null),SoundService=SoundService_1=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,mongoose_1['InjectModel'])('Sound')),__param(0x5,(0x0,common_1['Inject'])(sound_gateway_1[a136_0x3d8510(0x14b)])),__metadata(a136_0x3d8510(0x12d),[mongoose_2[a136_0x3d8510(0x10d)],agenda_service_1[a136_0x3d8510(0x11c)],upload_service_1[a136_0x3d8510(0x13f)],text_to_audio_service_1[a136_0x3d8510(0x141)],streaming_service_1['StreamingService'],sound_gateway_1['SoundGateway']])],SoundService),exports[a136_0x3d8510(0x11f)]=SoundService;