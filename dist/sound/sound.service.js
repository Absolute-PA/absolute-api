'use strict';const a136_0x4e408a=a136_0x53a3;(function(_0xcc0e90,_0x18d1d1){const _0x34148b=a136_0x53a3,_0x19ca62=_0xcc0e90();while(!![]){try{const _0x278bae=parseInt(_0x34148b(0x110))/0x1*(parseInt(_0x34148b(0x137))/0x2)+parseInt(_0x34148b(0x130))/0x3+-parseInt(_0x34148b(0xe8))/0x4+parseInt(_0x34148b(0xea))/0x5*(parseInt(_0x34148b(0x133))/0x6)+parseInt(_0x34148b(0x10a))/0x7+-parseInt(_0x34148b(0xec))/0x8*(parseInt(_0x34148b(0x13a))/0x9)+parseInt(_0x34148b(0x126))/0xa*(-parseInt(_0x34148b(0x11b))/0xb);if(_0x278bae===_0x18d1d1)break;else _0x19ca62['push'](_0x19ca62['shift']());}catch(_0x46a1d2){_0x19ca62['push'](_0x19ca62['shift']());}}}(a136_0x350b,0x2aa28));function a136_0x350b(){const _0x1e08fe=['join','audio','forEach','playTextToAudioRecorded','design:returntype','TextToAudioService','cancelJob','volume','update','updateVolume','createFolder','SoundService','647144cfOpKM','AUDIO_DIR','35igHegm','agendaService','25664DHLzGM','playAsync','PlaySound','../common/file','DEFAULT_TUNES','all','Voice\x20file\x20not\x20found:\x20','getNewFileName','logger','../streaming/streaming.service','@nestjs/mongoose','path','prototype','TMP_UPLOAD_DIR','../text-to-audio/text-to-audio.service','Play\x20sound:\x20','findVoiceRecoredById','killAll','Sound\x20file\x20not\x20found:\x20','AudioPlayer','../common/constants','OnEvent','length','validateAndMoveFileAsync','moveFile','Tune','uuid','decorate','VoiceRecorded','scheduleJob','1945650zodUZV','soundGateway','deleteFile','SoundEvent','exec','stop','2ynxvjj','playVoiceRecorded','../common/path','find','File\x20not\x20found!','findOne','processRootPath','isFileExist','textToAudio','defineProperty','__esModule','911790uPcuZh','fileName','Playing\x20sound:\x20','design:paramtypes','assets','textToAudioService','mongoose','play','SoundType','pop','push','40PASvWV','Injectable','soundModel','name','\x20-\x20','assign','findByType','design:type','now','Sound\x20not\x20found!','562770yuWfov','getOwnPropertyDescriptor','uploadService','48528vPLmYk','__param','delete','findByIdAndUpdate','184318OitVZQ','Logger','SoundGateway','108aLgTfk','findByIds','log','cwd','PROCESS_CACHE','playSoundOnEvent','metadata','function','executeJob','copyFiles','_id','broadcastPlaying','Playing\x20voice\x20recorded:\x20','Sound','./sound.gateway','split','findByIdAndDelete','playStreamAudioAsync','findById','object','create','JobType','../agenda/agenda.service'];a136_0x350b=function(){return _0x1e08fe;};return a136_0x350b();}var __decorate=this&&this['__decorate']||function(_0x38be5d,_0x16420e,_0x27bffc,_0x3aaa7e){const _0x1b2bd9=a136_0x53a3;var _0x13a7a2=arguments['length'],_0x18846b=_0x13a7a2<0x3?_0x16420e:_0x3aaa7e===null?_0x3aaa7e=Object[_0x1b2bd9(0x131)](_0x16420e,_0x27bffc):_0x3aaa7e,_0x1a014d;if(typeof Reflect===_0x1b2bd9(0x14d)&&typeof Reflect[_0x1b2bd9(0x107)]==='function')_0x18846b=Reflect[_0x1b2bd9(0x107)](_0x38be5d,_0x16420e,_0x27bffc,_0x3aaa7e);else{for(var _0x42a144=_0x38be5d[_0x1b2bd9(0x102)]-0x1;_0x42a144>=0x0;_0x42a144--)if(_0x1a014d=_0x38be5d[_0x42a144])_0x18846b=(_0x13a7a2<0x3?_0x1a014d(_0x18846b):_0x13a7a2>0x3?_0x1a014d(_0x16420e,_0x27bffc,_0x18846b):_0x1a014d(_0x16420e,_0x27bffc))||_0x18846b;}return _0x13a7a2>0x3&&_0x18846b&&Object[_0x1b2bd9(0x119)](_0x16420e,_0x27bffc,_0x18846b),_0x18846b;},__metadata=this&&this['__metadata']||function(_0x35f28b,_0x232f14){const _0x4f9c8a=a136_0x53a3;if(typeof Reflect===_0x4f9c8a(0x14d)&&typeof Reflect[_0x4f9c8a(0x140)]===_0x4f9c8a(0x141))return Reflect[_0x4f9c8a(0x140)](_0x35f28b,_0x232f14);},__param=this&&this[a136_0x4e408a(0x134)]||function(_0x1d6535,_0x32be32){return function(_0x1f5825,_0xbf57be){_0x32be32(_0x1f5825,_0xbf57be,_0x1d6535);};},SoundService_1;function a136_0x53a3(_0x8bb57f,_0x48846c){const _0x350bf5=a136_0x350b();return a136_0x53a3=function(_0x53a391,_0x2ce64f){_0x53a391=_0x53a391-0xe2;let _0x51a72e=_0x350bf5[_0x53a391];return _0x51a72e;},a136_0x53a3(_0x8bb57f,_0x48846c);}Object[a136_0x4e408a(0x119)](exports,a136_0x4e408a(0x11a),{'value':!![]}),exports[a136_0x4e408a(0xe7)]=void 0x0;const common_1=require('@nestjs/common'),mongoose_1=require(a136_0x4e408a(0xf6)),mongoose_2=require(a136_0x4e408a(0x121)),path=require(a136_0x4e408a(0xf7)),event_emitter_1=require('@nestjs/event-emitter'),file_1=require(a136_0x4e408a(0xef)),agenda_service_1=require(a136_0x4e408a(0x150)),enums_1=require('../common/enums'),constants_1=require(a136_0x4e408a(0x100)),utils_1=require('../common/utils'),path_1=require(a136_0x4e408a(0x112)),audio_player_1=require('../common/audio/audio-player'),sound_1=require('../common/events/sound'),job_1=require('../common/job'),constants_2=require('./constants'),default_sounds_1=require('./data/default-sounds'),sound_gateway_1=require(a136_0x4e408a(0x148)),path_2=require(a136_0x4e408a(0xf7)),upload_service_1=require('../upload/upload.service'),text_to_audio_service_1=require(a136_0x4e408a(0xfa)),streaming_service_1=require(a136_0x4e408a(0xf5));let SoundService=SoundService_1=class SoundService{constructor(_0x5f4d53,_0x57a998,_0x40ce36,_0x1aa8d4,_0x44d642,_0x5c39b8){const _0x1d4f23=a136_0x4e408a;this[_0x1d4f23(0x128)]=_0x5f4d53,this[_0x1d4f23(0xeb)]=_0x57a998,this[_0x1d4f23(0x132)]=_0x40ce36,this[_0x1d4f23(0x120)]=_0x1aa8d4,this['streamingService']=_0x44d642,this[_0x1d4f23(0x10b)]=_0x5c39b8,this['logger']=new common_1[(_0x1d4f23(0x138))](SoundService_1[_0x1d4f23(0x129)]);}async['create'](_0x46d6ab){const _0xb45c34=a136_0x4e408a;await this[_0xb45c34(0x103)](_0x46d6ab,null);const _0x8220ef=new this[(_0xb45c34(0x128))](_0x46d6ab);return _0x8220ef['save']();}async[a136_0x4e408a(0x12c)](_0x75b99a){const _0x553265=a136_0x4e408a,_0x27e0b9=await this[_0x553265(0x128)][_0x553265(0x113)]({'type':_0x75b99a})['exec']();return _0x27e0b9;}async[a136_0x4e408a(0x115)](_0x1a7fe3){const _0x555aa4=await this['soundModel']['findById'](_0x1a7fe3);return _0x555aa4;}async[a136_0x4e408a(0x13b)](_0x3c0137){const _0x469930=a136_0x4e408a,_0x56f144=await this[_0x469930(0x128)][_0x469930(0x113)]({'_id':{'$in':_0x3c0137}});return _0x56f144;}async[a136_0x4e408a(0xe4)](_0x1d200f,_0x2fcec9){const _0x48a078=a136_0x4e408a,_0x5d2085=await this['soundModel'][_0x48a078(0x14c)](_0x1d200f)[_0x48a078(0x10e)]();if(!_0x5d2085)throw new Error('Sound\x20not\x20found!');await this[_0x48a078(0x103)](_0x2fcec9,_0x5d2085===null||_0x5d2085===void 0x0?void 0x0:_0x5d2085['fileName']);const _0x4e0437=await this['soundModel'][_0x48a078(0x136)](_0x1d200f,Object[_0x48a078(0x12b)](Object['assign']({},_0x2fcec9),{'updatedAtUtc':new Date()}),{'new':!![]});return _0x4e0437;}async[a136_0x4e408a(0xe5)](_0x279982,_0x13d673){const _0x57a76a=a136_0x4e408a,_0x3151a5=await this[_0x57a76a(0x128)][_0x57a76a(0x14c)](_0x279982)['exec']();if(!_0x3151a5)throw new Error(_0x57a76a(0x12f));const _0xab4102=await this[_0x57a76a(0x128)][_0x57a76a(0x136)](_0x279982,Object[_0x57a76a(0x12b)](Object[_0x57a76a(0x12b)]({},_0x13d673),{'updatedAtUtc':new Date()}),{'new':!![]});return _0xab4102;}async[a136_0x4e408a(0x135)](_0x3fef8a){const _0x56c53f=a136_0x4e408a,_0x2c3857=await this[_0x56c53f(0x128)][_0x56c53f(0x14a)](_0x3fef8a);if(_0x2c3857['fileName']){const _0x465eee=constants_1[_0x56c53f(0xe9)]+'/'+_0x2c3857['fileName'];try{(0x0,file_1[_0x56c53f(0x10c)])(_0x465eee);}catch(_0xfe2bc){this[_0x56c53f(0xf4)]['error'](_0xfe2bc);}}return _0x2c3857;}async['upload'](_0x2ad7b0,_0x1e896d){const _0x527ded=a136_0x4e408a,_0x334996=await this[_0x527ded(0x128)][_0x527ded(0x14c)](_0x2ad7b0)[_0x527ded(0x10e)](),_0x13f2aa=_0x334996===null||_0x334996===void 0x0?void 0x0:_0x334996[_0x527ded(0x11c)],_0x9cbc85=this['getNewFileName'](_0x1e896d['originalname']),_0x17507e=constants_1['AUDIO_DIR']+'/'+_0x9cbc85;await(0x0,file_1[_0x527ded(0x104)])(_0x1e896d[_0x527ded(0xf7)],_0x17507e);const _0x389764={'fileName':_0x9cbc85},_0x518841=await this['soundModel'][_0x527ded(0x136)](_0x2ad7b0,Object[_0x527ded(0x12b)](Object['assign']({},_0x389764),{'updatedAtUtc':new Date()}),{'new':!![]});if(_0x13f2aa){const _0x3f44d0=constants_1['AUDIO_DIR']+'/'+_0x13f2aa;(0x0,file_1[_0x527ded(0x10c)])(_0x3f44d0);}return _0x518841;}async[a136_0x4e408a(0x13f)](_0xabf886){const _0x413e0d=a136_0x4e408a,{soundId:_0x1dde54,jobId:_0x5ccb2a,durationInSecond:_0x6dbf49}=_0xabf886,_0x5063ab=await this[_0x413e0d(0x115)](_0x1dde54),_0x53bef4=path[_0x413e0d(0x151)](path_1[_0x413e0d(0x116)],_0x413e0d(0x11f),_0x413e0d(0x152),_0x5063ab[_0x413e0d(0x11c)]);if(!(0x0,file_1['isFileExist'])(_0x53bef4)){this['logger']['error'](_0x413e0d(0xfe)+_0x53bef4);return;}job_1[_0x413e0d(0x13e)][_0x413e0d(0xfd)](),this[_0x413e0d(0xf4)]['log'](_0x413e0d(0x11d)+_0x1dde54+_0x413e0d(0x12a)+_0x5063ab[_0x413e0d(0x129)]),(0x0,job_1[_0x413e0d(0x142)])({'jobId':_0x5ccb2a,'run':()=>audio_player_1[_0x413e0d(0xff)][_0x413e0d(0xed)](_0x53bef4,_0x5063ab[_0x413e0d(0xe3)]),'next':()=>this[_0x413e0d(0x10f)](_0x1dde54),'durationInSecond':_0x6dbf49}),this[_0x413e0d(0x10b)][_0x413e0d(0x145)]({'id':_0x1dde54,'isPlaying':!![]});}async[a136_0x4e408a(0x111)](_0x13e993){const _0x2263b3=a136_0x4e408a,{voiceId:_0x57f878,jobId:_0x109150,durationInSecond:_0x1b0fe2}=_0x13e993,_0x28bc67=await this[_0x2263b3(0x132)][_0x2263b3(0xfc)](_0x57f878),_0x1f1090=_0x28bc67['filePath'],_0x4107c7=(0x0,path_2[_0x2263b3(0x151)])(process[_0x2263b3(0x13d)](),_0x1f1090);if(!(0x0,file_1['isFileExist'])(_0x4107c7)){this['logger']['error'](_0x2263b3(0xf2)+_0x4107c7);return;}job_1[_0x2263b3(0x13e)][_0x2263b3(0xfd)](),this[_0x2263b3(0xf4)][_0x2263b3(0x13c)](_0x2263b3(0x146)+_0x57f878),(0x0,job_1['executeJob'])({'jobId':_0x109150,'run':()=>audio_player_1[_0x2263b3(0xff)]['playAsync'](_0x4107c7),'durationInSecond':_0x1b0fe2,'next':()=>null});}async['playTextToAudioRecorded'](_0x3e9e80){const _0x2b3a05=a136_0x4e408a,{textToAudioId:_0x2cebd5,jobId:_0x22ad37,durationInSecond:_0x1b24b4}=_0x3e9e80,{message:_0x32f021}=await this[_0x2b3a05(0x120)]['getMessageById'](_0x2cebd5);job_1['PROCESS_CACHE'][_0x2b3a05(0xfd)](),(0x0,job_1[_0x2b3a05(0x142)])({'jobId':_0x22ad37,'run':()=>{const _0x1adb5c=_0x2b3a05;let _0x46006=null;return this['textToAudioService'][_0x1adb5c(0x118)](_0x32f021,_0x29850b=>{const _0x6bd773=_0x1adb5c;_0x46006=this['streamingService'][_0x6bd773(0x14b)](_0x29850b);}),_0x46006;},'durationInSecond':_0x1b24b4,'next':()=>null});}async[a136_0x4e408a(0x122)](_0x521a94,_0x530451,_0x38d6b5=![]){const _0x350d36=a136_0x4e408a,_0x1eab25={'when':_0x350d36(0x12e),'jobType':enums_1['JobType']['PlaySound'],'attributes':{'soundId':_0x530451,'durationInSecond':_0x38d6b5?0x15180:undefined},'audit':{'actor':_0x521a94,'name':enums_1[_0x350d36(0x14f)][_0x350d36(0xee)],'message':_0x350d36(0xfb)+_0x530451}},_0x312a96=await this[_0x350d36(0x128)]['findOne']({'jobId':{'$ne':null}});_0x312a96&&await this[_0x350d36(0x10f)](_0x312a96['id']);const {jobId:_0x1f32ce}=await this['agendaService'][_0x350d36(0x109)](_0x1eab25);return this[_0x350d36(0xe4)](_0x530451,{'jobId':_0x1f32ce});}async[a136_0x4e408a(0x10f)](_0x23e2f7){const _0x4d2c93=a136_0x4e408a;let _0x16640e=await this[_0x4d2c93(0x115)](_0x23e2f7);const {jobId:_0xe1ae2}=_0x16640e||{};if(_0xe1ae2){const {success:_0x434175}=await this[_0x4d2c93(0xeb)][_0x4d2c93(0xe2)](_0xe1ae2);_0x434175&&(_0x16640e=await this[_0x4d2c93(0xe4)](_0x23e2f7,{'jobId':null}));}return this[_0x4d2c93(0x10b)]['broadcastPlaying']({'id':_0x16640e['id'],'isPlaying':![]}),_0x16640e;}async['resetTunes'](){const _0x5eecdb=a136_0x4e408a,_0x2d42e5=await this['findByType'](constants_2[_0x5eecdb(0x123)][_0x5eecdb(0x105)]);if(_0x2d42e5[_0x5eecdb(0x102)]>0x0){const _0x41ecf7=[];_0x2d42e5[_0x5eecdb(0x153)](_0x33e7fc=>{const _0x5d9043=_0x5eecdb;_0x41ecf7[_0x5d9043(0x125)](this[_0x5d9043(0x135)](_0x33e7fc[_0x5d9043(0x144)]));}),await Promise[_0x5eecdb(0xf1)](_0x41ecf7);}await(0x0,file_1[_0x5eecdb(0x143)])(constants_1['DEFAULT_TUNES_DIR'],constants_1[_0x5eecdb(0xf9)]);const _0x983ebf=[];return default_sounds_1[_0x5eecdb(0xf0)][_0x5eecdb(0x153)](_0x33ade6=>{const _0x4ef67c=_0x5eecdb;_0x983ebf[_0x4ef67c(0x125)](this[_0x4ef67c(0x14e)](Object[_0x4ef67c(0x12b)]({},_0x33ade6)));}),await Promise['all'](_0x983ebf),!![];}[a136_0x4e408a(0xf3)](_0x3e5af6){const _0x122348=a136_0x4e408a,_0x46c448=_0x3e5af6[_0x122348(0x149)]('.')[_0x122348(0x124)]();return(0x0,utils_1[_0x122348(0x106)])()+'.'+_0x46c448;}async[a136_0x4e408a(0x103)](_0x41eae6,_0x2fed6b){const _0x384b68=a136_0x4e408a;if(!_0x41eae6[_0x384b68(0x11c)])return;const _0x534d14=constants_1[_0x384b68(0xf9)]+'/'+_0x41eae6['fileName'],_0x1e5d9e=_0x2fed6b||this[_0x384b68(0xf3)](_0x41eae6['fileName']),_0x2b89e5=constants_1['AUDIO_DIR']+'/'+_0x1e5d9e;if(!(0x0,file_1[_0x384b68(0x117)])(_0x534d14))throw new Error(_0x384b68(0x114));!(0x0,file_1[_0x384b68(0x117)])(constants_1['AUDIO_DIR'])&&(0x0,file_1[_0x384b68(0xe6)])(constants_1['AUDIO_DIR']),await(0x0,file_1[_0x384b68(0x104)])(_0x534d14,_0x2b89e5),_0x41eae6[_0x384b68(0x11c)]=_0x1e5d9e;}};__decorate([(0x0,event_emitter_1[a136_0x4e408a(0x101)])(sound_1['SoundEvent']['Play']),__metadata('design:type',Function),__metadata(a136_0x4e408a(0x11e),[Object]),__metadata(a136_0x4e408a(0x155),Promise)],SoundService[a136_0x4e408a(0xf8)],'playSoundOnEvent',null),__decorate([(0x0,event_emitter_1[a136_0x4e408a(0x101)])(sound_1[a136_0x4e408a(0x10d)][a136_0x4e408a(0x108)]),__metadata(a136_0x4e408a(0x12d),Function),__metadata(a136_0x4e408a(0x11e),[Object]),__metadata(a136_0x4e408a(0x155),Promise)],SoundService['prototype'],'playVoiceRecorded',null),__decorate([(0x0,event_emitter_1[a136_0x4e408a(0x101)])(sound_1[a136_0x4e408a(0x10d)]['TextToAudio']),__metadata('design:type',Function),__metadata(a136_0x4e408a(0x11e),[Object]),__metadata(a136_0x4e408a(0x155),Promise)],SoundService[a136_0x4e408a(0xf8)],a136_0x4e408a(0x154),null),SoundService=SoundService_1=__decorate([(0x0,common_1[a136_0x4e408a(0x127)])(),__param(0x0,(0x0,mongoose_1['InjectModel'])(a136_0x4e408a(0x147))),__param(0x5,(0x0,common_1['Inject'])(sound_gateway_1[a136_0x4e408a(0x139)])),__metadata(a136_0x4e408a(0x11e),[mongoose_2['Model'],agenda_service_1['AgendaService'],upload_service_1['UploadService'],text_to_audio_service_1[a136_0x4e408a(0x156)],streaming_service_1['StreamingService'],sound_gateway_1[a136_0x4e408a(0x139)]])],SoundService),exports[a136_0x4e408a(0xe7)]=SoundService;