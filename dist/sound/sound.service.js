'use strict';const a133_0x1a598e=a133_0x47e0;(function(_0x5b2c05,_0x47ffc5){const _0x19d328=a133_0x47e0,_0x29d614=_0x5b2c05();while(!![]){try{const _0x2ebb99=-parseInt(_0x19d328(0x1e9))/0x1+-parseInt(_0x19d328(0x204))/0x2+-parseInt(_0x19d328(0x223))/0x3+parseInt(_0x19d328(0x252))/0x4+parseInt(_0x19d328(0x236))/0x5+-parseInt(_0x19d328(0x24d))/0x6*(parseInt(_0x19d328(0x234))/0x7)+parseInt(_0x19d328(0x1de))/0x8;if(_0x2ebb99===_0x47ffc5)break;else _0x29d614['push'](_0x29d614['shift']());}catch(_0xc15907){_0x29d614['push'](_0x29d614['shift']());}}}(a133_0x3d2f,0xb5120));function a133_0x3d2f(){const _0x188468=['Playing\x20voice\x20recorded:\x20','playStreamAudioAsync','path','__esModule','mongoose','./sound.gateway','TextToAudio','assets','now','function','SoundService','pop','findOne','./constants','all','metadata','2303GJvJbA','updateVolume','1586945PGnSdM','agendaService','soundModel','OnEvent','File\x20not\x20found!','uuid','TextToAudioService','./data/default-sounds','decorate','createFolder','SoundType','findByIdAndDelete','exec','../common/constants','AgendaService','Injectable','@nestjs/event-emitter','object','Model','_id','log','play','originalname','26802GLuTZz','assign','UploadService','streamingService','StreamingService','124940MdZJTn','copyFiles','Sound\x20not\x20found!','filePath','cancelJob','SoundGateway','../common/audio/audio-player','46588472FVeHSr','findByIds','TMP_UPLOAD_DIR','error','DEFAULT_TUNES_DIR','soundGateway','create','../common/events/sound','findById','moveFile','../common/path','1204404ySPpOV','../common/file','playAsync','defineProperty','playVoiceRecorded','uploadService','logger','textToAudio','executeJob','../common/job','fileName','Logger','design:returntype','processRootPath','../common/utils','../agenda/agenda.service','split','playTextToAudioRecorded','VoiceRecorded','InjectModel','__metadata','Tune','getOwnPropertyDescriptor','Playing\x20sound:\x20','JobType','killAll','../upload/upload.service','2697636dioAIl','PlaySound','join','PROCESS_CACHE','design:paramtypes','broadcastPlaying','getNewFileName','AUDIO_DIR','cwd','SoundEvent','push','textToAudioService','length','design:type','findByIdAndUpdate','Inject','audio','deleteFile','prototype','save','validateAndMoveFileAsync','name','find','stop','upload','playSoundOnEvent','isFileExist','forEach','AudioPlayer','volume','update','4222962NkIxtB'];a133_0x3d2f=function(){return _0x188468;};return a133_0x3d2f();}function a133_0x47e0(_0x5d7779,_0x385be7){const _0x3d2f72=a133_0x3d2f();return a133_0x47e0=function(_0x47e0e9,_0x4851d7){_0x47e0e9=_0x47e0e9-0x1d8;let _0x2782e1=_0x3d2f72[_0x47e0e9];return _0x2782e1;},a133_0x47e0(_0x5d7779,_0x385be7);}var __decorate=this&&this['__decorate']||function(_0x17289a,_0x40e1cc,_0x858902,_0x5ab258){const _0x59171b=a133_0x47e0;var _0x417059=arguments[_0x59171b(0x210)],_0x527d6b=_0x417059<0x3?_0x40e1cc:_0x5ab258===null?_0x5ab258=Object[_0x59171b(0x1ff)](_0x40e1cc,_0x858902):_0x5ab258,_0x5c745d;if(typeof Reflect===_0x59171b(0x247)&&typeof Reflect[_0x59171b(0x23e)]==='function')_0x527d6b=Reflect['decorate'](_0x17289a,_0x40e1cc,_0x858902,_0x5ab258);else{for(var _0x5f8c3f=_0x17289a['length']-0x1;_0x5f8c3f>=0x0;_0x5f8c3f--)if(_0x5c745d=_0x17289a[_0x5f8c3f])_0x527d6b=(_0x417059<0x3?_0x5c745d(_0x527d6b):_0x417059>0x3?_0x5c745d(_0x40e1cc,_0x858902,_0x527d6b):_0x5c745d(_0x40e1cc,_0x858902))||_0x527d6b;}return _0x417059>0x3&&_0x527d6b&&Object[_0x59171b(0x1ec)](_0x40e1cc,_0x858902,_0x527d6b),_0x527d6b;},__metadata=this&&this[a133_0x1a598e(0x1fd)]||function(_0x50826a,_0x5cfa39){const _0x5887db=a133_0x1a598e;if(typeof Reflect===_0x5887db(0x247)&&typeof Reflect['metadata']===_0x5887db(0x22d))return Reflect[_0x5887db(0x233)](_0x50826a,_0x5cfa39);},__param=this&&this['__param']||function(_0x3eda5d,_0x3b9c3f){return function(_0x426828,_0x54b8b6){_0x3b9c3f(_0x426828,_0x54b8b6,_0x3eda5d);};},SoundService_1;Object[a133_0x1a598e(0x1ec)](exports,a133_0x1a598e(0x227),{'value':!![]}),exports['SoundService']=void 0x0;const common_1=require('@nestjs/common'),mongoose_1=require('@nestjs/mongoose'),mongoose_2=require(a133_0x1a598e(0x228)),path=require(a133_0x1a598e(0x226)),event_emitter_1=require(a133_0x1a598e(0x246)),file_1=require(a133_0x1a598e(0x1ea)),agenda_service_1=require(a133_0x1a598e(0x1f8)),enums_1=require('../common/enums'),constants_1=require(a133_0x1a598e(0x243)),utils_1=require(a133_0x1a598e(0x1f7)),path_1=require(a133_0x1a598e(0x1e8)),audio_player_1=require(a133_0x1a598e(0x1dd)),sound_1=require(a133_0x1a598e(0x1e5)),job_1=require(a133_0x1a598e(0x1f2)),constants_2=require(a133_0x1a598e(0x231)),default_sounds_1=require(a133_0x1a598e(0x23d)),sound_gateway_1=require(a133_0x1a598e(0x229)),path_2=require('path'),upload_service_1=require(a133_0x1a598e(0x203)),text_to_audio_service_1=require('../text-to-audio/text-to-audio.service'),streaming_service_1=require('../streaming/streaming.service');let SoundService=SoundService_1=class SoundService{constructor(_0x42ad12,_0x2f64e8,_0x2ad8b6,_0x4f7dbd,_0x41e0d7,_0x1a33f2){const _0x48b657=a133_0x1a598e;this['soundModel']=_0x42ad12,this[_0x48b657(0x237)]=_0x2f64e8,this[_0x48b657(0x1ee)]=_0x2ad8b6,this['textToAudioService']=_0x4f7dbd,this[_0x48b657(0x250)]=_0x41e0d7,this['soundGateway']=_0x1a33f2,this[_0x48b657(0x1ef)]=new common_1[(_0x48b657(0x1f4))](SoundService_1[_0x48b657(0x219)]);}async['create'](_0x4d2da6){const _0x5c3f35=a133_0x1a598e;await this['validateAndMoveFileAsync'](_0x4d2da6,null);const _0x1c2b79=new this[(_0x5c3f35(0x238))](_0x4d2da6);return _0x1c2b79[_0x5c3f35(0x217)]();}async['findByType'](_0x17465c){const _0x44dd8f=a133_0x1a598e,_0x5651e6=await this[_0x44dd8f(0x238)][_0x44dd8f(0x21a)]({'type':_0x17465c})['exec']();return _0x5651e6;}async[a133_0x1a598e(0x230)](_0x2a24ba){const _0x226b71=a133_0x1a598e,_0x72fcd1=await this['soundModel'][_0x226b71(0x1e6)](_0x2a24ba);return _0x72fcd1;}async[a133_0x1a598e(0x1df)](_0x56b921){const _0x32ccb9=a133_0x1a598e,_0x59ced9=await this[_0x32ccb9(0x238)][_0x32ccb9(0x21a)]({'_id':{'$in':_0x56b921}});return _0x59ced9;}async[a133_0x1a598e(0x222)](_0x592b8a,_0x216c7f){const _0x280d67=a133_0x1a598e,_0x134bd5=await this[_0x280d67(0x238)]['findById'](_0x592b8a)['exec']();if(!_0x134bd5)throw new Error(_0x280d67(0x1d9));await this[_0x280d67(0x218)](_0x216c7f,_0x134bd5===null||_0x134bd5===void 0x0?void 0x0:_0x134bd5[_0x280d67(0x1f3)]);const _0x36d398=await this[_0x280d67(0x238)][_0x280d67(0x212)](_0x592b8a,Object[_0x280d67(0x24e)](Object[_0x280d67(0x24e)]({},_0x216c7f),{'updatedAtUtc':new Date()}),{'new':!![]});return _0x36d398;}async[a133_0x1a598e(0x235)](_0x1a7447,_0x400067){const _0x5081b3=a133_0x1a598e,_0x256fa0=await this[_0x5081b3(0x238)]['findById'](_0x1a7447)['exec']();if(!_0x256fa0)throw new Error(_0x5081b3(0x1d9));const _0x1c9a9f=await this['soundModel'][_0x5081b3(0x212)](_0x1a7447,Object[_0x5081b3(0x24e)](Object[_0x5081b3(0x24e)]({},_0x400067),{'updatedAtUtc':new Date()}),{'new':!![]});return _0x1c9a9f;}async['delete'](_0x1f734a){const _0xf4b837=a133_0x1a598e,_0x1e493b=await this[_0xf4b837(0x238)][_0xf4b837(0x241)](_0x1f734a);if(_0x1e493b[_0xf4b837(0x1f3)]){const _0x444223=constants_1[_0xf4b837(0x20b)]+'/'+_0x1e493b['fileName'];try{(0x0,file_1[_0xf4b837(0x215)])(_0x444223);}catch(_0x284662){this[_0xf4b837(0x1ef)][_0xf4b837(0x1e1)](_0x284662);}}return _0x1e493b;}async[a133_0x1a598e(0x21c)](_0x487960,_0x2c83f0){const _0x5f1347=a133_0x1a598e,_0x159cbb=await this[_0x5f1347(0x238)][_0x5f1347(0x1e6)](_0x487960)[_0x5f1347(0x242)](),_0x4117fa=_0x159cbb===null||_0x159cbb===void 0x0?void 0x0:_0x159cbb[_0x5f1347(0x1f3)],_0x1cefff=this[_0x5f1347(0x20a)](_0x2c83f0[_0x5f1347(0x24c)]),_0xb74231=constants_1[_0x5f1347(0x20b)]+'/'+_0x1cefff;await(0x0,file_1[_0x5f1347(0x1e7)])(_0x2c83f0[_0x5f1347(0x226)],_0xb74231);const _0x5a56c8={'fileName':_0x1cefff},_0x57a185=await this[_0x5f1347(0x238)]['findByIdAndUpdate'](_0x487960,Object[_0x5f1347(0x24e)](Object[_0x5f1347(0x24e)]({},_0x5a56c8),{'updatedAtUtc':new Date()}),{'new':!![]});if(_0x4117fa){const _0x6d9b78=constants_1[_0x5f1347(0x20b)]+'/'+_0x4117fa;(0x0,file_1['deleteFile'])(_0x6d9b78);}return _0x57a185;}async[a133_0x1a598e(0x21d)](_0x4d5fa6){const _0x2def61=a133_0x1a598e,{soundId:_0x4387f6,jobId:_0x21e9d0,durationInSecond:_0x2797c3}=_0x4d5fa6,_0x4198a6=await this[_0x2def61(0x230)](_0x4387f6),_0x1824dc=path[_0x2def61(0x206)](path_1[_0x2def61(0x1f6)],_0x2def61(0x22b),_0x2def61(0x214),_0x4198a6[_0x2def61(0x1f3)]);job_1['PROCESS_CACHE'][_0x2def61(0x202)](),this[_0x2def61(0x1ef)][_0x2def61(0x24a)](_0x2def61(0x200)+_0x4387f6+'\x20-\x20'+_0x4198a6[_0x2def61(0x219)]),(0x0,job_1[_0x2def61(0x1f1)])({'jobId':_0x21e9d0,'run':()=>audio_player_1[_0x2def61(0x220)][_0x2def61(0x1eb)](_0x1824dc,_0x4198a6[_0x2def61(0x221)]),'next':()=>this['stop'](_0x4387f6),'durationInSecond':_0x2797c3}),this[_0x2def61(0x1e3)]['broadcastPlaying']({'id':_0x4387f6,'isPlaying':!![]});}async[a133_0x1a598e(0x1ed)](_0x540997){const _0x128a79=a133_0x1a598e,{voiceId:_0x1000ad,jobId:_0x2963d7,durationInSecond:_0xaa207f}=_0x540997,_0x4c6c53=await this[_0x128a79(0x1ee)]['findVoiceRecoredById'](_0x1000ad),_0x13a6b6=_0x4c6c53[_0x128a79(0x1da)],_0x16f546=(0x0,path_2[_0x128a79(0x206)])(process[_0x128a79(0x20c)](),_0x13a6b6);job_1[_0x128a79(0x207)][_0x128a79(0x202)](),this['logger']['log'](_0x128a79(0x224)+_0x1000ad),(0x0,job_1[_0x128a79(0x1f1)])({'jobId':_0x2963d7,'run':()=>audio_player_1[_0x128a79(0x220)][_0x128a79(0x1eb)](_0x16f546),'durationInSecond':_0xaa207f,'next':()=>null});}async[a133_0x1a598e(0x1fa)](_0x3bd4ed){const _0x13c748=a133_0x1a598e,{textToAudioId:_0x49deef,jobId:_0x3ea009,durationInSecond:_0x2b2971}=_0x3bd4ed,{message:_0x1724c2}=await this[_0x13c748(0x20f)]['getMessageById'](_0x49deef);job_1[_0x13c748(0x207)]['killAll'](),(0x0,job_1['executeJob'])({'jobId':_0x3ea009,'run':()=>{const _0x1a4994=_0x13c748;let _0x51d669=null;return this['textToAudioService'][_0x1a4994(0x1f0)](_0x1724c2,_0x50dedd=>{const _0x50a4c3=_0x1a4994;_0x51d669=this[_0x50a4c3(0x250)][_0x50a4c3(0x225)](_0x50dedd);}),_0x51d669;},'durationInSecond':_0x2b2971,'next':()=>null});}async[a133_0x1a598e(0x24b)](_0x3f7e4b,_0x4806da,_0x277835=![]){const _0x2644da=a133_0x1a598e,_0x5d9c0b={'when':_0x2644da(0x22c),'jobType':enums_1['JobType']['PlaySound'],'attributes':{'soundId':_0x4806da,'durationInSecond':_0x277835?0x15180:undefined},'audit':{'actor':_0x3f7e4b,'name':enums_1[_0x2644da(0x201)][_0x2644da(0x205)],'message':'Play\x20sound:\x20'+_0x4806da}},_0x545837=await this[_0x2644da(0x238)][_0x2644da(0x230)]({'jobId':{'$ne':null}});_0x545837&&await this[_0x2644da(0x21b)](_0x545837['id']);const {jobId:_0x5cb9ef}=await this[_0x2644da(0x237)]['scheduleJob'](_0x5d9c0b);return this[_0x2644da(0x222)](_0x4806da,{'jobId':_0x5cb9ef});}async[a133_0x1a598e(0x21b)](_0x1b9191){const _0x45a99f=a133_0x1a598e;let _0x48925a=await this[_0x45a99f(0x230)](_0x1b9191);const {jobId:_0x48c895}=_0x48925a||{};if(_0x48c895){const {success:_0x40b9a2}=await this['agendaService'][_0x45a99f(0x1db)](_0x48c895);_0x40b9a2&&(_0x48925a=await this[_0x45a99f(0x222)](_0x1b9191,{'jobId':null}));}return this[_0x45a99f(0x1e3)][_0x45a99f(0x209)]({'id':_0x48925a['id'],'isPlaying':![]}),_0x48925a;}async['resetTunes'](){const _0xe2d20f=a133_0x1a598e,_0xa9aa0c=await this['findByType'](constants_2[_0xe2d20f(0x240)][_0xe2d20f(0x1fe)]);if(_0xa9aa0c[_0xe2d20f(0x210)]>0x0){const _0x5e301a=[];_0xa9aa0c[_0xe2d20f(0x21f)](_0xaa2bc8=>{const _0x897f26=_0xe2d20f;_0x5e301a[_0x897f26(0x20e)](this['delete'](_0xaa2bc8[_0x897f26(0x249)]));}),await Promise['all'](_0x5e301a);}await(0x0,file_1[_0xe2d20f(0x1d8)])(constants_1[_0xe2d20f(0x1e2)],constants_1[_0xe2d20f(0x1e0)]);const _0x22cbd6=[];return default_sounds_1['DEFAULT_TUNES'][_0xe2d20f(0x21f)](_0x2627d0=>{const _0x2991bd=_0xe2d20f;_0x22cbd6[_0x2991bd(0x20e)](this[_0x2991bd(0x1e4)](Object[_0x2991bd(0x24e)]({},_0x2627d0)));}),await Promise[_0xe2d20f(0x232)](_0x22cbd6),!![];}[a133_0x1a598e(0x20a)](_0x43cc86){const _0x388c5f=a133_0x1a598e,_0x18351f=_0x43cc86[_0x388c5f(0x1f9)]('.')[_0x388c5f(0x22f)]();return(0x0,utils_1[_0x388c5f(0x23b)])()+'.'+_0x18351f;}async[a133_0x1a598e(0x218)](_0x407aca,_0x48a978){const _0x47ba94=a133_0x1a598e;if(!_0x407aca[_0x47ba94(0x1f3)])return;const _0x4ddb74=constants_1[_0x47ba94(0x1e0)]+'/'+_0x407aca[_0x47ba94(0x1f3)],_0xd531f9=_0x48a978||this[_0x47ba94(0x20a)](_0x407aca[_0x47ba94(0x1f3)]),_0x4c6f4e=constants_1[_0x47ba94(0x20b)]+'/'+_0xd531f9;if(!(0x0,file_1['isFileExist'])(_0x4ddb74))throw new Error(_0x47ba94(0x23a));!(0x0,file_1[_0x47ba94(0x21e)])(constants_1[_0x47ba94(0x20b)])&&(0x0,file_1[_0x47ba94(0x23f)])(constants_1[_0x47ba94(0x20b)]),await(0x0,file_1['moveFile'])(_0x4ddb74,_0x4c6f4e),_0x407aca[_0x47ba94(0x1f3)]=_0xd531f9;}};__decorate([(0x0,event_emitter_1['OnEvent'])(sound_1[a133_0x1a598e(0x20d)]['Play']),__metadata(a133_0x1a598e(0x211),Function),__metadata('design:paramtypes',[Object]),__metadata(a133_0x1a598e(0x1f5),Promise)],SoundService['prototype'],a133_0x1a598e(0x21d),null),__decorate([(0x0,event_emitter_1['OnEvent'])(sound_1['SoundEvent'][a133_0x1a598e(0x1fb)]),__metadata(a133_0x1a598e(0x211),Function),__metadata(a133_0x1a598e(0x208),[Object]),__metadata(a133_0x1a598e(0x1f5),Promise)],SoundService['prototype'],'playVoiceRecorded',null),__decorate([(0x0,event_emitter_1[a133_0x1a598e(0x239)])(sound_1[a133_0x1a598e(0x20d)][a133_0x1a598e(0x22a)]),__metadata('design:type',Function),__metadata(a133_0x1a598e(0x208),[Object]),__metadata(a133_0x1a598e(0x1f5),Promise)],SoundService[a133_0x1a598e(0x216)],a133_0x1a598e(0x1fa),null),SoundService=SoundService_1=__decorate([(0x0,common_1[a133_0x1a598e(0x245)])(),__param(0x0,(0x0,mongoose_1[a133_0x1a598e(0x1fc)])('Sound')),__param(0x5,(0x0,common_1[a133_0x1a598e(0x213)])(sound_gateway_1[a133_0x1a598e(0x1dc)])),__metadata('design:paramtypes',[mongoose_2[a133_0x1a598e(0x248)],agenda_service_1[a133_0x1a598e(0x244)],upload_service_1[a133_0x1a598e(0x24f)],text_to_audio_service_1[a133_0x1a598e(0x23c)],streaming_service_1[a133_0x1a598e(0x251)],sound_gateway_1[a133_0x1a598e(0x1dc)]])],SoundService),exports[a133_0x1a598e(0x22e)]=SoundService;