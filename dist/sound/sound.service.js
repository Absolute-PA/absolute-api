'use strict';function a136_0x38ac(_0x5c0af4,_0x276cae){const _0x44a427=a136_0x44a4();return a136_0x38ac=function(_0x38ac45,_0xcd3d83){_0x38ac45=_0x38ac45-0xa0;let _0x493168=_0x44a427[_0x38ac45];return _0x493168;},a136_0x38ac(_0x5c0af4,_0x276cae);}const a136_0x577106=a136_0x38ac;(function(_0x35452b,_0x17b152){const _0x1f2baf=a136_0x38ac,_0x50eb9d=_0x35452b();while(!![]){try{const _0xa5a59c=parseInt(_0x1f2baf(0x110))/0x1*(-parseInt(_0x1f2baf(0xa1))/0x2)+parseInt(_0x1f2baf(0x111))/0x3+-parseInt(_0x1f2baf(0x10b))/0x4+-parseInt(_0x1f2baf(0xd6))/0x5*(-parseInt(_0x1f2baf(0xc4))/0x6)+parseInt(_0x1f2baf(0xaf))/0x7*(-parseInt(_0x1f2baf(0xf2))/0x8)+-parseInt(_0x1f2baf(0xf4))/0x9*(parseInt(_0x1f2baf(0xb1))/0xa)+parseInt(_0x1f2baf(0xbf))/0xb;if(_0xa5a59c===_0x17b152)break;else _0x50eb9d['push'](_0x50eb9d['shift']());}catch(_0x577c38){_0x50eb9d['push'](_0x50eb9d['shift']());}}}(a136_0x44a4,0x62eb8));var __decorate=this&&this['__decorate']||function(_0x2fb466,_0x30a249,_0x136121,_0x3ed29a){const _0x3744ee=a136_0x38ac;var _0x424f8a=arguments['length'],_0x40185e=_0x424f8a<0x3?_0x30a249:_0x3ed29a===null?_0x3ed29a=Object[_0x3744ee(0xb5)](_0x30a249,_0x136121):_0x3ed29a,_0x4f7a29;if(typeof Reflect===_0x3744ee(0xa2)&&typeof Reflect['decorate']===_0x3744ee(0xf6))_0x40185e=Reflect[_0x3744ee(0x116)](_0x2fb466,_0x30a249,_0x136121,_0x3ed29a);else{for(var _0x4afec4=_0x2fb466[_0x3744ee(0xed)]-0x1;_0x4afec4>=0x0;_0x4afec4--)if(_0x4f7a29=_0x2fb466[_0x4afec4])_0x40185e=(_0x424f8a<0x3?_0x4f7a29(_0x40185e):_0x424f8a>0x3?_0x4f7a29(_0x30a249,_0x136121,_0x40185e):_0x4f7a29(_0x30a249,_0x136121))||_0x40185e;}return _0x424f8a>0x3&&_0x40185e&&Object[_0x3744ee(0x107)](_0x30a249,_0x136121,_0x40185e),_0x40185e;},__metadata=this&&this[a136_0x577106(0x106)]||function(_0x179498,_0x3b24ca){const _0x5975b8=a136_0x577106;if(typeof Reflect===_0x5975b8(0xa2)&&typeof Reflect[_0x5975b8(0x11a)]===_0x5975b8(0xf6))return Reflect[_0x5975b8(0x11a)](_0x179498,_0x3b24ca);},__param=this&&this[a136_0x577106(0xe5)]||function(_0x36b055,_0x3a9941){return function(_0x596c05,_0x1ebca1){_0x3a9941(_0x596c05,_0x1ebca1,_0x36b055);};},SoundService_1;function a136_0x44a4(){const _0x501f9b=['2970CHOzZX','Voice\x20file\x20not\x20found:\x20','textToAudioService','playVoiceRecorded','TextToAudio','streamingService','prototype','@nestjs/event-emitter','SoundEvent','findById','SoundGateway','textToAudio','design:type','path','TMP_UPLOAD_DIR','__param','../text-to-audio/text-to-audio.service','push','updateVolume','getNewFileName','../upload/upload.service','find','../common/events/sound','length','forEach','isFileExist','all','playStreamAudioAsync','14056XQUqcP','volume','9IlRVCf','join','function','../common/utils','logger','update','log','broadcastPlaying','playSoundOnEvent','split','validateAndMoveFileAsync','cwd','findByIds','upload','SoundService','playTextToAudioRecorded','findByIdAndUpdate','findOne','__metadata','defineProperty','assign','./sound.gateway','VoiceRecorded','680396xaixzQ','JobType','audio','Injectable','StreamingService','22721jipCWq','1940385mwGyNJ','stop','../streaming/streaming.service','@nestjs/common','../common/file','decorate','error','File\x20not\x20found!','AudioPlayer','metadata','pop','28AFXLlh','object','Playing\x20sound:\x20','Tune','exec','InjectModel','AgendaService','soundGateway','playAsync','design:returntype','killAll','name','soundModel','delete','1316smoWxx','DEFAULT_TUNES','7291680RGKgNG','scheduleJob','resetTunes','SoundType','getOwnPropertyDescriptor','deleteFile','DEFAULT_TUNES_DIR','uploadService','\x20-\x20','Sound\x20file\x20not\x20found:\x20','executeJob','@nestjs/mongoose','../common/job','agendaService','9165574krYwsk','getMessageById','filePath','create','mongoose','4776kqgZuc','AUDIO_DIR','../common/audio/audio-player','Sound\x20not\x20found!','UploadService','findVoiceRecoredById','Play','fileName','moveFile','findByIdAndDelete','Play\x20sound:\x20','Model','findByType','OnEvent','design:paramtypes','PROCESS_CACHE','../common/path','createFolder'];a136_0x44a4=function(){return _0x501f9b;};return a136_0x44a4();}Object[a136_0x577106(0x107)](exports,'__esModule',{'value':!![]}),exports[a136_0x577106(0x102)]=void 0x0;const common_1=require(a136_0x577106(0x114)),mongoose_1=require(a136_0x577106(0xbc)),mongoose_2=require(a136_0x577106(0xc3)),path=require('path'),event_emitter_1=require(a136_0x577106(0xdd)),file_1=require(a136_0x577106(0x115)),agenda_service_1=require('../agenda/agenda.service'),enums_1=require('../common/enums'),constants_1=require('../common/constants'),utils_1=require(a136_0x577106(0xf7)),path_1=require(a136_0x577106(0xd4)),audio_player_1=require(a136_0x577106(0xc6)),sound_1=require(a136_0x577106(0xec)),job_1=require(a136_0x577106(0xbd)),constants_2=require('./constants'),default_sounds_1=require('./data/default-sounds'),sound_gateway_1=require(a136_0x577106(0x109)),path_2=require('path'),upload_service_1=require(a136_0x577106(0xea)),text_to_audio_service_1=require(a136_0x577106(0xe6)),streaming_service_1=require(a136_0x577106(0x113));let SoundService=SoundService_1=class SoundService{constructor(_0x3c3eb4,_0x45ca56,_0x5cefc8,_0x3194d5,_0x49d8d3,_0x4a7584){const _0x4f0a19=a136_0x577106;this[_0x4f0a19(0xad)]=_0x3c3eb4,this[_0x4f0a19(0xbe)]=_0x45ca56,this[_0x4f0a19(0xb8)]=_0x5cefc8,this['textToAudioService']=_0x3194d5,this[_0x4f0a19(0xdb)]=_0x49d8d3,this[_0x4f0a19(0xa8)]=_0x4a7584,this[_0x4f0a19(0xf8)]=new common_1['Logger'](SoundService_1['name']);}async[a136_0x577106(0xc2)](_0x711238){const _0x500fb5=a136_0x577106;await this[_0x500fb5(0xfe)](_0x711238,null);const _0x18a463=new this[(_0x500fb5(0xad))](_0x711238);return _0x18a463['save']();}async[a136_0x577106(0xd0)](_0x78946b){const _0x1a3306=a136_0x577106,_0x3743a7=await this[_0x1a3306(0xad)][_0x1a3306(0xeb)]({'type':_0x78946b})[_0x1a3306(0xa5)]();return _0x3743a7;}async['findOne'](_0x3b3a8d){const _0x1dcf61=a136_0x577106,_0x3450b6=await this[_0x1dcf61(0xad)][_0x1dcf61(0xdf)](_0x3b3a8d);return _0x3450b6;}async[a136_0x577106(0x100)](_0x197a59){const _0x451206=a136_0x577106,_0x1879cc=await this['soundModel'][_0x451206(0xeb)]({'_id':{'$in':_0x197a59}});return _0x1879cc;}async['update'](_0x4c39df,_0x1e4b03){const _0x4a8a00=a136_0x577106,_0x46fab6=await this[_0x4a8a00(0xad)][_0x4a8a00(0xdf)](_0x4c39df)[_0x4a8a00(0xa5)]();if(!_0x46fab6)throw new Error('Sound\x20not\x20found!');await this[_0x4a8a00(0xfe)](_0x1e4b03,_0x46fab6===null||_0x46fab6===void 0x0?void 0x0:_0x46fab6[_0x4a8a00(0xcb)]);const _0x2ceeaa=await this[_0x4a8a00(0xad)]['findByIdAndUpdate'](_0x4c39df,Object[_0x4a8a00(0x108)](Object[_0x4a8a00(0x108)]({},_0x1e4b03),{'updatedAtUtc':new Date()}),{'new':!![]});return _0x2ceeaa;}async[a136_0x577106(0xe8)](_0x1c632d,_0x56f027){const _0x5805f3=a136_0x577106,_0x3ffbf3=await this[_0x5805f3(0xad)][_0x5805f3(0xdf)](_0x1c632d)[_0x5805f3(0xa5)]();if(!_0x3ffbf3)throw new Error(_0x5805f3(0xc7));const _0x316b30=await this[_0x5805f3(0xad)][_0x5805f3(0x104)](_0x1c632d,Object[_0x5805f3(0x108)](Object[_0x5805f3(0x108)]({},_0x56f027),{'updatedAtUtc':new Date()}),{'new':!![]});return _0x316b30;}async[a136_0x577106(0xae)](_0x1e1ac2){const _0x38ed94=a136_0x577106,_0x2d2a8f=await this['soundModel'][_0x38ed94(0xcd)](_0x1e1ac2);if(_0x2d2a8f[_0x38ed94(0xcb)]){const _0xe186c4=constants_1[_0x38ed94(0xc5)]+'/'+_0x2d2a8f[_0x38ed94(0xcb)];try{(0x0,file_1['deleteFile'])(_0xe186c4);}catch(_0x3d7c78){this['logger'][_0x38ed94(0x117)](_0x3d7c78);}}return _0x2d2a8f;}async[a136_0x577106(0x101)](_0x44fcbe,_0x372813){const _0x1807f8=a136_0x577106,_0x33075d=await this[_0x1807f8(0xad)]['findById'](_0x44fcbe)[_0x1807f8(0xa5)](),_0x4d5016=_0x33075d===null||_0x33075d===void 0x0?void 0x0:_0x33075d[_0x1807f8(0xcb)],_0x50eaa4=this[_0x1807f8(0xe9)](_0x372813['originalname']),_0x2272c9=constants_1[_0x1807f8(0xc5)]+'/'+_0x50eaa4;await(0x0,file_1[_0x1807f8(0xcc)])(_0x372813[_0x1807f8(0xe3)],_0x2272c9);const _0x1d695e={'fileName':_0x50eaa4},_0x433951=await this['soundModel'][_0x1807f8(0x104)](_0x44fcbe,Object[_0x1807f8(0x108)](Object['assign']({},_0x1d695e),{'updatedAtUtc':new Date()}),{'new':!![]});if(_0x4d5016){const _0x14cf1d=constants_1[_0x1807f8(0xc5)]+'/'+_0x4d5016;(0x0,file_1[_0x1807f8(0xb6)])(_0x14cf1d);}return _0x433951;}async[a136_0x577106(0xfc)](_0x5b687d){const _0xc8d155=a136_0x577106,{soundId:_0x49fb54,jobId:_0x1c58db,durationInSecond:_0x34e2ea}=_0x5b687d,_0x59d5c3=await this['findOne'](_0x49fb54),_0x1c7879=path[_0xc8d155(0xf5)](path_1['processRootPath'],'assets',_0xc8d155(0x10d),_0x59d5c3[_0xc8d155(0xcb)]);if(!(0x0,file_1[_0xc8d155(0xef)])(_0x1c7879)){this[_0xc8d155(0xf8)][_0xc8d155(0x117)](_0xc8d155(0xba)+_0x1c7879);return;}job_1[_0xc8d155(0xd3)][_0xc8d155(0xab)](),this[_0xc8d155(0xf8)]['log'](_0xc8d155(0xa3)+_0x49fb54+_0xc8d155(0xb9)+_0x59d5c3[_0xc8d155(0xac)]),(0x0,job_1[_0xc8d155(0xbb)])({'jobId':_0x1c58db,'run':()=>audio_player_1[_0xc8d155(0x119)][_0xc8d155(0xa9)](_0x1c7879,_0x59d5c3[_0xc8d155(0xf3)]),'next':()=>this[_0xc8d155(0x112)](_0x49fb54),'durationInSecond':_0x34e2ea}),this[_0xc8d155(0xa8)]['broadcastPlaying']({'id':_0x49fb54,'isPlaying':!![]});}async['playVoiceRecorded'](_0x444247){const _0x1d8980=a136_0x577106,{voiceId:_0x25d615,jobId:_0x595fe1,durationInSecond:_0x5a1545}=_0x444247,_0x5e6b72=await this[_0x1d8980(0xb8)][_0x1d8980(0xc9)](_0x25d615),_0x5233b9=_0x5e6b72[_0x1d8980(0xc1)],_0x5a43f3=(0x0,path_2['join'])(process[_0x1d8980(0xff)](),_0x5233b9);if(!(0x0,file_1[_0x1d8980(0xef)])(_0x5a43f3)){this[_0x1d8980(0xf8)][_0x1d8980(0x117)](_0x1d8980(0xd7)+_0x5a43f3);return;}job_1['PROCESS_CACHE'][_0x1d8980(0xab)](),this['logger'][_0x1d8980(0xfa)]('Playing\x20voice\x20recorded:\x20'+_0x25d615),(0x0,job_1['executeJob'])({'jobId':_0x595fe1,'run':()=>audio_player_1[_0x1d8980(0x119)][_0x1d8980(0xa9)](_0x5a43f3),'durationInSecond':_0x5a1545,'next':()=>null});}async['playTextToAudioRecorded'](_0x326c07){const _0x55b1e5=a136_0x577106,{textToAudioId:_0x467341,jobId:_0x118499,durationInSecond:_0x391651}=_0x326c07,{message:_0x5abf7e}=await this[_0x55b1e5(0xd8)][_0x55b1e5(0xc0)](_0x467341);job_1['PROCESS_CACHE'][_0x55b1e5(0xab)](),(0x0,job_1[_0x55b1e5(0xbb)])({'jobId':_0x118499,'run':()=>{const _0x1d1a8a=_0x55b1e5;let _0x26f3e4=null;return this[_0x1d1a8a(0xd8)][_0x1d1a8a(0xe1)](_0x5abf7e,_0x3906c5=>{const _0x54c962=_0x1d1a8a;_0x26f3e4=this['streamingService'][_0x54c962(0xf1)](_0x3906c5);}),_0x26f3e4;},'durationInSecond':_0x391651,'next':()=>null});}async['play'](_0x2ec31f,_0x396fc1,_0x1ddfa0=![]){const _0x1b4b50=a136_0x577106,_0x5713e9={'when':'now','jobType':enums_1[_0x1b4b50(0x10c)]['PlaySound'],'attributes':{'soundId':_0x396fc1,'durationInSecond':_0x1ddfa0?0x15180:undefined},'audit':{'actor':_0x2ec31f,'name':enums_1[_0x1b4b50(0x10c)]['PlaySound'],'message':_0x1b4b50(0xce)+_0x396fc1}},_0x56f33d=await this[_0x1b4b50(0xad)][_0x1b4b50(0x105)]({'jobId':{'$ne':null}});_0x56f33d&&await this[_0x1b4b50(0x112)](_0x56f33d['id']);const {jobId:_0x21a63d}=await this[_0x1b4b50(0xbe)][_0x1b4b50(0xb2)](_0x5713e9);return this[_0x1b4b50(0xf9)](_0x396fc1,{'jobId':_0x21a63d});}async[a136_0x577106(0x112)](_0x265f05){const _0x233ab7=a136_0x577106;let _0x45da6b=await this['findOne'](_0x265f05);const {jobId:_0x2f1283}=_0x45da6b||{};if(_0x2f1283){const {success:_0x358320}=await this['agendaService']['cancelJob'](_0x2f1283);_0x358320&&(_0x45da6b=await this[_0x233ab7(0xf9)](_0x265f05,{'jobId':null}));}return this[_0x233ab7(0xa8)][_0x233ab7(0xfb)]({'id':_0x45da6b['id'],'isPlaying':![]}),_0x45da6b;}async[a136_0x577106(0xb3)](){const _0x26ecbb=a136_0x577106,_0xa36921=await this[_0x26ecbb(0xd0)](constants_2[_0x26ecbb(0xb4)][_0x26ecbb(0xa4)]);if(_0xa36921[_0x26ecbb(0xed)]>0x0){const _0x237a50=[];_0xa36921['forEach'](_0x430c9d=>{const _0x21a3ac=_0x26ecbb;_0x237a50[_0x21a3ac(0xe7)](this[_0x21a3ac(0xae)](_0x430c9d['_id']));}),await Promise['all'](_0x237a50);}await(0x0,file_1['copyFiles'])(constants_1[_0x26ecbb(0xb7)],constants_1['TMP_UPLOAD_DIR']);const _0x1b5192=[];return default_sounds_1[_0x26ecbb(0xb0)][_0x26ecbb(0xee)](_0x345cf3=>{const _0x5f3f26=_0x26ecbb;_0x1b5192[_0x5f3f26(0xe7)](this[_0x5f3f26(0xc2)](Object[_0x5f3f26(0x108)]({},_0x345cf3)));}),await Promise[_0x26ecbb(0xf0)](_0x1b5192),!![];}[a136_0x577106(0xe9)](_0x159c79){const _0x2290c6=a136_0x577106,_0x5b89bd=_0x159c79[_0x2290c6(0xfd)]('.')[_0x2290c6(0xa0)]();return(0x0,utils_1['uuid'])()+'.'+_0x5b89bd;}async['validateAndMoveFileAsync'](_0x3b9067,_0x156f50){const _0x472cb5=a136_0x577106;if(!_0x3b9067[_0x472cb5(0xcb)])return;const _0x138b8d=constants_1[_0x472cb5(0xe4)]+'/'+_0x3b9067[_0x472cb5(0xcb)],_0x3d7942=_0x156f50||this['getNewFileName'](_0x3b9067[_0x472cb5(0xcb)]),_0x51fd39=constants_1[_0x472cb5(0xc5)]+'/'+_0x3d7942;if(!(0x0,file_1[_0x472cb5(0xef)])(_0x138b8d))throw new Error(_0x472cb5(0x118));!(0x0,file_1[_0x472cb5(0xef)])(constants_1[_0x472cb5(0xc5)])&&(0x0,file_1[_0x472cb5(0xd5)])(constants_1[_0x472cb5(0xc5)]),await(0x0,file_1['moveFile'])(_0x138b8d,_0x51fd39),_0x3b9067[_0x472cb5(0xcb)]=_0x3d7942;}};__decorate([(0x0,event_emitter_1[a136_0x577106(0xd1)])(sound_1[a136_0x577106(0xde)][a136_0x577106(0xca)]),__metadata('design:type',Function),__metadata('design:paramtypes',[Object]),__metadata(a136_0x577106(0xaa),Promise)],SoundService['prototype'],a136_0x577106(0xfc),null),__decorate([(0x0,event_emitter_1[a136_0x577106(0xd1)])(sound_1[a136_0x577106(0xde)][a136_0x577106(0x10a)]),__metadata(a136_0x577106(0xe2),Function),__metadata(a136_0x577106(0xd2),[Object]),__metadata('design:returntype',Promise)],SoundService[a136_0x577106(0xdc)],a136_0x577106(0xd9),null),__decorate([(0x0,event_emitter_1[a136_0x577106(0xd1)])(sound_1['SoundEvent'][a136_0x577106(0xda)]),__metadata(a136_0x577106(0xe2),Function),__metadata(a136_0x577106(0xd2),[Object]),__metadata('design:returntype',Promise)],SoundService[a136_0x577106(0xdc)],a136_0x577106(0x103),null),SoundService=SoundService_1=__decorate([(0x0,common_1[a136_0x577106(0x10e)])(),__param(0x0,(0x0,mongoose_1[a136_0x577106(0xa6)])('Sound')),__param(0x5,(0x0,common_1['Inject'])(sound_gateway_1[a136_0x577106(0xe0)])),__metadata(a136_0x577106(0xd2),[mongoose_2[a136_0x577106(0xcf)],agenda_service_1[a136_0x577106(0xa7)],upload_service_1[a136_0x577106(0xc8)],text_to_audio_service_1['TextToAudioService'],streaming_service_1[a136_0x577106(0x10f)],sound_gateway_1['SoundGateway']])],SoundService),exports[a136_0x577106(0x102)]=SoundService;