'use strict';const a133_0x4a7bf8=a133_0x1adf;(function(_0x3aa1bc,_0xeac99){const _0x5e848e=a133_0x1adf,_0x30afff=_0x3aa1bc();while(!![]){try{const _0x550c14=parseInt(_0x5e848e(0x191))/0x1*(-parseInt(_0x5e848e(0x150))/0x2)+parseInt(_0x5e848e(0x15a))/0x3+-parseInt(_0x5e848e(0x131))/0x4+-parseInt(_0x5e848e(0x174))/0x5*(-parseInt(_0x5e848e(0x141))/0x6)+-parseInt(_0x5e848e(0x15e))/0x7*(parseInt(_0x5e848e(0x173))/0x8)+-parseInt(_0x5e848e(0x182))/0x9*(parseInt(_0x5e848e(0x13e))/0xa)+parseInt(_0x5e848e(0x16f))/0xb*(parseInt(_0x5e848e(0x13d))/0xc);if(_0x550c14===_0xeac99)break;else _0x30afff['push'](_0x30afff['shift']());}catch(_0x4c9ddf){_0x30afff['push'](_0x30afff['shift']());}}}(a133_0x1ee8,0xe8894));function a133_0x1ee8(){const _0x25c3cb=['prototype','design:returntype','findVoiceRecoredById','66sSkZjl','../common/utils','defineProperty','soundGateway','10601576LSifxt','25TFTkZH','cancelJob','DEFAULT_TUNES_DIR','Sound','all','executeJob','@nestjs/mongoose','killAll','resetTunes','../common/events/sound','JobType','../text-to-audio/text-to-audio.service','soundModel','push','6668325NjgXgS','playAsync','playVoiceRecorded','join','upload','processRootPath','\x20-\x20','TextToAudioService','agendaService','metadata','create','SoundType','../common/path','now','object','152tvXwad','Play\x20sound:\x20','../common/job','__param','__decorate','@nestjs/common','getOwnPropertyDescriptor','playSoundOnEvent','uploadService','findOne','Injectable','save','../agenda/agenda.service','fileName','Inject','pop','AUDIO_DIR','Playing\x20sound:\x20','@nestjs/event-emitter','find','SoundEvent','__esModule','VoiceRecorded','findByIdAndDelete','textToAudioService','design:type','mongoose','2326064QQJhUI','PlaySound','playStreamAudioAsync','isFileExist','logger','findByType','scheduleJob','InjectModel','Logger','play','StreamingService','assets','5208708vLqmbK','20ymfmBO','OnEvent','Play','2116104RUhHHp','../common/enums','exec','DEFAULT_TUNES','validateAndMoveFileAsync','function','cwd','findByIdAndUpdate','forEach','uuid','audio','PROCESS_CACHE','playTextToAudioRecorded','delete','../upload/upload.service','14852ESWwAJ','Sound\x20not\x20found!','./sound.gateway','../common/file','Model','streamingService','split','decorate','AudioPlayer','getMessageById','3306027ZkVLqH','assign','createFolder','update','7CNSOjs','moveFile','TextToAudio','broadcastPlaying','name','SoundService','textToAudio','stop','getNewFileName','AgendaService','path','length','findById','log'];a133_0x1ee8=function(){return _0x25c3cb;};return a133_0x1ee8();}function a133_0x1adf(_0x1b5a92,_0x338ff1){const _0x1ee8dc=a133_0x1ee8();return a133_0x1adf=function(_0x1adf4b,_0x2edb9b){_0x1adf4b=_0x1adf4b-0x11b;let _0x2934c4=_0x1ee8dc[_0x1adf4b];return _0x2934c4;},a133_0x1adf(_0x1b5a92,_0x338ff1);}var __decorate=this&&this[a133_0x4a7bf8(0x195)]||function(_0x426181,_0x46f3b2,_0x5458e1,_0x111d96){const _0x14551b=a133_0x4a7bf8;var _0x4fca79=arguments[_0x14551b(0x169)],_0x51095d=_0x4fca79<0x3?_0x46f3b2:_0x111d96===null?_0x111d96=Object[_0x14551b(0x11c)](_0x46f3b2,_0x5458e1):_0x111d96,_0x1849a2;if(typeof Reflect==='object'&&typeof Reflect[_0x14551b(0x157)]===_0x14551b(0x146))_0x51095d=Reflect[_0x14551b(0x157)](_0x426181,_0x46f3b2,_0x5458e1,_0x111d96);else{for(var _0x58c22c=_0x426181[_0x14551b(0x169)]-0x1;_0x58c22c>=0x0;_0x58c22c--)if(_0x1849a2=_0x426181[_0x58c22c])_0x51095d=(_0x4fca79<0x3?_0x1849a2(_0x51095d):_0x4fca79>0x3?_0x1849a2(_0x46f3b2,_0x5458e1,_0x51095d):_0x1849a2(_0x46f3b2,_0x5458e1))||_0x51095d;}return _0x4fca79>0x3&&_0x51095d&&Object[_0x14551b(0x171)](_0x46f3b2,_0x5458e1,_0x51095d),_0x51095d;},__metadata=this&&this['__metadata']||function(_0x339063,_0x34af94){const _0x28252c=a133_0x4a7bf8;if(typeof Reflect===_0x28252c(0x190)&&typeof Reflect['metadata']===_0x28252c(0x146))return Reflect[_0x28252c(0x18b)](_0x339063,_0x34af94);},__param=this&&this[a133_0x4a7bf8(0x194)]||function(_0x4d8c33,_0x8b5d67){return function(_0xedcb23,_0x5e87bd){_0x8b5d67(_0xedcb23,_0x5e87bd,_0x4d8c33);};},SoundService_1;Object[a133_0x4a7bf8(0x171)](exports,a133_0x4a7bf8(0x12b),{'value':!![]}),exports[a133_0x4a7bf8(0x163)]=void 0x0;const common_1=require(a133_0x4a7bf8(0x11b)),mongoose_1=require(a133_0x4a7bf8(0x17a)),mongoose_2=require(a133_0x4a7bf8(0x130)),path=require(a133_0x4a7bf8(0x168)),event_emitter_1=require(a133_0x4a7bf8(0x128)),file_1=require(a133_0x4a7bf8(0x153)),agenda_service_1=require(a133_0x4a7bf8(0x122)),enums_1=require(a133_0x4a7bf8(0x142)),constants_1=require('../common/constants'),utils_1=require(a133_0x4a7bf8(0x170)),path_1=require(a133_0x4a7bf8(0x18e)),audio_player_1=require('../common/audio/audio-player'),sound_1=require(a133_0x4a7bf8(0x17d)),job_1=require(a133_0x4a7bf8(0x193)),constants_2=require('./constants'),default_sounds_1=require('./data/default-sounds'),sound_gateway_1=require(a133_0x4a7bf8(0x152)),path_2=require(a133_0x4a7bf8(0x168)),upload_service_1=require(a133_0x4a7bf8(0x14f)),text_to_audio_service_1=require(a133_0x4a7bf8(0x17f)),streaming_service_1=require('../streaming/streaming.service');let SoundService=SoundService_1=class SoundService{constructor(_0x23b0d6,_0x415183,_0x4e3658,_0x5a5f45,_0x2f3ed4,_0x22a02c){const _0x24270a=a133_0x4a7bf8;this[_0x24270a(0x180)]=_0x23b0d6,this[_0x24270a(0x18a)]=_0x415183,this[_0x24270a(0x11e)]=_0x4e3658,this[_0x24270a(0x12e)]=_0x5a5f45,this['streamingService']=_0x2f3ed4,this[_0x24270a(0x172)]=_0x22a02c,this[_0x24270a(0x135)]=new common_1[(_0x24270a(0x139))](SoundService_1[_0x24270a(0x162)]);}async[a133_0x4a7bf8(0x18c)](_0x512b86){const _0x5c1119=a133_0x4a7bf8;await this[_0x5c1119(0x145)](_0x512b86,null);const _0x4107e3=new this[(_0x5c1119(0x180))](_0x512b86);return _0x4107e3[_0x5c1119(0x121)]();}async[a133_0x4a7bf8(0x136)](_0x2ec852){const _0x41ba04=a133_0x4a7bf8,_0x385076=await this[_0x41ba04(0x180)][_0x41ba04(0x129)]({'type':_0x2ec852})[_0x41ba04(0x143)]();return _0x385076;}async[a133_0x4a7bf8(0x11f)](_0x4b7781){const _0x3915db=a133_0x4a7bf8,_0x4d0d99=await this['soundModel'][_0x3915db(0x16a)](_0x4b7781);return _0x4d0d99;}async['findByIds'](_0x1f6c1f){const _0xfb115d=a133_0x4a7bf8,_0x2c494a=await this[_0xfb115d(0x180)][_0xfb115d(0x129)]({'_id':{'$in':_0x1f6c1f}});return _0x2c494a;}async[a133_0x4a7bf8(0x15d)](_0xbf54d4,_0x34d820){const _0x13dd39=a133_0x4a7bf8,_0x278939=await this[_0x13dd39(0x180)]['findById'](_0xbf54d4)[_0x13dd39(0x143)]();if(!_0x278939)throw new Error(_0x13dd39(0x151));await this['validateAndMoveFileAsync'](_0x34d820,_0x278939===null||_0x278939===void 0x0?void 0x0:_0x278939[_0x13dd39(0x123)]);const _0x5bbae5=await this[_0x13dd39(0x180)]['findByIdAndUpdate'](_0xbf54d4,Object[_0x13dd39(0x15b)](Object[_0x13dd39(0x15b)]({},_0x34d820),{'updatedAtUtc':new Date()}),{'new':!![]});return _0x5bbae5;}async['updateVolume'](_0x1f39d,_0x5a1396){const _0x32407a=a133_0x4a7bf8,_0x32bf25=await this['soundModel']['findById'](_0x1f39d)['exec']();if(!_0x32bf25)throw new Error(_0x32407a(0x151));const _0x5873c3=await this[_0x32407a(0x180)][_0x32407a(0x148)](_0x1f39d,Object[_0x32407a(0x15b)](Object['assign']({},_0x5a1396),{'updatedAtUtc':new Date()}),{'new':!![]});return _0x5873c3;}async[a133_0x4a7bf8(0x14e)](_0x435401){const _0x4a4ca7=a133_0x4a7bf8,_0x5e21a6=await this['soundModel'][_0x4a4ca7(0x12d)](_0x435401);if(_0x5e21a6[_0x4a4ca7(0x123)]){const _0x4ba4a6=constants_1[_0x4a4ca7(0x126)]+'/'+_0x5e21a6[_0x4a4ca7(0x123)];try{(0x0,file_1['deleteFile'])(_0x4ba4a6);}catch(_0x137034){this[_0x4a4ca7(0x135)]['error'](_0x137034);}}return _0x5e21a6;}async[a133_0x4a7bf8(0x186)](_0x1d032e,_0x227b8d){const _0xfda1b2=a133_0x4a7bf8,_0x48a1cc=await this[_0xfda1b2(0x180)]['findById'](_0x1d032e)[_0xfda1b2(0x143)](),_0x113c15=_0x48a1cc===null||_0x48a1cc===void 0x0?void 0x0:_0x48a1cc['fileName'],_0x10b739=this['getNewFileName'](_0x227b8d['originalname']),_0x36570b=constants_1[_0xfda1b2(0x126)]+'/'+_0x10b739;await(0x0,file_1[_0xfda1b2(0x15f)])(_0x227b8d[_0xfda1b2(0x168)],_0x36570b);const _0x72955b={'fileName':_0x10b739},_0x560ddf=await this['soundModel'][_0xfda1b2(0x148)](_0x1d032e,Object[_0xfda1b2(0x15b)](Object[_0xfda1b2(0x15b)]({},_0x72955b),{'updatedAtUtc':new Date()}),{'new':!![]});if(_0x113c15){const _0x3eb9aa=constants_1['AUDIO_DIR']+'/'+_0x113c15;(0x0,file_1['deleteFile'])(_0x3eb9aa);}return _0x560ddf;}async['playSoundOnEvent'](_0x3cdd9b){const _0x1c1a93=a133_0x4a7bf8,{soundId:_0x14f157,jobId:_0x22de12,durationInSecond:_0x3e100a}=_0x3cdd9b,_0x503de1=await this[_0x1c1a93(0x11f)](_0x14f157),_0x27705c=path[_0x1c1a93(0x185)](path_1[_0x1c1a93(0x187)],_0x1c1a93(0x13c),_0x1c1a93(0x14b),_0x503de1['fileName']);job_1[_0x1c1a93(0x14c)][_0x1c1a93(0x17b)](),this[_0x1c1a93(0x135)][_0x1c1a93(0x16b)](_0x1c1a93(0x127)+_0x14f157+_0x1c1a93(0x188)+_0x503de1[_0x1c1a93(0x162)]),(0x0,job_1[_0x1c1a93(0x179)])({'jobId':_0x22de12,'run':()=>audio_player_1[_0x1c1a93(0x158)]['playAsync'](_0x27705c,_0x503de1['volume']),'next':()=>this[_0x1c1a93(0x165)](_0x14f157),'durationInSecond':_0x3e100a}),this[_0x1c1a93(0x172)]['broadcastPlaying']({'id':_0x14f157,'isPlaying':!![]});}async['playVoiceRecorded'](_0x196066){const _0x30700b=a133_0x4a7bf8,{voiceId:_0x427f01,jobId:_0x16f1a8,durationInSecond:_0x216743}=_0x196066,_0x315a6f=await this['uploadService'][_0x30700b(0x16e)](_0x427f01),_0x29d07c=_0x315a6f['filePath'],_0x4a8060=(0x0,path_2[_0x30700b(0x185)])(process[_0x30700b(0x147)](),_0x29d07c);job_1[_0x30700b(0x14c)]['killAll'](),this[_0x30700b(0x135)]['log']('Playing\x20voice\x20recorded:\x20'+_0x427f01),(0x0,job_1[_0x30700b(0x179)])({'jobId':_0x16f1a8,'run':()=>audio_player_1['AudioPlayer'][_0x30700b(0x183)](_0x4a8060),'durationInSecond':_0x216743,'next':()=>null});}async['playTextToAudioRecorded'](_0x178d23){const _0x1d187a=a133_0x4a7bf8,{textToAudioId:_0x4fbfc8,jobId:_0x3352e4,durationInSecond:_0x312488}=_0x178d23,{message:_0x5becf4}=await this[_0x1d187a(0x12e)][_0x1d187a(0x159)](_0x4fbfc8);job_1['PROCESS_CACHE'][_0x1d187a(0x17b)](),(0x0,job_1['executeJob'])({'jobId':_0x3352e4,'run':()=>{const _0x303447=_0x1d187a;let _0x3fec83=null;return this['textToAudioService'][_0x303447(0x164)](_0x5becf4,_0x42789e=>{const _0x3bb703=_0x303447;_0x3fec83=this[_0x3bb703(0x155)][_0x3bb703(0x133)](_0x42789e);}),_0x3fec83;},'durationInSecond':_0x312488,'next':()=>null});}async[a133_0x4a7bf8(0x13a)](_0x2a3060,_0x52fed6,_0x11a9e4=![]){const _0x15c0d6=a133_0x4a7bf8,_0x21515c={'when':_0x15c0d6(0x18f),'jobType':enums_1[_0x15c0d6(0x17e)]['PlaySound'],'attributes':{'soundId':_0x52fed6,'durationInSecond':_0x11a9e4?0x15180:undefined},'audit':{'actor':_0x2a3060,'name':enums_1[_0x15c0d6(0x17e)][_0x15c0d6(0x132)],'message':_0x15c0d6(0x192)+_0x52fed6}},_0x2a25ac=await this['soundModel'][_0x15c0d6(0x11f)]({'jobId':{'$ne':null}});_0x2a25ac&&await this[_0x15c0d6(0x165)](_0x2a25ac['id']);const {jobId:_0x2c9f06}=await this[_0x15c0d6(0x18a)][_0x15c0d6(0x137)](_0x21515c);return this[_0x15c0d6(0x15d)](_0x52fed6,{'jobId':_0x2c9f06});}async[a133_0x4a7bf8(0x165)](_0x3dd57f){const _0x3eafb8=a133_0x4a7bf8;let _0x5a4d1c=await this['findOne'](_0x3dd57f);const {jobId:_0xf69720}=_0x5a4d1c||{};if(_0xf69720){const {success:_0x5275d0}=await this[_0x3eafb8(0x18a)][_0x3eafb8(0x175)](_0xf69720);_0x5275d0&&(_0x5a4d1c=await this[_0x3eafb8(0x15d)](_0x3dd57f,{'jobId':null}));}return this[_0x3eafb8(0x172)][_0x3eafb8(0x161)]({'id':_0x5a4d1c['id'],'isPlaying':![]}),_0x5a4d1c;}async[a133_0x4a7bf8(0x17c)](){const _0x36fc30=a133_0x4a7bf8,_0x3e9b20=await this[_0x36fc30(0x136)](constants_2[_0x36fc30(0x18d)]['Tune']);if(_0x3e9b20[_0x36fc30(0x169)]>0x0){const _0x16ed4f=[];_0x3e9b20['forEach'](_0x31773c=>{const _0x5f3a15=_0x36fc30;_0x16ed4f[_0x5f3a15(0x181)](this[_0x5f3a15(0x14e)](_0x31773c['_id']));}),await Promise['all'](_0x16ed4f);}await(0x0,file_1['copyFiles'])(constants_1[_0x36fc30(0x176)],constants_1['TMP_UPLOAD_DIR']);const _0x5efa7c=[];return default_sounds_1[_0x36fc30(0x144)][_0x36fc30(0x149)](_0x56e807=>{const _0x2b3484=_0x36fc30;_0x5efa7c[_0x2b3484(0x181)](this[_0x2b3484(0x18c)](Object[_0x2b3484(0x15b)]({},_0x56e807)));}),await Promise[_0x36fc30(0x178)](_0x5efa7c),!![];}[a133_0x4a7bf8(0x166)](_0x240312){const _0x5845e2=a133_0x4a7bf8,_0x477eda=_0x240312[_0x5845e2(0x156)]('.')[_0x5845e2(0x125)]();return(0x0,utils_1[_0x5845e2(0x14a)])()+'.'+_0x477eda;}async[a133_0x4a7bf8(0x145)](_0x224d4f,_0x1bb070){const _0xe9e3bc=a133_0x4a7bf8;if(!_0x224d4f[_0xe9e3bc(0x123)])return;const _0x3bdc62=constants_1['TMP_UPLOAD_DIR']+'/'+_0x224d4f[_0xe9e3bc(0x123)],_0x3a61a2=_0x1bb070||this['getNewFileName'](_0x224d4f['fileName']),_0x155450=constants_1[_0xe9e3bc(0x126)]+'/'+_0x3a61a2;if(!(0x0,file_1[_0xe9e3bc(0x134)])(_0x3bdc62))throw new Error('File\x20not\x20found!');!(0x0,file_1[_0xe9e3bc(0x134)])(constants_1['AUDIO_DIR'])&&(0x0,file_1[_0xe9e3bc(0x15c)])(constants_1[_0xe9e3bc(0x126)]),await(0x0,file_1[_0xe9e3bc(0x15f)])(_0x3bdc62,_0x155450),_0x224d4f[_0xe9e3bc(0x123)]=_0x3a61a2;}};__decorate([(0x0,event_emitter_1[a133_0x4a7bf8(0x13f)])(sound_1[a133_0x4a7bf8(0x12a)][a133_0x4a7bf8(0x140)]),__metadata(a133_0x4a7bf8(0x12f),Function),__metadata('design:paramtypes',[Object]),__metadata(a133_0x4a7bf8(0x16d),Promise)],SoundService[a133_0x4a7bf8(0x16c)],a133_0x4a7bf8(0x11d),null),__decorate([(0x0,event_emitter_1[a133_0x4a7bf8(0x13f)])(sound_1['SoundEvent'][a133_0x4a7bf8(0x12c)]),__metadata(a133_0x4a7bf8(0x12f),Function),__metadata('design:paramtypes',[Object]),__metadata('design:returntype',Promise)],SoundService[a133_0x4a7bf8(0x16c)],a133_0x4a7bf8(0x184),null),__decorate([(0x0,event_emitter_1[a133_0x4a7bf8(0x13f)])(sound_1[a133_0x4a7bf8(0x12a)][a133_0x4a7bf8(0x160)]),__metadata('design:type',Function),__metadata('design:paramtypes',[Object]),__metadata('design:returntype',Promise)],SoundService[a133_0x4a7bf8(0x16c)],a133_0x4a7bf8(0x14d),null),SoundService=SoundService_1=__decorate([(0x0,common_1[a133_0x4a7bf8(0x120)])(),__param(0x0,(0x0,mongoose_1[a133_0x4a7bf8(0x138)])(a133_0x4a7bf8(0x177))),__param(0x5,(0x0,common_1[a133_0x4a7bf8(0x124)])(sound_gateway_1['SoundGateway'])),__metadata('design:paramtypes',[mongoose_2[a133_0x4a7bf8(0x154)],agenda_service_1[a133_0x4a7bf8(0x167)],upload_service_1['UploadService'],text_to_audio_service_1[a133_0x4a7bf8(0x189)],streaming_service_1[a133_0x4a7bf8(0x13b)],sound_gateway_1['SoundGateway']])],SoundService),exports['SoundService']=SoundService;