'use strict';const a136_0x319f62=a136_0x258a;function a136_0x258a(_0x562746,_0x24ad35){const _0x4e994f=a136_0x4e99();return a136_0x258a=function(_0x258a5b,_0xcc1f40){_0x258a5b=_0x258a5b-0xc7;let _0x3884f1=_0x4e994f[_0x258a5b];return _0x3884f1;},a136_0x258a(_0x562746,_0x24ad35);}(function(_0x411312,_0x1fab1d){const _0x348db5=a136_0x258a,_0x4b3328=_0x411312();while(!![]){try{const _0x1b03e8=parseInt(_0x348db5(0xf5))/0x1*(parseInt(_0x348db5(0xfc))/0x2)+-parseInt(_0x348db5(0x135))/0x3*(parseInt(_0x348db5(0x11a))/0x4)+-parseInt(_0x348db5(0x149))/0x5*(-parseInt(_0x348db5(0xf7))/0x6)+parseInt(_0x348db5(0x141))/0x7*(parseInt(_0x348db5(0x108))/0x8)+-parseInt(_0x348db5(0xfb))/0x9+parseInt(_0x348db5(0xc8))/0xa+-parseInt(_0x348db5(0xe6))/0xb*(parseInt(_0x348db5(0x111))/0xc);if(_0x1b03e8===_0x1fab1d)break;else _0x4b3328['push'](_0x4b3328['shift']());}catch(_0x39624e){_0x4b3328['push'](_0x4b3328['shift']());}}}(a136_0x4e99,0x7968c));var __decorate=this&&this[a136_0x319f62(0x140)]||function(_0x3c2968,_0x1b204b,_0x4f0e42,_0x444495){const _0x3af6f8=a136_0x319f62;var _0x39447c=arguments[_0x3af6f8(0xca)],_0x4c7a85=_0x39447c<0x3?_0x1b204b:_0x444495===null?_0x444495=Object[_0x3af6f8(0x129)](_0x1b204b,_0x4f0e42):_0x444495,_0x317a40;if(typeof Reflect===_0x3af6f8(0x102)&&typeof Reflect[_0x3af6f8(0xde)]===_0x3af6f8(0x146))_0x4c7a85=Reflect[_0x3af6f8(0xde)](_0x3c2968,_0x1b204b,_0x4f0e42,_0x444495);else{for(var _0x325b0c=_0x3c2968[_0x3af6f8(0xca)]-0x1;_0x325b0c>=0x0;_0x325b0c--)if(_0x317a40=_0x3c2968[_0x325b0c])_0x4c7a85=(_0x39447c<0x3?_0x317a40(_0x4c7a85):_0x39447c>0x3?_0x317a40(_0x1b204b,_0x4f0e42,_0x4c7a85):_0x317a40(_0x1b204b,_0x4f0e42))||_0x4c7a85;}return _0x39447c>0x3&&_0x4c7a85&&Object[_0x3af6f8(0x136)](_0x1b204b,_0x4f0e42,_0x4c7a85),_0x4c7a85;},__metadata=this&&this[a136_0x319f62(0x125)]||function(_0x4fca4f,_0x1b4a12){const _0x2f48ab=a136_0x319f62;if(typeof Reflect===_0x2f48ab(0x102)&&typeof Reflect[_0x2f48ab(0xe2)]===_0x2f48ab(0x146))return Reflect[_0x2f48ab(0xe2)](_0x4fca4f,_0x1b4a12);},__param=this&&this[a136_0x319f62(0xf9)]||function(_0xf2806,_0x55dafc){return function(_0x5cfba3,_0x1e0da0){_0x55dafc(_0x5cfba3,_0x1e0da0,_0xf2806);};},SoundService_1;Object[a136_0x319f62(0x136)](exports,'__esModule',{'value':!![]}),exports['SoundService']=void 0x0;const common_1=require('@nestjs/common'),mongoose_1=require(a136_0x319f62(0x121)),mongoose_2=require(a136_0x319f62(0x110)),path=require(a136_0x319f62(0x130)),event_emitter_1=require(a136_0x319f62(0x133)),file_1=require('../common/file'),agenda_service_1=require(a136_0x319f62(0x106)),enums_1=require(a136_0x319f62(0xfe)),constants_1=require(a136_0x319f62(0xcf)),utils_1=require(a136_0x319f62(0xef)),path_1=require(a136_0x319f62(0x10d)),audio_player_1=require(a136_0x319f62(0xe0)),sound_1=require(a136_0x319f62(0xcb)),job_1=require(a136_0x319f62(0x120)),constants_2=require(a136_0x319f62(0x138)),default_sounds_1=require(a136_0x319f62(0x11b)),sound_gateway_1=require(a136_0x319f62(0xcc)),path_2=require(a136_0x319f62(0x130)),upload_service_1=require(a136_0x319f62(0x109)),text_to_audio_service_1=require(a136_0x319f62(0x119)),streaming_service_1=require(a136_0x319f62(0x12f));function a136_0x4e99(){const _0x3ff22f=['AgendaService','Tune','name','function','isFileExist','Injectable','8165PttBhr','prototype','Voice\x20file\x20not\x20found:\x20','assets','1524300ENBiWD','cancelJob','length','../common/events/sound','./sound.gateway','agendaService','logger','../common/constants','OnEvent','textToAudioService','split','SoundType','Playing\x20voice\x20recorded:\x20','moveFile','playStreamAudioAsync','delete','SoundService','killAll','update','findVoiceRecoredById','soundModel','Sound\x20file\x20not\x20found:\x20','decorate','findOne','../common/audio/audio-player','updateVolume','metadata','textToAudio','playSoundOnEvent','filePath','22KaVjhB','assign','JobType','TMP_UPLOAD_DIR','push','copyFiles','streamingService','Play\x20sound:\x20','executeJob','../common/utils','resetTunes','all','Logger','now','exec','186981wGOcWo','scheduleJob','3378oGKrKm','getMessageById','__param','save','8728182ThSBwT','4mQQLat','\x20-\x20','../common/enums','Inject','File\x20not\x20found!','audio','object','playTextToAudioRecorded','DEFAULT_TUNES_DIR','findByIdAndUpdate','../agenda/agenda.service','cwd','1611080zxcCqp','../upload/upload.service','fileName','UploadService','volume','../common/path','create','Sound','mongoose','1279032fxbaGu','findByType','DEFAULT_TUNES','broadcastPlaying','AUDIO_DIR','findByIdAndDelete','soundGateway','TextToAudioService','../text-to-audio/text-to-audio.service','224372fHwLhU','./data/default-sounds','forEach','VoiceRecorded','getNewFileName','pop','../common/job','@nestjs/mongoose','playAsync','PROCESS_CACHE','InjectModel','__metadata','PlaySound','Playing\x20sound:\x20','Play','getOwnPropertyDescriptor','SoundGateway','AudioPlayer','_id','log','error','../streaming/streaming.service','path','find','validateAndMoveFileAsync','@nestjs/event-emitter','findById','9BbUBFV','defineProperty','stop','./constants','TextToAudio','findByIds','playVoiceRecorded','SoundEvent','upload','design:paramtypes','design:returntype','__decorate','14Mvbkyb','design:type'];a136_0x4e99=function(){return _0x3ff22f;};return a136_0x4e99();}let SoundService=SoundService_1=class SoundService{constructor(_0x5a43cf,_0x275d50,_0x3fb7b0,_0x3f247d,_0x2ea409,_0x14f508){const _0x595581=a136_0x319f62;this[_0x595581(0xdc)]=_0x5a43cf,this[_0x595581(0xcd)]=_0x275d50,this['uploadService']=_0x3fb7b0,this[_0x595581(0xd1)]=_0x3f247d,this[_0x595581(0xec)]=_0x2ea409,this[_0x595581(0x117)]=_0x14f508,this[_0x595581(0xce)]=new common_1[(_0x595581(0xf2))](SoundService_1[_0x595581(0x145)]);}async[a136_0x319f62(0x10e)](_0x20666b){const _0x59a0e4=a136_0x319f62;await this[_0x59a0e4(0x132)](_0x20666b,null);const _0x4fb527=new this[(_0x59a0e4(0xdc))](_0x20666b);return _0x4fb527[_0x59a0e4(0xfa)]();}async[a136_0x319f62(0x112)](_0x3ea99b){const _0x31ff8f=a136_0x319f62,_0x17488c=await this[_0x31ff8f(0xdc)]['find']({'type':_0x3ea99b})[_0x31ff8f(0xf4)]();return _0x17488c;}async[a136_0x319f62(0xdf)](_0x3c7871){const _0x598511=a136_0x319f62,_0x200120=await this[_0x598511(0xdc)][_0x598511(0x134)](_0x3c7871);return _0x200120;}async[a136_0x319f62(0x13a)](_0x13a8f6){const _0x42aaf5=a136_0x319f62,_0x46de20=await this[_0x42aaf5(0xdc)][_0x42aaf5(0x131)]({'_id':{'$in':_0x13a8f6}});return _0x46de20;}async['update'](_0x1e9e4e,_0x3d5602){const _0x3f59b3=a136_0x319f62,_0x36717e=await this[_0x3f59b3(0xdc)]['findById'](_0x1e9e4e)[_0x3f59b3(0xf4)]();if(!_0x36717e)throw new Error('Sound\x20not\x20found!');await this['validateAndMoveFileAsync'](_0x3d5602,_0x36717e===null||_0x36717e===void 0x0?void 0x0:_0x36717e[_0x3f59b3(0x10a)]);const _0x3198b1=await this[_0x3f59b3(0xdc)]['findByIdAndUpdate'](_0x1e9e4e,Object['assign'](Object[_0x3f59b3(0xe7)]({},_0x3d5602),{'updatedAtUtc':new Date()}),{'new':!![]});return _0x3198b1;}async[a136_0x319f62(0xe1)](_0x5172d0,_0x1795f6){const _0x1df958=a136_0x319f62,_0x17a8ce=await this[_0x1df958(0xdc)][_0x1df958(0x134)](_0x5172d0)[_0x1df958(0xf4)]();if(!_0x17a8ce)throw new Error('Sound\x20not\x20found!');const _0xb75a55=await this[_0x1df958(0xdc)]['findByIdAndUpdate'](_0x5172d0,Object[_0x1df958(0xe7)](Object[_0x1df958(0xe7)]({},_0x1795f6),{'updatedAtUtc':new Date()}),{'new':!![]});return _0xb75a55;}async[a136_0x319f62(0xd7)](_0x5c3551){const _0x221b1e=a136_0x319f62,_0x47e2ff=await this[_0x221b1e(0xdc)][_0x221b1e(0x116)](_0x5c3551);if(_0x47e2ff[_0x221b1e(0x10a)]){const _0x4a0668=constants_1['AUDIO_DIR']+'/'+_0x47e2ff['fileName'];try{(0x0,file_1['deleteFile'])(_0x4a0668);}catch(_0x57680c){this[_0x221b1e(0xce)][_0x221b1e(0x12e)](_0x57680c);}}return _0x47e2ff;}async[a136_0x319f62(0x13d)](_0x6e48e0,_0x435fa4){const _0x82f63b=a136_0x319f62,_0x54d2de=await this[_0x82f63b(0xdc)]['findById'](_0x6e48e0)[_0x82f63b(0xf4)](),_0x159b9a=_0x54d2de===null||_0x54d2de===void 0x0?void 0x0:_0x54d2de[_0x82f63b(0x10a)],_0xf2dce=this[_0x82f63b(0x11e)](_0x435fa4['originalname']),_0x5a1e9d=constants_1[_0x82f63b(0x115)]+'/'+_0xf2dce;await(0x0,file_1[_0x82f63b(0xd5)])(_0x435fa4[_0x82f63b(0x130)],_0x5a1e9d);const _0x6b3cd0={'fileName':_0xf2dce},_0x24d703=await this['soundModel'][_0x82f63b(0x105)](_0x6e48e0,Object['assign'](Object['assign']({},_0x6b3cd0),{'updatedAtUtc':new Date()}),{'new':!![]});if(_0x159b9a){const _0x463050=constants_1[_0x82f63b(0x115)]+'/'+_0x159b9a;(0x0,file_1['deleteFile'])(_0x463050);}return _0x24d703;}async[a136_0x319f62(0xe4)](_0x34480e){const _0x46e28d=a136_0x319f62,{soundId:_0x4b08ac,jobId:_0x498e9,durationInSecond:_0x4689db}=_0x34480e,_0x312951=await this[_0x46e28d(0xdf)](_0x4b08ac),_0x59d836=path['join'](path_1['processRootPath'],_0x46e28d(0xc7),_0x46e28d(0x101),_0x312951['fileName']);if(!(0x0,file_1[_0x46e28d(0x147)])(_0x59d836)){this['logger']['error'](_0x46e28d(0xdd)+_0x59d836);return;}job_1[_0x46e28d(0x123)][_0x46e28d(0xd9)](),this[_0x46e28d(0xce)][_0x46e28d(0x12d)](_0x46e28d(0x127)+_0x4b08ac+_0x46e28d(0xfd)+_0x312951[_0x46e28d(0x145)]),(0x0,job_1[_0x46e28d(0xee)])({'jobId':_0x498e9,'run':()=>audio_player_1[_0x46e28d(0x12b)][_0x46e28d(0x122)](_0x59d836,_0x312951[_0x46e28d(0x10c)]),'next':()=>this[_0x46e28d(0x137)](_0x4b08ac),'durationInSecond':_0x4689db}),this[_0x46e28d(0x117)]['broadcastPlaying']({'id':_0x4b08ac,'isPlaying':!![]});}async[a136_0x319f62(0x13b)](_0x52596f){const _0x4d57a7=a136_0x319f62,{voiceId:_0x497197,jobId:_0x29cc83,durationInSecond:_0x1b73ba}=_0x52596f,_0x1ff31c=await this['uploadService'][_0x4d57a7(0xdb)](_0x497197),_0x3b6ffd=_0x1ff31c[_0x4d57a7(0xe5)],_0x29eae8=(0x0,path_2['join'])(process[_0x4d57a7(0x107)](),_0x3b6ffd);if(!(0x0,file_1[_0x4d57a7(0x147)])(_0x29eae8)){this[_0x4d57a7(0xce)][_0x4d57a7(0x12e)](_0x4d57a7(0x14b)+_0x29eae8);return;}job_1[_0x4d57a7(0x123)][_0x4d57a7(0xd9)](),this[_0x4d57a7(0xce)]['log'](_0x4d57a7(0xd4)+_0x497197),(0x0,job_1['executeJob'])({'jobId':_0x29cc83,'run':()=>audio_player_1[_0x4d57a7(0x12b)]['playAsync'](_0x29eae8),'durationInSecond':_0x1b73ba,'next':()=>null});}async[a136_0x319f62(0x103)](_0xec053c){const _0x1ce1e1=a136_0x319f62,{textToAudioId:_0x50d5d4,jobId:_0x2bfc8e,durationInSecond:_0x5381df}=_0xec053c,{message:_0x4ce840}=await this[_0x1ce1e1(0xd1)][_0x1ce1e1(0xf8)](_0x50d5d4);job_1[_0x1ce1e1(0x123)][_0x1ce1e1(0xd9)](),(0x0,job_1['executeJob'])({'jobId':_0x2bfc8e,'run':()=>{const _0x3742d4=_0x1ce1e1;let _0x20b158=null;return this[_0x3742d4(0xd1)][_0x3742d4(0xe3)](_0x4ce840,_0x55d03b=>{const _0x4f0853=_0x3742d4;_0x20b158=this[_0x4f0853(0xec)][_0x4f0853(0xd6)](_0x55d03b);}),_0x20b158;},'durationInSecond':_0x5381df,'next':()=>null});}async['play'](_0x39d386,_0x49a65a,_0x4c70a7=![]){const _0x106af2=a136_0x319f62,_0x46821a={'when':_0x106af2(0xf3),'jobType':enums_1[_0x106af2(0xe8)][_0x106af2(0x126)],'attributes':{'soundId':_0x49a65a,'durationInSecond':_0x4c70a7?0x15180:undefined},'audit':{'actor':_0x39d386,'name':enums_1[_0x106af2(0xe8)][_0x106af2(0x126)],'message':_0x106af2(0xed)+_0x49a65a}},_0x2fe02a=await this[_0x106af2(0xdc)][_0x106af2(0xdf)]({'jobId':{'$ne':null}});_0x2fe02a&&await this[_0x106af2(0x137)](_0x2fe02a['id']);const {jobId:_0x3835f7}=await this[_0x106af2(0xcd)][_0x106af2(0xf6)](_0x46821a);return this[_0x106af2(0xda)](_0x49a65a,{'jobId':_0x3835f7});}async[a136_0x319f62(0x137)](_0x3f76d9){const _0x21810f=a136_0x319f62;let _0x5934fd=await this[_0x21810f(0xdf)](_0x3f76d9);const {jobId:_0x79db3a}=_0x5934fd||{};if(_0x79db3a){const {success:_0x506608}=await this['agendaService'][_0x21810f(0xc9)](_0x79db3a);_0x506608&&(_0x5934fd=await this[_0x21810f(0xda)](_0x3f76d9,{'jobId':null}));}return this['soundGateway'][_0x21810f(0x114)]({'id':_0x5934fd['id'],'isPlaying':![]}),_0x5934fd;}async[a136_0x319f62(0xf0)](){const _0x4a09e1=a136_0x319f62,_0x566401=await this[_0x4a09e1(0x112)](constants_2[_0x4a09e1(0xd3)][_0x4a09e1(0x144)]);if(_0x566401['length']>0x0){const _0x67f818=[];_0x566401[_0x4a09e1(0x11c)](_0x44a495=>{const _0x292ef8=_0x4a09e1;_0x67f818['push'](this[_0x292ef8(0xd7)](_0x44a495[_0x292ef8(0x12c)]));}),await Promise['all'](_0x67f818);}await(0x0,file_1[_0x4a09e1(0xeb)])(constants_1[_0x4a09e1(0x104)],constants_1[_0x4a09e1(0xe9)]);const _0x246abf=[];return default_sounds_1[_0x4a09e1(0x113)][_0x4a09e1(0x11c)](_0x26241a=>{const _0x2099ac=_0x4a09e1;_0x246abf[_0x2099ac(0xea)](this[_0x2099ac(0x10e)](Object[_0x2099ac(0xe7)]({},_0x26241a)));}),await Promise[_0x4a09e1(0xf1)](_0x246abf),!![];}[a136_0x319f62(0x11e)](_0x529d1c){const _0x7d7884=a136_0x319f62,_0x1b650e=_0x529d1c[_0x7d7884(0xd2)]('.')[_0x7d7884(0x11f)]();return(0x0,utils_1['uuid'])()+'.'+_0x1b650e;}async[a136_0x319f62(0x132)](_0x11e2be,_0x1f844b){const _0x1c4fbf=a136_0x319f62;if(!_0x11e2be[_0x1c4fbf(0x10a)])return;const _0x1aa7ae=constants_1[_0x1c4fbf(0xe9)]+'/'+_0x11e2be['fileName'],_0x4cb1eb=_0x1f844b||this[_0x1c4fbf(0x11e)](_0x11e2be[_0x1c4fbf(0x10a)]),_0x5d639d=constants_1[_0x1c4fbf(0x115)]+'/'+_0x4cb1eb;if(!(0x0,file_1['isFileExist'])(_0x1aa7ae))throw new Error(_0x1c4fbf(0x100));!(0x0,file_1['isFileExist'])(constants_1['AUDIO_DIR'])&&(0x0,file_1['createFolder'])(constants_1[_0x1c4fbf(0x115)]),await(0x0,file_1[_0x1c4fbf(0xd5)])(_0x1aa7ae,_0x5d639d),_0x11e2be[_0x1c4fbf(0x10a)]=_0x4cb1eb;}};__decorate([(0x0,event_emitter_1['OnEvent'])(sound_1[a136_0x319f62(0x13c)][a136_0x319f62(0x128)]),__metadata(a136_0x319f62(0x142),Function),__metadata(a136_0x319f62(0x13e),[Object]),__metadata(a136_0x319f62(0x13f),Promise)],SoundService['prototype'],a136_0x319f62(0xe4),null),__decorate([(0x0,event_emitter_1[a136_0x319f62(0xd0)])(sound_1[a136_0x319f62(0x13c)][a136_0x319f62(0x11d)]),__metadata(a136_0x319f62(0x142),Function),__metadata(a136_0x319f62(0x13e),[Object]),__metadata('design:returntype',Promise)],SoundService[a136_0x319f62(0x14a)],a136_0x319f62(0x13b),null),__decorate([(0x0,event_emitter_1[a136_0x319f62(0xd0)])(sound_1['SoundEvent'][a136_0x319f62(0x139)]),__metadata(a136_0x319f62(0x142),Function),__metadata(a136_0x319f62(0x13e),[Object]),__metadata(a136_0x319f62(0x13f),Promise)],SoundService[a136_0x319f62(0x14a)],a136_0x319f62(0x103),null),SoundService=SoundService_1=__decorate([(0x0,common_1[a136_0x319f62(0x148)])(),__param(0x0,(0x0,mongoose_1[a136_0x319f62(0x124)])(a136_0x319f62(0x10f))),__param(0x5,(0x0,common_1[a136_0x319f62(0xff)])(sound_gateway_1[a136_0x319f62(0x12a)])),__metadata(a136_0x319f62(0x13e),[mongoose_2['Model'],agenda_service_1[a136_0x319f62(0x143)],upload_service_1[a136_0x319f62(0x10b)],text_to_audio_service_1[a136_0x319f62(0x118)],streaming_service_1['StreamingService'],sound_gateway_1['SoundGateway']])],SoundService),exports[a136_0x319f62(0xd8)]=SoundService;