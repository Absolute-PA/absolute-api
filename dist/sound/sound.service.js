'use strict';const a133_0x364791=a133_0x690a;function a133_0x690a(_0x78bbf7,_0x46f480){const _0x5e238f=a133_0x5e23();return a133_0x690a=function(_0x690a79,_0x1d3021){_0x690a79=_0x690a79-0x14c;let _0x34193b=_0x5e238f[_0x690a79];return _0x34193b;},a133_0x690a(_0x78bbf7,_0x46f480);}(function(_0x53c0f5,_0x3e6f6e){const _0x2daa3f=a133_0x690a,_0x5fd51a=_0x53c0f5();while(!![]){try{const _0x53805a=parseInt(_0x2daa3f(0x1a7))/0x1*(parseInt(_0x2daa3f(0x17e))/0x2)+-parseInt(_0x2daa3f(0x15d))/0x3*(parseInt(_0x2daa3f(0x196))/0x4)+parseInt(_0x2daa3f(0x1a3))/0x5*(parseInt(_0x2daa3f(0x1b2))/0x6)+parseInt(_0x2daa3f(0x1b4))/0x7*(parseInt(_0x2daa3f(0x17b))/0x8)+-parseInt(_0x2daa3f(0x182))/0x9*(-parseInt(_0x2daa3f(0x15a))/0xa)+-parseInt(_0x2daa3f(0x186))/0xb*(-parseInt(_0x2daa3f(0x1c0))/0xc)+-parseInt(_0x2daa3f(0x14f))/0xd;if(_0x53805a===_0x3e6f6e)break;else _0x5fd51a['push'](_0x5fd51a['shift']());}catch(_0x2e221c){_0x5fd51a['push'](_0x5fd51a['shift']());}}}(a133_0x5e23,0x30a8f));var __decorate=this&&this[a133_0x364791(0x183)]||function(_0x43d97a,_0x216a61,_0x11262e,_0x3de189){const _0x41507e=a133_0x364791;var _0x2e4884=arguments[_0x41507e(0x18b)],_0x15e4e2=_0x2e4884<0x3?_0x216a61:_0x3de189===null?_0x3de189=Object['getOwnPropertyDescriptor'](_0x216a61,_0x11262e):_0x3de189,_0x173c92;if(typeof Reflect==='object'&&typeof Reflect[_0x41507e(0x153)]==='function')_0x15e4e2=Reflect['decorate'](_0x43d97a,_0x216a61,_0x11262e,_0x3de189);else{for(var _0x3b53cb=_0x43d97a['length']-0x1;_0x3b53cb>=0x0;_0x3b53cb--)if(_0x173c92=_0x43d97a[_0x3b53cb])_0x15e4e2=(_0x2e4884<0x3?_0x173c92(_0x15e4e2):_0x2e4884>0x3?_0x173c92(_0x216a61,_0x11262e,_0x15e4e2):_0x173c92(_0x216a61,_0x11262e))||_0x15e4e2;}return _0x2e4884>0x3&&_0x15e4e2&&Object[_0x41507e(0x187)](_0x216a61,_0x11262e,_0x15e4e2),_0x15e4e2;},__metadata=this&&this[a133_0x364791(0x1b8)]||function(_0x14d513,_0x2f84fa){const _0x234b68=a133_0x364791;if(typeof Reflect===_0x234b68(0x178)&&typeof Reflect[_0x234b68(0x16a)]===_0x234b68(0x14c))return Reflect['metadata'](_0x14d513,_0x2f84fa);},__param=this&&this[a133_0x364791(0x151)]||function(_0x4d8a83,_0x1e3ec4){return function(_0x107ed1,_0x2957ae){_0x1e3ec4(_0x107ed1,_0x2957ae,_0x4d8a83);};},SoundService_1;Object[a133_0x364791(0x187)](exports,'__esModule',{'value':!![]}),exports[a133_0x364791(0x193)]=void 0x0;const common_1=require(a133_0x364791(0x160)),mongoose_1=require(a133_0x364791(0x1b5)),mongoose_2=require(a133_0x364791(0x1ae)),path=require(a133_0x364791(0x18e)),event_emitter_1=require('@nestjs/event-emitter'),file_1=require(a133_0x364791(0x177)),agenda_service_1=require(a133_0x364791(0x19e)),enums_1=require(a133_0x364791(0x1be)),constants_1=require('../common/constants'),utils_1=require('../common/utils'),path_1=require(a133_0x364791(0x167)),audio_player_1=require(a133_0x364791(0x19f)),sound_1=require('../common/events/sound'),job_1=require(a133_0x364791(0x191)),constants_2=require(a133_0x364791(0x16b)),default_sounds_1=require(a133_0x364791(0x152)),sound_gateway_1=require(a133_0x364791(0x154)),path_2=require(a133_0x364791(0x18e)),upload_service_1=require('../upload/upload.service'),text_to_audio_service_1=require(a133_0x364791(0x163)),streaming_service_1=require('../streaming/streaming.service');let SoundService=SoundService_1=class SoundService{constructor(_0xaa1cb1,_0x1da105,_0x4b3562,_0x21a193,_0x446122,_0x3d415e){const _0x43e32a=a133_0x364791;this[_0x43e32a(0x175)]=_0xaa1cb1,this[_0x43e32a(0x15c)]=_0x1da105,this[_0x43e32a(0x170)]=_0x4b3562,this[_0x43e32a(0x168)]=_0x21a193,this['streamingService']=_0x446122,this['soundGateway']=_0x3d415e,this[_0x43e32a(0x176)]=new common_1[(_0x43e32a(0x1b1))](SoundService_1[_0x43e32a(0x156)]);}async[a133_0x364791(0x1a0)](_0x1d4d08){const _0x35d291=a133_0x364791;await this[_0x35d291(0x166)](_0x1d4d08,null);const _0x51fda7=new this[(_0x35d291(0x175))](_0x1d4d08);return _0x51fda7[_0x35d291(0x14e)]();}async['findByType'](_0x10e69b){const _0x6f0bc=a133_0x364791,_0x58fe19=await this[_0x6f0bc(0x175)][_0x6f0bc(0x161)]({'type':_0x10e69b})[_0x6f0bc(0x150)]();return _0x58fe19;}async[a133_0x364791(0x184)](_0x161742){const _0x44e29c=a133_0x364791,_0x4c4d13=await this[_0x44e29c(0x175)][_0x44e29c(0x188)](_0x161742);return _0x4c4d13;}async[a133_0x364791(0x1a8)](_0x57af85){const _0x293b31=a133_0x364791,_0x3c19e8=await this[_0x293b31(0x175)][_0x293b31(0x161)]({'_id':{'$in':_0x57af85}});return _0x3c19e8;}async[a133_0x364791(0x1ad)](_0x3e0d00,_0x347e73){const _0x26532b=a133_0x364791,_0x559a22=await this['soundModel'][_0x26532b(0x188)](_0x3e0d00)[_0x26532b(0x150)]();if(!_0x559a22)throw new Error(_0x26532b(0x18a));await this[_0x26532b(0x166)](_0x347e73,_0x559a22===null||_0x559a22===void 0x0?void 0x0:_0x559a22[_0x26532b(0x1b3)]);const _0x44cf88=await this[_0x26532b(0x175)][_0x26532b(0x181)](_0x3e0d00,Object[_0x26532b(0x1bb)](Object[_0x26532b(0x1bb)]({},_0x347e73),{'updatedAtUtc':new Date()}),{'new':!![]});return _0x44cf88;}async['updateVolume'](_0x3719f5,_0x597446){const _0x1edc15=a133_0x364791,_0x202b9e=await this['soundModel'][_0x1edc15(0x188)](_0x3719f5)[_0x1edc15(0x150)]();if(!_0x202b9e)throw new Error(_0x1edc15(0x18a));const _0x3f174c=await this['soundModel'][_0x1edc15(0x181)](_0x3719f5,Object[_0x1edc15(0x1bb)](Object[_0x1edc15(0x1bb)]({},_0x597446),{'updatedAtUtc':new Date()}),{'new':!![]});return _0x3f174c;}async[a133_0x364791(0x17a)](_0x698fe9){const _0x20c0a0=a133_0x364791,_0x44aecc=await this[_0x20c0a0(0x175)]['findByIdAndDelete'](_0x698fe9);if(_0x44aecc[_0x20c0a0(0x1b3)]){const _0x264784=constants_1['AUDIO_DIR']+'/'+_0x44aecc[_0x20c0a0(0x1b3)];try{(0x0,file_1['deleteFile'])(_0x264784);}catch(_0x596244){this[_0x20c0a0(0x176)][_0x20c0a0(0x157)](_0x596244);}}return _0x44aecc;}async[a133_0x364791(0x195)](_0x152a32,_0x5e308b){const _0x484f24=a133_0x364791,_0x546e53=await this[_0x484f24(0x175)]['findById'](_0x152a32)['exec'](),_0x14f31f=_0x546e53===null||_0x546e53===void 0x0?void 0x0:_0x546e53[_0x484f24(0x1b3)],_0x42c2ce=this[_0x484f24(0x197)](_0x5e308b[_0x484f24(0x1af)]),_0x3fa39c=constants_1[_0x484f24(0x16e)]+'/'+_0x42c2ce;await(0x0,file_1[_0x484f24(0x164)])(_0x5e308b['path'],_0x3fa39c);const _0x691609={'fileName':_0x42c2ce},_0x1ca540=await this[_0x484f24(0x175)][_0x484f24(0x181)](_0x152a32,Object[_0x484f24(0x1bb)](Object[_0x484f24(0x1bb)]({},_0x691609),{'updatedAtUtc':new Date()}),{'new':!![]});if(_0x14f31f){const _0x37f39d=constants_1['AUDIO_DIR']+'/'+_0x14f31f;(0x0,file_1[_0x484f24(0x165)])(_0x37f39d);}return _0x1ca540;}async[a133_0x364791(0x1bc)](_0x2546cf){const _0x111d42=a133_0x364791,{soundId:_0x264f76,jobId:_0x4e1dfa,durationInSecond:_0x171087}=_0x2546cf,_0x27cdfe=await this[_0x111d42(0x184)](_0x264f76),_0x5f0d1a=path[_0x111d42(0x185)](path_1[_0x111d42(0x15b)],_0x111d42(0x1b9),_0x111d42(0x16d),_0x27cdfe[_0x111d42(0x1b3)]);job_1[_0x111d42(0x17d)][_0x111d42(0x1bf)](),this[_0x111d42(0x176)]['log'](_0x111d42(0x19d)+_0x264f76+'\x20-\x20'+_0x27cdfe[_0x111d42(0x156)]),(0x0,job_1['executeJob'])({'jobId':_0x4e1dfa,'run':()=>audio_player_1[_0x111d42(0x19a)][_0x111d42(0x1ba)](_0x5f0d1a,_0x27cdfe['volume']),'next':()=>this[_0x111d42(0x18d)](_0x264f76),'durationInSecond':_0x171087}),this['soundGateway'][_0x111d42(0x162)]({'id':_0x264f76,'isPlaying':!![]});}async[a133_0x364791(0x1a1)](_0xb23c04){const _0x28a082=a133_0x364791,{voiceId:_0x465043,jobId:_0x4680f6,durationInSecond:_0x55feae}=_0xb23c04,_0x26bf49=await this[_0x28a082(0x170)][_0x28a082(0x1ac)](_0x465043),_0x51b6e0=_0x26bf49['filePath'],_0xc75dd5=(0x0,path_2[_0x28a082(0x185)])(process[_0x28a082(0x190)](),_0x51b6e0);job_1['PROCESS_CACHE']['killAll'](),this[_0x28a082(0x176)][_0x28a082(0x15f)](_0x28a082(0x171)+_0x465043),(0x0,job_1[_0x28a082(0x1a9)])({'jobId':_0x4680f6,'run':()=>audio_player_1[_0x28a082(0x19a)][_0x28a082(0x1ba)](_0xc75dd5),'durationInSecond':_0x55feae,'next':()=>null});}async[a133_0x364791(0x14d)](_0x3818ca){const _0x12a43e=a133_0x364791,{textToAudioId:_0x2fd4a5,jobId:_0x28cc87,durationInSecond:_0x2e09f1}=_0x3818ca,{message:_0x44b106}=await this[_0x12a43e(0x168)]['getMessageById'](_0x2fd4a5);job_1[_0x12a43e(0x17d)][_0x12a43e(0x1bf)](),(0x0,job_1[_0x12a43e(0x1a9)])({'jobId':_0x28cc87,'run':()=>{const _0x30ec95=_0x12a43e;let _0x2606a5=null;return this['textToAudioService'][_0x30ec95(0x179)](_0x44b106,_0x261505=>{_0x2606a5=this['streamingService']['playStreamAudioAsync'](_0x261505);}),_0x2606a5;},'durationInSecond':_0x2e09f1,'next':()=>null});}async[a133_0x364791(0x17c)](_0x74abc,_0x5bd37e,_0x3ede0f=![]){const _0x2dc766=a133_0x364791,_0x414c6a={'when':'now','jobType':enums_1[_0x2dc766(0x180)]['PlaySound'],'attributes':{'soundId':_0x5bd37e,'durationInSecond':_0x3ede0f?0x15180:undefined},'audit':{'actor':_0x74abc,'name':enums_1['JobType']['PlaySound'],'message':_0x2dc766(0x172)+_0x5bd37e}},_0x153bbf=await this[_0x2dc766(0x175)][_0x2dc766(0x184)]({'jobId':{'$ne':null}});_0x153bbf&&await this[_0x2dc766(0x18d)](_0x153bbf['id']);const {jobId:_0x105f05}=await this[_0x2dc766(0x15c)]['scheduleJob'](_0x414c6a);return this[_0x2dc766(0x1ad)](_0x5bd37e,{'jobId':_0x105f05});}async[a133_0x364791(0x18d)](_0x18c197){const _0x218199=a133_0x364791;let _0x3032af=await this['findOne'](_0x18c197);const {jobId:_0x518ec9}=_0x3032af||{};if(_0x518ec9){const {success:_0x49c47d}=await this[_0x218199(0x15c)]['cancelJob'](_0x518ec9);_0x49c47d&&(_0x3032af=await this[_0x218199(0x1ad)](_0x18c197,{'jobId':null}));}return this[_0x218199(0x173)]['broadcastPlaying']({'id':_0x3032af['id'],'isPlaying':![]}),_0x3032af;}async[a133_0x364791(0x1bd)](){const _0x36b6fc=a133_0x364791,_0x2d5573=await this[_0x36b6fc(0x1aa)](constants_2[_0x36b6fc(0x19b)][_0x36b6fc(0x189)]);if(_0x2d5573['length']>0x0){const _0x18391f=[];_0x2d5573['forEach'](_0x222857=>{const _0x236e25=_0x36b6fc;_0x18391f['push'](this[_0x236e25(0x17a)](_0x222857[_0x236e25(0x15e)]));}),await Promise[_0x36b6fc(0x169)](_0x18391f);}await(0x0,file_1[_0x36b6fc(0x18c)])(constants_1[_0x36b6fc(0x198)],constants_1[_0x36b6fc(0x158)]);const _0x5ebced=[];return default_sounds_1[_0x36b6fc(0x155)][_0x36b6fc(0x192)](_0x5c1e19=>{const _0x564337=_0x36b6fc;_0x5ebced['push'](this[_0x564337(0x1a0)](Object[_0x564337(0x1bb)]({},_0x5c1e19)));}),await Promise[_0x36b6fc(0x169)](_0x5ebced),!![];}['getNewFileName'](_0xb0c12c){const _0x2620d2=a133_0x364791,_0xf81d2e=_0xb0c12c['split']('.')[_0x2620d2(0x1b6)]();return(0x0,utils_1['uuid'])()+'.'+_0xf81d2e;}async[a133_0x364791(0x166)](_0x57d668,_0x5c0e6f){const _0x243072=a133_0x364791;if(!_0x57d668[_0x243072(0x1b3)])return;const _0x1349fb=constants_1[_0x243072(0x158)]+'/'+_0x57d668[_0x243072(0x1b3)],_0x4b217f=_0x5c0e6f||this[_0x243072(0x197)](_0x57d668[_0x243072(0x1b3)]),_0x42785f=constants_1['AUDIO_DIR']+'/'+_0x4b217f;if(!(0x0,file_1[_0x243072(0x1a4)])(_0x1349fb))throw new Error(_0x243072(0x194));!(0x0,file_1[_0x243072(0x1a4)])(constants_1[_0x243072(0x16e)])&&(0x0,file_1['createFolder'])(constants_1['AUDIO_DIR']),await(0x0,file_1[_0x243072(0x164)])(_0x1349fb,_0x42785f),_0x57d668['fileName']=_0x4b217f;}};__decorate([(0x0,event_emitter_1['OnEvent'])(sound_1[a133_0x364791(0x16f)][a133_0x364791(0x18f)]),__metadata(a133_0x364791(0x199),Function),__metadata(a133_0x364791(0x16c),[Object]),__metadata(a133_0x364791(0x1a6),Promise)],SoundService[a133_0x364791(0x1a2)],a133_0x364791(0x1bc),null),__decorate([(0x0,event_emitter_1[a133_0x364791(0x17f)])(sound_1[a133_0x364791(0x16f)]['VoiceRecorded']),__metadata(a133_0x364791(0x199),Function),__metadata(a133_0x364791(0x16c),[Object]),__metadata(a133_0x364791(0x1a6),Promise)],SoundService[a133_0x364791(0x1a2)],a133_0x364791(0x1a1),null),__decorate([(0x0,event_emitter_1[a133_0x364791(0x17f)])(sound_1[a133_0x364791(0x16f)]['TextToAudio']),__metadata(a133_0x364791(0x199),Function),__metadata(a133_0x364791(0x16c),[Object]),__metadata(a133_0x364791(0x1a6),Promise)],SoundService[a133_0x364791(0x1a2)],a133_0x364791(0x14d),null),SoundService=SoundService_1=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,mongoose_1[a133_0x364791(0x1b0)])(a133_0x364791(0x159))),__param(0x5,(0x0,common_1[a133_0x364791(0x1ab)])(sound_gateway_1[a133_0x364791(0x19c)])),__metadata(a133_0x364791(0x16c),[mongoose_2[a133_0x364791(0x174)],agenda_service_1['AgendaService'],upload_service_1[a133_0x364791(0x1b7)],text_to_audio_service_1[a133_0x364791(0x1a5)],streaming_service_1['StreamingService'],sound_gateway_1[a133_0x364791(0x19c)]])],SoundService),exports[a133_0x364791(0x193)]=SoundService;function a133_0x5e23(){const _0x5536b8=['moveFile','deleteFile','validateAndMoveFileAsync','../common/path','textToAudioService','all','metadata','./constants','design:paramtypes','audio','AUDIO_DIR','SoundEvent','uploadService','Playing\x20voice\x20recorded:\x20','Play\x20sound:\x20','soundGateway','Model','soundModel','logger','../common/file','object','textToAudio','delete','40lqxIiP','play','PROCESS_CACHE','67554BzIdfN','OnEvent','JobType','findByIdAndUpdate','9SVPFHO','__decorate','findOne','join','198RUuyHq','defineProperty','findById','Tune','Sound\x20not\x20found!','length','copyFiles','stop','path','Play','cwd','../common/job','forEach','SoundService','File\x20not\x20found!','upload','8jfMZwN','getNewFileName','DEFAULT_TUNES_DIR','design:type','AudioPlayer','SoundType','SoundGateway','Playing\x20sound:\x20','../agenda/agenda.service','../common/audio/audio-player','create','playVoiceRecorded','prototype','415135LjpHZg','isFileExist','TextToAudioService','design:returntype','7oeYvVz','findByIds','executeJob','findByType','Inject','findVoiceRecoredById','update','mongoose','originalname','InjectModel','Logger','6ewTleO','fileName','25683vlJDlB','@nestjs/mongoose','pop','UploadService','__metadata','assets','playAsync','assign','playSoundOnEvent','resetTunes','../common/enums','killAll','82164qQQXYn','function','playTextToAudioRecorded','save','4563611PqklXA','exec','__param','./data/default-sounds','decorate','./sound.gateway','DEFAULT_TUNES','name','error','TMP_UPLOAD_DIR','Sound','1898990kqnNlI','processRootPath','agendaService','150897MQqwva','_id','log','@nestjs/common','find','broadcastPlaying','../text-to-audio/text-to-audio.service'];a133_0x5e23=function(){return _0x5536b8;};return a133_0x5e23();}