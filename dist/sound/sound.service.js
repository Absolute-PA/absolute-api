'use strict';const a136_0x371e6a=a136_0x320f;(function(_0x2601f9,_0x3f2891){const _0x5b3950=a136_0x320f,_0x4f526c=_0x2601f9();while(!![]){try{const _0x40087f=parseInt(_0x5b3950(0xfa))/0x1+-parseInt(_0x5b3950(0x153))/0x2+-parseInt(_0x5b3950(0x133))/0x3*(parseInt(_0x5b3950(0x150))/0x4)+-parseInt(_0x5b3950(0x10e))/0x5*(parseInt(_0x5b3950(0xf2))/0x6)+-parseInt(_0x5b3950(0xef))/0x7*(parseInt(_0x5b3950(0x152))/0x8)+-parseInt(_0x5b3950(0x143))/0x9+parseInt(_0x5b3950(0x10c))/0xa;if(_0x40087f===_0x3f2891)break;else _0x4f526c['push'](_0x4f526c['shift']());}catch(_0x1abb13){_0x4f526c['push'](_0x4f526c['shift']());}}}(a136_0x999f,0x25a0d));function a136_0x320f(_0x4888c4,_0x126172){const _0x999ff4=a136_0x999f();return a136_0x320f=function(_0x320faa,_0xe2f50){_0x320faa=_0x320faa-0xe1;let _0x5b3610=_0x999ff4[_0x320faa];return _0x5b3610;},a136_0x320f(_0x4888c4,_0x126172);}function a136_0x999f(){const _0x4479ba=['getMessageById','__param','TMP_UPLOAD_DIR','design:paramtypes','object','executeJob','defineProperty','resetTunes','../upload/upload.service','__decorate','cwd','copyFiles','Model','name','createFolder','Voice\x20file\x20not\x20found:\x20','soundModel','Injectable','broadcastPlaying','findByType','path','originalname','AgendaService','./sound.gateway','../common/constants','playStreamAudioAsync','182235uOlPKS','soundGateway','moveFile','create','OnEvent','../common/job','assign','Sound\x20file\x20not\x20found:\x20','AUDIO_DIR','forEach','isFileExist','@nestjs/common','./data/default-sounds','play','findByIds','deleteFile','1753650bKPFKn','error','upload','length','design:returntype','PROCESS_CACHE','assets','stop','push','TextToAudio','filePath','\x20-\x20','AudioPlayer','16EpPpHC','getOwnPropertyDescriptor','608RWjSMk','520672MucirE','save','__esModule','playVoiceRecorded','update','delete','all','Play','join','updateVolume','scheduleJob','../common/path','findByIdAndUpdate','SoundGateway','agendaService','./constants','metadata','InjectModel','playSoundOnEvent','streamingService','../agenda/agenda.service','../common/enums','textToAudioService','prototype','Inject','volume','17311OnkLnk','function','log','36hbnxnj','audio','Sound\x20not\x20found!','UploadService','logger','design:type','findOne','validateAndMoveFileAsync','82802fUZmSh','findById','uploadService','uuid','getNewFileName','SoundEvent','../common/file','PlaySound','../text-to-audio/text-to-audio.service','@nestjs/mongoose','Logger','@nestjs/event-emitter','JobType','findVoiceRecoredById','__metadata','killAll','exec','cancelJob','11786390SMzLVN','textToAudio','184335ZsgbeL','pop','DEFAULT_TUNES','File\x20not\x20found!','../common/audio/audio-player','TextToAudioService','processRootPath','fileName','../common/utils','Playing\x20sound:\x20','VoiceRecorded'];a136_0x999f=function(){return _0x4479ba;};return a136_0x999f();}var __decorate=this&&this[a136_0x371e6a(0x122)]||function(_0x4468d2,_0x5b4c4c,_0x4e945b,_0x5f0457){const _0x11df49=a136_0x371e6a;var _0x489316=arguments[_0x11df49(0x146)],_0x42bd88=_0x489316<0x3?_0x5b4c4c:_0x5f0457===null?_0x5f0457=Object[_0x11df49(0x151)](_0x5b4c4c,_0x4e945b):_0x5f0457,_0x9ca98b;if(typeof Reflect===_0x11df49(0x11d)&&typeof Reflect['decorate']===_0x11df49(0xf0))_0x42bd88=Reflect['decorate'](_0x4468d2,_0x5b4c4c,_0x4e945b,_0x5f0457);else{for(var _0x24340b=_0x4468d2[_0x11df49(0x146)]-0x1;_0x24340b>=0x0;_0x24340b--)if(_0x9ca98b=_0x4468d2[_0x24340b])_0x42bd88=(_0x489316<0x3?_0x9ca98b(_0x42bd88):_0x489316>0x3?_0x9ca98b(_0x5b4c4c,_0x4e945b,_0x42bd88):_0x9ca98b(_0x5b4c4c,_0x4e945b))||_0x42bd88;}return _0x489316>0x3&&_0x42bd88&&Object[_0x11df49(0x11f)](_0x5b4c4c,_0x4e945b,_0x42bd88),_0x42bd88;},__metadata=this&&this[a136_0x371e6a(0x108)]||function(_0x180564,_0x5ac92e){const _0x3cb276=a136_0x371e6a;if(typeof Reflect===_0x3cb276(0x11d)&&typeof Reflect['metadata']===_0x3cb276(0xf0))return Reflect[_0x3cb276(0xe5)](_0x180564,_0x5ac92e);},__param=this&&this[a136_0x371e6a(0x11a)]||function(_0x2f6458,_0x4f29fb){return function(_0x3b55c4,_0xb9bcbf){_0x4f29fb(_0x3b55c4,_0xb9bcbf,_0x2f6458);};},SoundService_1;Object['defineProperty'](exports,a136_0x371e6a(0x155),{'value':!![]}),exports['SoundService']=void 0x0;const common_1=require(a136_0x371e6a(0x13e)),mongoose_1=require(a136_0x371e6a(0x103)),mongoose_2=require('mongoose'),path=require(a136_0x371e6a(0x12d)),event_emitter_1=require(a136_0x371e6a(0x105)),file_1=require(a136_0x371e6a(0x100)),agenda_service_1=require(a136_0x371e6a(0xe9)),enums_1=require(a136_0x371e6a(0xea)),constants_1=require(a136_0x371e6a(0x131)),utils_1=require(a136_0x371e6a(0x116)),path_1=require(a136_0x371e6a(0x15e)),audio_player_1=require(a136_0x371e6a(0x112)),sound_1=require('../common/events/sound'),job_1=require(a136_0x371e6a(0x138)),constants_2=require(a136_0x371e6a(0xe4)),default_sounds_1=require(a136_0x371e6a(0x13f)),sound_gateway_1=require(a136_0x371e6a(0x130)),path_2=require(a136_0x371e6a(0x12d)),upload_service_1=require(a136_0x371e6a(0x121)),text_to_audio_service_1=require(a136_0x371e6a(0x102)),streaming_service_1=require('../streaming/streaming.service');let SoundService=SoundService_1=class SoundService{constructor(_0x55c22c,_0x40f7be,_0x304ce6,_0x49d57e,_0x5a3faa,_0x3a5e14){const _0x47d9d1=a136_0x371e6a;this[_0x47d9d1(0x129)]=_0x55c22c,this['agendaService']=_0x40f7be,this[_0x47d9d1(0xfc)]=_0x304ce6,this[_0x47d9d1(0xeb)]=_0x49d57e,this[_0x47d9d1(0xe8)]=_0x5a3faa,this[_0x47d9d1(0x134)]=_0x3a5e14,this[_0x47d9d1(0xf6)]=new common_1[(_0x47d9d1(0x104))](SoundService_1[_0x47d9d1(0x126)]);}async[a136_0x371e6a(0x136)](_0x20ce2d){const _0x19e725=a136_0x371e6a;await this[_0x19e725(0xf9)](_0x20ce2d,null);const _0x2d65a4=new this['soundModel'](_0x20ce2d);return _0x2d65a4[_0x19e725(0x154)]();}async[a136_0x371e6a(0x12c)](_0x35bb11){const _0x463f89=a136_0x371e6a,_0xc08561=await this[_0x463f89(0x129)]['find']({'type':_0x35bb11})[_0x463f89(0x10a)]();return _0xc08561;}async[a136_0x371e6a(0xf8)](_0x583c2a){const _0x150b88=a136_0x371e6a,_0x570415=await this['soundModel'][_0x150b88(0xfb)](_0x583c2a);return _0x570415;}async[a136_0x371e6a(0x141)](_0x3fcc16){const _0x4fd08f=await this['soundModel']['find']({'_id':{'$in':_0x3fcc16}});return _0x4fd08f;}async['update'](_0x594d18,_0x21a1aa){const _0x5669d2=a136_0x371e6a,_0x19b17d=await this[_0x5669d2(0x129)][_0x5669d2(0xfb)](_0x594d18)['exec']();if(!_0x19b17d)throw new Error(_0x5669d2(0xf4));await this[_0x5669d2(0xf9)](_0x21a1aa,_0x19b17d===null||_0x19b17d===void 0x0?void 0x0:_0x19b17d['fileName']);const _0x1d042b=await this[_0x5669d2(0x129)][_0x5669d2(0xe1)](_0x594d18,Object[_0x5669d2(0x139)](Object[_0x5669d2(0x139)]({},_0x21a1aa),{'updatedAtUtc':new Date()}),{'new':!![]});return _0x1d042b;}async[a136_0x371e6a(0x15c)](_0x25c582,_0x4bce7d){const _0x176a3a=a136_0x371e6a,_0x240e76=await this[_0x176a3a(0x129)][_0x176a3a(0xfb)](_0x25c582)[_0x176a3a(0x10a)]();if(!_0x240e76)throw new Error('Sound\x20not\x20found!');const _0xeca3d8=await this[_0x176a3a(0x129)][_0x176a3a(0xe1)](_0x25c582,Object[_0x176a3a(0x139)](Object[_0x176a3a(0x139)]({},_0x4bce7d),{'updatedAtUtc':new Date()}),{'new':!![]});return _0xeca3d8;}async[a136_0x371e6a(0x158)](_0x2a8fd4){const _0x2556bb=a136_0x371e6a,_0x1c15eb=await this[_0x2556bb(0x129)]['findByIdAndDelete'](_0x2a8fd4);if(_0x1c15eb['fileName']){const _0x395437=constants_1[_0x2556bb(0x13b)]+'/'+_0x1c15eb['fileName'];try{(0x0,file_1[_0x2556bb(0x142)])(_0x395437);}catch(_0xc9e929){this[_0x2556bb(0xf6)][_0x2556bb(0x144)](_0xc9e929);}}return _0x1c15eb;}async[a136_0x371e6a(0x145)](_0x36ee0b,_0x341ff5){const _0x314dbe=a136_0x371e6a,_0x263c84=await this[_0x314dbe(0x129)]['findById'](_0x36ee0b)['exec'](),_0x2486d4=_0x263c84===null||_0x263c84===void 0x0?void 0x0:_0x263c84[_0x314dbe(0x115)],_0x189a91=this[_0x314dbe(0xfe)](_0x341ff5[_0x314dbe(0x12e)]),_0x195fed=constants_1[_0x314dbe(0x13b)]+'/'+_0x189a91;await(0x0,file_1['moveFile'])(_0x341ff5['path'],_0x195fed);const _0x315c51={'fileName':_0x189a91},_0x103b42=await this[_0x314dbe(0x129)][_0x314dbe(0xe1)](_0x36ee0b,Object[_0x314dbe(0x139)](Object[_0x314dbe(0x139)]({},_0x315c51),{'updatedAtUtc':new Date()}),{'new':!![]});if(_0x2486d4){const _0x5cfe6b=constants_1[_0x314dbe(0x13b)]+'/'+_0x2486d4;(0x0,file_1[_0x314dbe(0x142)])(_0x5cfe6b);}return _0x103b42;}async[a136_0x371e6a(0xe7)](_0x459a3c){const _0x34290c=a136_0x371e6a,{soundId:_0x590d6e,jobId:_0x8618aa,durationInSecond:_0x268982}=_0x459a3c,_0x2751b3=await this['findOne'](_0x590d6e),_0x588c78=path[_0x34290c(0x15b)](path_1[_0x34290c(0x114)],_0x34290c(0x149),_0x34290c(0xf3),_0x2751b3[_0x34290c(0x115)]);if(!(0x0,file_1[_0x34290c(0x13d)])(_0x588c78)){this[_0x34290c(0xf6)]['error'](_0x34290c(0x13a)+_0x588c78);return;}job_1['PROCESS_CACHE'][_0x34290c(0x109)](),this[_0x34290c(0xf6)][_0x34290c(0xf1)](_0x34290c(0x117)+_0x590d6e+_0x34290c(0x14e)+_0x2751b3[_0x34290c(0x126)]),(0x0,job_1[_0x34290c(0x11e)])({'jobId':_0x8618aa,'run':()=>audio_player_1[_0x34290c(0x14f)]['playAsync'](_0x588c78,_0x2751b3[_0x34290c(0xee)]),'next':()=>this[_0x34290c(0x14a)](_0x590d6e),'durationInSecond':_0x268982}),this[_0x34290c(0x134)][_0x34290c(0x12b)]({'id':_0x590d6e,'isPlaying':!![]});}async[a136_0x371e6a(0x156)](_0x12c459){const _0x35fad7=a136_0x371e6a,{voiceId:_0x3fbe3a,jobId:_0x1edd45,durationInSecond:_0x7caf1c}=_0x12c459,_0x3e7a02=await this['uploadService'][_0x35fad7(0x107)](_0x3fbe3a),_0x1df558=_0x3e7a02[_0x35fad7(0x14d)],_0x5339fc=(0x0,path_2[_0x35fad7(0x15b)])(process[_0x35fad7(0x123)](),_0x1df558);if(!(0x0,file_1['isFileExist'])(_0x5339fc)){this['logger'][_0x35fad7(0x144)](_0x35fad7(0x128)+_0x5339fc);return;}job_1[_0x35fad7(0x148)]['killAll'](),this['logger']['log']('Playing\x20voice\x20recorded:\x20'+_0x3fbe3a),(0x0,job_1[_0x35fad7(0x11e)])({'jobId':_0x1edd45,'run':()=>audio_player_1[_0x35fad7(0x14f)]['playAsync'](_0x5339fc),'durationInSecond':_0x7caf1c,'next':()=>null});}async['playTextToAudioRecorded'](_0x2afcfc){const _0x253470=a136_0x371e6a,{textToAudioId:_0x1c6f2f,jobId:_0x4bb2d5,durationInSecond:_0x2ecc49}=_0x2afcfc,{message:_0x2c682e}=await this[_0x253470(0xeb)][_0x253470(0x119)](_0x1c6f2f);job_1[_0x253470(0x148)][_0x253470(0x109)](),(0x0,job_1[_0x253470(0x11e)])({'jobId':_0x4bb2d5,'run':()=>{const _0x275f6d=_0x253470;let _0x5e87d8=null;return this[_0x275f6d(0xeb)][_0x275f6d(0x10d)](_0x2c682e,_0x203459=>{const _0x285a7a=_0x275f6d;_0x5e87d8=this[_0x285a7a(0xe8)][_0x285a7a(0x132)](_0x203459);}),_0x5e87d8;},'durationInSecond':_0x2ecc49,'next':()=>null});}async[a136_0x371e6a(0x140)](_0x9b4ebe,_0x3a5c7b,_0x2c9116=![]){const _0x5b8da6=a136_0x371e6a,_0x3aec60={'when':'now','jobType':enums_1[_0x5b8da6(0x106)][_0x5b8da6(0x101)],'attributes':{'soundId':_0x3a5c7b,'durationInSecond':_0x2c9116?0x15180:undefined},'audit':{'actor':_0x9b4ebe,'name':enums_1[_0x5b8da6(0x106)][_0x5b8da6(0x101)],'message':'Play\x20sound:\x20'+_0x3a5c7b}},_0x1e5e8a=await this[_0x5b8da6(0x129)][_0x5b8da6(0xf8)]({'jobId':{'$ne':null}});_0x1e5e8a&&await this['stop'](_0x1e5e8a['id']);const {jobId:_0x4df488}=await this[_0x5b8da6(0xe3)][_0x5b8da6(0x15d)](_0x3aec60);return this[_0x5b8da6(0x157)](_0x3a5c7b,{'jobId':_0x4df488});}async[a136_0x371e6a(0x14a)](_0x26f5cb){const _0x456620=a136_0x371e6a;let _0x4c9972=await this[_0x456620(0xf8)](_0x26f5cb);const {jobId:_0x6b558c}=_0x4c9972||{};if(_0x6b558c){const {success:_0x5a9f1d}=await this[_0x456620(0xe3)][_0x456620(0x10b)](_0x6b558c);_0x5a9f1d&&(_0x4c9972=await this[_0x456620(0x157)](_0x26f5cb,{'jobId':null}));}return this['soundGateway']['broadcastPlaying']({'id':_0x4c9972['id'],'isPlaying':![]}),_0x4c9972;}async[a136_0x371e6a(0x120)](){const _0xe780ae=a136_0x371e6a,_0x3156f8=await this[_0xe780ae(0x12c)](constants_2['SoundType']['Tune']);if(_0x3156f8[_0xe780ae(0x146)]>0x0){const _0x34fdf9=[];_0x3156f8[_0xe780ae(0x13c)](_0x2f7bbc=>{const _0x10e0a7=_0xe780ae;_0x34fdf9['push'](this[_0x10e0a7(0x158)](_0x2f7bbc['_id']));}),await Promise['all'](_0x34fdf9);}await(0x0,file_1[_0xe780ae(0x124)])(constants_1['DEFAULT_TUNES_DIR'],constants_1[_0xe780ae(0x11b)]);const _0x3a508c=[];return default_sounds_1[_0xe780ae(0x110)]['forEach'](_0x389aed=>{const _0x60ed22=_0xe780ae;_0x3a508c[_0x60ed22(0x14b)](this[_0x60ed22(0x136)](Object[_0x60ed22(0x139)]({},_0x389aed)));}),await Promise[_0xe780ae(0x159)](_0x3a508c),!![];}[a136_0x371e6a(0xfe)](_0x40797d){const _0x51906c=a136_0x371e6a,_0x55d2ed=_0x40797d['split']('.')[_0x51906c(0x10f)]();return(0x0,utils_1[_0x51906c(0xfd)])()+'.'+_0x55d2ed;}async[a136_0x371e6a(0xf9)](_0x521e99,_0x49957f){const _0x159316=a136_0x371e6a;if(!_0x521e99['fileName'])return;const _0x379ac7=constants_1[_0x159316(0x11b)]+'/'+_0x521e99[_0x159316(0x115)],_0x4cc2ad=_0x49957f||this['getNewFileName'](_0x521e99['fileName']),_0x29d694=constants_1[_0x159316(0x13b)]+'/'+_0x4cc2ad;if(!(0x0,file_1[_0x159316(0x13d)])(_0x379ac7))throw new Error(_0x159316(0x111));!(0x0,file_1[_0x159316(0x13d)])(constants_1[_0x159316(0x13b)])&&(0x0,file_1[_0x159316(0x127)])(constants_1['AUDIO_DIR']),await(0x0,file_1[_0x159316(0x135)])(_0x379ac7,_0x29d694),_0x521e99[_0x159316(0x115)]=_0x4cc2ad;}};__decorate([(0x0,event_emitter_1['OnEvent'])(sound_1[a136_0x371e6a(0xff)][a136_0x371e6a(0x15a)]),__metadata('design:type',Function),__metadata('design:paramtypes',[Object]),__metadata(a136_0x371e6a(0x147),Promise)],SoundService[a136_0x371e6a(0xec)],a136_0x371e6a(0xe7),null),__decorate([(0x0,event_emitter_1[a136_0x371e6a(0x137)])(sound_1[a136_0x371e6a(0xff)][a136_0x371e6a(0x118)]),__metadata(a136_0x371e6a(0xf7),Function),__metadata(a136_0x371e6a(0x11c),[Object]),__metadata(a136_0x371e6a(0x147),Promise)],SoundService['prototype'],a136_0x371e6a(0x156),null),__decorate([(0x0,event_emitter_1[a136_0x371e6a(0x137)])(sound_1['SoundEvent'][a136_0x371e6a(0x14c)]),__metadata('design:type',Function),__metadata(a136_0x371e6a(0x11c),[Object]),__metadata(a136_0x371e6a(0x147),Promise)],SoundService[a136_0x371e6a(0xec)],'playTextToAudioRecorded',null),SoundService=SoundService_1=__decorate([(0x0,common_1[a136_0x371e6a(0x12a)])(),__param(0x0,(0x0,mongoose_1[a136_0x371e6a(0xe6)])('Sound')),__param(0x5,(0x0,common_1[a136_0x371e6a(0xed)])(sound_gateway_1['SoundGateway'])),__metadata(a136_0x371e6a(0x11c),[mongoose_2[a136_0x371e6a(0x125)],agenda_service_1[a136_0x371e6a(0x12f)],upload_service_1[a136_0x371e6a(0xf5)],text_to_audio_service_1[a136_0x371e6a(0x113)],streaming_service_1['StreamingService'],sound_gateway_1[a136_0x371e6a(0xe2)]])],SoundService),exports['SoundService']=SoundService;