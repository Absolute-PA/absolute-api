'use strict';const a136_0x4018a1=a136_0x5218;(function(_0x10ac84,_0x432c40){const _0x695bfe=a136_0x5218,_0x954b13=_0x10ac84();while(!![]){try{const _0x3e6be3=-parseInt(_0x695bfe(0x10c))/0x1+parseInt(_0x695bfe(0xf3))/0x2*(-parseInt(_0x695bfe(0x106))/0x3)+parseInt(_0x695bfe(0xf4))/0x4*(-parseInt(_0x695bfe(0x11b))/0x5)+-parseInt(_0x695bfe(0xe7))/0x6*(parseInt(_0x695bfe(0x125))/0x7)+parseInt(_0x695bfe(0xec))/0x8*(-parseInt(_0x695bfe(0xdc))/0x9)+parseInt(_0x695bfe(0x102))/0xa+parseInt(_0x695bfe(0xef))/0xb;if(_0x3e6be3===_0x432c40)break;else _0x954b13['push'](_0x954b13['shift']());}catch(_0x277fdd){_0x954b13['push'](_0x954b13['shift']());}}}(a136_0x3141,0x901c2));var __decorate=this&&this[a136_0x4018a1(0xf1)]||function(_0x33ba33,_0x13ddef,_0x3073cb,_0xf03fbc){const _0x5af60b=a136_0x4018a1;var _0x2cfdc1=arguments[_0x5af60b(0xd8)],_0x286f04=_0x2cfdc1<0x3?_0x13ddef:_0xf03fbc===null?_0xf03fbc=Object['getOwnPropertyDescriptor'](_0x13ddef,_0x3073cb):_0xf03fbc,_0x132092;if(typeof Reflect===_0x5af60b(0xf0)&&typeof Reflect[_0x5af60b(0xde)]==='function')_0x286f04=Reflect[_0x5af60b(0xde)](_0x33ba33,_0x13ddef,_0x3073cb,_0xf03fbc);else{for(var _0x24bd78=_0x33ba33[_0x5af60b(0xd8)]-0x1;_0x24bd78>=0x0;_0x24bd78--)if(_0x132092=_0x33ba33[_0x24bd78])_0x286f04=(_0x2cfdc1<0x3?_0x132092(_0x286f04):_0x2cfdc1>0x3?_0x132092(_0x13ddef,_0x3073cb,_0x286f04):_0x132092(_0x13ddef,_0x3073cb))||_0x286f04;}return _0x2cfdc1>0x3&&_0x286f04&&Object[_0x5af60b(0x14a)](_0x13ddef,_0x3073cb,_0x286f04),_0x286f04;},__metadata=this&&this[a136_0x4018a1(0x144)]||function(_0xd9f303,_0x519836){const _0x28da9c=a136_0x4018a1;if(typeof Reflect===_0x28da9c(0xf0)&&typeof Reflect[_0x28da9c(0x147)]===_0x28da9c(0x10a))return Reflect[_0x28da9c(0x147)](_0xd9f303,_0x519836);},__param=this&&this[a136_0x4018a1(0x137)]||function(_0x2bbb81,_0x490b59){return function(_0x3d6c7e,_0x1d754b){_0x490b59(_0x3d6c7e,_0x1d754b,_0x2bbb81);};},SoundService_1;Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a136_0x4018a1(0x115)]=void 0x0;function a136_0x5218(_0x47cca9,_0x1f274c){const _0x314171=a136_0x3141();return a136_0x5218=function(_0x521845,_0x4fc5b2){_0x521845=_0x521845-0xd6;let _0x491299=_0x314171[_0x521845];return _0x491299;},a136_0x5218(_0x47cca9,_0x1f274c);}function a136_0x3141(){const _0x3ea2b9=['16179pCNxPQ','resetTunes','Playing\x20sound:\x20','soundGateway','function','playVoiceRecorded','45888jvkrYf','../common/events/sound','upload','forEach','name','StreamingService','File\x20not\x20found!','playTextToAudioRecorded','streamingService','SoundService','update','filePath','deleteFile','Play','executeJob','1461050ZCZGyc','findByType','findVoiceRecoredById','SoundEvent','logger','agendaService','textToAudio','mongoose','soundModel','design:returntype','7MHxOey','killAll','design:type','findById','../common/path','_id','findOne','TMP_UPLOAD_DIR','playSoundOnEvent','findByIds','PlaySound','split','TextToAudioService','Play\x20sound:\x20','all','JobType','prototype','UploadService','__param','@nestjs/common','assets','Voice\x20file\x20not\x20found:\x20','playAsync','../common/audio/audio-player','processRootPath','AgendaService','../common/job','pop','AUDIO_DIR','InjectModel','SoundType','__metadata','createFolder','../common/constants','metadata','find','./data/default-sounds','defineProperty','OnEvent','delete','create','path','uuid','isFileExist','length','volume','../streaming/streaming.service','originalname','48375dHqVxq','Playing\x20voice\x20recorded:\x20','decorate','Model','PROCESS_CACHE','getNewFileName','../agenda/agenda.service','../common/file','design:paramtypes','findByIdAndUpdate','Logger','5568216OvKISm','join','./constants','broadcastPlaying','fileName','32mZxOda','exec','validateAndMoveFileAsync','24037079mTuzLe','object','__decorate','save','142hlspkz','4slOoDc','findByIdAndDelete','SoundGateway','../text-to-audio/text-to-audio.service','Inject','stop','moveFile','@nestjs/mongoose','Sound\x20not\x20found!','DEFAULT_TUNES','textToAudioService','uploadService','log','getMessageById','756220yrAqTk','error','audio','assign'];a136_0x3141=function(){return _0x3ea2b9;};return a136_0x3141();}const common_1=require(a136_0x4018a1(0x138)),mongoose_1=require(a136_0x4018a1(0xfb)),mongoose_2=require(a136_0x4018a1(0x122)),path=require(a136_0x4018a1(0x14e)),event_emitter_1=require('@nestjs/event-emitter'),file_1=require(a136_0x4018a1(0xe3)),agenda_service_1=require(a136_0x4018a1(0xe2)),enums_1=require('../common/enums'),constants_1=require(a136_0x4018a1(0x146)),utils_1=require('../common/utils'),path_1=require(a136_0x4018a1(0x129)),audio_player_1=require(a136_0x4018a1(0x13c)),sound_1=require(a136_0x4018a1(0x10d)),job_1=require(a136_0x4018a1(0x13f)),constants_2=require(a136_0x4018a1(0xe9)),default_sounds_1=require(a136_0x4018a1(0x149)),sound_gateway_1=require('./sound.gateway'),path_2=require('path'),upload_service_1=require('../upload/upload.service'),text_to_audio_service_1=require(a136_0x4018a1(0xf7)),streaming_service_1=require(a136_0x4018a1(0xda));let SoundService=SoundService_1=class SoundService{constructor(_0x4c2ef7,_0x44d969,_0x5929fe,_0x5df0ae,_0x3d24fd,_0x62ca94){const _0x273ffc=a136_0x4018a1;this['soundModel']=_0x4c2ef7,this[_0x273ffc(0x120)]=_0x44d969,this[_0x273ffc(0xff)]=_0x5929fe,this['textToAudioService']=_0x5df0ae,this[_0x273ffc(0x114)]=_0x3d24fd,this['soundGateway']=_0x62ca94,this['logger']=new common_1[(_0x273ffc(0xe6))](SoundService_1[_0x273ffc(0x110)]);}async[a136_0x4018a1(0x14d)](_0x423c61){const _0x2a69b0=a136_0x4018a1;await this[_0x2a69b0(0xee)](_0x423c61,null);const _0x37f50c=new this[(_0x2a69b0(0x123))](_0x423c61);return _0x37f50c[_0x2a69b0(0xf2)]();}async[a136_0x4018a1(0x11c)](_0x3e2780){const _0x244ece=a136_0x4018a1,_0x437dc5=await this[_0x244ece(0x123)][_0x244ece(0x148)]({'type':_0x3e2780})['exec']();return _0x437dc5;}async['findOne'](_0x54f135){const _0xacb89=a136_0x4018a1,_0x4593f0=await this[_0xacb89(0x123)][_0xacb89(0x128)](_0x54f135);return _0x4593f0;}async[a136_0x4018a1(0x12e)](_0x53cc3a){const _0x52ca3b=a136_0x4018a1,_0x4667bb=await this[_0x52ca3b(0x123)][_0x52ca3b(0x148)]({'_id':{'$in':_0x53cc3a}});return _0x4667bb;}async[a136_0x4018a1(0x116)](_0x41f811,_0x40cd13){const _0x2530ca=a136_0x4018a1,_0x13bc8b=await this['soundModel'][_0x2530ca(0x128)](_0x41f811)[_0x2530ca(0xed)]();if(!_0x13bc8b)throw new Error(_0x2530ca(0xfc));await this[_0x2530ca(0xee)](_0x40cd13,_0x13bc8b===null||_0x13bc8b===void 0x0?void 0x0:_0x13bc8b['fileName']);const _0x44b9bc=await this[_0x2530ca(0x123)][_0x2530ca(0xe5)](_0x41f811,Object[_0x2530ca(0x105)](Object[_0x2530ca(0x105)]({},_0x40cd13),{'updatedAtUtc':new Date()}),{'new':!![]});return _0x44b9bc;}async['updateVolume'](_0xda7725,_0x399e8c){const _0xb38016=a136_0x4018a1,_0xf2424f=await this[_0xb38016(0x123)]['findById'](_0xda7725)[_0xb38016(0xed)]();if(!_0xf2424f)throw new Error(_0xb38016(0xfc));const _0x1e96cf=await this[_0xb38016(0x123)]['findByIdAndUpdate'](_0xda7725,Object[_0xb38016(0x105)](Object[_0xb38016(0x105)]({},_0x399e8c),{'updatedAtUtc':new Date()}),{'new':!![]});return _0x1e96cf;}async[a136_0x4018a1(0x14c)](_0x1599e1){const _0x4b9ad3=a136_0x4018a1,_0xed02af=await this[_0x4b9ad3(0x123)][_0x4b9ad3(0xf5)](_0x1599e1);if(_0xed02af[_0x4b9ad3(0xeb)]){const _0x29c423=constants_1['AUDIO_DIR']+'/'+_0xed02af[_0x4b9ad3(0xeb)];try{(0x0,file_1[_0x4b9ad3(0x118)])(_0x29c423);}catch(_0x3aaec7){this[_0x4b9ad3(0x11f)]['error'](_0x3aaec7);}}return _0xed02af;}async[a136_0x4018a1(0x10e)](_0x2c3195,_0x2229d1){const _0x2967cd=a136_0x4018a1,_0x3d9718=await this[_0x2967cd(0x123)][_0x2967cd(0x128)](_0x2c3195)['exec'](),_0x555f37=_0x3d9718===null||_0x3d9718===void 0x0?void 0x0:_0x3d9718['fileName'],_0x1d5322=this[_0x2967cd(0xe1)](_0x2229d1[_0x2967cd(0xdb)]),_0x24fb3a=constants_1[_0x2967cd(0x141)]+'/'+_0x1d5322;await(0x0,file_1['moveFile'])(_0x2229d1[_0x2967cd(0x14e)],_0x24fb3a);const _0x29785c={'fileName':_0x1d5322},_0x9a86d5=await this[_0x2967cd(0x123)][_0x2967cd(0xe5)](_0x2c3195,Object[_0x2967cd(0x105)](Object['assign']({},_0x29785c),{'updatedAtUtc':new Date()}),{'new':!![]});if(_0x555f37){const _0x1a8d64=constants_1[_0x2967cd(0x141)]+'/'+_0x555f37;(0x0,file_1['deleteFile'])(_0x1a8d64);}return _0x9a86d5;}async[a136_0x4018a1(0x12d)](_0x555693){const _0x1d71fa=a136_0x4018a1,{soundId:_0x4a85c4,jobId:_0x41a0f2,durationInSecond:_0x256dbc}=_0x555693,_0x4c830f=await this['findOne'](_0x4a85c4),_0x3b2ae=path[_0x1d71fa(0xe8)](path_1[_0x1d71fa(0x13d)],_0x1d71fa(0x139),_0x1d71fa(0x104),_0x4c830f[_0x1d71fa(0xeb)]);if(!(0x0,file_1['isFileExist'])(_0x3b2ae)){this[_0x1d71fa(0x11f)][_0x1d71fa(0x103)]('Sound\x20file\x20not\x20found:\x20'+_0x3b2ae);return;}job_1[_0x1d71fa(0xe0)][_0x1d71fa(0x126)](),this[_0x1d71fa(0x11f)][_0x1d71fa(0x100)](_0x1d71fa(0x108)+_0x4a85c4+'\x20-\x20'+_0x4c830f[_0x1d71fa(0x110)]),(0x0,job_1[_0x1d71fa(0x11a)])({'jobId':_0x41a0f2,'run':()=>audio_player_1['AudioPlayer'][_0x1d71fa(0x13b)](_0x3b2ae,_0x4c830f[_0x1d71fa(0xd9)]),'next':()=>this[_0x1d71fa(0xf9)](_0x4a85c4),'durationInSecond':_0x256dbc}),this[_0x1d71fa(0x109)]['broadcastPlaying']({'id':_0x4a85c4,'isPlaying':!![]});}async['playVoiceRecorded'](_0x29a3f0){const _0x429f63=a136_0x4018a1,{voiceId:_0x10773,jobId:_0x49ece4,durationInSecond:_0x36cc45}=_0x29a3f0,_0x38c715=await this[_0x429f63(0xff)][_0x429f63(0x11d)](_0x10773),_0x53e92e=_0x38c715[_0x429f63(0x117)],_0x2f175b=(0x0,path_2['join'])(process['cwd'](),_0x53e92e);if(!(0x0,file_1[_0x429f63(0xd7)])(_0x2f175b)){this[_0x429f63(0x11f)][_0x429f63(0x103)](_0x429f63(0x13a)+_0x2f175b);return;}job_1[_0x429f63(0xe0)][_0x429f63(0x126)](),this[_0x429f63(0x11f)][_0x429f63(0x100)](_0x429f63(0xdd)+_0x10773),(0x0,job_1['executeJob'])({'jobId':_0x49ece4,'run':()=>audio_player_1['AudioPlayer'][_0x429f63(0x13b)](_0x2f175b),'durationInSecond':_0x36cc45,'next':()=>null});}async[a136_0x4018a1(0x113)](_0x4f0912){const _0x3c12e6=a136_0x4018a1,{textToAudioId:_0x15a021,jobId:_0x12b41f,durationInSecond:_0xd21f52}=_0x4f0912,{message:_0x47a89a}=await this[_0x3c12e6(0xfe)][_0x3c12e6(0x101)](_0x15a021);job_1['PROCESS_CACHE'][_0x3c12e6(0x126)](),(0x0,job_1[_0x3c12e6(0x11a)])({'jobId':_0x12b41f,'run':()=>{const _0x26cfa3=_0x3c12e6;let _0x37b127=null;return this[_0x26cfa3(0xfe)][_0x26cfa3(0x121)](_0x47a89a,_0x219dde=>{const _0x55cae5=_0x26cfa3;_0x37b127=this[_0x55cae5(0x114)]['playStreamAudioAsync'](_0x219dde);}),_0x37b127;},'durationInSecond':_0xd21f52,'next':()=>null});}async['play'](_0x14c6d7,_0x590ae2,_0x3e2e80=![]){const _0x9be68e=a136_0x4018a1,_0x26f6cd={'when':'now','jobType':enums_1['JobType'][_0x9be68e(0x12f)],'attributes':{'soundId':_0x590ae2,'durationInSecond':_0x3e2e80?0x15180:undefined},'audit':{'actor':_0x14c6d7,'name':enums_1[_0x9be68e(0x134)][_0x9be68e(0x12f)],'message':_0x9be68e(0x132)+_0x590ae2}},_0x5ef878=await this['soundModel'][_0x9be68e(0x12b)]({'jobId':{'$ne':null}});_0x5ef878&&await this['stop'](_0x5ef878['id']);const {jobId:_0x17a07e}=await this[_0x9be68e(0x120)]['scheduleJob'](_0x26f6cd);return this[_0x9be68e(0x116)](_0x590ae2,{'jobId':_0x17a07e});}async[a136_0x4018a1(0xf9)](_0x37588d){const _0x3ddfa2=a136_0x4018a1;let _0x28ede2=await this[_0x3ddfa2(0x12b)](_0x37588d);const {jobId:_0x17e72c}=_0x28ede2||{};if(_0x17e72c){const {success:_0x26c59a}=await this['agendaService']['cancelJob'](_0x17e72c);_0x26c59a&&(_0x28ede2=await this['update'](_0x37588d,{'jobId':null}));}return this[_0x3ddfa2(0x109)][_0x3ddfa2(0xea)]({'id':_0x28ede2['id'],'isPlaying':![]}),_0x28ede2;}async[a136_0x4018a1(0x107)](){const _0x2458e7=a136_0x4018a1,_0x6a900=await this['findByType'](constants_2[_0x2458e7(0x143)]['Tune']);if(_0x6a900[_0x2458e7(0xd8)]>0x0){const _0x39f686=[];_0x6a900[_0x2458e7(0x10f)](_0x1b6ad6=>{const _0x45b078=_0x2458e7;_0x39f686['push'](this[_0x45b078(0x14c)](_0x1b6ad6[_0x45b078(0x12a)]));}),await Promise['all'](_0x39f686);}await(0x0,file_1['copyFiles'])(constants_1['DEFAULT_TUNES_DIR'],constants_1[_0x2458e7(0x12c)]);const _0x39f400=[];return default_sounds_1[_0x2458e7(0xfd)][_0x2458e7(0x10f)](_0x384626=>{const _0x18392a=_0x2458e7;_0x39f400['push'](this[_0x18392a(0x14d)](Object[_0x18392a(0x105)]({},_0x384626)));}),await Promise[_0x2458e7(0x133)](_0x39f400),!![];}['getNewFileName'](_0x4ed101){const _0x1f2d97=a136_0x4018a1,_0x201ad9=_0x4ed101[_0x1f2d97(0x130)]('.')[_0x1f2d97(0x140)]();return(0x0,utils_1[_0x1f2d97(0xd6)])()+'.'+_0x201ad9;}async['validateAndMoveFileAsync'](_0x4a1042,_0x108d31){const _0x3a750f=a136_0x4018a1;if(!_0x4a1042[_0x3a750f(0xeb)])return;const _0x39e4d5=constants_1[_0x3a750f(0x12c)]+'/'+_0x4a1042['fileName'],_0x575db8=_0x108d31||this[_0x3a750f(0xe1)](_0x4a1042[_0x3a750f(0xeb)]),_0x5c1c16=constants_1['AUDIO_DIR']+'/'+_0x575db8;if(!(0x0,file_1['isFileExist'])(_0x39e4d5))throw new Error(_0x3a750f(0x112));!(0x0,file_1[_0x3a750f(0xd7)])(constants_1[_0x3a750f(0x141)])&&(0x0,file_1[_0x3a750f(0x145)])(constants_1[_0x3a750f(0x141)]),await(0x0,file_1[_0x3a750f(0xfa)])(_0x39e4d5,_0x5c1c16),_0x4a1042[_0x3a750f(0xeb)]=_0x575db8;}};__decorate([(0x0,event_emitter_1[a136_0x4018a1(0x14b)])(sound_1[a136_0x4018a1(0x11e)][a136_0x4018a1(0x119)]),__metadata('design:type',Function),__metadata('design:paramtypes',[Object]),__metadata('design:returntype',Promise)],SoundService[a136_0x4018a1(0x135)],a136_0x4018a1(0x12d),null),__decorate([(0x0,event_emitter_1['OnEvent'])(sound_1[a136_0x4018a1(0x11e)]['VoiceRecorded']),__metadata('design:type',Function),__metadata(a136_0x4018a1(0xe4),[Object]),__metadata(a136_0x4018a1(0x124),Promise)],SoundService[a136_0x4018a1(0x135)],a136_0x4018a1(0x10b),null),__decorate([(0x0,event_emitter_1[a136_0x4018a1(0x14b)])(sound_1[a136_0x4018a1(0x11e)]['TextToAudio']),__metadata(a136_0x4018a1(0x127),Function),__metadata(a136_0x4018a1(0xe4),[Object]),__metadata(a136_0x4018a1(0x124),Promise)],SoundService[a136_0x4018a1(0x135)],a136_0x4018a1(0x113),null),SoundService=SoundService_1=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,mongoose_1[a136_0x4018a1(0x142)])('Sound')),__param(0x5,(0x0,common_1[a136_0x4018a1(0xf8)])(sound_gateway_1[a136_0x4018a1(0xf6)])),__metadata('design:paramtypes',[mongoose_2[a136_0x4018a1(0xdf)],agenda_service_1[a136_0x4018a1(0x13e)],upload_service_1[a136_0x4018a1(0x136)],text_to_audio_service_1[a136_0x4018a1(0x131)],streaming_service_1[a136_0x4018a1(0x111)],sound_gateway_1['SoundGateway']])],SoundService),exports[a136_0x4018a1(0x115)]=SoundService;