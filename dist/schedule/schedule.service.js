'use strict';const a108_0x51f80=a108_0x3eb9;(function(_0x44ee07,_0x21b22d){const _0x414aa0=a108_0x3eb9,_0x4357a5=_0x44ee07();while(!![]){try{const _0x4fbd2f=parseInt(_0x414aa0(0xd9))/0x1+-parseInt(_0x414aa0(0xc3))/0x2+-parseInt(_0x414aa0(0xcd))/0x3+-parseInt(_0x414aa0(0xc8))/0x4*(parseInt(_0x414aa0(0xfa))/0x5)+-parseInt(_0x414aa0(0xdb))/0x6*(parseInt(_0x414aa0(0xfc))/0x7)+parseInt(_0x414aa0(0xc0))/0x8*(parseInt(_0x414aa0(0xe9))/0x9)+-parseInt(_0x414aa0(0xec))/0xa*(-parseInt(_0x414aa0(0xd2))/0xb);if(_0x4fbd2f===_0x21b22d)break;else _0x4357a5['push'](_0x4357a5['shift']());}catch(_0x256f43){_0x4357a5['push'](_0x4357a5['shift']());}}}(a108_0x3f93,0xb643c));var __decorate=this&&this['__decorate']||function(_0x231f14,_0x115d69,_0x384d92,_0x5761c7){const _0xf3b8fe=a108_0x3eb9;var _0x140846=arguments[_0xf3b8fe(0xc9)],_0x6faca6=_0x140846<0x3?_0x115d69:_0x5761c7===null?_0x5761c7=Object[_0xf3b8fe(0xd1)](_0x115d69,_0x384d92):_0x5761c7,_0x1e3ae8;if(typeof Reflect===_0xf3b8fe(0xd4)&&typeof Reflect[_0xf3b8fe(0xd7)]===_0xf3b8fe(0xf3))_0x6faca6=Reflect['decorate'](_0x231f14,_0x115d69,_0x384d92,_0x5761c7);else{for(var _0x1d1e27=_0x231f14[_0xf3b8fe(0xc9)]-0x1;_0x1d1e27>=0x0;_0x1d1e27--)if(_0x1e3ae8=_0x231f14[_0x1d1e27])_0x6faca6=(_0x140846<0x3?_0x1e3ae8(_0x6faca6):_0x140846>0x3?_0x1e3ae8(_0x115d69,_0x384d92,_0x6faca6):_0x1e3ae8(_0x115d69,_0x384d92))||_0x6faca6;}return _0x140846>0x3&&_0x6faca6&&Object[_0xf3b8fe(0xfd)](_0x115d69,_0x384d92,_0x6faca6),_0x6faca6;},__metadata=this&&this[a108_0x51f80(0xea)]||function(_0x55e548,_0x444a6e){const _0x381f69=a108_0x51f80;if(typeof Reflect==='object'&&typeof Reflect[_0x381f69(0xc5)]===_0x381f69(0xf3))return Reflect[_0x381f69(0xc5)](_0x55e548,_0x444a6e);},__param=this&&this['__param']||function(_0x5c988d,_0xf4eb9){return function(_0x1fdba9,_0xf6d122){_0xf4eb9(_0x1fdba9,_0xf6d122,_0x5c988d);};};Object['defineProperty'](exports,a108_0x51f80(0xca),{'value':!![]}),exports[a108_0x51f80(0xce)]=void 0x0;function a108_0x3f93(){const _0x94be90=['findByIdAndDelete','remove','getTime','Schedule','push','createdAtUtc','9VuNXZu','__metadata','updatedAtUtc','175220iClhmA','find','toDate','toObject','update','findByIdAndUpdate','removeOtherExistingIncludeDates','function','Model','Injectable','format','scheduleModel','uuid','filter','476740JkBjWH','exec','21BQSwcv','defineProperty','save','map','@nestjs/mongoose','1661224ruqfbP','clone','startOf','2392788POaSdA','mongoose','metadata','addIncludeDate','InjectModel','20XzrGGx','length','__esModule','findById','sort','2673174wsxpyj','ScheduleService','findEligibleSchedule','includes','getOwnPropertyDescriptor','1562YLCvtz','toISOString','object','design:paramtypes','YYYY-MM-DD','decorate','findAllActiveSchedules','617137XMiIDz','isAfter','4332cUwmWp','assign','findOne','findAll','includeDates','create','setDate','findEligibleScheduleBetween'];a108_0x3f93=function(){return _0x94be90;};return a108_0x3f93();}function a108_0x3eb9(_0x3a94ba,_0x504f6e){const _0x3f934a=a108_0x3f93();return a108_0x3eb9=function(_0x3eb922,_0x4c0f73){_0x3eb922=_0x3eb922-0xbf;let _0x262e0e=_0x3f934a[_0x3eb922];return _0x262e0e;},a108_0x3eb9(_0x3a94ba,_0x504f6e);}const common_1=require('@nestjs/common'),mongoose_1=require(a108_0x51f80(0xbf)),mongoose_2=require(a108_0x51f80(0xc4)),dayjs=require('dayjs'),utils_1=require('../common/utils'),schedulePrioritySort=(_0x53568a,_0x8cbfe6)=>dayjs(_0x53568a[a108_0x51f80(0xe8)])[a108_0x51f80(0xda)](dayjs(_0x8cbfe6[a108_0x51f80(0xe8)]))?-0x1:0x1;let ScheduleService=class ScheduleService{constructor(_0x529888){const _0x1cddf3=a108_0x51f80;this[_0x1cddf3(0xf7)]=_0x529888;}async[a108_0x51f80(0xe0)](_0x25eef1){const _0x492c79=a108_0x51f80,_0x3a9e65=new this[(_0x492c79(0xf7))](_0x25eef1);return _0x3a9e65[_0x492c79(0xfe)]();}async[a108_0x51f80(0xde)](){const _0x30487f=a108_0x51f80,_0x19823f=await this[_0x30487f(0xf7)][_0x30487f(0xed)]()[_0x30487f(0xfb)]();return _0x19823f;}async[a108_0x51f80(0xdd)](_0x2b2342){const _0x8b39bf=a108_0x51f80,_0x3d4da4=await this['scheduleModel'][_0x8b39bf(0xcb)](_0x2b2342);return _0x3d4da4;}async[a108_0x51f80(0xcf)](_0x47e309){const _0x3d46db=a108_0x51f80,_0x589e76=await this[_0x3d46db(0xd8)](_0x47e309),_0x3ec4bb=_0x589e76[_0x3d46db(0xf9)](_0x1e5bc9=>_0x1e5bc9[_0x3d46db(0xdf)][_0x3d46db(0xc9)]>0x0&&_0x1e5bc9['includeDates'][_0x3d46db(0xff)](_0x4e810b=>dayjs(_0x4e810b)[_0x3d46db(0xf6)]('YYYY-MM-DD'))[_0x3d46db(0xd0)](dayjs(_0x47e309)[_0x3d46db(0xf6)](_0x3d46db(0xd6))))[_0x3d46db(0xcc)](schedulePrioritySort);if(_0x3ec4bb[_0x3d46db(0xc9)]>0x0)return _0x3ec4bb[0x0];const _0x42ba6f=_0x589e76[_0x3d46db(0xf9)](_0x21c105=>_0x21c105['weekDays']['includes'](_0x47e309['getDay']()))[_0x3d46db(0xcc)](schedulePrioritySort);if(_0x42ba6f[_0x3d46db(0xc9)]>0x0)return _0x42ba6f[0x0];return null;}async[a108_0x51f80(0xd8)](_0x4ca29f){const _0x183d48=a108_0x51f80,_0x47ba38=dayjs(_0x4ca29f)[_0x183d48(0xc2)]('day')[_0x183d48(0xee)](),_0x12021a={'$and':[{'$or':[{'startDate':{'$lte':_0x4ca29f},'endDate':{'$gte':_0x4ca29f}},{'startDate':{'$lte':_0x4ca29f},'endDate':null},{'startDate':null,'endDate':{'$gte':_0x4ca29f}}]},{'excludeDates':{'$nin':[_0x47ba38]}}]},_0x5c634b=await this[_0x183d48(0xf7)][_0x183d48(0xed)](_0x12021a)[_0x183d48(0xfb)]();return _0x5c634b;}async[a108_0x51f80(0xe2)](_0x146e70,_0x447630){const _0x146fbe=a108_0x51f80,_0x210ff0=new Date(_0x146e70),_0x3b1a43={};while(_0x210ff0<=_0x447630){const _0x293605=await this[_0x146fbe(0xcf)](_0x210ff0);_0x293605&&(_0x3b1a43[dayjs(_0x210ff0)[_0x146fbe(0xf6)](_0x146fbe(0xd6))]=_0x293605),_0x210ff0[_0x146fbe(0xe1)](_0x210ff0['getDate']()+0x1);}return _0x3b1a43;}async[a108_0x51f80(0xf0)](_0x3cb0da,_0x2464d7){const _0x102478=a108_0x51f80,_0x30194a=await this['scheduleModel'][_0x102478(0xf1)](_0x3cb0da,Object[_0x102478(0xdc)](Object[_0x102478(0xdc)]({},_0x2464d7),{'updatedAtUtc':new Date()}),{'new':!![]})[_0x102478(0xfb)]();return _0x30194a[_0x102478(0xdf)]&&await this[_0x102478(0xf2)](_0x3cb0da,_0x30194a[_0x102478(0xdf)]),_0x30194a;}async[a108_0x51f80(0xe4)](_0x37f7e1){const _0x4a7d82=a108_0x51f80,_0x2ba7c0=await this[_0x4a7d82(0xf7)][_0x4a7d82(0xe3)](_0x37f7e1)[_0x4a7d82(0xfb)]();return _0x2ba7c0;}async[a108_0x51f80(0xc6)](_0x34f9bf,_0x59c619){const _0x244572=a108_0x51f80,_0x164404=await this['findOne'](_0x34f9bf);_0x164404[_0x244572(0xdf)]['findIndex'](_0x21db01=>_0x21db01[_0x244572(0xe5)]()===_0x59c619[_0x244572(0xe5)]())===-0x1&&_0x164404[_0x244572(0xdf)][_0x244572(0xe7)](_0x59c619);const _0x110efd=await _0x164404['save']();return await this[_0x244572(0xf2)](_0x34f9bf,[_0x59c619]),_0x110efd;}async[a108_0x51f80(0xf2)](_0x4091dd,_0x377bf5){const _0x218b8b=a108_0x51f80,_0x28c156=await this[_0x218b8b(0xf7)][_0x218b8b(0xed)]({'_id':{'$ne':_0x4091dd},'includeDates':{'$in':_0x377bf5}})['exec'](),_0x62df97=_0x377bf5[_0x218b8b(0xff)](_0x44a7d7=>_0x44a7d7[_0x218b8b(0xd3)]());await Promise['all'](_0x28c156[_0x218b8b(0xff)](_0x4623ad=>{const _0xe5d479=_0x218b8b,_0x48cff0=_0x4623ad[_0xe5d479(0xdf)][_0xe5d479(0xf9)](_0x59b324=>!_0x62df97[_0xe5d479(0xd0)](_0x59b324['toISOString']()));return _0x4623ad[_0xe5d479(0xdf)]=_0x48cff0,_0x4623ad[_0xe5d479(0xeb)]=new Date(),_0x4623ad[_0xe5d479(0xfe)]();}));}async[a108_0x51f80(0xc1)](_0x469b1e){const _0xb5972d=a108_0x51f80,_0x3e20d9=await this['findOne'](_0x469b1e),_0x408379=_0x3e20d9['events'][_0xb5972d(0xff)](_0x3c460e=>Object['assign'](Object[_0xb5972d(0xdc)]({},_0x3c460e),{'id':(0x0,utils_1[_0xb5972d(0xf8)])()})),_0x19700e=new this['scheduleModel'](Object[_0xb5972d(0xdc)](Object['assign']({},_0x3e20d9[_0xb5972d(0xef)]()),{'events':_0x408379,'_id':undefined,'createdAtUtc':new Date(),'updatedAtUtc':new Date()}));return _0x19700e[_0xb5972d(0xfe)]();}};ScheduleService=__decorate([(0x0,common_1[a108_0x51f80(0xf5)])(),__param(0x0,(0x0,mongoose_1[a108_0x51f80(0xc7)])(a108_0x51f80(0xe6))),__metadata(a108_0x51f80(0xd5),[mongoose_2[a108_0x51f80(0xf4)]])],ScheduleService),exports[a108_0x51f80(0xce)]=ScheduleService;