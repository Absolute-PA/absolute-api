'use strict';const a108_0x4e8741=a108_0x5281;(function(_0x5e96c2,_0x3b2623){const _0x2efbe4=a108_0x5281,_0x461719=_0x5e96c2();while(!![]){try{const _0x448a91=-parseInt(_0x2efbe4(0x199))/0x1+parseInt(_0x2efbe4(0x184))/0x2+parseInt(_0x2efbe4(0x1a4))/0x3+-parseInt(_0x2efbe4(0x198))/0x4+-parseInt(_0x2efbe4(0x17e))/0x5*(parseInt(_0x2efbe4(0x1a7))/0x6)+-parseInt(_0x2efbe4(0x18f))/0x7*(-parseInt(_0x2efbe4(0x1a0))/0x8)+parseInt(_0x2efbe4(0x1aa))/0x9;if(_0x448a91===_0x3b2623)break;else _0x461719['push'](_0x461719['shift']());}catch(_0x35c46f){_0x461719['push'](_0x461719['shift']());}}}(a108_0x54cd,0x2a993));var __decorate=this&&this['__decorate']||function(_0x23a38e,_0x426b7b,_0xec9aac,_0x1134a8){const _0x2fb44f=a108_0x5281;var _0x590518=arguments[_0x2fb44f(0x187)],_0x3bc661=_0x590518<0x3?_0x426b7b:_0x1134a8===null?_0x1134a8=Object[_0x2fb44f(0x188)](_0x426b7b,_0xec9aac):_0x1134a8,_0x4ca824;if(typeof Reflect===_0x2fb44f(0x1b0)&&typeof Reflect[_0x2fb44f(0x17f)]==='function')_0x3bc661=Reflect[_0x2fb44f(0x17f)](_0x23a38e,_0x426b7b,_0xec9aac,_0x1134a8);else{for(var _0xa4dbe9=_0x23a38e[_0x2fb44f(0x187)]-0x1;_0xa4dbe9>=0x0;_0xa4dbe9--)if(_0x4ca824=_0x23a38e[_0xa4dbe9])_0x3bc661=(_0x590518<0x3?_0x4ca824(_0x3bc661):_0x590518>0x3?_0x4ca824(_0x426b7b,_0xec9aac,_0x3bc661):_0x4ca824(_0x426b7b,_0xec9aac))||_0x3bc661;}return _0x590518>0x3&&_0x3bc661&&Object[_0x2fb44f(0x175)](_0x426b7b,_0xec9aac,_0x3bc661),_0x3bc661;},__metadata=this&&this[a108_0x4e8741(0x1a5)]||function(_0x126ac2,_0x55c297){const _0x4f250c=a108_0x4e8741;if(typeof Reflect===_0x4f250c(0x1b0)&&typeof Reflect['metadata']==='function')return Reflect[_0x4f250c(0x196)](_0x126ac2,_0x55c297);},__param=this&&this[a108_0x4e8741(0x189)]||function(_0x540da8,_0xebe53a){return function(_0xfef8d2,_0x235855){_0xebe53a(_0xfef8d2,_0x235855,_0x540da8);};};Object[a108_0x4e8741(0x175)](exports,'__esModule',{'value':!![]}),exports['ScheduleService']=void 0x0;function a108_0x54cd(){const _0x46c396=['uuid','isAfter','toObject','16hjWdbB','findAll','findEligibleScheduleBetween','InjectModel','740766kzsPdH','__metadata','scheduleModel','8094wIHwmd','find','day','2683683GYeNMI','design:paramtypes','toISOString','getTime','includes','YYYY-MM-DD','object','../common/utils','defineProperty','format','getDay','startOf','filter','Injectable','mongoose','Model','findIndex','295QMpKHX','decorate','includeDates','save','toDate','dayjs','286702cVyctu','all','setDate','length','getOwnPropertyDescriptor','__param','@nestjs/common','remove','sort','findOne','push','385350yLfgdF','exec','assign','Schedule','events','findById','map','metadata','findEligibleSchedule','1074604tMVSXY','275835pWxszz','ScheduleService','findByIdAndDelete','removeOtherExistingIncludeDates'];a108_0x54cd=function(){return _0x46c396;};return a108_0x54cd();}const common_1=require(a108_0x4e8741(0x18a)),mongoose_1=require('@nestjs/mongoose'),mongoose_2=require(a108_0x4e8741(0x17b)),dayjs=require(a108_0x4e8741(0x183)),utils_1=require(a108_0x4e8741(0x174)),schedulePrioritySort=(_0x48e303,_0x3aa2be)=>dayjs(_0x48e303['createdAtUtc'])[a108_0x4e8741(0x19e)](dayjs(_0x3aa2be['createdAtUtc']))?-0x1:0x1;function a108_0x5281(_0x52eb4a,_0x10cc83){const _0x54cd54=a108_0x54cd();return a108_0x5281=function(_0x528139,_0x26610c){_0x528139=_0x528139-0x174;let _0x1bf71d=_0x54cd54[_0x528139];return _0x1bf71d;},a108_0x5281(_0x52eb4a,_0x10cc83);}let ScheduleService=class ScheduleService{constructor(_0x212e2f){const _0x1fba3a=a108_0x4e8741;this[_0x1fba3a(0x1a6)]=_0x212e2f;}async['create'](_0x2e7c70){const _0xf57960=a108_0x4e8741,_0x23698c=new this['scheduleModel'](_0x2e7c70);return _0x23698c[_0xf57960(0x181)]();}async[a108_0x4e8741(0x1a1)](){const _0x25998a=a108_0x4e8741,_0x4d66e1=await this[_0x25998a(0x1a6)][_0x25998a(0x1a8)]()[_0x25998a(0x190)]();return _0x4d66e1;}async['findOne'](_0x586cba){const _0x4b841d=a108_0x4e8741,_0x1afd12=await this[_0x4b841d(0x1a6)][_0x4b841d(0x194)](_0x586cba);return _0x1afd12;}async[a108_0x4e8741(0x197)](_0x303ca9){const _0x308824=a108_0x4e8741,_0x54cd16=await this['findAllActiveSchedules'](_0x303ca9),_0x33d336=_0x54cd16[_0x308824(0x179)](_0x430206=>_0x430206[_0x308824(0x180)]['length']>0x0&&_0x430206['includeDates'][_0x308824(0x195)](_0x23d63a=>dayjs(_0x23d63a)[_0x308824(0x176)]('YYYY-MM-DD'))[_0x308824(0x1ae)](dayjs(_0x303ca9)['format'](_0x308824(0x1af))))[_0x308824(0x18c)](schedulePrioritySort);if(_0x33d336['length']>0x0)return _0x33d336[0x0];const _0x4881f2=_0x54cd16[_0x308824(0x179)](_0x296b1c=>_0x296b1c['weekDays'][_0x308824(0x1ae)](_0x303ca9[_0x308824(0x177)]()))[_0x308824(0x18c)](schedulePrioritySort);if(_0x4881f2[_0x308824(0x187)]>0x0)return _0x4881f2[0x0];return null;}async['findAllActiveSchedules'](_0x1a7aa8){const _0x13fc99=a108_0x4e8741,_0x364fdc=dayjs(_0x1a7aa8)[_0x13fc99(0x178)](_0x13fc99(0x1a9))[_0x13fc99(0x182)](),_0x20adcb={'$and':[{'$or':[{'startDate':{'$lte':_0x1a7aa8},'endDate':{'$gte':_0x1a7aa8}},{'startDate':{'$lte':_0x1a7aa8},'endDate':null},{'startDate':null,'endDate':{'$gte':_0x1a7aa8}}]},{'excludeDates':{'$nin':[_0x364fdc]}}]},_0x226323=await this[_0x13fc99(0x1a6)][_0x13fc99(0x1a8)](_0x20adcb)['exec']();return _0x226323;}async[a108_0x4e8741(0x1a2)](_0x45ca49,_0x433e84){const _0x21cb22=a108_0x4e8741,_0x1977fa=new Date(_0x45ca49),_0x19df33={};while(_0x1977fa<=_0x433e84){const _0x516697=await this['findEligibleSchedule'](_0x1977fa);_0x516697&&(_0x19df33[dayjs(_0x1977fa)[_0x21cb22(0x176)](_0x21cb22(0x1af))]=_0x516697),_0x1977fa[_0x21cb22(0x186)](_0x1977fa['getDate']()+0x1);}return _0x19df33;}async['update'](_0x5dd940,_0x54f042){const _0x557ed6=a108_0x4e8741,_0x4ac86d=await this[_0x557ed6(0x1a6)]['findByIdAndUpdate'](_0x5dd940,Object[_0x557ed6(0x191)](Object[_0x557ed6(0x191)]({},_0x54f042),{'updatedAtUtc':new Date()}),{'new':!![]})[_0x557ed6(0x190)]();return _0x4ac86d['includeDates']&&await this['removeOtherExistingIncludeDates'](_0x5dd940,_0x4ac86d[_0x557ed6(0x180)]),_0x4ac86d;}async[a108_0x4e8741(0x18b)](_0x40f751){const _0x4a115d=a108_0x4e8741,_0x123de6=await this[_0x4a115d(0x1a6)][_0x4a115d(0x19b)](_0x40f751)[_0x4a115d(0x190)]();return _0x123de6;}async['addIncludeDate'](_0x4e294c,_0x49d735){const _0x10e485=a108_0x4e8741,_0x238752=await this[_0x10e485(0x18d)](_0x4e294c);_0x238752['includeDates'][_0x10e485(0x17d)](_0x3d2d5f=>_0x3d2d5f['getTime']()===_0x49d735[_0x10e485(0x1ad)]())===-0x1&&_0x238752[_0x10e485(0x180)][_0x10e485(0x18e)](_0x49d735);const _0x1dffa6=await _0x238752[_0x10e485(0x181)]();return await this[_0x10e485(0x19c)](_0x4e294c,[_0x49d735]),_0x1dffa6;}async[a108_0x4e8741(0x19c)](_0x1642f6,_0xd1b2cd){const _0x14a111=a108_0x4e8741,_0x2d0b4a=await this[_0x14a111(0x1a6)]['find']({'_id':{'$ne':_0x1642f6},'includeDates':{'$in':_0xd1b2cd}})[_0x14a111(0x190)](),_0xfc3c07=_0xd1b2cd['map'](_0x25d522=>_0x25d522[_0x14a111(0x1ac)]());await Promise[_0x14a111(0x185)](_0x2d0b4a[_0x14a111(0x195)](_0x1524a2=>{const _0x52b6e3=_0x14a111,_0x66f1e3=_0x1524a2[_0x52b6e3(0x180)][_0x52b6e3(0x179)](_0x1ac086=>!_0xfc3c07['includes'](_0x1ac086['toISOString']()));return _0x1524a2['includeDates']=_0x66f1e3,_0x1524a2['updatedAtUtc']=new Date(),_0x1524a2[_0x52b6e3(0x181)]();}));}async['clone'](_0x50d75c){const _0x3f3f49=a108_0x4e8741,_0x2f337d=await this[_0x3f3f49(0x18d)](_0x50d75c),_0x492821=_0x2f337d[_0x3f3f49(0x193)][_0x3f3f49(0x195)](_0x3c94e1=>Object[_0x3f3f49(0x191)](Object[_0x3f3f49(0x191)]({},_0x3c94e1),{'id':(0x0,utils_1[_0x3f3f49(0x19d)])()})),_0x2157e0=new this[(_0x3f3f49(0x1a6))](Object[_0x3f3f49(0x191)](Object[_0x3f3f49(0x191)]({},_0x2f337d[_0x3f3f49(0x19f)]()),{'events':_0x492821,'_id':undefined,'createdAtUtc':new Date(),'updatedAtUtc':new Date()}));return _0x2157e0[_0x3f3f49(0x181)]();}};ScheduleService=__decorate([(0x0,common_1[a108_0x4e8741(0x17a)])(),__param(0x0,(0x0,mongoose_1[a108_0x4e8741(0x1a3)])(a108_0x4e8741(0x192))),__metadata(a108_0x4e8741(0x1ab),[mongoose_2[a108_0x4e8741(0x17c)]])],ScheduleService),exports[a108_0x4e8741(0x19a)]=ScheduleService;