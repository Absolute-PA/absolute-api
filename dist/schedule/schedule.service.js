'use strict';const a111_0x37327a=a111_0x4116;function a111_0x4116(_0x4b3add,_0x1a3e99){const _0x544e9a=a111_0x544e();return a111_0x4116=function(_0x4116f3,_0x4f6d8d){_0x4116f3=_0x4116f3-0xb4;let _0x458645=_0x544e9a[_0x4116f3];return _0x458645;},a111_0x4116(_0x4b3add,_0x1a3e99);}(function(_0x372e42,_0x23184c){const _0x5bfa34=a111_0x4116,_0x3863bd=_0x372e42();while(!![]){try{const _0x3810a3=-parseInt(_0x5bfa34(0xe2))/0x1+-parseInt(_0x5bfa34(0xdc))/0x2+-parseInt(_0x5bfa34(0xe9))/0x3+parseInt(_0x5bfa34(0xbb))/0x4*(parseInt(_0x5bfa34(0xd1))/0x5)+-parseInt(_0x5bfa34(0xb9))/0x6*(-parseInt(_0x5bfa34(0xe4))/0x7)+-parseInt(_0x5bfa34(0xcf))/0x8+parseInt(_0x5bfa34(0xc1))/0x9;if(_0x3810a3===_0x23184c)break;else _0x3863bd['push'](_0x3863bd['shift']());}catch(_0x58153d){_0x3863bd['push'](_0x3863bd['shift']());}}}(a111_0x544e,0xd5a3d));function a111_0x544e(){const _0x49984b=['format','toDate','sort','YYYY-MM-DD','findEligibleScheduleBetween','find','1050126MumCAq','isAfter','scheduleModel','Schedule','update','decorate','137760PqbFtq','defineProperty','72107MGIagw','clone','assign','design:paramtypes','uuid','2232903NSizPL','__esModule','getOwnPropertyDescriptor','toObject','ScheduleService','findAll','create','removeOtherExistingIncludeDates','filter','exec','getDay','includes','642oZwLCz','@nestjs/mongoose','65444NJZFYr','day','length','__param','findByIdAndDelete','push','7941384NWHwEZ','all','mongoose','save','Model','dayjs','includeDates','findEligibleSchedule','findIndex','InjectModel','remove','updatedAtUtc','object','__decorate','4687072uhCLow','map','270GqWQgn','findOne','function','toISOString','setDate'];a111_0x544e=function(){return _0x49984b;};return a111_0x544e();}var __decorate=this&&this[a111_0x37327a(0xce)]||function(_0x3bf01a,_0x294b8d,_0x160d4a,_0x47f805){const _0x3f630e=a111_0x37327a;var _0x23e85a=arguments[_0x3f630e(0xbd)],_0x578490=_0x23e85a<0x3?_0x294b8d:_0x47f805===null?_0x47f805=Object[_0x3f630e(0xeb)](_0x294b8d,_0x160d4a):_0x47f805,_0x309497;if(typeof Reflect===_0x3f630e(0xcd)&&typeof Reflect['decorate']===_0x3f630e(0xd3))_0x578490=Reflect[_0x3f630e(0xe1)](_0x3bf01a,_0x294b8d,_0x160d4a,_0x47f805);else{for(var _0x218fa5=_0x3bf01a['length']-0x1;_0x218fa5>=0x0;_0x218fa5--)if(_0x309497=_0x3bf01a[_0x218fa5])_0x578490=(_0x23e85a<0x3?_0x309497(_0x578490):_0x23e85a>0x3?_0x309497(_0x294b8d,_0x160d4a,_0x578490):_0x309497(_0x294b8d,_0x160d4a))||_0x578490;}return _0x23e85a>0x3&&_0x578490&&Object['defineProperty'](_0x294b8d,_0x160d4a,_0x578490),_0x578490;},__metadata=this&&this['__metadata']||function(_0x1d54e3,_0x171769){const _0x17f4dc=a111_0x37327a;if(typeof Reflect===_0x17f4dc(0xcd)&&typeof Reflect['metadata']===_0x17f4dc(0xd3))return Reflect['metadata'](_0x1d54e3,_0x171769);},__param=this&&this[a111_0x37327a(0xbe)]||function(_0x16bab3,_0x35c795){return function(_0x189a10,_0x5dd353){_0x35c795(_0x189a10,_0x5dd353,_0x16bab3);};};Object[a111_0x37327a(0xe3)](exports,a111_0x37327a(0xea),{'value':!![]}),exports[a111_0x37327a(0xed)]=void 0x0;const common_1=require('@nestjs/common'),mongoose_1=require(a111_0x37327a(0xba)),mongoose_2=require(a111_0x37327a(0xc3)),dayjs=require(a111_0x37327a(0xc6)),utils_1=require('../common/utils'),schedulePrioritySort=(_0x371dcd,_0x273f60)=>dayjs(_0x371dcd['createdAtUtc'])[a111_0x37327a(0xdd)](dayjs(_0x273f60['createdAtUtc']))?-0x1:0x1;let ScheduleService=class ScheduleService{constructor(_0x28cc28){const _0x379125=a111_0x37327a;this[_0x379125(0xde)]=_0x28cc28;}async[a111_0x37327a(0xef)](_0x5955f5){const _0x46840d=new this['scheduleModel'](_0x5955f5);return _0x46840d['save']();}async[a111_0x37327a(0xee)](){const _0xe59feb=a111_0x37327a,_0x2e0943=await this[_0xe59feb(0xde)][_0xe59feb(0xdb)]()['exec']();return _0x2e0943;}async[a111_0x37327a(0xd2)](_0x5a7065){const _0x531265=a111_0x37327a,_0xc21215=await this[_0x531265(0xde)]['findById'](_0x5a7065);return _0xc21215;}async[a111_0x37327a(0xc8)](_0x256345){const _0x21ccc9=a111_0x37327a,_0xebf362=await this['findAllActiveSchedules'](_0x256345),_0x38581e=_0xebf362['filter'](_0x12655d=>_0x12655d[_0x21ccc9(0xc7)][_0x21ccc9(0xbd)]>0x0&&_0x12655d[_0x21ccc9(0xc7)][_0x21ccc9(0xd0)](_0x1036a7=>dayjs(_0x1036a7)[_0x21ccc9(0xd6)](_0x21ccc9(0xd9)))[_0x21ccc9(0xb8)](dayjs(_0x256345)['format'](_0x21ccc9(0xd9))))[_0x21ccc9(0xd8)](schedulePrioritySort);if(_0x38581e[_0x21ccc9(0xbd)]>0x0)return _0x38581e[0x0];const _0x597184=_0xebf362[_0x21ccc9(0xb5)](_0xa22dab=>_0xa22dab['weekDays'][_0x21ccc9(0xb8)](_0x256345[_0x21ccc9(0xb7)]()))[_0x21ccc9(0xd8)](schedulePrioritySort);if(_0x597184[_0x21ccc9(0xbd)]>0x0)return _0x597184[0x0];return null;}async['findAllActiveSchedules'](_0x4715da){const _0x19307f=a111_0x37327a,_0x3c10dd=dayjs(_0x4715da)['startOf'](_0x19307f(0xbc))[_0x19307f(0xd7)](),_0xef61a1={'$and':[{'$or':[{'startDate':{'$lte':_0x4715da},'endDate':{'$gte':_0x4715da}},{'startDate':{'$lte':_0x4715da},'endDate':null},{'startDate':null,'endDate':{'$gte':_0x4715da}}]},{'excludeDates':{'$nin':[_0x3c10dd]}}]},_0x4ed1a2=await this[_0x19307f(0xde)][_0x19307f(0xdb)](_0xef61a1)['exec']();return _0x4ed1a2;}async[a111_0x37327a(0xda)](_0xe43a78,_0x1aa2f2){const _0x4832ca=a111_0x37327a,_0x558828=new Date(_0xe43a78),_0x4ff64f={};while(_0x558828<=_0x1aa2f2){const _0x73e9cf=await this['findEligibleSchedule'](_0x558828);_0x73e9cf&&(_0x4ff64f[dayjs(_0x558828)[_0x4832ca(0xd6)]('YYYY-MM-DD')]=_0x73e9cf),_0x558828[_0x4832ca(0xd5)](_0x558828['getDate']()+0x1);}return _0x4ff64f;}async[a111_0x37327a(0xe0)](_0x4d06f1,_0x24af58){const _0x334c75=a111_0x37327a,_0x526510=await this[_0x334c75(0xde)]['findByIdAndUpdate'](_0x4d06f1,Object[_0x334c75(0xe6)](Object[_0x334c75(0xe6)]({},_0x24af58),{'updatedAtUtc':new Date()}),{'new':!![]})[_0x334c75(0xb6)]();return _0x526510[_0x334c75(0xc7)]&&await this[_0x334c75(0xb4)](_0x4d06f1,_0x526510[_0x334c75(0xc7)]),_0x526510;}async[a111_0x37327a(0xcb)](_0x3199ef){const _0x31e65d=a111_0x37327a,_0x2072a8=await this['scheduleModel'][_0x31e65d(0xbf)](_0x3199ef)['exec']();return _0x2072a8;}async['addIncludeDate'](_0x5ed654,_0x1285fe){const _0x477d94=a111_0x37327a,_0x4bc505=await this[_0x477d94(0xd2)](_0x5ed654);_0x4bc505[_0x477d94(0xc7)][_0x477d94(0xc9)](_0x5da02e=>_0x5da02e['getTime']()===_0x1285fe['getTime']())===-0x1&&_0x4bc505[_0x477d94(0xc7)][_0x477d94(0xc0)](_0x1285fe);const _0x2e20ab=await _0x4bc505['save']();return await this[_0x477d94(0xb4)](_0x5ed654,[_0x1285fe]),_0x2e20ab;}async[a111_0x37327a(0xb4)](_0x5c65ee,_0xb7a023){const _0x319312=a111_0x37327a,_0x214e32=await this['scheduleModel'][_0x319312(0xdb)]({'_id':{'$ne':_0x5c65ee},'includeDates':{'$in':_0xb7a023}})[_0x319312(0xb6)](),_0x5dec84=_0xb7a023[_0x319312(0xd0)](_0xefc5ef=>_0xefc5ef[_0x319312(0xd4)]());await Promise[_0x319312(0xc2)](_0x214e32[_0x319312(0xd0)](_0x1bd4b8=>{const _0x4e3a53=_0x319312,_0x2b5e10=_0x1bd4b8[_0x4e3a53(0xc7)][_0x4e3a53(0xb5)](_0x4712dd=>!_0x5dec84[_0x4e3a53(0xb8)](_0x4712dd[_0x4e3a53(0xd4)]()));return _0x1bd4b8[_0x4e3a53(0xc7)]=_0x2b5e10,_0x1bd4b8[_0x4e3a53(0xcc)]=new Date(),_0x1bd4b8['save']();}));}async[a111_0x37327a(0xe5)](_0x535c8b){const _0x2b9dfb=a111_0x37327a,_0x27ea4d=await this[_0x2b9dfb(0xd2)](_0x535c8b),_0xf2ca08=_0x27ea4d['events'][_0x2b9dfb(0xd0)](_0xe55e=>Object[_0x2b9dfb(0xe6)](Object[_0x2b9dfb(0xe6)]({},_0xe55e),{'id':(0x0,utils_1[_0x2b9dfb(0xe8)])()})),_0x2602ad=new this[(_0x2b9dfb(0xde))](Object[_0x2b9dfb(0xe6)](Object['assign']({},_0x27ea4d[_0x2b9dfb(0xec)]()),{'events':_0xf2ca08,'_id':undefined,'createdAtUtc':new Date(),'updatedAtUtc':new Date()}));return _0x2602ad[_0x2b9dfb(0xc4)]();}};ScheduleService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,mongoose_1[a111_0x37327a(0xca)])(a111_0x37327a(0xdf))),__metadata(a111_0x37327a(0xe7),[mongoose_2[a111_0x37327a(0xc5)]])],ScheduleService),exports[a111_0x37327a(0xed)]=ScheduleService;