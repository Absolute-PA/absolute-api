'use strict';const a111_0x5c0b73=a111_0x2b64;(function(_0x518d7c,_0x161135){const _0x5cea51=a111_0x2b64,_0xcdebbb=_0x518d7c();while(!![]){try{const _0x40e8c5=-parseInt(_0x5cea51(0x115))/0x1+-parseInt(_0x5cea51(0xf2))/0x2*(-parseInt(_0x5cea51(0x118))/0x3)+parseInt(_0x5cea51(0xf8))/0x4+parseInt(_0x5cea51(0x11e))/0x5+parseInt(_0x5cea51(0x119))/0x6*(-parseInt(_0x5cea51(0x11a))/0x7)+parseInt(_0x5cea51(0x120))/0x8+-parseInt(_0x5cea51(0xfd))/0x9;if(_0x40e8c5===_0x161135)break;else _0xcdebbb['push'](_0xcdebbb['shift']());}catch(_0x108c6b){_0xcdebbb['push'](_0xcdebbb['shift']());}}}(a111_0x4bf4,0xbf6a7));var __decorate=this&&this['__decorate']||function(_0x9801c1,_0x337997,_0x50a6e9,_0x126fcf){const _0x1018c0=a111_0x2b64;var _0x1e3aa5=arguments[_0x1018c0(0x10d)],_0x10c3d4=_0x1e3aa5<0x3?_0x337997:_0x126fcf===null?_0x126fcf=Object[_0x1018c0(0xf7)](_0x337997,_0x50a6e9):_0x126fcf,_0x2e1a40;if(typeof Reflect===_0x1018c0(0x107)&&typeof Reflect[_0x1018c0(0xf3)]===_0x1018c0(0x104))_0x10c3d4=Reflect['decorate'](_0x9801c1,_0x337997,_0x50a6e9,_0x126fcf);else{for(var _0x5e17a6=_0x9801c1[_0x1018c0(0x10d)]-0x1;_0x5e17a6>=0x0;_0x5e17a6--)if(_0x2e1a40=_0x9801c1[_0x5e17a6])_0x10c3d4=(_0x1e3aa5<0x3?_0x2e1a40(_0x10c3d4):_0x1e3aa5>0x3?_0x2e1a40(_0x337997,_0x50a6e9,_0x10c3d4):_0x2e1a40(_0x337997,_0x50a6e9))||_0x10c3d4;}return _0x1e3aa5>0x3&&_0x10c3d4&&Object[_0x1018c0(0x10c)](_0x337997,_0x50a6e9,_0x10c3d4),_0x10c3d4;},__metadata=this&&this['__metadata']||function(_0x41cbab,_0x3fe7f8){const _0x8ee304=a111_0x2b64;if(typeof Reflect===_0x8ee304(0x107)&&typeof Reflect[_0x8ee304(0x10a)]==='function')return Reflect[_0x8ee304(0x10a)](_0x41cbab,_0x3fe7f8);},__param=this&&this['__param']||function(_0x3d3e53,_0x1c1943){return function(_0x1eb86c,_0x343d76){_0x1c1943(_0x1eb86c,_0x343d76,_0x3d3e53);};};function a111_0x2b64(_0x31ae04,_0x2b3582){const _0x4bf4bf=a111_0x4bf4();return a111_0x2b64=function(_0x2b6460,_0x49f9e6){_0x2b6460=_0x2b6460-0xf1;let _0xbe6f7d=_0x4bf4bf[_0x2b6460];return _0xbe6f7d;},a111_0x2b64(_0x31ae04,_0x2b3582);}Object[a111_0x5c0b73(0x10c)](exports,a111_0x5c0b73(0x12b),{'value':!![]}),exports[a111_0x5c0b73(0x124)]=void 0x0;function a111_0x4bf4(){const _0x1b78af=['design:paramtypes','findAllActiveSchedules','2182935YSnGtq','@nestjs/mongoose','3743776xoZSud','filter','findIndex','day','ScheduleService','push','Model','removeOtherExistingIncludeDates','toObject','assign','format','__esModule','Injectable','674tghxfp','decorate','getDay','scheduleModel','create','getOwnPropertyDescriptor','2128632JQjPdE','addIncludeDate','mongoose','findEligibleScheduleBetween','setDate','3608568xPDWBn','findByIdAndDelete','getTime','getDate','toISOString','exec','sort','function','update','map','object','remove','toDate','metadata','clone','defineProperty','length','InjectModel','includeDates','findById','find','findEligibleSchedule','YYYY-MM-DD','findOne','381973AeQoFa','isAfter','save','3489UBZzjB','216CYgLRu','50883MiSFyA','createdAtUtc'];a111_0x4bf4=function(){return _0x1b78af;};return a111_0x4bf4();}const common_1=require('@nestjs/common'),mongoose_1=require(a111_0x5c0b73(0x11f)),mongoose_2=require(a111_0x5c0b73(0xfa)),dayjs=require('dayjs'),utils_1=require('../common/utils'),schedulePrioritySort=(_0x4617c5,_0x1de8e9)=>dayjs(_0x4617c5[a111_0x5c0b73(0x11b)])[a111_0x5c0b73(0x116)](dayjs(_0x1de8e9['createdAtUtc']))?-0x1:0x1;let ScheduleService=class ScheduleService{constructor(_0x5260a4){const _0x33abe1=a111_0x5c0b73;this[_0x33abe1(0xf5)]=_0x5260a4;}async[a111_0x5c0b73(0xf6)](_0x3d8f96){const _0x162be8=a111_0x5c0b73,_0x483814=new this[(_0x162be8(0xf5))](_0x3d8f96);return _0x483814['save']();}async['findAll'](){const _0x13f1c2=a111_0x5c0b73,_0x2677cc=await this['scheduleModel'][_0x13f1c2(0x111)]()[_0x13f1c2(0x102)]();return _0x2677cc;}async[a111_0x5c0b73(0x114)](_0x7be990){const _0x1c826d=a111_0x5c0b73,_0x3476cc=await this[_0x1c826d(0xf5)][_0x1c826d(0x110)](_0x7be990);return _0x3476cc;}async['findEligibleSchedule'](_0x2f902f){const _0x6ebf3d=a111_0x5c0b73,_0x9b14a3=await this[_0x6ebf3d(0x11d)](_0x2f902f),_0x1efeae=_0x9b14a3['filter'](_0x401832=>_0x401832[_0x6ebf3d(0x10f)][_0x6ebf3d(0x10d)]>0x0&&_0x401832[_0x6ebf3d(0x10f)]['map'](_0x181aa3=>dayjs(_0x181aa3)['format'](_0x6ebf3d(0x113)))['includes'](dayjs(_0x2f902f)[_0x6ebf3d(0x12a)]('YYYY-MM-DD')))['sort'](schedulePrioritySort);if(_0x1efeae[_0x6ebf3d(0x10d)]>0x0)return _0x1efeae[0x0];const _0x4f1d56=_0x9b14a3[_0x6ebf3d(0x121)](_0x3d952e=>_0x3d952e['weekDays']['includes'](_0x2f902f[_0x6ebf3d(0xf4)]()))[_0x6ebf3d(0x103)](schedulePrioritySort);if(_0x4f1d56[_0x6ebf3d(0x10d)]>0x0)return _0x4f1d56[0x0];return null;}async[a111_0x5c0b73(0x11d)](_0x268038){const _0x36937a=a111_0x5c0b73,_0x4d2320=dayjs(_0x268038)['startOf'](_0x36937a(0x123))[_0x36937a(0x109)](),_0x6af0be={'$and':[{'$or':[{'startDate':{'$lte':_0x268038},'endDate':{'$gte':_0x268038}},{'startDate':{'$lte':_0x268038},'endDate':null},{'startDate':null,'endDate':{'$gte':_0x268038}}]},{'excludeDates':{'$nin':[_0x4d2320]}}]},_0x30af0e=await this[_0x36937a(0xf5)]['find'](_0x6af0be)['exec']();return _0x30af0e;}async[a111_0x5c0b73(0xfb)](_0x2ccfe9,_0x1f7849){const _0x12598f=a111_0x5c0b73,_0x306c67=new Date(_0x2ccfe9),_0x186b06={};while(_0x306c67<=_0x1f7849){const _0x4f474f=await this[_0x12598f(0x112)](_0x306c67);_0x4f474f&&(_0x186b06[dayjs(_0x306c67)[_0x12598f(0x12a)](_0x12598f(0x113))]=_0x4f474f),_0x306c67[_0x12598f(0xfc)](_0x306c67[_0x12598f(0x100)]()+0x1);}return _0x186b06;}async[a111_0x5c0b73(0x105)](_0x7d3d33,_0x184964){const _0x289fe9=a111_0x5c0b73,_0x597704=await this['scheduleModel']['findByIdAndUpdate'](_0x7d3d33,Object[_0x289fe9(0x129)](Object[_0x289fe9(0x129)]({},_0x184964),{'updatedAtUtc':new Date()}),{'new':!![]})['exec']();return _0x597704['includeDates']&&await this[_0x289fe9(0x127)](_0x7d3d33,_0x597704[_0x289fe9(0x10f)]),_0x597704;}async[a111_0x5c0b73(0x108)](_0x4d1373){const _0x45db7c=a111_0x5c0b73,_0x15c7fd=await this['scheduleModel'][_0x45db7c(0xfe)](_0x4d1373)[_0x45db7c(0x102)]();return _0x15c7fd;}async[a111_0x5c0b73(0xf9)](_0x27199d,_0x27fc65){const _0x29ef3b=a111_0x5c0b73,_0x20ebe4=await this['findOne'](_0x27199d);_0x20ebe4[_0x29ef3b(0x10f)][_0x29ef3b(0x122)](_0x1b8f02=>_0x1b8f02[_0x29ef3b(0xff)]()===_0x27fc65[_0x29ef3b(0xff)]())===-0x1&&_0x20ebe4[_0x29ef3b(0x10f)][_0x29ef3b(0x125)](_0x27fc65);const _0x37380e=await _0x20ebe4['save']();return await this['removeOtherExistingIncludeDates'](_0x27199d,[_0x27fc65]),_0x37380e;}async['removeOtherExistingIncludeDates'](_0x36287e,_0x5a6e1a){const _0x39c190=a111_0x5c0b73,_0x3148a1=await this[_0x39c190(0xf5)]['find']({'_id':{'$ne':_0x36287e},'includeDates':{'$in':_0x5a6e1a}})['exec'](),_0xa06132=_0x5a6e1a['map'](_0x57bbb3=>_0x57bbb3[_0x39c190(0x101)]());await Promise['all'](_0x3148a1[_0x39c190(0x106)](_0x23bc39=>{const _0x2428c6=_0x39c190,_0x1366f5=_0x23bc39[_0x2428c6(0x10f)][_0x2428c6(0x121)](_0x220a81=>!_0xa06132['includes'](_0x220a81[_0x2428c6(0x101)]()));return _0x23bc39[_0x2428c6(0x10f)]=_0x1366f5,_0x23bc39['updatedAtUtc']=new Date(),_0x23bc39[_0x2428c6(0x117)]();}));}async[a111_0x5c0b73(0x10b)](_0x3a6cf5){const _0x4369c2=a111_0x5c0b73,_0x379570=await this[_0x4369c2(0x114)](_0x3a6cf5),_0x4d0b22=_0x379570['events']['map'](_0x3792ee=>Object[_0x4369c2(0x129)](Object[_0x4369c2(0x129)]({},_0x3792ee),{'id':(0x0,utils_1['uuid'])()})),_0x442240=new this[(_0x4369c2(0xf5))](Object[_0x4369c2(0x129)](Object['assign']({},_0x379570[_0x4369c2(0x128)]()),{'events':_0x4d0b22,'_id':undefined,'createdAtUtc':new Date(),'updatedAtUtc':new Date()}));return _0x442240[_0x4369c2(0x117)]();}};ScheduleService=__decorate([(0x0,common_1[a111_0x5c0b73(0xf1)])(),__param(0x0,(0x0,mongoose_1[a111_0x5c0b73(0x10e)])('Schedule')),__metadata(a111_0x5c0b73(0x11c),[mongoose_2[a111_0x5c0b73(0x126)]])],ScheduleService),exports[a111_0x5c0b73(0x124)]=ScheduleService;