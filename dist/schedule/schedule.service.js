'use strict';const a111_0x4c3993=a111_0x5a50;(function(_0x2512ca,_0x4d459e){const _0x3d36d=a111_0x5a50,_0x4df2ed=_0x2512ca();while(!![]){try{const _0x35370c=parseInt(_0x3d36d(0x16e))/0x1+parseInt(_0x3d36d(0x15b))/0x2+parseInt(_0x3d36d(0x157))/0x3*(parseInt(_0x3d36d(0x13f))/0x4)+parseInt(_0x3d36d(0x159))/0x5+-parseInt(_0x3d36d(0x142))/0x6*(-parseInt(_0x3d36d(0x148))/0x7)+-parseInt(_0x3d36d(0x13a))/0x8+-parseInt(_0x3d36d(0x156))/0x9;if(_0x35370c===_0x4d459e)break;else _0x4df2ed['push'](_0x4df2ed['shift']());}catch(_0x1639fd){_0x4df2ed['push'](_0x4df2ed['shift']());}}}(a111_0x4702,0x7bb84));function a111_0x4702(){const _0x19e84b=['function','toDate','assign','ScheduleService','893648yYtyLN','__decorate','__esModule','scheduleModel','format','save','uuid','__metadata','1234616Dtswxi','getDate','Injectable','weekDays','includeDates','36BSfNsS','../common/utils','getTime','59772sgpRcH','map','Model','defineProperty','findAll','@nestjs/mongoose','259tAbKla','toISOString','day','exec','__param','decorate','length','createdAtUtc','filter','findByIdAndUpdate','addIncludeDate','clone','find','create','14185269DbWZsi','95943xDEbsS','@nestjs/common','2833090BYYICH','YYYY-MM-DD','241070bqlgWZ','updatedAtUtc','object','includes','findById','findEligibleSchedule','all','removeOtherExistingIncludeDates','mongoose','isAfter','InjectModel','sort','update','findOne','metadata'];a111_0x4702=function(){return _0x19e84b;};return a111_0x4702();}var __decorate=this&&this[a111_0x4c3993(0x16f)]||function(_0x11fe04,_0x37b4af,_0x279733,_0xb37f9b){const _0x1e64a7=a111_0x4c3993;var _0x158ee3=arguments[_0x1e64a7(0x14e)],_0x5f5c13=_0x158ee3<0x3?_0x37b4af:_0xb37f9b===null?_0xb37f9b=Object['getOwnPropertyDescriptor'](_0x37b4af,_0x279733):_0xb37f9b,_0x4b80f0;if(typeof Reflect==='object'&&typeof Reflect[_0x1e64a7(0x14d)]===_0x1e64a7(0x16a))_0x5f5c13=Reflect['decorate'](_0x11fe04,_0x37b4af,_0x279733,_0xb37f9b);else{for(var _0x514cde=_0x11fe04['length']-0x1;_0x514cde>=0x0;_0x514cde--)if(_0x4b80f0=_0x11fe04[_0x514cde])_0x5f5c13=(_0x158ee3<0x3?_0x4b80f0(_0x5f5c13):_0x158ee3>0x3?_0x4b80f0(_0x37b4af,_0x279733,_0x5f5c13):_0x4b80f0(_0x37b4af,_0x279733))||_0x5f5c13;}return _0x158ee3>0x3&&_0x5f5c13&&Object[_0x1e64a7(0x145)](_0x37b4af,_0x279733,_0x5f5c13),_0x5f5c13;},__metadata=this&&this[a111_0x4c3993(0x175)]||function(_0x53f03d,_0x5da58f){const _0x12f9be=a111_0x4c3993;if(typeof Reflect===_0x12f9be(0x15d)&&typeof Reflect[_0x12f9be(0x169)]===_0x12f9be(0x16a))return Reflect[_0x12f9be(0x169)](_0x53f03d,_0x5da58f);},__param=this&&this[a111_0x4c3993(0x14c)]||function(_0x42d8f2,_0x2de169){return function(_0xb67984,_0x430794){_0x2de169(_0xb67984,_0x430794,_0x42d8f2);};};function a111_0x5a50(_0x56376b,_0x4ecb79){const _0x470268=a111_0x4702();return a111_0x5a50=function(_0x5a5066,_0x57992f){_0x5a5066=_0x5a5066-0x13a;let _0x14c302=_0x470268[_0x5a5066];return _0x14c302;},a111_0x5a50(_0x56376b,_0x4ecb79);}Object[a111_0x4c3993(0x145)](exports,a111_0x4c3993(0x170),{'value':!![]}),exports['ScheduleService']=void 0x0;const common_1=require(a111_0x4c3993(0x158)),mongoose_1=require(a111_0x4c3993(0x147)),mongoose_2=require(a111_0x4c3993(0x163)),dayjs=require('dayjs'),utils_1=require(a111_0x4c3993(0x140)),schedulePrioritySort=(_0x11e8f7,_0x3ab22b)=>dayjs(_0x11e8f7[a111_0x4c3993(0x14f)])[a111_0x4c3993(0x164)](dayjs(_0x3ab22b[a111_0x4c3993(0x14f)]))?-0x1:0x1;let ScheduleService=class ScheduleService{constructor(_0x4c9cab){const _0xd0bb14=a111_0x4c3993;this[_0xd0bb14(0x171)]=_0x4c9cab;}async[a111_0x4c3993(0x155)](_0x2fe569){const _0x17b414=a111_0x4c3993,_0x579fc5=new this[(_0x17b414(0x171))](_0x2fe569);return _0x579fc5[_0x17b414(0x173)]();}async[a111_0x4c3993(0x146)](){const _0x1bb3c1=a111_0x4c3993,_0x39392d=await this[_0x1bb3c1(0x171)][_0x1bb3c1(0x154)]()[_0x1bb3c1(0x14b)]();return _0x39392d;}async['findOne'](_0x510e50){const _0x42766=a111_0x4c3993,_0x111789=await this[_0x42766(0x171)][_0x42766(0x15f)](_0x510e50);return _0x111789;}async['findEligibleSchedule'](_0x22a9bc){const _0x4051cd=a111_0x4c3993,_0x518a2e=await this['findAllActiveSchedules'](_0x22a9bc),_0x5225a1=_0x518a2e[_0x4051cd(0x150)](_0x5744e0=>_0x5744e0['includeDates']['length']>0x0&&_0x5744e0[_0x4051cd(0x13e)][_0x4051cd(0x143)](_0x633ada=>dayjs(_0x633ada)[_0x4051cd(0x172)](_0x4051cd(0x15a)))[_0x4051cd(0x15e)](dayjs(_0x22a9bc)['format'](_0x4051cd(0x15a))))[_0x4051cd(0x166)](schedulePrioritySort);if(_0x5225a1[_0x4051cd(0x14e)]>0x0)return _0x5225a1[0x0];const _0x5e28d4=_0x518a2e[_0x4051cd(0x150)](_0x1f8d2b=>_0x1f8d2b[_0x4051cd(0x13d)][_0x4051cd(0x15e)](_0x22a9bc['getDay']()))['sort'](schedulePrioritySort);if(_0x5e28d4[_0x4051cd(0x14e)]>0x0)return _0x5e28d4[0x0];return null;}async['findAllActiveSchedules'](_0x57f6f6){const _0x18e96a=a111_0x4c3993,_0x287bcd=dayjs(_0x57f6f6)['startOf'](_0x18e96a(0x14a))[_0x18e96a(0x16b)](),_0x7a635f={'$and':[{'$or':[{'startDate':{'$lte':_0x57f6f6},'endDate':{'$gte':_0x57f6f6}},{'startDate':{'$lte':_0x57f6f6},'endDate':null},{'startDate':null,'endDate':{'$gte':_0x57f6f6}}]},{'excludeDates':{'$nin':[_0x287bcd]}}]},_0x2e9514=await this[_0x18e96a(0x171)][_0x18e96a(0x154)](_0x7a635f)[_0x18e96a(0x14b)]();return _0x2e9514;}async['findEligibleScheduleBetween'](_0x990d1c,_0x148a3b){const _0x373483=a111_0x4c3993,_0x137510=new Date(_0x990d1c),_0x5b860d={};while(_0x137510<=_0x148a3b){const _0x2a5201=await this[_0x373483(0x160)](_0x137510);_0x2a5201&&(_0x5b860d[dayjs(_0x137510)['format'](_0x373483(0x15a))]=_0x2a5201),_0x137510['setDate'](_0x137510[_0x373483(0x13b)]()+0x1);}return _0x5b860d;}async[a111_0x4c3993(0x167)](_0x22a537,_0xab9d71){const _0xdccc81=a111_0x4c3993,_0x3ad6cd=await this['scheduleModel'][_0xdccc81(0x151)](_0x22a537,Object[_0xdccc81(0x16c)](Object[_0xdccc81(0x16c)]({},_0xab9d71),{'updatedAtUtc':new Date()}),{'new':!![]})['exec']();return _0x3ad6cd[_0xdccc81(0x13e)]&&await this[_0xdccc81(0x162)](_0x22a537,_0x3ad6cd[_0xdccc81(0x13e)]),_0x3ad6cd;}async['remove'](_0x2a61e1){const _0x459294=a111_0x4c3993,_0x33c086=await this[_0x459294(0x171)]['findByIdAndDelete'](_0x2a61e1)[_0x459294(0x14b)]();return _0x33c086;}async[a111_0x4c3993(0x152)](_0x4cb29d,_0x331ca5){const _0x239b52=a111_0x4c3993,_0x5dcb0a=await this[_0x239b52(0x168)](_0x4cb29d);_0x5dcb0a[_0x239b52(0x13e)]['findIndex'](_0x217353=>_0x217353[_0x239b52(0x141)]()===_0x331ca5[_0x239b52(0x141)]())===-0x1&&_0x5dcb0a['includeDates']['push'](_0x331ca5);const _0x327eba=await _0x5dcb0a[_0x239b52(0x173)]();return await this[_0x239b52(0x162)](_0x4cb29d,[_0x331ca5]),_0x327eba;}async['removeOtherExistingIncludeDates'](_0x1cf5dd,_0x330255){const _0x2680d0=a111_0x4c3993,_0x1b8fca=await this[_0x2680d0(0x171)]['find']({'_id':{'$ne':_0x1cf5dd},'includeDates':{'$in':_0x330255}})[_0x2680d0(0x14b)](),_0x5887c2=_0x330255['map'](_0x5670c9=>_0x5670c9[_0x2680d0(0x149)]());await Promise[_0x2680d0(0x161)](_0x1b8fca[_0x2680d0(0x143)](_0x9835e4=>{const _0x7ae53c=_0x2680d0,_0x49fd08=_0x9835e4[_0x7ae53c(0x13e)][_0x7ae53c(0x150)](_0x3981b1=>!_0x5887c2[_0x7ae53c(0x15e)](_0x3981b1[_0x7ae53c(0x149)]()));return _0x9835e4['includeDates']=_0x49fd08,_0x9835e4[_0x7ae53c(0x15c)]=new Date(),_0x9835e4['save']();}));}async[a111_0x4c3993(0x153)](_0x800508){const _0x4d9647=a111_0x4c3993,_0x296e8e=await this[_0x4d9647(0x168)](_0x800508),_0xf47fdf=_0x296e8e['events'][_0x4d9647(0x143)](_0x2fd85d=>Object[_0x4d9647(0x16c)](Object['assign']({},_0x2fd85d),{'id':(0x0,utils_1[_0x4d9647(0x174)])()})),_0x11c39d=new this[(_0x4d9647(0x171))](Object[_0x4d9647(0x16c)](Object[_0x4d9647(0x16c)]({},_0x296e8e['toObject']()),{'events':_0xf47fdf,'_id':undefined,'createdAtUtc':new Date(),'updatedAtUtc':new Date()}));return _0x11c39d[_0x4d9647(0x173)]();}};ScheduleService=__decorate([(0x0,common_1[a111_0x4c3993(0x13c)])(),__param(0x0,(0x0,mongoose_1[a111_0x4c3993(0x165)])('Schedule')),__metadata('design:paramtypes',[mongoose_2[a111_0x4c3993(0x144)]])],ScheduleService),exports[a111_0x4c3993(0x16d)]=ScheduleService;