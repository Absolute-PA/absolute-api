'use strict';const a111_0x1e40ac=a111_0x8f56;(function(_0x538ce1,_0x4f4ff0){const _0x5c0b7e=a111_0x8f56,_0x449817=_0x538ce1();while(!![]){try{const _0x3c4eec=parseInt(_0x5c0b7e(0x17f))/0x1+-parseInt(_0x5c0b7e(0x186))/0x2+-parseInt(_0x5c0b7e(0x154))/0x3+parseInt(_0x5c0b7e(0x189))/0x4*(parseInt(_0x5c0b7e(0x15b))/0x5)+-parseInt(_0x5c0b7e(0x188))/0x6+parseInt(_0x5c0b7e(0x168))/0x7*(parseInt(_0x5c0b7e(0x17b))/0x8)+parseInt(_0x5c0b7e(0x163))/0x9;if(_0x3c4eec===_0x4f4ff0)break;else _0x449817['push'](_0x449817['shift']());}catch(_0x407c94){_0x449817['push'](_0x449817['shift']());}}}(a111_0x5efd,0xb3e4a));var __decorate=this&&this['__decorate']||function(_0xef8be7,_0x4f4caf,_0x5ec8a2,_0x17a212){const _0x4ffcb6=a111_0x8f56;var _0x42422b=arguments[_0x4ffcb6(0x170)],_0x4fba0e=_0x42422b<0x3?_0x4f4caf:_0x17a212===null?_0x17a212=Object[_0x4ffcb6(0x15f)](_0x4f4caf,_0x5ec8a2):_0x17a212,_0x3df85a;if(typeof Reflect===_0x4ffcb6(0x183)&&typeof Reflect[_0x4ffcb6(0x166)]===_0x4ffcb6(0x16c))_0x4fba0e=Reflect['decorate'](_0xef8be7,_0x4f4caf,_0x5ec8a2,_0x17a212);else{for(var _0x43691d=_0xef8be7[_0x4ffcb6(0x170)]-0x1;_0x43691d>=0x0;_0x43691d--)if(_0x3df85a=_0xef8be7[_0x43691d])_0x4fba0e=(_0x42422b<0x3?_0x3df85a(_0x4fba0e):_0x42422b>0x3?_0x3df85a(_0x4f4caf,_0x5ec8a2,_0x4fba0e):_0x3df85a(_0x4f4caf,_0x5ec8a2))||_0x4fba0e;}return _0x42422b>0x3&&_0x4fba0e&&Object['defineProperty'](_0x4f4caf,_0x5ec8a2,_0x4fba0e),_0x4fba0e;},__metadata=this&&this['__metadata']||function(_0x3e27f2,_0x125977){const _0xc09b38=a111_0x8f56;if(typeof Reflect===_0xc09b38(0x183)&&typeof Reflect['metadata']===_0xc09b38(0x16c))return Reflect[_0xc09b38(0x152)](_0x3e27f2,_0x125977);},__param=this&&this[a111_0x1e40ac(0x164)]||function(_0x32cc8b,_0x40defc){return function(_0x3f39d1,_0x30ac59){_0x40defc(_0x3f39d1,_0x30ac59,_0x32cc8b);};};Object['defineProperty'](exports,a111_0x1e40ac(0x158),{'value':!![]}),exports['ScheduleService']=void 0x0;function a111_0x5efd(){const _0x11bbda=['__param','addIncludeDate','decorate','all','7FXsKlg','findOne','includes','setDate','function','day','filter','map','length','toISOString','findEligibleScheduleBetween','exec','clone','../common/utils','findAll','dayjs','scheduleModel','mongoose','toObject','1086296VUHdFv','remove','sort','createdAtUtc','856419KrCdta','Schedule','updatedAtUtc','includeDates','object','find','findByIdAndUpdate','597898GiKQYy','format','3607416eZIGPE','2572oOfLjy','InjectModel','save','assign','push','getDate','findIndex','metadata','getDay','2596845voBkMi','findEligibleSchedule','getTime','toDate','__esModule','findAllActiveSchedules','create','1990kPQOKJ','removeOtherExistingIncludeDates','update','YYYY-MM-DD','getOwnPropertyDescriptor','weekDays','Model','events','11290698jsrInH'];a111_0x5efd=function(){return _0x11bbda;};return a111_0x5efd();}function a111_0x8f56(_0x2fb187,_0x2bcb2d){const _0x5efda8=a111_0x5efd();return a111_0x8f56=function(_0x8f56ed,_0x56e766){_0x8f56ed=_0x8f56ed-0x14d;let _0x258090=_0x5efda8[_0x8f56ed];return _0x258090;},a111_0x8f56(_0x2fb187,_0x2bcb2d);}const common_1=require('@nestjs/common'),mongoose_1=require('@nestjs/mongoose'),mongoose_2=require(a111_0x1e40ac(0x179)),dayjs=require(a111_0x1e40ac(0x177)),utils_1=require(a111_0x1e40ac(0x175)),schedulePrioritySort=(_0x3cd9a4,_0x414377)=>dayjs(_0x3cd9a4[a111_0x1e40ac(0x17e)])['isAfter'](dayjs(_0x414377[a111_0x1e40ac(0x17e)]))?-0x1:0x1;let ScheduleService=class ScheduleService{constructor(_0x1be0d6){const _0x2fdce3=a111_0x1e40ac;this[_0x2fdce3(0x178)]=_0x1be0d6;}async[a111_0x1e40ac(0x15a)](_0xbd0bd0){const _0x45d285=a111_0x1e40ac,_0x20063a=new this[(_0x45d285(0x178))](_0xbd0bd0);return _0x20063a[_0x45d285(0x14d)]();}async[a111_0x1e40ac(0x176)](){const _0x420973=a111_0x1e40ac,_0x276d73=await this[_0x420973(0x178)][_0x420973(0x184)]()[_0x420973(0x173)]();return _0x276d73;}async['findOne'](_0x405ff5){const _0xd6a575=a111_0x1e40ac,_0x4a70bc=await this[_0xd6a575(0x178)]['findById'](_0x405ff5);return _0x4a70bc;}async[a111_0x1e40ac(0x155)](_0x5112cd){const _0xb9451b=a111_0x1e40ac,_0x3bdbbc=await this[_0xb9451b(0x159)](_0x5112cd),_0x5e4415=_0x3bdbbc[_0xb9451b(0x16e)](_0x349085=>_0x349085['includeDates']['length']>0x0&&_0x349085[_0xb9451b(0x182)][_0xb9451b(0x16f)](_0x5efee1=>dayjs(_0x5efee1)[_0xb9451b(0x187)]('YYYY-MM-DD'))[_0xb9451b(0x16a)](dayjs(_0x5112cd)['format'](_0xb9451b(0x15e))))[_0xb9451b(0x17d)](schedulePrioritySort);if(_0x5e4415['length']>0x0)return _0x5e4415[0x0];const _0x50c62d=_0x3bdbbc[_0xb9451b(0x16e)](_0x3c19f1=>_0x3c19f1[_0xb9451b(0x160)][_0xb9451b(0x16a)](_0x5112cd[_0xb9451b(0x153)]()))['sort'](schedulePrioritySort);if(_0x50c62d['length']>0x0)return _0x50c62d[0x0];return null;}async['findAllActiveSchedules'](_0x4cc56a){const _0x6a95ce=a111_0x1e40ac,_0x8afc9=dayjs(_0x4cc56a)['startOf'](_0x6a95ce(0x16d))[_0x6a95ce(0x157)](),_0x5c512e={'$and':[{'$or':[{'startDate':{'$lte':_0x4cc56a},'endDate':{'$gte':_0x4cc56a}},{'startDate':{'$lte':_0x4cc56a},'endDate':null},{'startDate':null,'endDate':{'$gte':_0x4cc56a}}]},{'excludeDates':{'$nin':[_0x8afc9]}}]},_0x24899e=await this[_0x6a95ce(0x178)][_0x6a95ce(0x184)](_0x5c512e)['exec']();return _0x24899e;}async[a111_0x1e40ac(0x172)](_0x396eda,_0x16260e){const _0x17788f=a111_0x1e40ac,_0x55ed2a=new Date(_0x396eda),_0x40ceab={};while(_0x55ed2a<=_0x16260e){const _0x3ba07a=await this['findEligibleSchedule'](_0x55ed2a);_0x3ba07a&&(_0x40ceab[dayjs(_0x55ed2a)[_0x17788f(0x187)](_0x17788f(0x15e))]=_0x3ba07a),_0x55ed2a[_0x17788f(0x16b)](_0x55ed2a[_0x17788f(0x150)]()+0x1);}return _0x40ceab;}async[a111_0x1e40ac(0x15d)](_0x5ed459,_0x3fb2d0){const _0xede81a=a111_0x1e40ac,_0x6cd97d=await this[_0xede81a(0x178)][_0xede81a(0x185)](_0x5ed459,Object[_0xede81a(0x14e)](Object[_0xede81a(0x14e)]({},_0x3fb2d0),{'updatedAtUtc':new Date()}),{'new':!![]})[_0xede81a(0x173)]();return _0x6cd97d[_0xede81a(0x182)]&&await this['removeOtherExistingIncludeDates'](_0x5ed459,_0x6cd97d[_0xede81a(0x182)]),_0x6cd97d;}async[a111_0x1e40ac(0x17c)](_0x8bcf00){const _0x3cdaf7=a111_0x1e40ac,_0x226e94=await this[_0x3cdaf7(0x178)]['findByIdAndDelete'](_0x8bcf00)[_0x3cdaf7(0x173)]();return _0x226e94;}async[a111_0x1e40ac(0x165)](_0xf1d388,_0x46e7e9){const _0x44619d=a111_0x1e40ac,_0x264387=await this[_0x44619d(0x169)](_0xf1d388);_0x264387['includeDates'][_0x44619d(0x151)](_0x430724=>_0x430724[_0x44619d(0x156)]()===_0x46e7e9[_0x44619d(0x156)]())===-0x1&&_0x264387[_0x44619d(0x182)][_0x44619d(0x14f)](_0x46e7e9);const _0x82e639=await _0x264387[_0x44619d(0x14d)]();return await this[_0x44619d(0x15c)](_0xf1d388,[_0x46e7e9]),_0x82e639;}async[a111_0x1e40ac(0x15c)](_0x47d84f,_0x4f046f){const _0x467ff9=a111_0x1e40ac,_0x5eae2e=await this['scheduleModel'][_0x467ff9(0x184)]({'_id':{'$ne':_0x47d84f},'includeDates':{'$in':_0x4f046f}})[_0x467ff9(0x173)](),_0x403197=_0x4f046f[_0x467ff9(0x16f)](_0x595b19=>_0x595b19['toISOString']());await Promise[_0x467ff9(0x167)](_0x5eae2e[_0x467ff9(0x16f)](_0x4b3ebe=>{const _0xbb04d8=_0x467ff9,_0x390510=_0x4b3ebe[_0xbb04d8(0x182)][_0xbb04d8(0x16e)](_0x1f4b4c=>!_0x403197[_0xbb04d8(0x16a)](_0x1f4b4c[_0xbb04d8(0x171)]()));return _0x4b3ebe[_0xbb04d8(0x182)]=_0x390510,_0x4b3ebe[_0xbb04d8(0x181)]=new Date(),_0x4b3ebe[_0xbb04d8(0x14d)]();}));}async[a111_0x1e40ac(0x174)](_0x19e90d){const _0xf90e05=a111_0x1e40ac,_0x5ad25f=await this['findOne'](_0x19e90d),_0xf15c60=_0x5ad25f[_0xf90e05(0x162)][_0xf90e05(0x16f)](_0x53b026=>Object[_0xf90e05(0x14e)](Object['assign']({},_0x53b026),{'id':(0x0,utils_1['uuid'])()})),_0x70f8af=new this[(_0xf90e05(0x178))](Object['assign'](Object[_0xf90e05(0x14e)]({},_0x5ad25f[_0xf90e05(0x17a)]()),{'events':_0xf15c60,'_id':undefined,'createdAtUtc':new Date(),'updatedAtUtc':new Date()}));return _0x70f8af['save']();}};ScheduleService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,mongoose_1[a111_0x1e40ac(0x18a)])(a111_0x1e40ac(0x180))),__metadata('design:paramtypes',[mongoose_2[a111_0x1e40ac(0x161)]])],ScheduleService),exports['ScheduleService']=ScheduleService;