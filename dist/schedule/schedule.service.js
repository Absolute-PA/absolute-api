'use strict';const a111_0x208cf0=a111_0x50b3;function a111_0x3441(){const _0x3197b5=['create','Model','17768aoqWUD','../common/utils','clone','findEligibleScheduleBetween','findIndex','getDay','21467182xLXGOz','decorate','function','uuid','findOne','createdAtUtc','length','remove','findById','filter','includeDates','getOwnPropertyDescriptor','findByIdAndDelete','toISOString','595FPrciN','findAllActiveSchedules','events','dayjs','@nestjs/common','findEligibleSchedule','includes','findAll','Schedule','isAfter','334DiSgUs','save','__param','6792640DMMPyS','6346DaPhHL','map','1491cZEyId','assign','metadata','YYYY-MM-DD','find','__metadata','all','findByIdAndUpdate','design:paramtypes','scheduleModel','format','getTime','19806PlNLVb','toObject','__esModule','weekDays','Injectable','@nestjs/mongoose','getDate','InjectModel','object','exec','3731706ffCCOB','setDate','defineProperty','250548hhFUQB','toDate','21brkYVD','ScheduleService','removeOtherExistingIncludeDates','startOf'];a111_0x3441=function(){return _0x3197b5;};return a111_0x3441();}(function(_0x450e80,_0x45d5d3){const _0x50ab9d=a111_0x50b3,_0x1744c2=_0x450e80();while(!![]){try{const _0x2a6720=-parseInt(_0x50ab9d(0x1e1))/0x1*(parseInt(_0x50ab9d(0x1dd))/0x2)+parseInt(_0x50ab9d(0x1fe))/0x3*(-parseInt(_0x50ab9d(0x1fc))/0x4)+-parseInt(_0x50ab9d(0x218))/0x5*(-parseInt(_0x50ab9d(0x1ef))/0x6)+-parseInt(_0x50ab9d(0x1e3))/0x7*(parseInt(_0x50ab9d(0x204))/0x8)+-parseInt(_0x50ab9d(0x1f9))/0x9+parseInt(_0x50ab9d(0x1e0))/0xa+parseInt(_0x50ab9d(0x20a))/0xb;if(_0x2a6720===_0x45d5d3)break;else _0x1744c2['push'](_0x1744c2['shift']());}catch(_0x261c17){_0x1744c2['push'](_0x1744c2['shift']());}}}(a111_0x3441,0x9bb01));var __decorate=this&&this['__decorate']||function(_0x413ddc,_0x128a86,_0x36c217,_0x203217){const _0x1decd0=a111_0x50b3;var _0x5e8f1d=arguments[_0x1decd0(0x210)],_0x184a52=_0x5e8f1d<0x3?_0x128a86:_0x203217===null?_0x203217=Object[_0x1decd0(0x215)](_0x128a86,_0x36c217):_0x203217,_0x42402a;if(typeof Reflect===_0x1decd0(0x1f7)&&typeof Reflect[_0x1decd0(0x20b)]===_0x1decd0(0x20c))_0x184a52=Reflect['decorate'](_0x413ddc,_0x128a86,_0x36c217,_0x203217);else{for(var _0x143a05=_0x413ddc[_0x1decd0(0x210)]-0x1;_0x143a05>=0x0;_0x143a05--)if(_0x42402a=_0x413ddc[_0x143a05])_0x184a52=(_0x5e8f1d<0x3?_0x42402a(_0x184a52):_0x5e8f1d>0x3?_0x42402a(_0x128a86,_0x36c217,_0x184a52):_0x42402a(_0x128a86,_0x36c217))||_0x184a52;}return _0x5e8f1d>0x3&&_0x184a52&&Object['defineProperty'](_0x128a86,_0x36c217,_0x184a52),_0x184a52;},__metadata=this&&this[a111_0x208cf0(0x1e8)]||function(_0x1c9959,_0x2d245a){const _0x4285c0=a111_0x208cf0;if(typeof Reflect===_0x4285c0(0x1f7)&&typeof Reflect['metadata']===_0x4285c0(0x20c))return Reflect[_0x4285c0(0x1e5)](_0x1c9959,_0x2d245a);},__param=this&&this[a111_0x208cf0(0x1df)]||function(_0x4a9f37,_0x18f2cd){return function(_0x426cfb,_0x49f037){_0x18f2cd(_0x426cfb,_0x49f037,_0x4a9f37);};};Object[a111_0x208cf0(0x1fb)](exports,a111_0x208cf0(0x1f1),{'value':!![]}),exports[a111_0x208cf0(0x1ff)]=void 0x0;function a111_0x50b3(_0xa4917e,_0xd13086){const _0x34419b=a111_0x3441();return a111_0x50b3=function(_0x50b337,_0x177040){_0x50b337=_0x50b337-0x1dd;let _0x5239da=_0x34419b[_0x50b337];return _0x5239da;},a111_0x50b3(_0xa4917e,_0xd13086);}const common_1=require(a111_0x208cf0(0x21c)),mongoose_1=require(a111_0x208cf0(0x1f4)),mongoose_2=require('mongoose'),dayjs=require(a111_0x208cf0(0x21b)),utils_1=require(a111_0x208cf0(0x205)),schedulePrioritySort=(_0x38ae85,_0x312905)=>dayjs(_0x38ae85[a111_0x208cf0(0x20f)])[a111_0x208cf0(0x221)](dayjs(_0x312905['createdAtUtc']))?-0x1:0x1;let ScheduleService=class ScheduleService{constructor(_0x3d03d4){const _0x35aa57=a111_0x208cf0;this[_0x35aa57(0x1ec)]=_0x3d03d4;}async[a111_0x208cf0(0x202)](_0x3fed0e){const _0x4fa923=a111_0x208cf0,_0x4cbc22=new this[(_0x4fa923(0x1ec))](_0x3fed0e);return _0x4cbc22[_0x4fa923(0x1de)]();}async[a111_0x208cf0(0x21f)](){const _0x11bd86=a111_0x208cf0,_0x39be0b=await this[_0x11bd86(0x1ec)][_0x11bd86(0x1e7)]()[_0x11bd86(0x1f8)]();return _0x39be0b;}async[a111_0x208cf0(0x20e)](_0x1ff182){const _0x294d3b=a111_0x208cf0,_0x4ae0bb=await this['scheduleModel'][_0x294d3b(0x212)](_0x1ff182);return _0x4ae0bb;}async[a111_0x208cf0(0x21d)](_0x31cf4a){const _0x59b93b=a111_0x208cf0,_0x4e796b=await this['findAllActiveSchedules'](_0x31cf4a),_0x1180cc=_0x4e796b[_0x59b93b(0x213)](_0x32dc1b=>_0x32dc1b[_0x59b93b(0x214)]['length']>0x0&&_0x32dc1b[_0x59b93b(0x214)][_0x59b93b(0x1e2)](_0x4c94d1=>dayjs(_0x4c94d1)[_0x59b93b(0x1ed)](_0x59b93b(0x1e6)))[_0x59b93b(0x21e)](dayjs(_0x31cf4a)['format'](_0x59b93b(0x1e6))))['sort'](schedulePrioritySort);if(_0x1180cc[_0x59b93b(0x210)]>0x0)return _0x1180cc[0x0];const _0x4276a9=_0x4e796b[_0x59b93b(0x213)](_0x11782b=>_0x11782b[_0x59b93b(0x1f2)][_0x59b93b(0x21e)](_0x31cf4a[_0x59b93b(0x209)]()))['sort'](schedulePrioritySort);if(_0x4276a9[_0x59b93b(0x210)]>0x0)return _0x4276a9[0x0];return null;}async[a111_0x208cf0(0x219)](_0x194bf0){const _0x1e1298=a111_0x208cf0,_0x84311b=dayjs(_0x194bf0)[_0x1e1298(0x201)]('day')[_0x1e1298(0x1fd)](),_0xdceb1c={'$and':[{'$or':[{'startDate':{'$lte':_0x194bf0},'endDate':{'$gte':_0x194bf0}},{'startDate':{'$lte':_0x194bf0},'endDate':null},{'startDate':null,'endDate':{'$gte':_0x194bf0}}]},{'excludeDates':{'$nin':[_0x84311b]}}]},_0x2ea06d=await this[_0x1e1298(0x1ec)][_0x1e1298(0x1e7)](_0xdceb1c)[_0x1e1298(0x1f8)]();return _0x2ea06d;}async[a111_0x208cf0(0x207)](_0x13af4d,_0x2afc54){const _0x4d6347=a111_0x208cf0,_0x2d2a5d=new Date(_0x13af4d),_0x3922ed={};while(_0x2d2a5d<=_0x2afc54){const _0x4b1c8b=await this[_0x4d6347(0x21d)](_0x2d2a5d);_0x4b1c8b&&(_0x3922ed[dayjs(_0x2d2a5d)[_0x4d6347(0x1ed)](_0x4d6347(0x1e6))]=_0x4b1c8b),_0x2d2a5d[_0x4d6347(0x1fa)](_0x2d2a5d[_0x4d6347(0x1f5)]()+0x1);}return _0x3922ed;}async['update'](_0x47dd58,_0x407689){const _0x172eaa=a111_0x208cf0,_0x444d45=await this['scheduleModel'][_0x172eaa(0x1ea)](_0x47dd58,Object['assign'](Object[_0x172eaa(0x1e4)]({},_0x407689),{'updatedAtUtc':new Date()}),{'new':!![]})[_0x172eaa(0x1f8)]();return _0x444d45[_0x172eaa(0x214)]&&await this[_0x172eaa(0x200)](_0x47dd58,_0x444d45[_0x172eaa(0x214)]),_0x444d45;}async[a111_0x208cf0(0x211)](_0x16b4e5){const _0x9e7b62=a111_0x208cf0,_0x48965d=await this[_0x9e7b62(0x1ec)][_0x9e7b62(0x216)](_0x16b4e5)[_0x9e7b62(0x1f8)]();return _0x48965d;}async['addIncludeDate'](_0x1f88b6,_0x6c0994){const _0x312bdd=a111_0x208cf0,_0x4573d5=await this[_0x312bdd(0x20e)](_0x1f88b6);_0x4573d5['includeDates'][_0x312bdd(0x208)](_0x2d3941=>_0x2d3941[_0x312bdd(0x1ee)]()===_0x6c0994['getTime']())===-0x1&&_0x4573d5[_0x312bdd(0x214)]['push'](_0x6c0994);const _0xa80d4a=await _0x4573d5['save']();return await this['removeOtherExistingIncludeDates'](_0x1f88b6,[_0x6c0994]),_0xa80d4a;}async['removeOtherExistingIncludeDates'](_0x40f46d,_0x28cb7a){const _0x2ed277=a111_0x208cf0,_0x3c0329=await this[_0x2ed277(0x1ec)][_0x2ed277(0x1e7)]({'_id':{'$ne':_0x40f46d},'includeDates':{'$in':_0x28cb7a}})[_0x2ed277(0x1f8)](),_0x385b63=_0x28cb7a[_0x2ed277(0x1e2)](_0x43eeff=>_0x43eeff['toISOString']());await Promise[_0x2ed277(0x1e9)](_0x3c0329[_0x2ed277(0x1e2)](_0x27690f=>{const _0x1b50cd=_0x2ed277,_0x132f45=_0x27690f[_0x1b50cd(0x214)][_0x1b50cd(0x213)](_0x5e4b6a=>!_0x385b63['includes'](_0x5e4b6a[_0x1b50cd(0x217)]()));return _0x27690f[_0x1b50cd(0x214)]=_0x132f45,_0x27690f['updatedAtUtc']=new Date(),_0x27690f[_0x1b50cd(0x1de)]();}));}async[a111_0x208cf0(0x206)](_0xd85b64){const _0x37c9a3=a111_0x208cf0,_0x49d043=await this['findOne'](_0xd85b64),_0x1e3257=_0x49d043[_0x37c9a3(0x21a)][_0x37c9a3(0x1e2)](_0x1cbe29=>Object[_0x37c9a3(0x1e4)](Object[_0x37c9a3(0x1e4)]({},_0x1cbe29),{'id':(0x0,utils_1[_0x37c9a3(0x20d)])()})),_0x5e93a5=new this['scheduleModel'](Object['assign'](Object[_0x37c9a3(0x1e4)]({},_0x49d043[_0x37c9a3(0x1f0)]()),{'events':_0x1e3257,'_id':undefined,'createdAtUtc':new Date(),'updatedAtUtc':new Date()}));return _0x5e93a5[_0x37c9a3(0x1de)]();}};ScheduleService=__decorate([(0x0,common_1[a111_0x208cf0(0x1f3)])(),__param(0x0,(0x0,mongoose_1[a111_0x208cf0(0x1f6)])(a111_0x208cf0(0x220))),__metadata(a111_0x208cf0(0x1eb),[mongoose_2[a111_0x208cf0(0x203)]])],ScheduleService),exports[a111_0x208cf0(0x1ff)]=ScheduleService;