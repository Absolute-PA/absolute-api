'use strict';const a108_0x1f592f=a108_0x5da5;function a108_0x34cf(){const _0x5e530f=['toISOString','9262690MceWkw','5pZxwLs','startOf','filter','map','findByIdAndDelete','weekDays','decorate','mongoose','toDate','1366542NoKCXw','Model','dayjs','toObject','updatedAtUtc','day','getDay','remove','defineProperty','469254UDXSxI','includeDates','removeOtherExistingIncludeDates','includes','1232BmfCcf','3217096gEgRVA','function','length','7OnTosL','events','assign','createdAtUtc','find','addIncludeDate','findAll','exec','findOne','metadata','design:paramtypes','24075cNDfQp','YYYY-MM-DD','Injectable','getDate','create','push','1491258QncJrf','uuid','clone','Schedule','scheduleModel','__esModule','object','save','InjectModel','getTime','1060684RbFDaX','format','findById','ScheduleService'];a108_0x34cf=function(){return _0x5e530f;};return a108_0x34cf();}function a108_0x5da5(_0x444043,_0x6b7142){const _0x34cf71=a108_0x34cf();return a108_0x5da5=function(_0x5da552,_0x11246c){_0x5da552=_0x5da552-0xfa;let _0x295a2e=_0x34cf71[_0x5da552];return _0x295a2e;},a108_0x5da5(_0x444043,_0x6b7142);}(function(_0x56cb54,_0x3e3462){const _0x3d0442=a108_0x5da5,_0x3da400=_0x56cb54();while(!![]){try{const _0x43883d=-parseInt(_0x3d0442(0x132))/0x1+parseInt(_0x3d0442(0x106))/0x2+-parseInt(_0x3d0442(0x10f))/0x3+parseInt(_0x3d0442(0x114))/0x4*(parseInt(_0x3d0442(0xfd))/0x5)+parseInt(_0x3d0442(0x128))/0x6*(-parseInt(_0x3d0442(0x117))/0x7)+-parseInt(_0x3d0442(0x113))/0x8*(parseInt(_0x3d0442(0x122))/0x9)+parseInt(_0x3d0442(0xfc))/0xa;if(_0x43883d===_0x3e3462)break;else _0x3da400['push'](_0x3da400['shift']());}catch(_0xd79a99){_0x3da400['push'](_0x3da400['shift']());}}}(a108_0x34cf,0x82e9b));var __decorate=this&&this['__decorate']||function(_0x1216c2,_0x3b88ae,_0x30fa16,_0x855635){const _0x10e4f9=a108_0x5da5;var _0x3d7d70=arguments[_0x10e4f9(0x116)],_0x16881f=_0x3d7d70<0x3?_0x3b88ae:_0x855635===null?_0x855635=Object['getOwnPropertyDescriptor'](_0x3b88ae,_0x30fa16):_0x855635,_0x466f61;if(typeof Reflect===_0x10e4f9(0x12e)&&typeof Reflect['decorate']===_0x10e4f9(0x115))_0x16881f=Reflect[_0x10e4f9(0x103)](_0x1216c2,_0x3b88ae,_0x30fa16,_0x855635);else{for(var _0x123f03=_0x1216c2[_0x10e4f9(0x116)]-0x1;_0x123f03>=0x0;_0x123f03--)if(_0x466f61=_0x1216c2[_0x123f03])_0x16881f=(_0x3d7d70<0x3?_0x466f61(_0x16881f):_0x3d7d70>0x3?_0x466f61(_0x3b88ae,_0x30fa16,_0x16881f):_0x466f61(_0x3b88ae,_0x30fa16))||_0x16881f;}return _0x3d7d70>0x3&&_0x16881f&&Object[_0x10e4f9(0x10e)](_0x3b88ae,_0x30fa16,_0x16881f),_0x16881f;},__metadata=this&&this['__metadata']||function(_0x4da09e,_0x2983ea){const _0x1f65a1=a108_0x5da5;if(typeof Reflect==='object'&&typeof Reflect[_0x1f65a1(0x120)]==='function')return Reflect['metadata'](_0x4da09e,_0x2983ea);},__param=this&&this['__param']||function(_0x2955ee,_0xf2da4e){return function(_0x4f206a,_0x1ab974){_0xf2da4e(_0x4f206a,_0x1ab974,_0x2955ee);};};Object[a108_0x1f592f(0x10e)](exports,a108_0x1f592f(0x12d),{'value':!![]}),exports[a108_0x1f592f(0xfa)]=void 0x0;const common_1=require('@nestjs/common'),mongoose_1=require('@nestjs/mongoose'),mongoose_2=require(a108_0x1f592f(0x104)),dayjs=require(a108_0x1f592f(0x108)),utils_1=require('../common/utils'),schedulePrioritySort=(_0x68c841,_0xcf928e)=>dayjs(_0x68c841['createdAtUtc'])['isAfter'](dayjs(_0xcf928e[a108_0x1f592f(0x11a)]))?-0x1:0x1;let ScheduleService=class ScheduleService{constructor(_0x544952){const _0x54bbaa=a108_0x1f592f;this[_0x54bbaa(0x12c)]=_0x544952;}async[a108_0x1f592f(0x126)](_0x709f34){const _0x982137=a108_0x1f592f,_0x4de8ce=new this[(_0x982137(0x12c))](_0x709f34);return _0x4de8ce[_0x982137(0x12f)]();}async[a108_0x1f592f(0x11d)](){const _0x4e641f=a108_0x1f592f,_0xb78e03=await this['scheduleModel']['find']()[_0x4e641f(0x11e)]();return _0xb78e03;}async[a108_0x1f592f(0x11f)](_0x3f108f){const _0x1219fc=a108_0x1f592f,_0x512d1e=await this[_0x1219fc(0x12c)][_0x1219fc(0x134)](_0x3f108f);return _0x512d1e;}async['findEligibleSchedule'](_0x3976f8){const _0x29b79d=a108_0x1f592f,_0x4b9173=await this['findAllActiveSchedules'](_0x3976f8),_0x47c313=_0x4b9173[_0x29b79d(0xff)](_0x36f4e7=>_0x36f4e7['includeDates']['length']>0x0&&_0x36f4e7[_0x29b79d(0x110)][_0x29b79d(0x100)](_0x3b3df4=>dayjs(_0x3b3df4)[_0x29b79d(0x133)](_0x29b79d(0x123)))['includes'](dayjs(_0x3976f8)[_0x29b79d(0x133)](_0x29b79d(0x123))))['sort'](schedulePrioritySort);if(_0x47c313[_0x29b79d(0x116)]>0x0)return _0x47c313[0x0];const _0x1fee75=_0x4b9173['filter'](_0x323af6=>_0x323af6[_0x29b79d(0x102)][_0x29b79d(0x112)](_0x3976f8[_0x29b79d(0x10c)]()))['sort'](schedulePrioritySort);if(_0x1fee75[_0x29b79d(0x116)]>0x0)return _0x1fee75[0x0];return null;}async['findAllActiveSchedules'](_0x1cd98f){const _0x4ffadd=a108_0x1f592f,_0x5db26f=dayjs(_0x1cd98f)[_0x4ffadd(0xfe)](_0x4ffadd(0x10b))[_0x4ffadd(0x105)](),_0x30837b={'$and':[{'$or':[{'startDate':{'$lte':_0x1cd98f},'endDate':{'$gte':_0x1cd98f}},{'startDate':{'$lte':_0x1cd98f},'endDate':null},{'startDate':null,'endDate':{'$gte':_0x1cd98f}}]},{'excludeDates':{'$nin':[_0x5db26f]}}]},_0x224976=await this[_0x4ffadd(0x12c)][_0x4ffadd(0x11b)](_0x30837b)['exec']();return _0x224976;}async['findEligibleScheduleBetween'](_0xbb0cf9,_0x5aab20){const _0x3b830f=a108_0x1f592f,_0x183105=new Date(_0xbb0cf9),_0x19957f={};while(_0x183105<=_0x5aab20){const _0x47423a=await this['findEligibleSchedule'](_0x183105);_0x47423a&&(_0x19957f[dayjs(_0x183105)[_0x3b830f(0x133)](_0x3b830f(0x123))]=_0x47423a),_0x183105['setDate'](_0x183105[_0x3b830f(0x125)]()+0x1);}return _0x19957f;}async['update'](_0x54ac45,_0x255ce2){const _0x1be6c1=a108_0x1f592f,_0x12bf4d=await this[_0x1be6c1(0x12c)]['findByIdAndUpdate'](_0x54ac45,Object[_0x1be6c1(0x119)](Object[_0x1be6c1(0x119)]({},_0x255ce2),{'updatedAtUtc':new Date()}),{'new':!![]})[_0x1be6c1(0x11e)]();return _0x12bf4d[_0x1be6c1(0x110)]&&await this['removeOtherExistingIncludeDates'](_0x54ac45,_0x12bf4d['includeDates']),_0x12bf4d;}async[a108_0x1f592f(0x10d)](_0x4002d4){const _0x15d242=a108_0x1f592f,_0x22fb8e=await this[_0x15d242(0x12c)][_0x15d242(0x101)](_0x4002d4)[_0x15d242(0x11e)]();return _0x22fb8e;}async[a108_0x1f592f(0x11c)](_0x5bc200,_0x11c3c5){const _0x429580=a108_0x1f592f,_0x262429=await this[_0x429580(0x11f)](_0x5bc200);_0x262429[_0x429580(0x110)]['findIndex'](_0x52ce6d=>_0x52ce6d[_0x429580(0x131)]()===_0x11c3c5['getTime']())===-0x1&&_0x262429[_0x429580(0x110)][_0x429580(0x127)](_0x11c3c5);const _0x115627=await _0x262429[_0x429580(0x12f)]();return await this[_0x429580(0x111)](_0x5bc200,[_0x11c3c5]),_0x115627;}async[a108_0x1f592f(0x111)](_0x58e074,_0xab9f51){const _0x43a9ab=a108_0x1f592f,_0x2fbbeb=await this[_0x43a9ab(0x12c)]['find']({'_id':{'$ne':_0x58e074},'includeDates':{'$in':_0xab9f51}})[_0x43a9ab(0x11e)](),_0x33125c=_0xab9f51[_0x43a9ab(0x100)](_0x1aa8b4=>_0x1aa8b4[_0x43a9ab(0xfb)]());await Promise['all'](_0x2fbbeb[_0x43a9ab(0x100)](_0x5ef85c=>{const _0x3de343=_0x43a9ab,_0x5218ab=_0x5ef85c['includeDates']['filter'](_0x1f8d3b=>!_0x33125c[_0x3de343(0x112)](_0x1f8d3b['toISOString']()));return _0x5ef85c[_0x3de343(0x110)]=_0x5218ab,_0x5ef85c[_0x3de343(0x10a)]=new Date(),_0x5ef85c[_0x3de343(0x12f)]();}));}async[a108_0x1f592f(0x12a)](_0x5d5f2b){const _0x4c27aa=a108_0x1f592f,_0x4a83d4=await this[_0x4c27aa(0x11f)](_0x5d5f2b),_0x3996c4=_0x4a83d4[_0x4c27aa(0x118)][_0x4c27aa(0x100)](_0x3f95e8=>Object[_0x4c27aa(0x119)](Object[_0x4c27aa(0x119)]({},_0x3f95e8),{'id':(0x0,utils_1[_0x4c27aa(0x129)])()})),_0x280b3a=new this[(_0x4c27aa(0x12c))](Object[_0x4c27aa(0x119)](Object['assign']({},_0x4a83d4[_0x4c27aa(0x109)]()),{'events':_0x3996c4,'_id':undefined,'createdAtUtc':new Date(),'updatedAtUtc':new Date()}));return _0x280b3a[_0x4c27aa(0x12f)]();}};ScheduleService=__decorate([(0x0,common_1[a108_0x1f592f(0x124)])(),__param(0x0,(0x0,mongoose_1[a108_0x1f592f(0x130)])(a108_0x1f592f(0x12b))),__metadata(a108_0x1f592f(0x121),[mongoose_2[a108_0x1f592f(0x107)]])],ScheduleService),exports['ScheduleService']=ScheduleService;