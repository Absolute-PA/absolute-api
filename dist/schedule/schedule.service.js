'use strict';const a111_0x5cb911=a111_0x44a7;function a111_0x1ab5(){const _0x235adb=['__esModule','findById','create','findOne','findIndex','update','format','29778060DIQPHD','getDate','setDate','weekDays','getOwnPropertyDescriptor','push','222490iSHFvL','decorate','10394796xZmHrr','scheduleModel','isAfter','assign','filter','length','toDate','save','@nestjs/common','function','events','remove','updatedAtUtc','all','find','dayjs','addIncludeDate','YYYY-MM-DD','7IrJUmj','day','22gYVfWT','sort','8wwQuRM','__metadata','findAll','uuid','object','createdAtUtc','11814399MBSABJ','getTime','../common/utils','includes','toObject','1498FBbtXy','findByIdAndDelete','13wlfQZK','ScheduleService','findByIdAndUpdate','map','defineProperty','__param','5mFrZOs','Model','design:paramtypes','includeDates','1277022NmfKQZ','removeOtherExistingIncludeDates','toISOString','Schedule','mongoose','clone','metadata','13430776HQqjsk','exec','863ifuEWX','findAllActiveSchedules'];a111_0x1ab5=function(){return _0x235adb;};return a111_0x1ab5();}(function(_0x3681d7,_0x2e053e){const _0xc8e61c=a111_0x44a7,_0x4d1bea=_0x3681d7();while(!![]){try{const _0x1d25b1=-parseInt(_0xc8e61c(0x83))/0x1*(-parseInt(_0xc8e61c(0xb5))/0x2)+parseInt(_0xc8e61c(0x7a))/0x3*(-parseInt(_0xc8e61c(0xaa))/0x4)+-parseInt(_0xc8e61c(0xbd))/0x5*(-parseInt(_0xc8e61c(0x94))/0x6)+parseInt(_0xc8e61c(0xa6))/0x7*(-parseInt(_0xc8e61c(0x81))/0x8)+-parseInt(_0xc8e61c(0xb0))/0x9+-parseInt(_0xc8e61c(0x92))/0xa*(parseInt(_0xc8e61c(0xa8))/0xb)+parseInt(_0xc8e61c(0x8c))/0xc*(parseInt(_0xc8e61c(0xb7))/0xd);if(_0x1d25b1===_0x2e053e)break;else _0x4d1bea['push'](_0x4d1bea['shift']());}catch(_0x2fcc3f){_0x4d1bea['push'](_0x4d1bea['shift']());}}}(a111_0x1ab5,0xed89a));function a111_0x44a7(_0x99d382,_0x21f9d9){const _0x1ab5a7=a111_0x1ab5();return a111_0x44a7=function(_0x44a78a,_0x2f8c3b){_0x44a78a=_0x44a78a-0x7a;let _0x1007d1=_0x1ab5a7[_0x44a78a];return _0x1007d1;},a111_0x44a7(_0x99d382,_0x21f9d9);}var __decorate=this&&this['__decorate']||function(_0x11c65a,_0x3766bb,_0x2eba73,_0x69e94a){const _0x346958=a111_0x44a7;var _0xe39f75=arguments[_0x346958(0x99)],_0x334e5d=_0xe39f75<0x3?_0x3766bb:_0x69e94a===null?_0x69e94a=Object[_0x346958(0x90)](_0x3766bb,_0x2eba73):_0x69e94a,_0x10d442;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x346958(0x9d))_0x334e5d=Reflect[_0x346958(0x93)](_0x11c65a,_0x3766bb,_0x2eba73,_0x69e94a);else{for(var _0x149255=_0x11c65a[_0x346958(0x99)]-0x1;_0x149255>=0x0;_0x149255--)if(_0x10d442=_0x11c65a[_0x149255])_0x334e5d=(_0xe39f75<0x3?_0x10d442(_0x334e5d):_0xe39f75>0x3?_0x10d442(_0x3766bb,_0x2eba73,_0x334e5d):_0x10d442(_0x3766bb,_0x2eba73))||_0x334e5d;}return _0xe39f75>0x3&&_0x334e5d&&Object[_0x346958(0xbb)](_0x3766bb,_0x2eba73,_0x334e5d),_0x334e5d;},__metadata=this&&this[a111_0x5cb911(0xab)]||function(_0x3473d9,_0xf73062){const _0x4d6e64=a111_0x5cb911;if(typeof Reflect===_0x4d6e64(0xae)&&typeof Reflect[_0x4d6e64(0x80)]===_0x4d6e64(0x9d))return Reflect[_0x4d6e64(0x80)](_0x3473d9,_0xf73062);},__param=this&&this[a111_0x5cb911(0xbc)]||function(_0x516d28,_0x2b8c39){return function(_0xa5473a,_0x308ef1){_0x2b8c39(_0xa5473a,_0x308ef1,_0x516d28);};};Object[a111_0x5cb911(0xbb)](exports,a111_0x5cb911(0x85),{'value':!![]}),exports[a111_0x5cb911(0xb8)]=void 0x0;const common_1=require(a111_0x5cb911(0x9c)),mongoose_1=require('@nestjs/mongoose'),mongoose_2=require(a111_0x5cb911(0x7e)),dayjs=require(a111_0x5cb911(0xa3)),utils_1=require(a111_0x5cb911(0xb2)),schedulePrioritySort=(_0x4cb239,_0xe98b65)=>dayjs(_0x4cb239[a111_0x5cb911(0xaf)])[a111_0x5cb911(0x96)](dayjs(_0xe98b65[a111_0x5cb911(0xaf)]))?-0x1:0x1;let ScheduleService=class ScheduleService{constructor(_0xfd34c){const _0x269b5a=a111_0x5cb911;this[_0x269b5a(0x95)]=_0xfd34c;}async[a111_0x5cb911(0x87)](_0x35348b){const _0x30cf95=new this['scheduleModel'](_0x35348b);return _0x30cf95['save']();}async[a111_0x5cb911(0xac)](){const _0x24ced3=a111_0x5cb911,_0x27a9e7=await this[_0x24ced3(0x95)][_0x24ced3(0xa2)]()[_0x24ced3(0x82)]();return _0x27a9e7;}async[a111_0x5cb911(0x88)](_0x1ba058){const _0x5c2a9e=a111_0x5cb911,_0x1e77b1=await this[_0x5c2a9e(0x95)][_0x5c2a9e(0x86)](_0x1ba058);return _0x1e77b1;}async['findEligibleSchedule'](_0x23196a){const _0x292c81=a111_0x5cb911,_0x5ee5ea=await this[_0x292c81(0x84)](_0x23196a),_0x13c19a=_0x5ee5ea[_0x292c81(0x98)](_0x21b67d=>_0x21b67d['includeDates'][_0x292c81(0x99)]>0x0&&_0x21b67d[_0x292c81(0xc0)]['map'](_0x4f9ea1=>dayjs(_0x4f9ea1)['format'](_0x292c81(0xa5)))['includes'](dayjs(_0x23196a)[_0x292c81(0x8b)]('YYYY-MM-DD')))[_0x292c81(0xa9)](schedulePrioritySort);if(_0x13c19a[_0x292c81(0x99)]>0x0)return _0x13c19a[0x0];const _0x5ea0a3=_0x5ee5ea[_0x292c81(0x98)](_0x598d67=>_0x598d67[_0x292c81(0x8f)][_0x292c81(0xb3)](_0x23196a['getDay']()))[_0x292c81(0xa9)](schedulePrioritySort);if(_0x5ea0a3[_0x292c81(0x99)]>0x0)return _0x5ea0a3[0x0];return null;}async[a111_0x5cb911(0x84)](_0x5c21bc){const _0x2951c2=a111_0x5cb911,_0x122992=dayjs(_0x5c21bc)['startOf'](_0x2951c2(0xa7))[_0x2951c2(0x9a)](),_0x54624d={'$and':[{'$or':[{'startDate':{'$lte':_0x5c21bc},'endDate':{'$gte':_0x5c21bc}},{'startDate':{'$lte':_0x5c21bc},'endDate':null},{'startDate':null,'endDate':{'$gte':_0x5c21bc}}]},{'excludeDates':{'$nin':[_0x122992]}}]},_0x1b8f8f=await this[_0x2951c2(0x95)][_0x2951c2(0xa2)](_0x54624d)[_0x2951c2(0x82)]();return _0x1b8f8f;}async['findEligibleScheduleBetween'](_0x3fb380,_0x1de7f4){const _0x1f5682=a111_0x5cb911,_0x11ee75=new Date(_0x3fb380),_0x5f4ccf={};while(_0x11ee75<=_0x1de7f4){const _0x40a91c=await this['findEligibleSchedule'](_0x11ee75);_0x40a91c&&(_0x5f4ccf[dayjs(_0x11ee75)['format'](_0x1f5682(0xa5))]=_0x40a91c),_0x11ee75[_0x1f5682(0x8e)](_0x11ee75[_0x1f5682(0x8d)]()+0x1);}return _0x5f4ccf;}async[a111_0x5cb911(0x8a)](_0x538a50,_0x4dbed3){const _0x13ad76=a111_0x5cb911,_0x5b7c91=await this[_0x13ad76(0x95)][_0x13ad76(0xb9)](_0x538a50,Object[_0x13ad76(0x97)](Object[_0x13ad76(0x97)]({},_0x4dbed3),{'updatedAtUtc':new Date()}),{'new':!![]})[_0x13ad76(0x82)]();return _0x5b7c91['includeDates']&&await this[_0x13ad76(0x7b)](_0x538a50,_0x5b7c91['includeDates']),_0x5b7c91;}async[a111_0x5cb911(0x9f)](_0x1a1199){const _0x3162b4=a111_0x5cb911,_0x4c3907=await this[_0x3162b4(0x95)][_0x3162b4(0xb6)](_0x1a1199)[_0x3162b4(0x82)]();return _0x4c3907;}async[a111_0x5cb911(0xa4)](_0x4efce0,_0xe641ab){const _0x2024c8=a111_0x5cb911,_0x4207f8=await this[_0x2024c8(0x88)](_0x4efce0);_0x4207f8['includeDates'][_0x2024c8(0x89)](_0x1868b7=>_0x1868b7['getTime']()===_0xe641ab[_0x2024c8(0xb1)]())===-0x1&&_0x4207f8[_0x2024c8(0xc0)][_0x2024c8(0x91)](_0xe641ab);const _0x3bd134=await _0x4207f8[_0x2024c8(0x9b)]();return await this[_0x2024c8(0x7b)](_0x4efce0,[_0xe641ab]),_0x3bd134;}async[a111_0x5cb911(0x7b)](_0x4157c7,_0x91b5fe){const _0xd650f1=a111_0x5cb911,_0x273cba=await this['scheduleModel'][_0xd650f1(0xa2)]({'_id':{'$ne':_0x4157c7},'includeDates':{'$in':_0x91b5fe}})[_0xd650f1(0x82)](),_0x2220a4=_0x91b5fe[_0xd650f1(0xba)](_0x5a2cdb=>_0x5a2cdb[_0xd650f1(0x7c)]());await Promise[_0xd650f1(0xa1)](_0x273cba[_0xd650f1(0xba)](_0x3fb502=>{const _0x16c20c=_0xd650f1,_0x14c0fc=_0x3fb502['includeDates'][_0x16c20c(0x98)](_0x11c039=>!_0x2220a4[_0x16c20c(0xb3)](_0x11c039['toISOString']()));return _0x3fb502[_0x16c20c(0xc0)]=_0x14c0fc,_0x3fb502[_0x16c20c(0xa0)]=new Date(),_0x3fb502['save']();}));}async[a111_0x5cb911(0x7f)](_0x549e50){const _0x45278a=a111_0x5cb911,_0x364018=await this[_0x45278a(0x88)](_0x549e50),_0x3bc539=_0x364018[_0x45278a(0x9e)][_0x45278a(0xba)](_0x3f36af=>Object[_0x45278a(0x97)](Object[_0x45278a(0x97)]({},_0x3f36af),{'id':(0x0,utils_1[_0x45278a(0xad)])()})),_0x2cd335=new this['scheduleModel'](Object[_0x45278a(0x97)](Object[_0x45278a(0x97)]({},_0x364018[_0x45278a(0xb4)]()),{'events':_0x3bc539,'_id':undefined,'createdAtUtc':new Date(),'updatedAtUtc':new Date()}));return _0x2cd335[_0x45278a(0x9b)]();}};ScheduleService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,mongoose_1['InjectModel'])(a111_0x5cb911(0x7d))),__metadata(a111_0x5cb911(0xbf),[mongoose_2[a111_0x5cb911(0xbe)]])],ScheduleService),exports[a111_0x5cb911(0xb8)]=ScheduleService;