'use strict';const a111_0xd3061c=a111_0x4bba;function a111_0x3458(){const _0x3cb114=['dayjs','__esModule','402abnZnf','94488KrTyIi','find','473338witSMQ','toObject','save','createdAtUtc','create','@nestjs/mongoose','__decorate','object','Injectable','clone','map','../common/utils','scheduleModel','56285ntfBFK','YYYY-MM-DD','length','__param','getDay','isAfter','updatedAtUtc','update','push','14516491laZqIG','findByIdAndUpdate','startOf','4004LlclsN','removeOtherExistingIncludeDates','3400150xjHeYo','exec','weekDays','findByIdAndDelete','1obGMUV','5728KtQZGE','assign','includeDates','events','includes','getDate','8383878tFyNTL','3YFebvb','getOwnPropertyDescriptor','Schedule','filter','remove','findById','metadata','findEligibleSchedule','format','mongoose','findOne','addIncludeDate','defineProperty','all','toISOString','decorate','findAllActiveSchedules','uuid'];a111_0x3458=function(){return _0x3cb114;};return a111_0x3458();}(function(_0x4ec128,_0x1d2c46){const _0x2410cd=a111_0x4bba,_0x466b01=_0x4ec128();while(!![]){try{const _0x286c1b=parseInt(_0x2410cd(0x1e7))/0x1*(-parseInt(_0x2410cd(0x206))/0x2)+parseInt(_0x2410cd(0x1ef))/0x3*(-parseInt(_0x2410cd(0x204))/0x4)+parseInt(_0x2410cd(0x1d5))/0x5*(-parseInt(_0x2410cd(0x203))/0x6)+parseInt(_0x2410cd(0x1e1))/0x7*(-parseInt(_0x2410cd(0x1e8))/0x8)+parseInt(_0x2410cd(0x1ee))/0x9+-parseInt(_0x2410cd(0x1e3))/0xa+parseInt(_0x2410cd(0x1de))/0xb;if(_0x286c1b===_0x1d2c46)break;else _0x466b01['push'](_0x466b01['shift']());}catch(_0x2d1500){_0x466b01['push'](_0x466b01['shift']());}}}(a111_0x3458,0x76eea));var __decorate=this&&this[a111_0xd3061c(0x20c)]||function(_0x4bfbd1,_0x227797,_0x16fc90,_0x5834b1){const _0x59ddb6=a111_0xd3061c;var _0x16ae5b=arguments[_0x59ddb6(0x1d7)],_0x67b2a2=_0x16ae5b<0x3?_0x227797:_0x5834b1===null?_0x5834b1=Object[_0x59ddb6(0x1f0)](_0x227797,_0x16fc90):_0x5834b1,_0x5de4bd;if(typeof Reflect===_0x59ddb6(0x20d)&&typeof Reflect['decorate']==='function')_0x67b2a2=Reflect[_0x59ddb6(0x1fe)](_0x4bfbd1,_0x227797,_0x16fc90,_0x5834b1);else{for(var _0xc79ae0=_0x4bfbd1[_0x59ddb6(0x1d7)]-0x1;_0xc79ae0>=0x0;_0xc79ae0--)if(_0x5de4bd=_0x4bfbd1[_0xc79ae0])_0x67b2a2=(_0x16ae5b<0x3?_0x5de4bd(_0x67b2a2):_0x16ae5b>0x3?_0x5de4bd(_0x227797,_0x16fc90,_0x67b2a2):_0x5de4bd(_0x227797,_0x16fc90))||_0x67b2a2;}return _0x16ae5b>0x3&&_0x67b2a2&&Object[_0x59ddb6(0x1fb)](_0x227797,_0x16fc90,_0x67b2a2),_0x67b2a2;},__metadata=this&&this['__metadata']||function(_0x513544,_0x49b082){const _0x1d7be6=a111_0xd3061c;if(typeof Reflect==='object'&&typeof Reflect['metadata']==='function')return Reflect[_0x1d7be6(0x1f5)](_0x513544,_0x49b082);},__param=this&&this[a111_0xd3061c(0x1d8)]||function(_0x279fcb,_0x28b45a){return function(_0x46834a,_0x540036){_0x28b45a(_0x46834a,_0x540036,_0x279fcb);};};Object[a111_0xd3061c(0x1fb)](exports,a111_0xd3061c(0x202),{'value':!![]}),exports['ScheduleService']=void 0x0;function a111_0x4bba(_0x27a6c4,_0x2ccd18){const _0x345883=a111_0x3458();return a111_0x4bba=function(_0x4bba5c,_0x54bbd){_0x4bba5c=_0x4bba5c-0x1d3;let _0x139be9=_0x345883[_0x4bba5c];return _0x139be9;},a111_0x4bba(_0x27a6c4,_0x2ccd18);}const common_1=require('@nestjs/common'),mongoose_1=require(a111_0xd3061c(0x20b)),mongoose_2=require(a111_0xd3061c(0x1f8)),dayjs=require(a111_0xd3061c(0x201)),utils_1=require(a111_0xd3061c(0x1d3)),schedulePrioritySort=(_0x2859e4,_0x5f0e42)=>dayjs(_0x2859e4[a111_0xd3061c(0x209)])[a111_0xd3061c(0x1da)](dayjs(_0x5f0e42['createdAtUtc']))?-0x1:0x1;let ScheduleService=class ScheduleService{constructor(_0xfac56){const _0x2d5b0a=a111_0xd3061c;this[_0x2d5b0a(0x1d4)]=_0xfac56;}async[a111_0xd3061c(0x20a)](_0x4fabec){const _0x5d7d54=a111_0xd3061c,_0x2c59b4=new this[(_0x5d7d54(0x1d4))](_0x4fabec);return _0x2c59b4['save']();}async['findAll'](){const _0x5b9df9=a111_0xd3061c,_0x570f56=await this[_0x5b9df9(0x1d4)][_0x5b9df9(0x205)]()[_0x5b9df9(0x1e4)]();return _0x570f56;}async[a111_0xd3061c(0x1f9)](_0x49e89c){const _0x1ec804=a111_0xd3061c,_0x1e5dd5=await this[_0x1ec804(0x1d4)][_0x1ec804(0x1f4)](_0x49e89c);return _0x1e5dd5;}async[a111_0xd3061c(0x1f6)](_0x31c78e){const _0x43ebcf=a111_0xd3061c,_0x53bcb7=await this[_0x43ebcf(0x1ff)](_0x31c78e),_0x18ece3=_0x53bcb7[_0x43ebcf(0x1f2)](_0x75309b=>_0x75309b[_0x43ebcf(0x1ea)][_0x43ebcf(0x1d7)]>0x0&&_0x75309b[_0x43ebcf(0x1ea)][_0x43ebcf(0x210)](_0x10daef=>dayjs(_0x10daef)[_0x43ebcf(0x1f7)](_0x43ebcf(0x1d6)))[_0x43ebcf(0x1ec)](dayjs(_0x31c78e)[_0x43ebcf(0x1f7)](_0x43ebcf(0x1d6))))['sort'](schedulePrioritySort);if(_0x18ece3[_0x43ebcf(0x1d7)]>0x0)return _0x18ece3[0x0];const _0x3c2b5e=_0x53bcb7[_0x43ebcf(0x1f2)](_0x191a7d=>_0x191a7d[_0x43ebcf(0x1e5)]['includes'](_0x31c78e[_0x43ebcf(0x1d9)]()))['sort'](schedulePrioritySort);if(_0x3c2b5e[_0x43ebcf(0x1d7)]>0x0)return _0x3c2b5e[0x0];return null;}async[a111_0xd3061c(0x1ff)](_0x35cd2c){const _0x1dbdc3=a111_0xd3061c,_0x45c425=dayjs(_0x35cd2c)[_0x1dbdc3(0x1e0)]('day')['toDate'](),_0x2e4836={'$and':[{'$or':[{'startDate':{'$lte':_0x35cd2c},'endDate':{'$gte':_0x35cd2c}},{'startDate':{'$lte':_0x35cd2c},'endDate':null},{'startDate':null,'endDate':{'$gte':_0x35cd2c}}]},{'excludeDates':{'$nin':[_0x45c425]}}]},_0xf8765b=await this[_0x1dbdc3(0x1d4)][_0x1dbdc3(0x205)](_0x2e4836)[_0x1dbdc3(0x1e4)]();return _0xf8765b;}async['findEligibleScheduleBetween'](_0x513319,_0x3f424a){const _0x535687=a111_0xd3061c,_0x3117cb=new Date(_0x513319),_0x2ac941={};while(_0x3117cb<=_0x3f424a){const _0x2ffc45=await this['findEligibleSchedule'](_0x3117cb);_0x2ffc45&&(_0x2ac941[dayjs(_0x3117cb)[_0x535687(0x1f7)](_0x535687(0x1d6))]=_0x2ffc45),_0x3117cb['setDate'](_0x3117cb[_0x535687(0x1ed)]()+0x1);}return _0x2ac941;}async[a111_0xd3061c(0x1dc)](_0x382048,_0x51d19e){const _0x3f55a8=a111_0xd3061c,_0x42f0d5=await this['scheduleModel'][_0x3f55a8(0x1df)](_0x382048,Object[_0x3f55a8(0x1e9)](Object[_0x3f55a8(0x1e9)]({},_0x51d19e),{'updatedAtUtc':new Date()}),{'new':!![]})[_0x3f55a8(0x1e4)]();return _0x42f0d5[_0x3f55a8(0x1ea)]&&await this['removeOtherExistingIncludeDates'](_0x382048,_0x42f0d5['includeDates']),_0x42f0d5;}async[a111_0xd3061c(0x1f3)](_0x1dace0){const _0x48f631=a111_0xd3061c,_0x3eca7f=await this[_0x48f631(0x1d4)][_0x48f631(0x1e6)](_0x1dace0)[_0x48f631(0x1e4)]();return _0x3eca7f;}async[a111_0xd3061c(0x1fa)](_0x18b0a9,_0x85ab6b){const _0x365a1f=a111_0xd3061c,_0x15a3d8=await this['findOne'](_0x18b0a9);_0x15a3d8[_0x365a1f(0x1ea)]['findIndex'](_0x427dba=>_0x427dba['getTime']()===_0x85ab6b['getTime']())===-0x1&&_0x15a3d8[_0x365a1f(0x1ea)][_0x365a1f(0x1dd)](_0x85ab6b);const _0x10839a=await _0x15a3d8[_0x365a1f(0x208)]();return await this[_0x365a1f(0x1e2)](_0x18b0a9,[_0x85ab6b]),_0x10839a;}async[a111_0xd3061c(0x1e2)](_0x156c80,_0x53d473){const _0x2c79ff=a111_0xd3061c,_0x4055d6=await this[_0x2c79ff(0x1d4)]['find']({'_id':{'$ne':_0x156c80},'includeDates':{'$in':_0x53d473}})['exec'](),_0x3eff3a=_0x53d473[_0x2c79ff(0x210)](_0x1b7dac=>_0x1b7dac[_0x2c79ff(0x1fd)]());await Promise[_0x2c79ff(0x1fc)](_0x4055d6[_0x2c79ff(0x210)](_0x3c67d5=>{const _0x105417=_0x2c79ff,_0x492f9a=_0x3c67d5[_0x105417(0x1ea)][_0x105417(0x1f2)](_0x1524ee=>!_0x3eff3a[_0x105417(0x1ec)](_0x1524ee[_0x105417(0x1fd)]()));return _0x3c67d5['includeDates']=_0x492f9a,_0x3c67d5[_0x105417(0x1db)]=new Date(),_0x3c67d5['save']();}));}async[a111_0xd3061c(0x20f)](_0x579202){const _0x394f5d=a111_0xd3061c,_0x3dd44a=await this[_0x394f5d(0x1f9)](_0x579202),_0x343ae7=_0x3dd44a[_0x394f5d(0x1eb)][_0x394f5d(0x210)](_0x2cffb5=>Object[_0x394f5d(0x1e9)](Object[_0x394f5d(0x1e9)]({},_0x2cffb5),{'id':(0x0,utils_1[_0x394f5d(0x200)])()})),_0x3aaaea=new this[(_0x394f5d(0x1d4))](Object[_0x394f5d(0x1e9)](Object[_0x394f5d(0x1e9)]({},_0x3dd44a[_0x394f5d(0x207)]()),{'events':_0x343ae7,'_id':undefined,'createdAtUtc':new Date(),'updatedAtUtc':new Date()}));return _0x3aaaea['save']();}};ScheduleService=__decorate([(0x0,common_1[a111_0xd3061c(0x20e)])(),__param(0x0,(0x0,mongoose_1['InjectModel'])(a111_0xd3061c(0x1f1))),__metadata('design:paramtypes',[mongoose_2['Model']])],ScheduleService),exports['ScheduleService']=ScheduleService;