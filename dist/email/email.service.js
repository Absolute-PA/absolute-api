'use strict';const a79_0x4f42a1=a79_0x5375;function a79_0x5375(_0x5c5006,_0x2ff515){const _0x2883cb=a79_0x2883();return a79_0x5375=function(_0x5375ff,_0x15b8da){_0x5375ff=_0x5375ff-0xdb;let _0x11fa6f=_0x2883cb[_0x5375ff];return _0x11fa6f;},a79_0x5375(_0x5c5006,_0x2ff515);}(function(_0x2d4896,_0x13406d){const _0x1326bd=a79_0x5375,_0xb5937a=_0x2d4896();while(!![]){try{const _0x809e9c=-parseInt(_0x1326bd(0x124))/0x1*(parseInt(_0x1326bd(0xe1))/0x2)+parseInt(_0x1326bd(0x102))/0x3+parseInt(_0x1326bd(0xdb))/0x4+-parseInt(_0x1326bd(0xe6))/0x5+-parseInt(_0x1326bd(0x10f))/0x6*(-parseInt(_0x1326bd(0x125))/0x7)+parseInt(_0x1326bd(0xec))/0x8+parseInt(_0x1326bd(0xea))/0x9;if(_0x809e9c===_0x13406d)break;else _0xb5937a['push'](_0xb5937a['shift']());}catch(_0x312cf3){_0xb5937a['push'](_0xb5937a['shift']());}}}(a79_0x2883,0x68c02));var __decorate=this&&this[a79_0x4f42a1(0x113)]||function(_0x1e4f67,_0x1db0cb,_0x57e133,_0x5ca59f){const _0x4b7a56=a79_0x4f42a1;var _0x42f62b=arguments['length'],_0x3b4256=_0x42f62b<0x3?_0x1db0cb:_0x5ca59f===null?_0x5ca59f=Object['getOwnPropertyDescriptor'](_0x1db0cb,_0x57e133):_0x5ca59f,_0x3b7880;if(typeof Reflect===_0x4b7a56(0xf2)&&typeof Reflect[_0x4b7a56(0x10d)]===_0x4b7a56(0x128))_0x3b4256=Reflect[_0x4b7a56(0x10d)](_0x1e4f67,_0x1db0cb,_0x57e133,_0x5ca59f);else{for(var _0x44e013=_0x1e4f67['length']-0x1;_0x44e013>=0x0;_0x44e013--)if(_0x3b7880=_0x1e4f67[_0x44e013])_0x3b4256=(_0x42f62b<0x3?_0x3b7880(_0x3b4256):_0x42f62b>0x3?_0x3b7880(_0x1db0cb,_0x57e133,_0x3b4256):_0x3b7880(_0x1db0cb,_0x57e133))||_0x3b4256;}return _0x42f62b>0x3&&_0x3b4256&&Object[_0x4b7a56(0xf4)](_0x1db0cb,_0x57e133,_0x3b4256),_0x3b4256;},__metadata=this&&this['__metadata']||function(_0x2a2eb3,_0xdfea7b){const _0x28fc48=a79_0x4f42a1;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x28fc48(0x128))return Reflect['metadata'](_0x2a2eb3,_0xdfea7b);},EmailService_1;Object[a79_0x4f42a1(0xf4)](exports,a79_0x4f42a1(0xfc),{'value':!![]}),exports['EmailService']=void 0x0;function a79_0x2883(){const _0x36ddd3=['design:paramtypes','115ivBlNs','2638237feSTUG','debug','587','function','createTransporter','message','</p>\x0a\x20\x20\x20\x20\x20\x20<p><strong>Request\x20Method:</strong>\x20','exdyrljbopqilckb',']\x20Unhandled\x20Exception\x20Occurred','stringify','1612736QxfFNs','\x0a\x0aException\x20Message:\x0a','\x0a\x0aRequest\x20Body:\x0a','Exception\x20notification\x20email\x20sent\x20successfully','transporter','toISOString','13382zOkkBH','@nestjs/common','SMTP_SECURE','dev.absolutepa@gmail.com','_settingService','1389825Kwrhyw','Injectable','SMTP_PORT','method','1093455GlELwr','\x0aTimestamp:\x20','2963896qfVkaM','nodemailer','smtp.gmail.com','schoolId','SMTP_FROM','EXCEPTION_NOTIFY_EMAIL','object','</pre>\x0a\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20<h3>Request\x20Headers:</h3>\x0a\x20\x20\x20\x20\x20\x20<pre\x20style=\x22background-color:\x20#f5f5f5;\x20padding:\x2010px;\x20border-radius:\x204px;\x20overflow:\x20auto;\x22>','defineProperty','Unknown\x20Device','cachedDeviceName','findFirst','</p>\x0a\x20\x20\x20\x20\x20\x20<p><strong>Request\x20URL:</strong>\x20','headers','trim','sendMail','__esModule','SMTP_HOST','\x0aUnhandled\x20Exception\x20Notification\x0a\x0aDevice:\x20','name','timestamp','body','613293vdKeue','Email\x20configuration\x20not\x20found.\x20Exceptions\x20will\x20be\x20sent\x20to\x20default\x20address.','Failed\x20to\x20send\x20exception\x20notification\x20email:','\x0aRequest\x20URL:\x20','N/A','\x0aRequest\x20Method:\x20','SettingService','SMTP_USER','defaultToEmail','url','formatExceptionEmail','decorate','env','6OvSIvE','logger','\x0a\x0aRequest\x20Headers:\x0a','getDeviceName','__decorate','warn','Logger','\x0a\x20\x20\x20\x20\x20\x20<h2>Unhandled\x20Exception\x20Notification</h2>\x0a\x20\x20\x20\x20\x20\x20<p><strong>Device:</strong>\x20','</pre>\x0a\x20\x20\x20\x20','isEmailConfigured','\x22Exception\x20Notifier\x22\x20<no-reply@absolutepa.com>','onModuleInit','error','formatExceptionEmailHtml','dev.absolutepa@gmail.com,service@absolutepa.com.au','piName','sendExceptionNotification','SMTP_PASS','Failed\x20to\x20get\x20device\x20name\x20from\x20SettingService,\x20falling\x20back\x20to\x20details.piName\x20or\x20default.','true'];a79_0x2883=function(){return _0x36ddd3;};return a79_0x2883();}const common_1=require(a79_0x4f42a1(0xe2)),nodemailer=require(a79_0x4f42a1(0xed)),setting_service_1=require('../setting/setting.service');let EmailService=EmailService_1=class EmailService{constructor(_0x49c00c){const _0x58da8d=a79_0x4f42a1;this[_0x58da8d(0xe5)]=_0x49c00c,this[_0x58da8d(0x110)]=new common_1[(_0x58da8d(0x115))](EmailService_1[_0x58da8d(0xff)]),this[_0x58da8d(0x10a)]=_0x58da8d(0x11d),this[_0x58da8d(0xf6)]=null,this[_0x58da8d(0x129)]();}async[a79_0x4f42a1(0x11a)](){const _0x4327a1=a79_0x4f42a1;try{const _0x42e5f6=await this['_settingService'][_0x4327a1(0xf7)]();this['cachedDeviceName']=(_0x42e5f6===null||_0x42e5f6===void 0x0?void 0x0:_0x42e5f6[_0x4327a1(0xef)])||null;}catch(_0x362258){this[_0x4327a1(0x110)][_0x4327a1(0x114)]('Failed\x20to\x20cache\x20device\x20name\x20on\x20startup.'),this['cachedDeviceName']=null;}}['createTransporter'](){const _0x27c21a=a79_0x4f42a1;this[_0x27c21a(0x118)]()?this[_0x27c21a(0xdf)]=nodemailer['createTransport']({'host':process[_0x27c21a(0x10e)][_0x27c21a(0xfd)],'port':parseInt(process[_0x27c21a(0x10e)][_0x27c21a(0xe8)]||_0x27c21a(0x127)),'secure':process[_0x27c21a(0x10e)][_0x27c21a(0xe3)]===_0x27c21a(0x122),'auth':{'user':process[_0x27c21a(0x10e)][_0x27c21a(0x109)],'pass':process['env'][_0x27c21a(0x120)]}}):(this[_0x27c21a(0x110)][_0x27c21a(0x114)](_0x27c21a(0x103)),this[_0x27c21a(0xdf)]=nodemailer['createTransport']({'host':_0x27c21a(0xee),'port':0x24b,'secure':![],'auth':{'user':_0x27c21a(0xe4),'pass':_0x27c21a(0x12c)}}));}[a79_0x4f42a1(0x118)](){const _0x4d9695=a79_0x4f42a1;return!!(process[_0x4d9695(0x10e)][_0x4d9695(0xfd)]&&process['env']['SMTP_USER']&&process['env'][_0x4d9695(0x120)]&&process[_0x4d9695(0x10e)][_0x4d9695(0xf1)]);}async[a79_0x4f42a1(0x11f)](_0x1970df){const _0xff04cf=a79_0x4f42a1;if(!this[_0xff04cf(0xdf)]){this[_0xff04cf(0x110)][_0xff04cf(0x126)]('Email\x20not\x20configured,\x20skipping\x20exception\x20notification');return;}const _0x2ac165=await this[_0xff04cf(0x112)](_0x1970df);try{const _0x7bb9e1=this[_0xff04cf(0x10c)](_0x1970df,_0x2ac165);await this[_0xff04cf(0xdf)][_0xff04cf(0xfb)]({'from':process['env'][_0xff04cf(0xf0)]||_0xff04cf(0x119),'to':process[_0xff04cf(0x10e)][_0xff04cf(0xf1)]||this[_0xff04cf(0x10a)],'subject':'['+_0x2ac165+_0xff04cf(0x12d),'text':_0x7bb9e1,'html':this['formatExceptionEmailHtml'](_0x1970df,_0x2ac165)}),this['logger']['log'](_0xff04cf(0xde));}catch(_0x19d8b9){this['logger'][_0xff04cf(0x11b)](_0xff04cf(0x104),_0x19d8b9);}}['formatExceptionEmail'](_0x4ee409,_0x1372f2){const _0x335ca2=a79_0x4f42a1;return(_0x335ca2(0xfe)+_0x1372f2+_0x335ca2(0xeb)+(_0x4ee409[_0x335ca2(0x100)]||new Date()[_0x335ca2(0xe0)]())+_0x335ca2(0x105)+(_0x4ee409['url']||'N/A')+_0x335ca2(0x107)+(_0x4ee409['method']||_0x335ca2(0x106))+_0x335ca2(0xdc)+_0x4ee409[_0x335ca2(0x12a)]+_0x335ca2(0xdd)+(_0x4ee409['body']?JSON[_0x335ca2(0x12e)](_0x4ee409['body'],null,0x2):'N/A')+_0x335ca2(0x111)+(_0x4ee409[_0x335ca2(0xf9)]?JSON[_0x335ca2(0x12e)](_0x4ee409[_0x335ca2(0xf9)],null,0x2):_0x335ca2(0x106))+'\x0a\x20\x20\x20\x20')[_0x335ca2(0xfa)]();}[a79_0x4f42a1(0x11c)](_0x50c22e,_0x255d2a){const _0x3c4c7d=a79_0x4f42a1;return _0x3c4c7d(0x116)+_0x255d2a+'</p>\x0a\x20\x20\x20\x20\x20\x20<p><strong>Timestamp:</strong>\x20'+(_0x50c22e[_0x3c4c7d(0x100)]||new Date()[_0x3c4c7d(0xe0)]())+_0x3c4c7d(0xf8)+(_0x50c22e[_0x3c4c7d(0x10b)]||_0x3c4c7d(0x106))+_0x3c4c7d(0x12b)+(_0x50c22e[_0x3c4c7d(0xe9)]||_0x3c4c7d(0x106))+'</p>\x0a\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20<h3>Exception\x20Message:</h3>\x0a\x20\x20\x20\x20\x20\x20<pre\x20style=\x22background-color:\x20#f5f5f5;\x20padding:\x2010px;\x20border-radius:\x204px;\x20overflow:\x20auto;\x22>'+_0x50c22e[_0x3c4c7d(0x12a)]+'</pre>\x0a\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20<h3>Request\x20Body:</h3>\x0a\x20\x20\x20\x20\x20\x20<pre\x20style=\x22background-color:\x20#f5f5f5;\x20padding:\x2010px;\x20border-radius:\x204px;\x20overflow:\x20auto;\x22>'+(_0x50c22e[_0x3c4c7d(0x101)]?JSON['stringify'](_0x50c22e[_0x3c4c7d(0x101)],null,0x2):_0x3c4c7d(0x106))+_0x3c4c7d(0xf3)+(_0x50c22e[_0x3c4c7d(0xf9)]?JSON['stringify'](_0x50c22e[_0x3c4c7d(0xf9)],null,0x2):_0x3c4c7d(0x106))+_0x3c4c7d(0x117);}async[a79_0x4f42a1(0x112)](_0x4cf2be){const _0x586090=a79_0x4f42a1;if(this[_0x586090(0xf6)])return this[_0x586090(0xf6)];try{const _0x2d4d03=await this['_settingService'][_0x586090(0xf7)]();return(_0x2d4d03===null||_0x2d4d03===void 0x0?void 0x0:_0x2d4d03['schoolId'])||_0x4cf2be[_0x586090(0x11e)]||_0x586090(0xf5);}catch(_0xc47b80){return this[_0x586090(0x110)][_0x586090(0x114)](_0x586090(0x121)),_0x4cf2be[_0x586090(0x11e)]||_0x586090(0xf5);}}};EmailService=EmailService_1=__decorate([(0x0,common_1[a79_0x4f42a1(0xe7)])(),__metadata(a79_0x4f42a1(0x123),[setting_service_1[a79_0x4f42a1(0x108)]])],EmailService),exports['EmailService']=EmailService;